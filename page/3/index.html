<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/page/3/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-207-【Webpack】了不起的Webpack-HMR学习指南（含源码分析）" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/06/17/207-%E3%80%90Webpack%E3%80%91%E4%BA%86%E4%B8%8D%E8%B5%B7%E7%9A%84Webpack-HMR%E5%AD%A6%E4%B9%A0%E6%8C%87%E5%8D%97%EF%BC%88%E5%90%AB%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%89/" class="article-date">
  <time class="dt-published" datetime="2020-06-16T16:12:05.000Z" itemprop="datePublished">2020-06-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/06/17/207-%E3%80%90Webpack%E3%80%91%E4%BA%86%E4%B8%8D%E8%B5%B7%E7%9A%84Webpack-HMR%E5%AD%A6%E4%B9%A0%E6%8C%87%E5%8D%97%EF%BC%88%E5%90%AB%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%89/">207-【Webpack】了不起的 Webpack HMR 学习指南（含源码分析）</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>学习时间：2020.06.14<br />学习章节：<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/30669007">《Webpack HMR 原理解析》</a><br /><img src="http://images.pingan8787.com/Webpack-HMR/Webpack-HMR-Xmind.png" alt="了不起的 Webpack HMR 学习指南.png"></p>
<h1 id="一、HMR-介绍"><a href="#一、HMR-介绍" class="headerlink" title="一、HMR 介绍"></a>一、HMR 介绍</h1><p>Hot Module Replacement（以下简称：HMR 模块热替换）是 Webpack 提供的一个非常有用的功能，<strong>它允许在 JavaScript 运行时更新各种模块，而无需完全刷新</strong>。</p>
<blockquote>
<p>Hot Module Replacement (or HMR) is one of the most useful features offered by webpack. It allows all kinds of modules to be updated at runtime without the need for a full refresh.<br>–《Hot Module Replacement》</p>
</blockquote>
<p>当我们修改代码并保存后，Webpack 将对代码重新打包，HMR 会在应用程序运行过程中替换、添加或删除模块，而无需重新加载整个页面。<br />HMR 主要通过以下几种方式，来显著加快开发速度：</p>
<ul>
<li>保留在完全重新加载页面时丢失的应用程序状态；</li>
<li>只更新变更内容，以节省宝贵的开发时间；</li>
<li>调整样式更加快速 - 几乎相当于在浏览器调试器中更改样式。</li>
</ul>
<p><strong>需要注意</strong>：HMR 不适用于生产环境，这意味着它应当只在开发环境使用。<br /></p>
<h1 id="二、HMR-使用方式"><a href="#二、HMR-使用方式" class="headerlink" title="二、HMR 使用方式"></a>二、HMR 使用方式</h1><p>在 Webpack 中启用 HMR 功能比较简单：</p>
<h2 id="1-方式一：使用-devServer"><a href="#1-方式一：使用-devServer" class="headerlink" title="1. 方式一：使用 devServer"></a>1. 方式一：使用 devServer</h2><h3 id="1-1-设置-devServer-选项"><a href="#1-1-设置-devServer-选项" class="headerlink" title="1.1 设置 devServer 选项"></a>1.1 设置 devServer 选项</h3><p>只需要在 <code>webpack.config.js</code> 中添加 <code>devServer</code> 选项，并设置 <code>hot</code> 值为 <code>true</code> ，并使用<code>HotModuleReplacementPlugin</code> 和 <code>NamedModulesPlugin</code> （可选）两个 Plugins ：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">// webpack.config.js</span><br><span class="line"></span><br><span class="line">const path = require(&#x27;path&#x27;)</span><br><span class="line">const webpack = require(&#x27;webpack&#x27;)</span><br><span class="line">module.exports = &#123;</span><br><span class="line">	entry: &#x27;./index.js&#x27;,</span><br><span class="line">	output: &#123;</span><br><span class="line">		filename: &#x27;bundle.js&#x27;,</span><br><span class="line">		path: path.join(__dirname, &#x27;/&#x27;)</span><br><span class="line">	&#125;,</span><br><span class="line"><span class="addition">+	devServer: &#123;</span></span><br><span class="line"><span class="addition">+		hot: true,   // 启动模块热更新 HMR</span></span><br><span class="line"><span class="addition">+   open: true,  // 开启自动打开浏览器页面</span></span><br><span class="line"><span class="addition">+	&#125;,</span></span><br><span class="line">  plugins: [</span><br><span class="line"><span class="addition">+   new webpack.NamedModulesPlugin(),</span></span><br><span class="line"><span class="addition">+   new webpack.HotModuleReplacementPlugin()</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-2-添加-scripts"><a href="#1-2-添加-scripts" class="headerlink" title="1.2 添加 scripts"></a>1.2 添加 scripts</h3><p>然后在 <code>package.json</code> 中为 <code>scripts</code> 命令即可：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// package.json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  // ...</span><br><span class="line">  &quot;scripts&quot;: &#123;</span><br><span class="line"><span class="addition">+    &quot;start&quot;: &quot;webpack-dev-server&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  // ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-方式二、使用命令行参数"><a href="#2-方式二、使用命令行参数" class="headerlink" title="2. 方式二、使用命令行参数"></a>2. 方式二、使用命令行参数</h2><p>另一种是通过添加 <code>--hot</code> 参数来实现。添加 <code>--hot</code> 参数后，devServer 会告诉 Webpack 自动引入 <code>HotModuleReplacementPlugin</code> ，而不需要我们手动引入。<br />另外常常也搭配 <code>--open</code> 来自动打开浏览器到页面。<br />这里移除掉前面添加的两个 Plugins ：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// webpack.config.js</span><br><span class="line"></span><br><span class="line">const path = require(&#x27;path&#x27;)</span><br><span class="line">const webpack = require(&#x27;webpack&#x27;)</span><br><span class="line">module.exports = &#123;</span><br><span class="line">	// ...</span><br><span class="line"><span class="deletion">- plugins: [</span></span><br><span class="line"><span class="deletion">-   new webpack.NamedModulesPlugin(),</span></span><br><span class="line"><span class="deletion">-   new webpack.HotModuleReplacementPlugin()</span></span><br><span class="line"><span class="deletion">- ]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后修改 <code>package.json</code> 文件中的 <code>scripts</code> 配置：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// package.json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  // ...</span><br><span class="line">  &quot;scripts&quot;: &#123;</span><br><span class="line"><span class="deletion">-    &quot;start&quot;: &quot;webpack-dev-server&quot;</span></span><br><span class="line"><span class="addition">+    &quot;start&quot;: &quot;webpack-dev-server --hot --open&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  // ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-简单示例"><a href="#3-简单示例" class="headerlink" title="3. 简单示例"></a>3. 简单示例</h2><p>基于上述配置，我们简单实现一个场景： <code>index.js</code> 文件中导入 <code>hello.js</code> 模块，当 <code>hello.js</code> 模块发生变化时， <code>index.js</code> 将更新模块。<br><br />模块代码如下实现：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// hello.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> () =&gt; <span class="string">&#x27;hi leo!&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// index.js</span></span><br><span class="line"><span class="keyword">import</span> hello <span class="keyword">from</span> <span class="string">&#x27;./hello.js&#x27;</span></span><br><span class="line"><span class="keyword">const</span> div = <span class="built_in">document</span>.createElement(<span class="string">&#x27;div&#x27;</span>);</span><br><span class="line">div.innerHTML = hello();</span><br><span class="line"></span><br><span class="line"><span class="built_in">document</span>.body.appendChild(div);</span><br></pre></td></tr></table></figure>
<p>然后在 <code>index.html</code> 中导入打包后的 JS 文件，并执行 <code>npm start</code> 运行项目：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">div</span>&gt;</span>了不起的 Webpack HMR 学习指南<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;bundle.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="4-实现监听更新"><a href="#4-实现监听更新" class="headerlink" title="4. 实现监听更新"></a>4. 实现监听更新</h2><p>当我们通过 <code>HotModuleReplacementPlugin</code>  插件启用了 HMR，则它的接口将被暴露在全局 <code>module.hot</code>  属性下面。通常，可以先检查这个接口是否可访问，然后再开始使用它。<br />举个例子，你可以这样 <code>accept</code>  一个更新的模块：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="built_in">module</span>.hot) &#123;</span><br><span class="line">  <span class="built_in">module</span>.hot.accept(<span class="string">&#x27;./library.js&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 使用更新过的 library 模块执行某些操作...</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>关于 <code>module.hot</code> 更多 API ，可以查看官方文档<a target="_blank" rel="noopener" href="https://webpack.js.org/api/hot-module-replacement/">《Hot Module Replacement API》</a> 。<br><br />回到上面示例，我们测试更新模块的功能。<br />这时我们修改 <code>index.js</code> 代码，来监听 <code>hello.js</code> 模块中的更新：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">import hello from &#x27;./hello.js&#x27;;</span><br><span class="line">const div = document.createElement(&#x27;div&#x27;);</span><br><span class="line">div.innerHTML = hello();</span><br><span class="line">document.body.appendChild(div);</span><br><span class="line"></span><br><span class="line"><span class="addition">+ if (module.hot) &#123;</span></span><br><span class="line"><span class="addition">+   module.hot.accept(&#x27;./hello.js&#x27;, function() &#123;</span></span><br><span class="line"><span class="addition">+     console.log(&#x27;现在在更新 hello 模块了~&#x27;);</span></span><br><span class="line"><span class="addition">+     div.innerHTML = hello();</span></span><br><span class="line"><span class="addition">+   &#125;)</span></span><br><span class="line"><span class="addition">+ &#125;</span></span><br></pre></td></tr></table></figure>
<p>然后修改 <code>hello.js</code> 文件内容，测试效果：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- export default () =&gt; &#x27;hi leo!&#x27;;</span></span><br><span class="line"><span class="addition">+ export default () =&gt; &#x27;hi leo! hello world&#x27;;</span></span><br></pre></td></tr></table></figure>
<p>当我们保存代码时，控制台输出 <code>&quot;现在在更新 hello模块了~&quot;</code> ，并且页面中 <code>&quot;hi leo!&quot;</code> 也更新为 <code>&quot;hi leo! hello world&quot;</code> ，证明我们监听到文件更新了。<br /><img src="http://images.pingan8787.com/Webpack-HMR/Webpack-HMR-demo1.png" alt="image.png"><br /><br><br />简单 Webpack HMR 使用方式就介绍到这，更多介绍，还请阅读官方文档<a target="_blank" rel="noopener" href="https://webpack.js.org/guides/hot-module-replacement/">《Hot Module Replacement》</a>。<br /></p>
<h2 id="5-devServer-常用配置和技巧"><a href="#5-devServer-常用配置和技巧" class="headerlink" title="5. devServer 常用配置和技巧"></a>5. devServer 常用配置和技巧</h2><h3 id="5-1-常用配置"><a href="#5-1-常用配置" class="headerlink" title="5.1 常用配置"></a>5.1 常用配置</h3><p>根据目录结构的不同，<code>contentBase</code>、<code>openPage</code> 参数要配置合适的值，否则运行时应该不会立刻访问到你的首页。 同时要注意你的 <code>publicPath</code>，静态资源打包后生成的路径是一个需要思考的点，取决于你的目录结构。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">devServer: &#123;</span><br><span class="line">  <span class="attr">contentBase</span>: path.join(__dirname, <span class="string">&#x27;static&#x27;</span>),    <span class="comment">// 告诉服务器从哪里提供内容(默认当前工作目录)</span></span><br><span class="line">  <span class="attr">openPage</span>: <span class="string">&#x27;views/index.html&#x27;</span>,  <span class="comment">// 指定默认启动浏览器时打开的页面</span></span><br><span class="line">  <span class="attr">index</span>: <span class="string">&#x27;views/index.html&#x27;</span>,  <span class="comment">// 指定首页位置</span></span><br><span class="line">  <span class="attr">watchContentBase</span>: <span class="literal">true</span>, <span class="comment">// contentBase下文件变动将reload页面(默认false)</span></span><br><span class="line">  <span class="attr">host</span>: <span class="string">&#x27;localhost&#x27;</span>, <span class="comment">// 默认localhost,想外部可访问用&#x27;0.0.0.0&#x27;</span></span><br><span class="line">  <span class="attr">port</span>: <span class="number">8080</span>, <span class="comment">// 默认8080</span></span><br><span class="line">  <span class="attr">inline</span>: <span class="literal">true</span>, <span class="comment">// 可以监控js变化</span></span><br><span class="line">  <span class="attr">hot</span>: <span class="literal">true</span>, <span class="comment">// 热启动</span></span><br><span class="line">  <span class="attr">open</span>: <span class="literal">true</span>, <span class="comment">// 启动时自动打开浏览器（指定打开chrome，open: &#x27;Google Chrome&#x27;）</span></span><br><span class="line">  <span class="attr">compress</span>: <span class="literal">true</span>, <span class="comment">// 一切服务都启用gzip 压缩</span></span><br><span class="line">  <span class="attr">disableHostCheck</span>: <span class="literal">true</span>, <span class="comment">// true：不进行host检查</span></span><br><span class="line">  <span class="attr">quiet</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">https</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">clientLogLevel</span>: <span class="string">&#x27;none&#x27;</span>,</span><br><span class="line">  <span class="attr">stats</span>: &#123; <span class="comment">// 设置控制台的提示信息</span></span><br><span class="line">    <span class="attr">chunks</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">children</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">modules</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">entrypoints</span>: <span class="literal">false</span>, <span class="comment">// 是否输出入口信息</span></span><br><span class="line">    <span class="attr">warnings</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">performance</span>: <span class="literal">false</span>, <span class="comment">// 是否输出webpack建议（如文件体积大小）</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">historyApiFallback</span>: &#123;</span><br><span class="line">    <span class="attr">disableDotRule</span>: <span class="literal">true</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">watchOptions</span>: &#123;</span><br><span class="line">    <span class="attr">ignored</span>: <span class="regexp">/node_modules/</span>, <span class="comment">// 略过node_modules目录</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">proxy</span>: &#123; <span class="comment">// 接口代理（这段配置更推荐：写到package.json，再引入到这里）</span></span><br><span class="line">    <span class="string">&quot;/api-dev&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;target&quot;</span>: <span class="string">&quot;http://api.test.xxx.com&quot;</span>,</span><br><span class="line">      <span class="string">&quot;secure&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="string">&quot;changeOrigin&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="string">&quot;pathRewrite&quot;</span>: &#123; <span class="comment">// 将url上的某段重写（例如此处是将 api-dev 替换成了空）</span></span><br><span class="line">        <span class="string">&quot;^/api-dev&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="function"><span class="title">before</span>(<span class="params">app</span>)</span> &#123; &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-2-技巧1：文件形式输出-dev-server-代码"><a href="#5-2-技巧1：文件形式输出-dev-server-代码" class="headerlink" title="5.2 技巧1：文件形式输出 dev-server 代码"></a>5.2 技巧1：文件形式输出 dev-server 代码</h3><p>dev-server 输出的代码通常在内存中，但也可以写入硬盘，产出实体文件：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">devServer:&#123;</span><br><span class="line">  <span class="attr">writeToDisk</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通常可以用于代理映射文件调试，编译时会产出许多带 hash 的 js 文件，不带 hash 的文件同样也是<strong>实时编译的</strong>。</p>
<h3 id="5-3-技巧2：默认使用本地-IP-启动服务"><a href="#5-3-技巧2：默认使用本地-IP-启动服务" class="headerlink" title="5.3 技巧2：默认使用本地 IP 启动服务"></a>5.3 技巧2：默认使用本地 IP 启动服务</h3><p>有的时候，启动服务时，想要默认使用本地的 ip 地址打开：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">devServer:&#123;</span><br><span class="line">  <span class="attr">disableHostCheck</span>: <span class="literal">true</span>, <span class="comment">// true：不进行host检查</span></span><br><span class="line">  <span class="comment">// useLocalIp: true, // 建议不在这里配置</span></span><br><span class="line">  <span class="comment">// host: &#x27;0.0.0.0&#x27;, // 建议不在这里配置</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同时还需要将 host 配置为 <code>0.0.0.0</code>，这个配置建议在 scripts 命令中追加，而非在配置中写死，否则将来不想要这种方式往回改折腾，取巧一点，配个新命令：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;dev-ip&quot;</span>: <span class="string">&quot;yarn run dev --host 0.0.0.0 --useLocalIp&quot;</span></span><br></pre></td></tr></table></figure>
<h3 id="5-4-技巧3：指定启动的调试域名"><a href="#5-4-技巧3：指定启动的调试域名" class="headerlink" title="5.4 技巧3：指定启动的调试域名"></a>5.4 技巧3：指定启动的调试域名</h3><p>有时启动的时候希望是指定的调试域名，例如：<code>local.test.baidu.com</code>：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">devServer:&#123;</span><br><span class="line">  <span class="attr">open</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">public</span>: <span class="string">&#x27;local.test.baidu.com:8080&#x27;</span>, <span class="comment">// 需要带上端口</span></span><br><span class="line">  <span class="attr">port</span>: <span class="number">8080</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同时需要将 <code>127.0.0.1</code> 修改为指定的 host，可以借助 iHost 等工具去修改，各个工具大同小异，格式如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> local.test.baidu.com</span><br></pre></td></tr></table></figure>
<p>服务启动后将自动打开 <code>local.test.baidu.com:8080</code> 访问<br /></p>
<h3 id="5-5-技巧4：启动-gzip-压缩"><a href="#5-5-技巧4：启动-gzip-压缩" class="headerlink" title="5.5 技巧4：启动 gzip 压缩"></a>5.5 技巧4：启动 gzip 压缩</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">devServer:&#123;</span><br><span class="line">  <span class="attr">compress</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="三、HMR-基本原理介绍"><a href="#三、HMR-基本原理介绍" class="headerlink" title="三、HMR 基本原理介绍"></a>三、HMR 基本原理介绍</h1><p>从前面介绍中，我们知道：HMR 主要功能是会<strong>在应用程序运行过程中替换、添加或删除模块，而无需重新加载整个页面</strong>。<br />那么，Webpack 编译源码所产生的文件变化在编译时，替换模块实现在运行时，两者如何联系起来？<br /><br><br />带着这两个问题，我们先简单看下 HMR 核心工作流程（简化版）：</p>
<p><img src="http://images.pingan8787.com/Webpack-HMR/Webpack-HMR-Simple-Process.png" alt="HMR 工作流程图.png"></p>
<p>接下来开始 HMR 工作流程分析：</p>
<ol>
<li>当 Webpack（Watchman） 监听到项目中的文件/模块代码发生变化后，将变化通知 Webpack 中的构建工具（Packager）即 HMR Plugin；</li>
<li>然后经过 HMR Plugin 处理后，将结果发送到应用程序（Application）的运行时框架（HMR Runtime）；</li>
<li>最后由 HMR Runtime 将这些发生变化的文件/模块更新（新增/删除或替换）到模块系统中。</li>
</ol>
<p>其中，HMR Runtime 是构建工具在编译时注入的，通过统一的 Module ID 将编译时的文件与运行时的模块对应起来，并且对外提供一系列 API 供应用层框架（如 React）调用。</p>
<p>💖<strong>注意</strong>💖：建议先理解上面这张图的大致流程，在进行后续阅读。放心，我等着大家~<a target="_blank" rel="noopener" href="https://emojipedia.org/people/">😃</a><br /></p>
<h1 id="四、HMR-完整原理和源码分析"><a href="#四、HMR-完整原理和源码分析" class="headerlink" title="四、HMR 完整原理和源码分析"></a>四、HMR 完整原理和源码分析</h1><p>通过上一节内容，我们大概知道 HMR 简单工作流程，那么或许你现在可能还有很多疑惑：文件更新是什么通知 HMR Plugin？HMR Plugin 怎么发送更新到 HMR Runtime？等等问题。</p>
<p>那么接下来我们开始详细结合源码分析整个 HMR 模块热更新流程，首先还是先看流程图，可以先不了解图中方法名称（红色字体黄色背景色部分）：</p>
<p><img src="http://images.pingan8787.com/Webpack-HMR/Webpack-HMR-Source-Process.png" alt="Webpack HMR.png"></p>
<p>上图展示了从我们修改代码，到模块热更新完成的一个 HMR 完整工作流程，图中已用红色阿拉伯数字符号将流程标识出来。</p>
<p>要了解上面工作原理，我们先理解图中这几个名称概念：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/webpack/webpack-dev-server"><strong>Webpack-dev-server</strong></a> ：一个服务器插件，相当于 express 服务器，启动一个 Web 服务，只适用于开发环境；</li>
<li><a target="_blank" rel="noopener" href="https://github.com/webpack/webpack-dev-middleware"><strong>Webpack-dev-middleware</strong></a> ：一个 <strong>Webpack-dev-server</strong> 的中间件，作用简单总结为：通过watch mode，监听资源的变更，然后自动打包。</li>
<li><a target="_blank" rel="noopener" href="https://github.com/webpack-contrib/webpack-hot-middleware"><strong>Webpack-hot-middleware</strong></a> ：结合 Webpack-dev-middleware 使用的中间件，它可以实现浏览器的无刷新更新，也就是 HMR；</li>
</ul>
<p><img src="http://images.pingan8787.com/Webpack-HMR/face1.gif"></p>
<p>下面一起学习 HMR 整个工作原理吧：</p>
<h2 id="1-监控代码变化，重新编译打包"><a href="#1-监控代码变化，重新编译打包" class="headerlink" title="1.监控代码变化，重新编译打包"></a>1.监控代码变化，重新编译打包</h2><p>首先根据 devServer 配置，使用 <code>npm start</code> 将启动 Webpack-dev-server 启动本地服务器并进入 Webpack 的 watch 模式，然后初始化 Webpack-dev-middleware ，在 Webpack-dev-middleware 中通过调用 <code>startWatch()</code> 方法对文件系统进行 watch：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack-dev-server\bin\webpack-dev-server.js</span></span><br><span class="line"><span class="comment">// 1.启动本地服务器 Line 386</span></span><br><span class="line">server = <span class="keyword">new</span> Server(compiler, options);</span><br><span class="line"></span><br><span class="line"><span class="comment">// webpack-dev-server\lib\Server.js</span></span><br><span class="line"><span class="comment">// 2.初始化 Webpack-dev-middleware Line 109</span></span><br><span class="line"><span class="built_in">this</span>.middleware = webpackDevMiddleware(compiler, <span class="built_in">Object</span>.assign(&#123;&#125;, options, wdmOptions));</span><br><span class="line"></span><br><span class="line"><span class="comment">// webpack-dev-middleware\lib\Shared.js</span></span><br><span class="line"><span class="comment">// 3.开始 watch 文件系统 Line 171</span></span><br><span class="line">startWatch: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">	<span class="comment">// start watching</span></span><br><span class="line">	<span class="keyword">if</span>(!options.lazy) &#123;</span><br><span class="line">		<span class="keyword">var</span> watching = compiler.watch(options.watchOptions, share.handleCompilerCallback);</span><br><span class="line">		context.watching = watching;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line">share.startWatch();</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure>
<p>当 <code>startWatch()</code> 方法执行后，便进入 watch 模式，若发现文件中代码发生修改，则根据配置文件<strong>对模块重新编译打包</strong>。</p>
<h2 id="2-保存编译结果"><a href="#2-保存编译结果" class="headerlink" title="2.保存编译结果"></a>2.保存编译结果</h2><p>Webpack 与  Webpack-dev-middleware 交互，Webpack-dev-middleware 调用 Webpack 的 API 对代码变化进行监控，并通知 Webpack 将重新编译的代码通过 JavaScript 对象<strong>保存在内存中</strong>。</p>
<p>我们会发现，在 <code>output.path</code> 指定的 <code>dist</code> 目录并没有保存编译结果的文件，这是为什么？</p>
<p>其实， Webpack 将编译结果保存在内存中，因为<strong>访问内存中的代码比访问文件系统中的文件快</strong>，这样可以减少代码写入文件的开销。</p>
<p>Webpack 能将代码保存到内存中，需要归功于 Webpack-dev-middleware 的 <code>memory-fs</code> 依赖库，它将原本 <code>outputFileSystem</code>  替换成了 <code>MemoryFileSystem</code>  的实例，便实现代码输出到内存中。其中部分源码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack-dev-middleware\lib\Shared.js Line 108</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// store our files in memory</span></span><br><span class="line"><span class="keyword">var</span> fs;</span><br><span class="line"><span class="keyword">var</span> isMemoryFs = !compiler.compilers &amp;&amp; </span><br><span class="line">    compiler.outputFileSystem <span class="keyword">instanceof</span> MemoryFileSystem;</span><br><span class="line"><span class="keyword">if</span>(isMemoryFs) &#123;</span><br><span class="line">	fs = compiler.outputFileSystem;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	fs = compiler.outputFileSystem = <span class="keyword">new</span> MemoryFileSystem();</span><br><span class="line">&#125;</span><br><span class="line">context.fs = fs;</span><br></pre></td></tr></table></figure>

<p>上述代码先判断 <code>fileSystem</code> 是否是 <code>MemoryFileSystem</code> 的实例，若不是，则用 <code>MemoryFileSystem</code> 的实例替换 compiler 之前的 <code>outputFileSystem</code>。这样 bundle.js 文件代码就作为一个简单 JavaScript 对象保存在内存中，当浏览器请求 bundle.js 文件时，devServer 就直接去内存中找到上面保存的 JavaScript 对象并返回给浏览器端。</p>
<h2 id="3-监控文件变化，刷新浏览器"><a href="#3-监控文件变化，刷新浏览器" class="headerlink" title="3.监控文件变化，刷新浏览器"></a>3.监控文件变化，刷新浏览器</h2><p>Webpack-dev-server 开始监控文件变化，与第 1 步不同的是，这里并不是监控代码变化重新编译打包。<br />当我们在配置文件中配置了 <a target="_blank" rel="noopener" href="https://webpack.js.org/configuration/dev-server/#devserver-watchcontentbase"><code>devServer.watchContentBase</code></a> 为 <code>true</code> ，Webpack-dev-server 会监听配置文件夹中静态文件的变化，发生变化时，通知浏览器端对应用进行<strong>浏览器刷新</strong>，这与 HMR 不一样。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack-dev-server\lib\Server.js</span></span><br><span class="line"><span class="comment">// 1. 读取参数 Line 385</span></span><br><span class="line"><span class="keyword">if</span> (options.watchContentBase) &#123; defaultFeatures.push(<span class="string">&#x27;watchContentBase&#x27;</span>); &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 定义 _watch 方法 Line 697</span></span><br><span class="line">Server.prototype._watch = <span class="function"><span class="keyword">function</span> (<span class="params">watchPath</span>) </span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">const</span> watcher = chokidar.watch(watchPath, options).on(<span class="string">&#x27;change&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.sockWrite(<span class="built_in">this</span>.sockets, <span class="string">&#x27;content-changed&#x27;</span>);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">this</span>.contentBaseWatchers.push(watcher);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 执行 _watch() 监听文件变化 Line 339</span></span><br><span class="line">watchContentBase: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="regexp">/^(https?:)?\/\//</span>.test(contentBase) || <span class="keyword">typeof</span> contentBase === <span class="string">&#x27;number&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&#x27;Watching remote files is not supported.&#x27;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(contentBase)) &#123;</span><br><span class="line">        contentBase.forEach(<span class="function">(<span class="params">item</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>._watch(item);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>._watch(contentBase);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4-建立-WS，同步编译阶段状态"><a href="#4-建立-WS，同步编译阶段状态" class="headerlink" title="4.建立 WS，同步编译阶段状态"></a>4.建立 WS，同步编译阶段状态</h2><p>这一步都是 Webpack-dev-server 中处理，主要通过 <a target="_blank" rel="noopener" href="https://github.com/sockjs/sockjs-client">sockjs</a>（Webpack-dev-server 的依赖），在 Webpack-dev-server 的浏览器端（Client）和服务器端（Webpack-dev-middleware）之间<strong>建立 WebSocket 长连接</strong>。</p>
<p>然后将 Webpack 编译打包的各个阶段状态信息同步到浏览器端。其中有两个重要步骤：</p>
<ul>
<li>发送状态</li>
</ul>
<p>Webpack-dev-server 通过 Webpack API 监听 compile 的 <code>done</code> 事件，当 compile 完成后，Webpack-dev-server 通过 <code>_sendStats</code> 方法将编译后新模块的 hash 值用 socket 发送给浏览器端。</p>
<ul>
<li>保存状态</li>
</ul>
<p>浏览器端将<code>_sendStats</code> 发送过来的 <code>hash</code> 保存下来，<strong>它将会用到后模块热更新</strong>。<br><img src="http://images.pingan8787.com/Webpack-HMR/Webpack-HMR-WS1.png" alt="image.png"></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack-dev-server\lib\Server.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. 定义 _sendStats 方法 Line 685</span></span><br><span class="line"><span class="comment">// send stats to a socket or multiple sockets</span></span><br><span class="line">Server.prototype._sendStats = <span class="function"><span class="keyword">function</span> (<span class="params">sockets, stats, force</span>) </span>&#123;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  <span class="built_in">this</span>.sockWrite(sockets, <span class="string">&#x27;hash&#x27;</span>, stats.hash);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 监听 done 事件 Line 86</span></span><br><span class="line">compiler.plugin(<span class="string">&#x27;done&#x27;</span>, <span class="function">(<span class="params">stats</span>) =&gt;</span> &#123;</span><br><span class="line">  	<span class="comment">// 将最新打包文件的 hash 值（stats.hash）作为参数传入 _sendStats()</span></span><br><span class="line">    <span class="built_in">this</span>._sendStats(<span class="built_in">this</span>.sockets, stats.toJson(clientStats));</span><br><span class="line">    <span class="built_in">this</span>._stats = stats;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// webpack-dev-server\client\index.js</span></span><br><span class="line"><span class="comment">// 3. 保存 hash 值 Line 74</span></span><br><span class="line"><span class="keyword">var</span> onSocketMsg = &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="attr">hash</span>: <span class="function"><span class="keyword">function</span> <span class="title">hash</span>(<span class="params">_hash</span>) </span>&#123;</span><br><span class="line">    currentHash = _hash;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line">socket(socketUrl, onSocketMsg);</span><br></pre></td></tr></table></figure>
<h2 id="5-浏览器端发布消息"><a href="#5-浏览器端发布消息" class="headerlink" title="5.浏览器端发布消息"></a>5.浏览器端发布消息</h2><p>当 <code>hash</code> 消息发送完成后，socket 还会发送一条 <code>ok</code> 的消息告知 Webpack-dev-server，由于客户端（Client）并不请求热更新代码，也不执行热更新模块操作，因此通过 <code>emit</code> 一个 <code>&quot;webpackHotUpdate&quot;</code> 消息，将工作转交回 Webpack。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack-dev-server\client\index.js</span></span><br><span class="line"><span class="comment">// 1. 处理 ok 消息 Line 135</span></span><br><span class="line"><span class="keyword">var</span> onSocketMsg = &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="attr">ok</span>: <span class="function"><span class="keyword">function</span> <span class="title">ok</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      sendMsg(<span class="string">&#x27;Ok&#x27;</span>);</span><br><span class="line">      <span class="keyword">if</span> (useWarningOverlay || useErrorOverlay) overlay.clear();</span><br><span class="line">      <span class="keyword">if</span> (initial) <span class="keyword">return</span> initial = <span class="literal">false</span>; <span class="comment">// eslint-disable-line no-return-assign</span></span><br><span class="line">      reloadApp();</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 处理刷新 APP Line 218</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reloadApp</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">if</span> (_hot) &#123;</span><br><span class="line">    <span class="comment">// 动态加载 emitter</span></span><br><span class="line">    <span class="keyword">var</span> hotEmitter = <span class="built_in">require</span>(<span class="string">&#x27;webpack/hot/emitter&#x27;</span>);</span><br><span class="line">    hotEmitter.emit(<span class="string">&#x27;webpackHotUpdate&#x27;</span>, currentHash);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> self !== <span class="string">&#x27;undefined&#x27;</span> &amp;&amp; self.window) &#123;</span><br><span class="line">      <span class="comment">// broadcast update to window</span></span><br><span class="line">      self.postMessage(<span class="string">&#x27;webpackHotUpdate&#x27;</span> + currentHash, <span class="string">&#x27;*&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="6-传递-hash-到-HMR"><a href="#6-传递-hash-到-HMR" class="headerlink" title="6.传递 hash 到 HMR"></a>6.传递 hash 到 HMR</h2><p>Webpack/hot/dev-server 监听浏览器端 <code>webpackHotUpdate</code> 消息，将新模块 hash 值传到客户端 HMR 核心中枢的 HotModuleReplacement.runtime ，并调用 <code>check</code> 方法检测更新，<strong>判断是浏览器刷新还是模块热更新</strong>。<br>如果是浏览器刷新的话，则没有后续步骤咯~~</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack\hot\dev-server.js</span></span><br><span class="line"><span class="comment">// 1.监听 webpackHotUpdate Line 42</span></span><br><span class="line"><span class="keyword">var</span> hotEmitter = <span class="built_in">require</span>(<span class="string">&quot;./emitter&quot;</span>);</span><br><span class="line">hotEmitter.on(<span class="string">&quot;webpackHotUpdate&quot;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">currentHash</span>) </span>&#123;</span><br><span class="line">    lastHash = currentHash;</span><br><span class="line">    <span class="keyword">if</span>(!upToDate() &amp;&amp; <span class="built_in">module</span>.hot.status() === <span class="string">&quot;idle&quot;</span>) &#123;</span><br><span class="line">        log(<span class="string">&quot;info&quot;</span>, <span class="string">&quot;[HMR] Checking for updates on the server...&quot;</span>);</span><br><span class="line">        check();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> check = <span class="function"><span class="keyword">function</span> <span class="title">check</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">module</span>.hot.check(<span class="literal">true</span>).then(<span class="function"><span class="keyword">function</span>(<span class="params">updatedModules</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!updatedModules) &#123;</span><br><span class="line">         	  <span class="comment">// ...</span></span><br><span class="line">						<span class="built_in">window</span>.location.reload();<span class="comment">// 浏览器刷新</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(!upToDate()) &#123;</span><br><span class="line">            check();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).catch(<span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123; <span class="comment">/*...*/</span>&#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// webpack\lib\HotModuleReplacement.runtime.js</span></span><br><span class="line"><span class="comment">// 3.调用 HotModuleReplacement.runtime 定义的 check 方法 Line 167</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hotCheck</span>(<span class="params">apply</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(hotStatus !== <span class="string">&quot;idle&quot;</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;check() is only allowed in idle status&quot;</span>);</span><br><span class="line">    hotApplyOnUpdate = apply;</span><br><span class="line">    hotSetStatus(<span class="string">&quot;check&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> hotDownloadManifest(hotRequestTimeout).then(<span class="function"><span class="keyword">function</span>(<span class="params">update</span>) </span>&#123;</span><br><span class="line">				<span class="comment">//...</span></span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="7-检测是否存在更新"><a href="#7-检测是否存在更新" class="headerlink" title="7.检测是否存在更新"></a>7.检测是否存在更新</h2><p>当 HotModuleReplacement.runtime 调用 <code>check</code> 方法时，会调用 JsonpMainTemplate.runtime 中的 <code>hotDownloadUpdateChunk</code> （获取最新模块代码）和 <code>hotDownloadManifest</code> （获取是否有更新文件）两个方法，这两个方法的源码，在下一步展开。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack\lib\HotModuleReplacement.runtime.js</span></span><br><span class="line"><span class="comment">// 1.调用 HotModuleReplacement.runtime 定义 hotDownloadUpdateChunk 方法 Line 171</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hotCheck</span>(<span class="params">apply</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(hotStatus !== <span class="string">&quot;idle&quot;</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;check() is only allowed in idle status&quot;</span>);</span><br><span class="line">    hotApplyOnUpdate = apply;</span><br><span class="line">    hotSetStatus(<span class="string">&quot;check&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> hotDownloadManifest(hotRequestTimeout).then(<span class="function"><span class="keyword">function</span>(<span class="params">update</span>) </span>&#123;</span><br><span class="line">				<span class="comment">//...</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="comment">// hotEnsureUpdateChunk 方法中会调用 hotDownloadUpdateChunk</span></span><br><span class="line">          hotEnsureUpdateChunk(chunkId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中 <code>hotEnsureUpdateChunk</code> 方法中会调用 <code>hotDownloadUpdateChunk</code> ：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack\lib\HotModuleReplacement.runtime.js Line 215</span></span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">hotEnsureUpdateChunk</span>(<span class="params">chunkId</span>) </span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(!hotAvailableFilesMap[chunkId]) &#123;</span><br><span class="line">			hotWaitingFilesMap[chunkId] = <span class="literal">true</span>;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			hotRequestedFilesMap[chunkId] = <span class="literal">true</span>;</span><br><span class="line">			hotWaitingFiles++;</span><br><span class="line">			hotDownloadUpdateChunk(chunkId);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<h2 id="8-请求更新最新文件列表"><a href="#8-请求更新最新文件列表" class="headerlink" title="8.请求更新最新文件列表"></a>8.请求更新最新文件列表</h2><p>在调用 <code>check</code> 方法时，会先调用 JsonpMainTemplate.runtime 中的 <code>hotDownloadManifest</code> 方法， 通过向服务端<strong>发起 AJAX 请求获取是否有更新文件</strong>，如果有的话将 <code>mainfest</code> 返回给浏览器端。<br><img src="http://images.pingan8787.com/Webpack-HMR/Webpack-HMR-WS2.png" alt="image.png"><br>这边涉及一些原生 <code>XMLHttpRequest</code>，就不全部贴出了~</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack\lib\JsonpMainTemplate.runtime.js</span></span><br><span class="line"><span class="comment">// hotDownloadManifest 定义 Line 22</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hotDownloadManifest</span>(<span class="params">requestTimeout</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">var</span> request = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">            <span class="keyword">var</span> requestPath = $require$.p + $hotMainFilename$;</span><br><span class="line">            request.open(<span class="string">&quot;GET&quot;</span>, requestPath, <span class="literal">true</span>);</span><br><span class="line">            request.timeout = requestTimeout;</span><br><span class="line">            request.send(<span class="literal">null</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span>(err) &#123;</span><br><span class="line">            <span class="keyword">return</span> reject(err);</span><br><span class="line">        &#125;</span><br><span class="line">        request.onreadystatechange = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="9-请求更新最新模块代码"><a href="#9-请求更新最新模块代码" class="headerlink" title="9.请求更新最新模块代码"></a>9.请求更新最新模块代码</h2><p>在  <code>hotDownloadManifest</code> 方法中，还会执行  <code>hotDownloadUpdateChunk</code> 方法，<strong>通过 JSONP 请求最新的模块代码</strong>，并将代码返回给 HMR runtime 。<br><strong><img src="http://images.pingan8787.com/Webpack-HMR/Webpack-HMR-WS3.png" alt="image.png"></strong></p>
<p>然后 HMR runtime 会将新代码进一步处理，<strong>判断是浏览器刷新还是模块热更新</strong>。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack\lib\JsonpMainTemplate.runtime.js</span></span><br><span class="line"><span class="comment">// hotDownloadManifest 定义 Line 12</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hotDownloadUpdateChunk</span>(<span class="params">chunkId</span>) </span>&#123;</span><br><span class="line">		<span class="comment">// 创建 script 标签，发起 JSONP 请求</span></span><br><span class="line">    <span class="keyword">var</span> head = <span class="built_in">document</span>.getElementsByTagName(<span class="string">&quot;head&quot;</span>)[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">var</span> script = <span class="built_in">document</span>.createElement(<span class="string">&quot;script&quot;</span>);</span><br><span class="line">    script.type = <span class="string">&quot;text/javascript&quot;</span>;</span><br><span class="line">    script.charset = <span class="string">&quot;utf-8&quot;</span>;</span><br><span class="line">    script.src = $require$.p + $hotChunkFilename$;</span><br><span class="line">    $crossOriginLoading$;</span><br><span class="line">    head.appendChild(script);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="10-更新模块和依赖引用"><a href="#10-更新模块和依赖引用" class="headerlink" title="10.更新模块和依赖引用"></a>10.更新模块和依赖引用</h2><p>这一步是整个模块热更新（HMR）的核心步骤，通过 HMR runtime 的 <code>hotApply</code> 方法，移除过期模块和代码，并添加新的模块和代码实现热更新。</p>
<p>从 <code>hotApply</code> 方法可以看出，模块热替换主要分三个阶段：</p>
<ol>
<li><p>找出过期模块 <code>outdatedModules</code> 和过期依赖 <code>outdatedDependencies</code> ；</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack\lib\HotModuleReplacement.runtime.js</span></span><br><span class="line"><span class="comment">// 找出 outdatedModules 和 outdatedDependencies Line 342</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hotApply</span>(<span class="params"></span>) </span>&#123; </span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">var</span> outdatedDependencies = &#123;&#125;;</span><br><span class="line">  <span class="keyword">var</span> outdatedModules = [];</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">getAffectedStuff</span>(<span class="params">updateModuleId</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> outdatedModules = [updateModuleId];</span><br><span class="line">    <span class="keyword">var</span> outdatedDependencies = &#123;&#125;;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&quot;accepted&quot;</span>,</span><br><span class="line">        <span class="attr">moduleId</span>: updateModuleId,</span><br><span class="line">        <span class="attr">outdatedModules</span>: outdatedModules,</span><br><span class="line">        <span class="attr">outdatedDependencies</span>: outdatedDependencies</span><br><span class="line">    &#125;;</span><br><span class="line">	&#125;;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">addAllToSet</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; b.length; i++) &#123;</span><br><span class="line">          <span class="keyword">var</span> item = b[i];</span><br><span class="line">          <span class="keyword">if</span> (a.indexOf(item) &lt; <span class="number">0</span>)</span><br><span class="line">              a.push(item);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">var</span> id <span class="keyword">in</span> hotUpdate) &#123;</span><br><span class="line">      <span class="keyword">if</span>(<span class="built_in">Object</span>.prototype.hasOwnProperty.call(hotUpdate, id)) &#123;</span><br><span class="line">          <span class="comment">// ... 省略多余代码</span></span><br><span class="line">          <span class="keyword">if</span>(hotUpdate[id]) &#123;</span><br><span class="line">              result = getAffectedStuff(moduleId);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span>(doApply) &#123;</span><br><span class="line">              <span class="keyword">for</span>(moduleId <span class="keyword">in</span> result.outdatedDependencies) &#123;</span><br><span class="line">                 <span class="comment">// 添加到 outdatedDependencies</span></span><br><span class="line">                  addAllToSet(outdatedDependencies[moduleId], result.outdatedDependencies[moduleId]);</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span>(doDispose) &#123;</span><br><span class="line">              <span class="comment">// 添加到 outdatedModules</span></span><br><span class="line">              addAllToSet(outdatedModules, [result.moduleId]);</span><br><span class="line">              appliedUpdate[moduleId] = warnUnexpectedRequire;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>从缓存中删除过期模块、依赖和所有子元素的引用；</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack\lib\HotModuleReplacement.runtime.js</span></span><br><span class="line"><span class="comment">// 从缓存中删除过期模块、依赖和所有子元素的引用 Line 442</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hotApply</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"> 		<span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">var</span> idx;</span><br><span class="line">    <span class="keyword">var</span> queue = outdatedModules.slice();</span><br><span class="line">    <span class="keyword">while</span>(queue.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        moduleId = queue.pop();</span><br><span class="line">        <span class="built_in">module</span> = installedModules[moduleId];</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="comment">// 移除缓存中的模块</span></span><br><span class="line">        <span class="keyword">delete</span> installedModules[moduleId];</span><br><span class="line">        <span class="comment">// 移除过期依赖中不需要使用的处理方法</span></span><br><span class="line">        <span class="keyword">delete</span> outdatedDependencies[moduleId];</span><br><span class="line">        <span class="comment">// 移除所有子元素的引用</span></span><br><span class="line">        <span class="keyword">for</span>(j = <span class="number">0</span>; j &lt; <span class="built_in">module</span>.children.length; j++) &#123;</span><br><span class="line">            <span class="keyword">var</span> child = installedModules[<span class="built_in">module</span>.children[j]];</span><br><span class="line">            <span class="keyword">if</span>(!child) <span class="keyword">continue</span>;</span><br><span class="line">            idx = child.parents.indexOf(moduleId);</span><br><span class="line">            <span class="keyword">if</span>(idx &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                child.parents.splice(idx, <span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; </span><br><span class="line">		<span class="comment">// 从模块子组件中删除过时的依赖项</span></span><br><span class="line">		<span class="keyword">var</span> dependency;</span><br><span class="line">		<span class="keyword">var</span> moduleOutdatedDependencies;</span><br><span class="line">		<span class="keyword">for</span>(moduleId <span class="keyword">in</span> outdatedDependencies) &#123;</span><br><span class="line">			<span class="keyword">if</span>(<span class="built_in">Object</span>.prototype.hasOwnProperty.call(outdatedDependencies, moduleId)) &#123;</span><br><span class="line">				<span class="built_in">module</span> = installedModules[moduleId];</span><br><span class="line">				<span class="keyword">if</span>(<span class="built_in">module</span>) &#123;</span><br><span class="line">					moduleOutdatedDependencies = outdatedDependencies[moduleId];</span><br><span class="line">					<span class="keyword">for</span>(j = <span class="number">0</span>; j &lt; moduleOutdatedDependencies.length; j++) &#123;</span><br><span class="line">						dependency = moduleOutdatedDependencies[j];</span><br><span class="line">						idx = <span class="built_in">module</span>.children.indexOf(dependency);</span><br><span class="line">						<span class="keyword">if</span>(idx &gt;= <span class="number">0</span>) <span class="built_in">module</span>.children.splice(idx, <span class="number">1</span>);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<ol start="3">
<li>将新模块代码添加到 modules 中，当下次调用 <code>__webpack_require__</code>  (webpack 重写的 <code>require</code>  方法)方法的时候，就是获取到了新的模块代码了。<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack\lib\HotModuleReplacement.runtime.js</span></span><br><span class="line"><span class="comment">// 将新模块代码添加到 modules 中 Line 501</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hotApply</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"> 		<span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">for</span>(moduleId <span class="keyword">in</span> appliedUpdate) &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">Object</span>.prototype.hasOwnProperty.call(appliedUpdate, moduleId)) &#123;</span><br><span class="line">            modules[moduleId] = appliedUpdate[moduleId];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<p><code>hotApply</code> 方法执行之后，新代码已经替换旧代码，但是我们业务代码并不知道这些变化，因此需要通过 <code>accept</code>事件通知应用层使用新的模块进行“局部刷新”，我们在业务中是这么使用：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">module</span>.hot) &#123;</span><br><span class="line">  <span class="built_in">module</span>.hot.accept(<span class="string">&#x27;./library.js&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 使用更新过的 library 模块执行某些操作...</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="11-热更新错误处理"><a href="#11-热更新错误处理" class="headerlink" title="11.热更新错误处理"></a>11.热更新错误处理</h2><p>在热更新过程中，<code>hotApply</code> 过程中可能出现 <code>abort</code> 或者 <code>fail</code> 错误，则热更新退回到刷新浏览器（Browser Reload），整个模块热更新完成。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack\hot\dev-server.js Line 13</span></span><br><span class="line"><span class="built_in">module</span>.hot.check(<span class="literal">true</span>).then(<span class="function"><span class="keyword">function</span> (<span class="params">updatedModules</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!updatedModules) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">window</span>.location.reload();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;).catch(<span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> status = <span class="built_in">module</span>.hot.status();</span><br><span class="line">    <span class="keyword">if</span> ([<span class="string">&quot;abort&quot;</span>, <span class="string">&quot;fail&quot;</span>].indexOf(status) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">window</span>.location.reload();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h1 id="五、总结"><a href="#五、总结" class="headerlink" title="五、总结"></a>五、总结</h1><p>本文主要​和大家分享 Webpack 的 HMR 使用和实现原理及源码分析，在源码分析中，通过一张“Webpack HMR 工作原理解析”图让大家对 HMR 整个工作流程有所了解，HMR 本身源码内容较多，许多细节之处本文没有完整写出，需要各位读者自己慢慢阅读和理解源码。</p>
<h1 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h1><p>1.官方文档<a target="_blank" rel="noopener" href="https://webpack.js.org/guides/hot-module-replacement/">《Hot Module Replacement》</a><br />2.<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/30669007">《Webpack HMR 原理解析》</a><br />3.<a href="www.ayqy.net/blog/hot-module-replacement/">《webpack HMR》</a> <br />4.<a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000020293167">《配置 dev-server》</a> </p>
<p><img src="http://images.pingan8787.com/2019_07_12guild_page.png" alt="bg"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/06/17/207-%E3%80%90Webpack%E3%80%91%E4%BA%86%E4%B8%8D%E8%B5%B7%E7%9A%84Webpack-HMR%E5%AD%A6%E4%B9%A0%E6%8C%87%E5%8D%97%EF%BC%88%E5%90%AB%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%89/" data-id="ckts3ejyq00n44d9keybw349e" data-title="207-【Webpack】了不起的 Webpack HMR 学习指南（含源码分析）" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Webpack/" rel="tag">Webpack</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/" rel="tag">前端开发</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%8E%9F%E5%88%9B/" rel="tag">原创</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" rel="tag">读书笔记</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-206-【读书】读《你不知道的WeakMap》总结" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/06/06/206-%E3%80%90%E8%AF%BB%E4%B9%A6%E3%80%91%E8%AF%BB%E3%80%8A%E4%BD%A0%E4%B8%8D%E7%9F%A5%E9%81%93%E7%9A%84WeakMap%E3%80%8B%E6%80%BB%E7%BB%93/" class="article-date">
  <time class="dt-published" datetime="2020-06-06T06:22:18.000Z" itemprop="datePublished">2020-06-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/06/06/206-%E3%80%90%E8%AF%BB%E4%B9%A6%E3%80%91%E8%AF%BB%E3%80%8A%E4%BD%A0%E4%B8%8D%E7%9F%A5%E9%81%93%E7%9A%84WeakMap%E3%80%8B%E6%80%BB%E7%BB%93/">206-【读书】读《你不知道的WeakMap》总结</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>学习时间：2020.05.26<br />学习章节：<a target="_blank" rel="noopener" href="https://juejin.im/post/5ecd1ad3e51d45784c52db73">《你不知道的 WeakMap》</a></p>
<h1 id="一、主要知识点"><a href="#一、主要知识点" class="headerlink" title="一、主要知识点"></a>一、主要知识点</h1><p><br />原文主要复习了“JavaScript垃圾回收机制”，“Map/WeakMap区别”和“WeakMap 属性和方法”。这很好弥补被我忽视的知识点。<br />另外，我们可以通过原文，以相同方式再去学 Set/WeakSet，效果会更好，本文后面也会介绍到。<br /><br><br /><strong>总结开始，先看原文大纲：</strong><br /><br><img src="http://images.pingan8787.com/blog/you-dont-know-WeakMap/xmind.png" alt="image.png"><br /></p>
<p><br />在开始介绍 WeakMap 之前，先复习一遍 JavaScript 中垃圾回收机制，这跟后面的 WeakMap/WeakSet 关系较大。<br /></p>
<h2 id="1-垃圾回收机制"><a href="#1-垃圾回收机制" class="headerlink" title="1. 垃圾回收机制"></a>1. 垃圾回收机制</h2><p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/zh-hans/%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6_(%E8%A8%88%E7%AE%97%E6%A9%9F%E7%A7%91%E5%AD%B8)">垃圾回收（Garbage Collection，缩写为GC）</a>是一种自动的存储器管理机制。当某个程序占用的一部分内存空间不再被这个程序访问时，这个程序会借助垃圾回收算法向操作系统归还这部分内存空间。垃圾回收器可以减轻程序员的负担，也减少程序中的错误。垃圾回收最早起源于LISP语言。<br />目前许多语言如Smalltalk、Java、C#和D语言都支持垃圾回收器，我们熟知的 JavaScript 具有自动垃圾回收机制。<br /><br><br /><strong>在 JavaScript 中，原始类型的数据被分配到栈空间中，引用类型的数据会被分配到堆空间中。</strong><br />**</p>
<h3 id="1-1-栈空间中的垃圾回收"><a href="#1-1-栈空间中的垃圾回收" class="headerlink" title="1.1 栈空间中的垃圾回收"></a>1.1 栈空间中的垃圾回收</h3><p>当函数 <code>showName</code> 调用完成后，通过下移 <a target="_blank" rel="noopener" href="https://baike.baidu.com/item/esp/35173">ESP（Extended Stack Pointer）</a>指针，来销毁 <code>showName</code> 函数，之后调用其他函数时，将覆盖掉旧内存，存放另一个函数的执行上下文，实现垃圾回收。<br /><img src="http://images.pingan8787.com/blog/you-dont-know-WeakMap/ESP.png" alt="image.png"><br />图片来自《浏览器工作原理与实践》<br /></p>
<h3 id="1-2-堆空间中的垃圾回收"><a href="#1-2-堆空间中的垃圾回收" class="headerlink" title="1.2 堆空间中的垃圾回收"></a>1.2 堆空间中的垃圾回收</h3><p>堆中数据垃圾回收策略的基础是：<a target="_blank" rel="noopener" href="https://plumbr.io/handbook/garbage-collection-in-java/generational-hypothesis"><strong>代际假说</strong>（The Generational Hypothesis）</a>。即：</p>
<ol>
<li>大部分对象在内存中存在时间极短，很多对象很快就不可访问。</li>
<li>不死的对象将活得更久。</li>
</ol>
<p><br />这两个特点不仅仅适用于 JavaScript，同样适用于大多数的动态语言，如 Java、Python 等。<br /><br><br />V8 引擎将堆空间分为<strong>新生代</strong>（存放生存<strong>时间短</strong>的对象）和<strong>老生代</strong>（存放生存<strong>时间长</strong>的对象）两个区域，并使用不同的垃圾回收器。<br /><br><br /></p>
<ul>
<li>副垃圾回收器，主要负责新生代的垃圾回收。</li>
<li>主垃圾回收器，主要负责老生代的垃圾回收。</li>
</ul>
<p><br />不管是哪种垃圾回收器，都使用相同垃圾回收流程：<strong>标记活动对象和非活动对象，回收非活动对象的内存，最后内存整理。</strong><br />**</p>
<h4 id="1-2-1-副垃圾回收器"><a href="#1-2-1-副垃圾回收器" class="headerlink" title="1.2.1 副垃圾回收器"></a>1.2.1 副垃圾回收器</h4><p>使用 Scavenge 算法处理，将新生代空间对半分为两个区域，一个对象区域，一个空闲区域。<br /><img src="http://images.pingan8787.com/blog/you-dont-know-WeakMap/Scavenge.png" alt="image.png"><br />图片来自《浏览器工作原理与实践》<br /><br><br />执行流程：</p>
<ul>
<li>新对象存在在<strong>对象区域</strong>，当对象区域将要写满时，执行一次垃圾回收；</li>
<li>垃圾回收过程中，首先对对象区域中的垃圾做标记，然后副垃圾回收器将存活的对象复制并有序排列到空闲区域，相当于完成内存整理。</li>
<li>复制完成后，将对象区域和空闲区域翻转，完成垃圾回收操作，这也让新生代中两块区域无限重复使用。</li>
</ul>
<p><br />当然，这也存在一些问题：若复制操作的数据较大则影响清理效率。<br /><br><br />JavaScript 引擎的解决方式是：将新生代区域设置得比较小，并采用对象晋升策略（经过两次回收仍存活的对象，会被移动到老生区），避免因为新生代区域较小引起存活对象装满整个区域的问题。<br /><br><br /></p>
<h4 id="1-2-2-主垃圾回收器"><a href="#1-2-2-主垃圾回收器" class="headerlink" title="1.2.2 主垃圾回收器"></a>1.2.2 主垃圾回收器</h4><p>分为：<strong>标记 - 清除（Mark-Sweep）算法</strong>，和<strong>标记 - 整理（Mark-Compact）算法</strong>。<br /><br><br /><strong>a)标记 - 清除（Mark-Sweep）算法</strong><br /><strong>过程：</strong></p>
<ul>
<li>标记过程：从一组根元素开始遍历整个元素，能到达的元素为活动对象，反之为垃圾数据；</li>
<li>清除过程：清理被标记的数据，并产生大量碎片内存。（缺点：导致大对象无法分配到足够的连续内存）</li>
</ul>
<p><img src="http://images.pingan8787.com/blog/you-dont-know-WeakMap/Mark-Sweep.png" alt="image.png"><br />图片来自《浏览器工作原理与实践》<br /><br><br /><strong>b)标记 - 整理（Mark-Compact）算法</strong><br /><strong>过程：</strong></p>
<ul>
<li>标记过程：从一组根元素开始遍历整个元素，能到达的元素为活动对象，反之为垃圾数据；</li>
<li>整理过程：将所有存活的对象，向一段移动，然后清除端边界以外的内容。</li>
</ul>
<p><img src="http://images.pingan8787.com/blog/you-dont-know-WeakMap/Mark-Compact.png" alt="image.png"><br />图片来自《浏览器工作原理与实践》</p>
<h3 id="1-3-拓展阅读"><a href="#1-3-拓展阅读" class="headerlink" title="1.3 拓展阅读"></a>1.3 拓展阅读</h3><p>1.<a target="_blank" rel="noopener" href="https://blog.csdn.net/justloveyou_/article/details/71216049">《图解Java 垃圾回收机制》</a><br />2.<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Memory_Management">《MDN 内存管理》</a><br /></p>
<h2 id="2-Map-VS-WeakMap"><a href="#2-Map-VS-WeakMap" class="headerlink" title="2. Map VS WeakMap"></a>2. Map VS WeakMap</h2><h3 id="2-1-Map-和-WeakMap-主要区别"><a href="#2-1-Map-和-WeakMap-主要区别" class="headerlink" title="2.1 Map 和 WeakMap 主要区别"></a>2.1 Map 和 WeakMap 主要区别</h3><p><code>WeakMap</code> 结构与 <code>Map</code> 结构类似，也是用于生成键值对的集合。<br />区别：</p>
<ul>
<li><p><code>Map</code>  对象的键可以是任何类型，但 <code>WeakMap</code>  对象中的键只能是对象引用（ <code>null</code> 除外）；</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> map = <span class="keyword">new</span> <span class="built_in">WeakMap</span>();</span><br><span class="line">map.set(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line"><span class="comment">// TypeError: 1 is not an object!</span></span><br><span class="line">map.set(<span class="built_in">Symbol</span>(), <span class="number">2</span>)</span><br><span class="line"><span class="comment">// TypeError: Invalid value used as weak map key</span></span><br><span class="line">map.set(<span class="literal">null</span>, <span class="number">2</span>)</span><br><span class="line"><span class="comment">// TypeError: Invalid value used as weak map key</span></span><br></pre></td></tr></table></figure></li>
<li><p><code>WeakMap</code>  不能包含无引用的对象，否则会被自动清除出集合（垃圾回收机制）；</p>
</li>
<li><p><code>WeakMap</code>  对象没有 <code>size</code> 属性，是不可枚举的，无法获取集合的大小。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> map = <span class="keyword">new</span> <span class="built_in">WeakMap</span>();</span><br><span class="line"><span class="keyword">const</span> user1 = &#123;<span class="attr">name</span>: <span class="string">&#x27;leo&#x27;</span>&#125;;</span><br><span class="line"><span class="keyword">const</span> user2 = &#123;<span class="attr">name</span>: <span class="string">&#x27;pingan&#x27;</span>&#125;;</span><br><span class="line">map.set(user1, <span class="string">&#x27;good~&#x27;</span>);</span><br><span class="line">map.set(user2, <span class="string">&#x27;hello&#x27;</span>);</span><br><span class="line">map.map(<span class="function"><span class="params">item</span> =&gt;</span> <span class="built_in">console</span>.log(item))</span><br><span class="line"><span class="comment">//Uncaught TypeError: map.map is not a function</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="2-2-Map-缺点和-WeakMap-优点"><a href="#2-2-Map-缺点和-WeakMap-优点" class="headerlink" title="2.2 Map 缺点和 WeakMap 优点"></a>2.2 Map 缺点和 WeakMap 优点</h3><p>1.赋值和搜索操作都是 O(n) 的时间复杂度，因为这两个操作都需要遍历全部整个数组来进行匹配。<br />2.可能会导致内存泄漏，因为数组会一直引用着每个键和值。<br /><br><br />相比之下， <code>WeakMap</code>  持有的是每个键对象的 “弱引用”，这意味着在没有其他引用存在时垃圾回收能正确进行。 原生 <code>WeakMap </code> 的结构是特殊且有效的，其用于映射的 key 只有在其没有被回收时才是有效的。<br /><br><br /></p>
<h3 id="2-3-Map-和-WeakMap-垃圾回收对比"><a href="#2-3-Map-和-WeakMap-垃圾回收对比" class="headerlink" title="2.3 Map 和 WeakMap 垃圾回收对比"></a>2.3 Map 和 WeakMap 垃圾回收对比</h3><p>当数据量越大，则垃圾回收效果越明显。<br />通过命令行执行 <code>node --expose-gc weakmap.js</code> 查看对比效果。<br />其中 <code>--expose-gc</code> 参数表示允许手动执行垃圾回收机制。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// weakmap.js</span></span><br><span class="line"><span class="keyword">const</span> objNum = <span class="number">10</span> * <span class="number">1024</span> * <span class="number">1024</span>;</span><br><span class="line"><span class="keyword">const</span> useType = <span class="number">1</span>; <span class="comment">// 修改 useType 值来测试Map和WeakMap</span></span><br><span class="line"><span class="keyword">const</span> curType = useType == <span class="number">1</span> ?<span class="string">&quot;【Map】&quot;</span> : <span class="string">&quot;【WeakMap】&quot;</span>;</span><br><span class="line"><span class="keyword">let</span> arr = <span class="keyword">new</span> <span class="built_in">Array</span>(objNum);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">usageSize</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> used = process.memoryUsage().heapUsed;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Math</span>.round((used / <span class="number">1024</span> / <span class="number">1024</span>) * <span class="number">100</span>) / <span class="number">100</span> + <span class="string">&quot;M&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (useType == <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="built_in">global</span>.gc();</span><br><span class="line">    <span class="built_in">console</span>.log(objNum + <span class="string">&#x27;个&#x27;</span> + curType + <span class="string">&#x27;占用内存：&#x27;</span> + usageSize());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> map = <span class="keyword">new</span> <span class="built_in">Map</span>();</span><br><span class="line">    map.set(arr, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">global</span>.gc();</span><br><span class="line">    <span class="built_in">console</span>.log(objNum + <span class="string">&#x27;个&#x27;</span> + curType + <span class="string">&#x27;占用内存：&#x27;</span> + usageSize());</span><br><span class="line"></span><br><span class="line">    arr = <span class="literal">null</span>;</span><br><span class="line">    <span class="built_in">global</span>.gc();</span><br><span class="line">    <span class="built_in">console</span>.log(objNum + <span class="string">&#x27;个&#x27;</span> + curType + <span class="string">&#x27;占用内存：&#x27;</span> + usageSize());</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;=====&quot;</span>)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">global</span>.gc();</span><br><span class="line">    <span class="built_in">console</span>.log(objNum + <span class="string">&#x27;个&#x27;</span> + curType + <span class="string">&#x27;占用内存：&#x27;</span> + usageSize());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> map = <span class="keyword">new</span> <span class="built_in">WeakMap</span>();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">global</span>.gc();</span><br><span class="line">    <span class="built_in">console</span>.log(objNum + <span class="string">&#x27;个&#x27;</span> + curType + <span class="string">&#x27;占用内存：&#x27;</span> + usageSize());</span><br><span class="line"></span><br><span class="line">    arr = <span class="literal">null</span>;</span><br><span class="line">    <span class="built_in">global</span>.gc();</span><br><span class="line">    <span class="built_in">console</span>.log(objNum + <span class="string">&#x27;个&#x27;</span> + curType + <span class="string">&#x27;占用内存：&#x27;</span> + usageSize());</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;=====&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="3-WeakMap介绍和应用"><a href="#3-WeakMap介绍和应用" class="headerlink" title="3. WeakMap介绍和应用"></a>3. WeakMap介绍和应用</h2><h3 id="3-1-WeakMap-介绍"><a href="#3-1-WeakMap-介绍" class="headerlink" title="3.1 WeakMap 介绍"></a>3.1 WeakMap 介绍</h3><p><code>WeakMap</code>  对象是一组键/值对的集合，其中的键是 <strong>弱引用</strong> 的。<br /><strong>WeakMap 的 key 只能是 Object 类型。</strong><br />** 原始数据类型是不能作为 key 的（比如 Symbol）。**<br /><code>WeakMap</code>只有四个方法可用：<code>get()</code>、<code>set()</code>、<code>has()</code>、<code>delete()</code>。<br />**<br />具体属性和方法介绍，可查看 《<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/WeakMap">MDN WeakMap</a>》。<br /></p>
<h3 id="3-2-WeakMap-应用"><a href="#3-2-WeakMap-应用" class="headerlink" title="3.2 WeakMap 应用"></a>3.2 WeakMap 应用</h3><p>原文中介绍了“通过 WeakMap 缓存计算结果”和“在 WeakMap 中保留私有数据”两种应用场景。<br />另外还有一种比较常见的场景：<strong>以 DOM节点作为键名的场景</strong>。<br /><br><br /><strong>场景1：当我们想要为DOM添加数据时，可使用 <code>WeakMap</code> 。</strong><br />好处在于，当DOM元素移除时，对应 WeakMap 记录也会自动移除：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;WeakMap&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> wm = <span class="keyword">new</span> <span class="built_in">WeakMap</span>();</span><br><span class="line"><span class="keyword">const</span> weakMap = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;WeakMap&#x27;</span>);</span><br><span class="line">wm.set(weakMap, <span class="string">&#x27;some information&#x27;</span>);</span><br><span class="line">wm.get(weakMap) <span class="comment">//&quot;some information&quot;</span></span><br></pre></td></tr></table></figure>
<p><strong>场景2：当我们想要为DOM元素添加事件监听时，可使用 <code>WeakMap</code> 。</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;button1&quot;</span>&gt;</span>按钮1<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;button2&quot;</span>&gt;</span>按钮2<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> button1 = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;button1&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> button2 = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;button2&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> handler1 = <span class="function">() =&gt;</span> &#123;  <span class="built_in">console</span>.log(<span class="string">&quot;button1 被点击&quot;</span>) &#125;;</span><br><span class="line"><span class="keyword">const</span> handler2 = <span class="function">() =&gt;</span> &#123;  <span class="built_in">console</span>.log(<span class="string">&quot;button2 被点击&quot;</span>) &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 代码1</span></span><br><span class="line">button1.addEventListener(<span class="string">&#x27;click&#x27;</span>, handler1, <span class="literal">false</span>);</span><br><span class="line">button2.addEventListener(<span class="string">&#x27;click&#x27;</span>, handler2, <span class="literal">false</span>);</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 代码2</span></span><br><span class="line"><span class="keyword">const</span> listener = <span class="keyword">new</span> <span class="built_in">WeakMap</span>();</span><br><span class="line"> </span><br><span class="line">listener.set(button1, handler1);</span><br><span class="line">listener.set(button2, handler2);</span><br><span class="line"> </span><br><span class="line">button1.addEventListener(<span class="string">&#x27;click&#x27;</span>, listener.get(button1), <span class="literal">false</span>);</span><br><span class="line">button2.addEventListener(<span class="string">&#x27;click&#x27;</span>, listener.get(button2), <span class="literal">false</span>);</span><br></pre></td></tr></table></figure>
<p>代码2比起代码1的好处是：由于监听函数是放在 WeakMap 里面，<br />则一旦 DOM 对象button1 / button2消失，与它绑定的监听函数handler1和handler2 也会自动消失。<br /></p>
<h1 id="二、拓展知识"><a href="#二、拓展知识" class="headerlink" title="二、拓展知识"></a>二、拓展知识</h1><h2 id="1-拓展-Set-WeakSet"><a href="#1-拓展-Set-WeakSet" class="headerlink" title="1. 拓展 Set/WeakSet"></a>1. 拓展 Set/WeakSet</h2><h3 id="1-1-Set-和-WeakSet-主要区别"><a href="#1-1-Set-和-WeakSet-主要区别" class="headerlink" title="1.1 Set 和 WeakSet 主要区别"></a>1.1 Set 和 WeakSet 主要区别</h3><p><code>WeakSet</code>  结构与 <code>Set</code> 类似，也是不重复的值的集合。<br />区别：</p>
<ul>
<li><p><code>WeakSet</code> 的成员只能是对象，而不能是其他类型的值；</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ws = <span class="keyword">new</span> <span class="built_in">WeakSet</span>();</span><br><span class="line">ws.add(<span class="number">1</span>)</span><br><span class="line"><span class="comment">// TypeError: Invalid value used in weak set</span></span><br><span class="line">ws.add(<span class="built_in">Symbol</span>())</span><br><span class="line"><span class="comment">// TypeError: invalid value used in weak set</span></span><br></pre></td></tr></table></figure></li>
<li><p><code>WeakSet</code>  中的对象都是弱引用，即垃圾回收机制不考虑 <code>WeakSet</code>  对该对象的引用;</p>
</li>
<li><p><code>WeakSet</code>  对象没有 <code>size</code> 属性，是不可枚举的，无法获取集合的大小。</p>
</li>
</ul>
<h3 id="1-2-Set-WeakSet-垃圾回收对比"><a href="#1-2-Set-WeakSet-垃圾回收对比" class="headerlink" title="1.2 Set/WeakSet 垃圾回收对比"></a>1.2 Set/WeakSet 垃圾回收对比</h3><p>通过命令行执行 <code>node --expose-gc weakset.js</code> 查看对比效果。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// weakset.js</span></span><br><span class="line"><span class="keyword">const</span> objNum = <span class="number">5000</span> * <span class="number">1024</span>;</span><br><span class="line"><span class="keyword">const</span> useType = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">const</span> curType = useType == <span class="number">1</span> ?<span class="string">&quot;【Set】&quot;</span> : <span class="string">&quot;【WeakSet】&quot;</span>;</span><br><span class="line"><span class="keyword">let</span> obj = [];</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> k = <span class="number">0</span>; k &lt; objNum; k++) &#123;</span><br><span class="line">    obj[k] = &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">usageSize</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> used = process.memoryUsage().heapUsed;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Math</span>.round((used / <span class="number">1024</span> / <span class="number">1024</span>) * <span class="number">100</span>) / <span class="number">100</span> + <span class="string">&quot;M&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (useType == <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="built_in">global</span>.gc();</span><br><span class="line">    <span class="built_in">console</span>.log(objNum + <span class="string">&#x27;个&#x27;</span> + curType + <span class="string">&#x27;占用内存：&#x27;</span> + usageSize());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> sets = <span class="keyword">new</span> <span class="built_in">Set</span>([...obj]);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">global</span>.gc();</span><br><span class="line">    <span class="built_in">console</span>.log(objNum + <span class="string">&#x27;个&#x27;</span> + curType + <span class="string">&#x27;占用内存：&#x27;</span> + usageSize());</span><br><span class="line"></span><br><span class="line">    obj = <span class="literal">null</span>;</span><br><span class="line">    <span class="built_in">global</span>.gc();</span><br><span class="line">    <span class="built_in">console</span>.log(objNum + <span class="string">&#x27;个&#x27;</span> + curType + <span class="string">&#x27;占用内存：&#x27;</span> + usageSize());</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;=====&quot;</span>)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">global</span>.gc();</span><br><span class="line">    <span class="built_in">console</span>.log(objNum + <span class="string">&#x27;个&#x27;</span> + curType + <span class="string">&#x27;占用内存：&#x27;</span> + usageSize());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> sets = <span class="keyword">new</span> <span class="built_in">WeakSet</span>(obj);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">global</span>.gc();</span><br><span class="line">    <span class="built_in">console</span>.log(objNum + <span class="string">&#x27;个&#x27;</span> + curType + <span class="string">&#x27;占用内存：&#x27;</span> + usageSize());</span><br><span class="line"></span><br><span class="line">    obj = <span class="literal">null</span>;</span><br><span class="line">    <span class="built_in">global</span>.gc();</span><br><span class="line">    <span class="built_in">console</span>.log(objNum + <span class="string">&#x27;个&#x27;</span> + curType + <span class="string">&#x27;占用内存：&#x27;</span> + usageSize());</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;=====&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h1 id="三、总结"><a href="#三、总结" class="headerlink" title="三、总结"></a>三、总结</h1><p>本文首先复习了《你不知道的 WeakMap》中核心知识点，重新回顾了“垃圾回收机制”，“Map VS WeakMap”和“WeakMap 介绍和应用”，最后延伸复习了“Set/WeakSet”相关知识点。<br />在实际业务开发中，最好也能考虑垃圾回收机制的合理使用，这也是提升产品性能的一个非常常用的方式。</p>
<table>
<thead>
<tr>
<th>Author</th>
<th>王平安</th>
</tr>
</thead>
<tbody><tr>
<td>E-mail</td>
<td><a href="mailto:&#x70;&#x69;&#110;&#x67;&#97;&#x6e;&#x38;&#55;&#x38;&#x37;&#x40;&#x71;&#x71;&#x2e;&#99;&#x6f;&#x6d;">&#x70;&#x69;&#110;&#x67;&#97;&#x6e;&#x38;&#55;&#x38;&#x37;&#x40;&#x71;&#x71;&#x2e;&#99;&#x6f;&#x6d;</a></td>
</tr>
<tr>
<td>博  客</td>
<td><a target="_blank" rel="noopener" href="http://www.pingan8787.com/">www.pingan8787.com</a></td>
</tr>
<tr>
<td>微  信</td>
<td>pingan8787</td>
</tr>
<tr>
<td>每日文章推荐</td>
<td><a target="_blank" rel="noopener" href="https://github.com/pingan8787/Leo_Reading/issues">https://github.com/pingan8787/Leo_Reading/issues</a></td>
</tr>
<tr>
<td>ES小册</td>
<td>js.pingan8787.com</td>
</tr>
<tr>
<td>语雀知识库</td>
<td><a target="_blank" rel="noopener" href="https://www.yuque.com/wangpingan/cute-frontend">Cute-FrontEnd</a></td>
</tr>
</tbody></table>
<p><img src="http://images.pingan8787.com/2019_07_12guild_page.png" alt="bg"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/06/06/206-%E3%80%90%E8%AF%BB%E4%B9%A6%E3%80%91%E8%AF%BB%E3%80%8A%E4%BD%A0%E4%B8%8D%E7%9F%A5%E9%81%93%E7%9A%84WeakMap%E3%80%8B%E6%80%BB%E7%BB%93/" data-id="ckts3eju6005t4d9k64fsemef" data-title="206-【读书】读《你不知道的WeakMap》总结" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/" rel="tag">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/" rel="tag">前端开发</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%8E%9F%E5%88%9B/" rel="tag">原创</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" rel="tag">读书笔记</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-205-【读书】读《你不知道的Blob》总结" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/06/06/205-%E3%80%90%E8%AF%BB%E4%B9%A6%E3%80%91%E8%AF%BB%E3%80%8A%E4%BD%A0%E4%B8%8D%E7%9F%A5%E9%81%93%E7%9A%84Blob%E3%80%8B%E6%80%BB%E7%BB%93/" class="article-date">
  <time class="dt-published" datetime="2020-06-06T05:53:10.000Z" itemprop="datePublished">2020-06-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/06/06/205-%E3%80%90%E8%AF%BB%E4%B9%A6%E3%80%91%E8%AF%BB%E3%80%8A%E4%BD%A0%E4%B8%8D%E7%9F%A5%E9%81%93%E7%9A%84Blob%E3%80%8B%E6%80%BB%E7%BB%93/">205-【读书】读《你不知道的Blob》总结</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>学习时间：2020.06.06<br />学习章节：<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/lQKTCS_QB0E62SK9oXD4LA">《你不知道的 Blob》</a><br /><br><br />原文对 Blob 的知识点介绍得非常完整清晰，本文通过四个问题来总结本文核心知识：</p>
<ol>
<li>Blob 是什么？</li>
<li>Blob 怎么用？</li>
<li>Blob 有哪些使用场景？</li>
<li>Blob 与 ArrayBuffer 有何区别？</li>
</ol>
<p><img src="http://images.pingan8787.com/blog/you-dont-know-blob/xmind.png" alt="读《你不知道的 Blob》总结.png"><br /></p>
<h1 id="一、Blob-是什么？"><a href="#一、Blob-是什么？" class="headerlink" title="一、Blob 是什么？"></a>一、Blob 是什么？</h1><p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Blob">Blob（Binary Large Object）</a>表示二进制类型的大对象，通常是影像、声音或多媒体文件。MySql/Oracle数据库中，就有一种Blob类型，专门存放二进制数据。在 JavaScript 中 Blob 对象表示一个不可变、原始数据的类文件对象，它不一定非得是大量数据，也可以表示一个小型文件的内容。<br />另外，JavaScript 中的 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/File">File</a> 接口是基于 Blob，继承 Blob 的功能并将其扩展使其支持用户系统上的文件。<br /></p>
<h1 id="二、Blob-怎么用？"><a href="#二、Blob-怎么用？" class="headerlink" title="二、Blob 怎么用？"></a>二、Blob 怎么用？</h1><p><code>Blob</code> 由一个可选字符串 <code>type</code> 和 <code>blobParts</code> 组成，其中， <code>type</code> 通常为 MIME 类型。</p>
<blockquote>
<p>MIME（Multipurpose Internet Mail Extensions）多用途互联网邮件扩展类型，常见有：超文本标记语言文本 .html <code>text/html</code> 、PNG图像 .png <code>image/png</code> 、普通文本 .txt <code>text/plain</code>  等。</p>
</blockquote>
<h2 id="1-构造函数"><a href="#1-构造函数" class="headerlink" title="1. 构造函数"></a>1. 构造函数</h2><p>Blob 构造函数语法为：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> myBlob = <span class="keyword">new</span> Blob(blobParts[, options])</span><br></pre></td></tr></table></figure>
<p><strong>入参：</strong></p>
<ul>
<li><code>blobParts</code>：它是一个由 ArrayBuffer，ArrayBufferView，Blob，DOMString 等对象构成的数组。DOMStrings 会被编码为 UTF-8。</li>
<li><code>options</code> ：一个可选的对象，包含以下两个属性：<ul>
<li><code>type</code> ：默认值为 <code>&quot;&quot;</code> ，表示将会被放入到 blob 中的数组内容的 MIME 类型。</li>
<li><code>endings</code> ：默认值为 <code>&quot;transparent&quot;</code>，用于指定包含行结束符 <code>\n</code> 的字符串如何被写入。它是以下两个值中的一个：<code>&quot;native&quot;</code>，代表行结束符会被更改为适合宿主操作系统文件系统的换行符，或者 <code>&quot;transparent&quot;</code>，代表会保持 blob 中保存的结束符不变。</li>
</ul>
</li>
</ul>
<p><strong>出参：</strong><br />返回一个新创建的 Blob 对象，其内容由参数中给定的数组串联组成。<br /></p>
<h2 id="2-属性和方法"><a href="#2-属性和方法" class="headerlink" title="2. 属性和方法"></a>2. 属性和方法</h2><h3 id="2-1-属性介绍"><a href="#2-1-属性介绍" class="headerlink" title="2.1 属性介绍"></a>2.1 属性介绍</h3><p><code>Blob</code> 对象拥有 2 个属性：</p>
<ul>
<li><code>size</code> ：只读，表示 <code>Blob</code> 对象中所包含的数据大小（以字节为单位）；</li>
<li><code>type</code> ：只读，值为字符串，表示该 <code>Blob</code> 对象所包含数据的 MIME 类型。若类型未知，则该属性值为空字符串。</li>
</ul>
<h3 id="2-2-方法介绍"><a href="#2-2-方法介绍" class="headerlink" title="2.2 方法介绍"></a>2.2 方法介绍</h3><ul>
<li><code>slice([start[, end[, contentType]]])</code> ：返回一个新的 Blob 对象，包含了源 Blob 对象中指定范围内的数据。</li>
<li><code>stream()</code>：返回一个能读取 Blob 内容的 <code>ReadableStream</code> 。</li>
<li><code>text()</code>：返回一个 Promise 对象且包含 Blob 所有内容的 UTF-8 格式的 <code>USVString</code> 。</li>
<li><code>arrayBuffer()</code>：返回一个 Promise 对象且包含 Blob 所有内容的二进制格式的 <code>ArrayBuffer</code> 。</li>
</ul>
<p><br />注意：** <code>Blob</code> 对象是不可改变的**，但是可以进行分割，并创建出新的 <code>Blob</code> 对象，将它们混合到一个新的 <code>Blob</code>  中。类似于 JavaScript 字符串：我们无法更改字符串中的字符，但可以创建新的更正后的字符串。<br /></p>
<h2 id="3-简单上手"><a href="#3-简单上手" class="headerlink" title="3. 简单上手"></a>3. 简单上手</h2><h3 id="3-1-示例1：从字符串创建-Blob"><a href="#3-1-示例1：从字符串创建-Blob" class="headerlink" title="3.1 示例1：从字符串创建 Blob"></a>3.1 示例1：从字符串创建 Blob</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> myBlobParts = [<span class="string">&#x27;&lt;html&gt;&lt;h2&gt;Hello Leo&lt;/h2&gt;&lt;/html&gt;&#x27;</span>]; <span class="comment">// 一个包含DOMString的数组</span></span><br><span class="line"><span class="keyword">let</span> myBlob = <span class="keyword">new</span> Blob(myBlobParts, &#123;<span class="attr">type</span> : <span class="string">&#x27;text/html&#x27;</span>, <span class="attr">endings</span>: <span class="string">&quot;transparent&quot;</span>&#125;); <span class="comment">// 得到 blob</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(myBlob.size + <span class="string">&quot; bytes size&quot;</span>);</span><br><span class="line"><span class="comment">// Output: 31 bytes size</span></span><br><span class="line"><span class="built_in">console</span>.log(myBlob.type + <span class="string">&quot; is the type&quot;</span>);</span><br><span class="line"><span class="comment">// Output: text/html is the type</span></span><br></pre></td></tr></table></figure>


<p><a name="uO7tW"></a></p>
<h3 id="3-2-示例2：从类型化数组和字符串创建-Blob"><a href="#3-2-示例2：从类型化数组和字符串创建-Blob" class="headerlink" title="3.2 示例2：从类型化数组和字符串创建 Blob"></a>3.2 示例2：从类型化数组和字符串创建 Blob</h3><p>JavaScript类型化数组是一种类似数组的对象，并提供了一种用于 <strong>访问原始二进制数据的机制</strong> 。并且在类型数组上调用 <code>Array.isArray()</code> 会返回 <code>false</code> 。<br />详细可参考MDN《<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Typed_arrays">JavaScript 类型化数组</a>》章节。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> hello = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>([<span class="number">72</span>, <span class="number">101</span>, <span class="number">108</span>, <span class="number">108</span>, <span class="number">111</span>]); <span class="comment">// 二进制格式的 &quot;hello&quot;</span></span><br><span class="line"><span class="keyword">let</span> blob = <span class="keyword">new</span> Blob([hello, <span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;leo&#x27;</span>], &#123;<span class="attr">type</span>: <span class="string">&#x27;text/plain&#x27;</span>&#125;);</span><br><span class="line"><span class="comment">// Output: &quot;Hello leo&quot;</span></span><br></pre></td></tr></table></figure>


<h3 id="3-3-示例3：组装新的-Blob"><a href="#3-3-示例3：组装新的-Blob" class="headerlink" title="3.3 示例3：组装新的 Blob"></a>3.3 示例3：组装新的 Blob</h3><p>由于 <code>Blob</code> 对象是不可改变的，但我们可以进行分割，并组装成一个新的 <code>Blob</code> 对象：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> blob1 = <span class="keyword">new</span> Blob([<span class="string">&#x27;&lt;html&gt;&lt;h2&gt;Hello Leo&lt;/h2&gt;&lt;/html&gt;&#x27;</span>], </span><br><span class="line">   &#123;<span class="attr">type</span> : <span class="string">&#x27;text/html&#x27;</span>, <span class="attr">endings</span>: <span class="string">&quot;transparent&quot;</span>&#125;);</span><br><span class="line"><span class="keyword">let</span> blob2 = <span class="keyword">new</span> Blob([<span class="string">&#x27;&lt;html&gt;&lt;h2&gt;Happy Boy!&lt;/h2&gt;&lt;/html&gt;&#x27;</span>], </span><br><span class="line">   &#123;<span class="attr">type</span> : <span class="string">&#x27;text/html&#x27;</span>, <span class="attr">endings</span>: <span class="string">&quot;transparent&quot;</span>&#125;);</span><br><span class="line"><span class="keyword">let</span> slice1 = blob1.slice(<span class="number">16</span>);</span><br><span class="line"><span class="keyword">let</span> slice2 = blob2.slice(<span class="number">0</span>, <span class="number">16</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">await</span> slice1.text();</span><br><span class="line"><span class="comment">// currtent slice1 value: &quot;Leo&lt;/h2&gt;&lt;/html&gt;&quot;</span></span><br><span class="line"><span class="keyword">await</span> slice2.text();</span><br><span class="line"><span class="comment">// currtent slice2 value: &quot;&lt;html&gt;&lt;h2&gt;Happy &quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> newBlob = <span class="keyword">new</span> Blob([slice2, slice1], </span><br><span class="line">   &#123;<span class="attr">type</span> : <span class="string">&#x27;text/html&#x27;</span>, <span class="attr">endings</span>: <span class="string">&quot;transparent&quot;</span>&#125;);</span><br><span class="line"><span class="keyword">await</span> newBlob.text();</span><br><span class="line"><span class="comment">// currtent newBlob value: &quot;&lt;html&gt;&lt;h2&gt;Happy Leo&lt;/h2&gt;&lt;/html&gt;&quot;</span></span><br></pre></td></tr></table></figure>

<h1 id="三、Blob-有哪些使用场景？"><a href="#三、Blob-有哪些使用场景？" class="headerlink" title="三、Blob 有哪些使用场景？"></a>三、Blob 有哪些使用场景？</h1><h2 id="1-图片本地预览"><a href="#1-图片本地预览" class="headerlink" title="1. 图片本地预览"></a>1. 图片本地预览</h2><p>这里整理 2 种图片本地预览的方式：</p>
<ol>
<li>使用 DataURL 方式；</li>
<li>使用 Blob URL/Object URL 方式；<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>1.DataURL方式：<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">accept</span>=<span class="string">&quot;image/*&quot;</span> <span class="attr">onchange</span>=<span class="string">&quot;selectFileForDataURL(event)&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">id</span>=<span class="string">&quot;output1&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>2.Blob方式：<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">accept</span>=<span class="string">&quot;image/*&quot;</span> <span class="attr">onchange</span>=<span class="string">&quot;selectFileForBlob(event)&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">id</span>=<span class="string">&quot;output2&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></span></span><br><span class="line"><span class="javascript">        <span class="comment">// 1.DataURL方式：</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">selectFileForDataURL</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">const</span> reader = <span class="keyword">new</span> FileReader();</span></span><br><span class="line"><span class="javascript">            reader.onload = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                <span class="keyword">const</span> output = <span class="built_in">document</span>.querySelector(<span class="string">&quot;#output1&quot;</span>)</span></span><br><span class="line"><span class="javascript">                output.src = reader.result;</span></span><br><span class="line"><span class="javascript">            &#125;</span></span><br><span class="line"><span class="javascript">            reader.readAsDataURL(event.target.files[<span class="number">0</span>]);</span></span><br><span class="line"><span class="javascript">        &#125;</span></span><br><span class="line"><span class="javascript"></span></span><br><span class="line"><span class="javascript">        <span class="comment">//2.Blob方式：</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">selectFileForBlob</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">const</span> reader = <span class="keyword">new</span> FileReader();</span></span><br><span class="line"><span class="javascript">            <span class="keyword">const</span> output = <span class="built_in">document</span>.querySelector(<span class="string">&quot;#output2&quot;</span>);</span></span><br><span class="line"><span class="javascript">            <span class="keyword">const</span> imgUrl = <span class="built_in">window</span>.URL.createObjectURL(event.target.files[<span class="number">0</span>]);</span></span><br><span class="line"><span class="javascript">            output.src = imgUrl;</span></span><br><span class="line"><span class="javascript">            reader.onload = <span class="function"><span class="keyword">function</span>(<span class="params">event</span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">                <span class="built_in">window</span>.URL.revokeObjectURL(imgUrl);</span></span><br><span class="line"><span class="javascript">            &#125;</span></span><br><span class="line"><span class="javascript">        &#125;</span></span><br><span class="line"><span class="javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<p><br />上面主要介绍 <code>Blob URL</code> 和 <code>Data URL</code> 两种方式实现图片本地预览，这两个类型的区别在<strong>《五、拓展》</strong>中介绍。<br /></p>
<h2 id="2-图片本地预览-分片上传"><a href="#2-图片本地预览-分片上传" class="headerlink" title="2. 图片本地预览 + 分片上传"></a>2. 图片本地预览 + 分片上传</h2><p><strong>实现本地预览：</strong><br />将 <code>input</code> 获取到的 <code>file</code> 对象，通过实例化 <code>FileReader</code> ，赋值给变量 <code>reader</code> ，调用<code>reader</code> 的 <code>readAsDataURL</code> 方法，将 <code>file</code> 对象转换为  <code>dataURL</code> ，然后监听 <code>reader</code> 的 <code>onload</code> 属性，获取到读取结果 <code>result</code> ，然后设置为图片的 <code>src</code> 值。<br /><br><br /><strong>实现分片上传：</strong><br />由于 File 是特殊类型的 Blob，可用于任意 Blob 类型的上下文，所以针对大文件传输，我们可以使用 <code>slice</code> 方法进行文件切割，分片上传。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">accept</span>=<span class="string">&quot;image/*&quot;</span> <span class="attr">onchange</span>=<span class="string">&quot;selectFile(event)&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">&quot;upload()&quot;</span>&gt;</span>上传<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">id</span>=<span class="string">&quot;output&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></span></span><br><span class="line"><span class="javascript">        <span class="keyword">const</span> chunkSize = <span class="number">10000</span>;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">const</span> url = <span class="string">&quot;https://httpbin.org/post&quot;</span>;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">selectFile</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">          	<span class="comment">// 本地预览</span></span></span><br><span class="line"><span class="javascript">            <span class="keyword">const</span> reader = <span class="keyword">new</span> FileReader();</span></span><br><span class="line"><span class="javascript">            reader.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">                <span class="keyword">const</span> output = <span class="built_in">document</span>.querySelector(<span class="string">&quot;#output&quot;</span>)</span></span><br><span class="line"><span class="javascript">                output.src = reader.result;</span></span><br><span class="line"><span class="javascript">            &#125;</span></span><br><span class="line"><span class="javascript">            reader.readAsDataURL(event.target.files[<span class="number">0</span>]);</span></span><br><span class="line"><span class="javascript"></span></span><br><span class="line"><span class="javascript">          	<span class="comment">// 分片上传</span></span></span><br><span class="line"><span class="javascript">            <span class="keyword">await</span> upload(event.target.files[<span class="number">0</span>]);</span></span><br><span class="line"><span class="javascript">        &#125;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">upload</span>(<span class="params">files</span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">const</span> file = files;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">for</span>(<span class="keyword">let</span> start = <span class="number">0</span>; start &lt; file.size; start += chunkSize)&#123;</span></span><br><span class="line"><span class="javascript">                <span class="keyword">const</span> chunk = file.slice(start, start + chunkSize + <span class="number">1</span>);</span></span><br><span class="line"><span class="javascript">                <span class="keyword">const</span> fd = <span class="keyword">new</span> FormData();</span></span><br><span class="line"><span class="javascript">                fd.append(<span class="string">&quot;data&quot;</span>, chunk);</span></span><br><span class="line"><span class="javascript">                <span class="keyword">await</span> fetch(url, &#123; <span class="attr">method</span>: <span class="string">&quot;post&quot;</span>, <span class="attr">body</span>: fd &#125;).then(<span class="function">(<span class="params">res</span>) =&gt;</span>&#123;</span></span><br><span class="line"><span class="javascript">                    <span class="built_in">console</span>.log(res)</span></span><br><span class="line"><span class="javascript">                    res.text();</span></span><br><span class="line"><span class="javascript">                &#125;);</span></span><br><span class="line"><span class="javascript">            &#125;</span></span><br><span class="line"><span class="javascript">        &#125;</span></span><br><span class="line"><span class="javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure>


<h2 id="3-图片本地预览-分片上传-暂停-续传"><a href="#3-图片本地预览-分片上传-暂停-续传" class="headerlink" title="3. 图片本地预览 + 分片上传 + 暂停 + 续传"></a>3. 图片本地预览 + 分片上传 + 暂停 + 续传</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">accept</span>=<span class="string">&quot;image/*&quot;</span> <span class="attr">onchange</span>=<span class="string">&quot;selectFile(event)&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">&quot;upload()&quot;</span>&gt;</span>上传<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">&quot;pause()&quot;</span>&gt;</span>暂停<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">&quot;continues()&quot;</span>&gt;</span>继续<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">id</span>=<span class="string">&quot;output&quot;</span> <span class="attr">src</span>=<span class="string">&quot;&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></span></span><br><span class="line"><span class="javascript">        <span class="keyword">const</span> chunkSize = <span class="number">30000</span>;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> start = <span class="number">0</span>, curFile, isPause = <span class="literal">false</span>;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">const</span> url = <span class="string">&quot;https://httpbin.org/post&quot;</span>;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">selectFile</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">const</span> reader = <span class="keyword">new</span> FileReader();</span></span><br><span class="line"><span class="javascript">            reader.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">                <span class="keyword">const</span> output = <span class="built_in">document</span>.querySelector(<span class="string">&quot;#output&quot;</span>)</span></span><br><span class="line"><span class="javascript">                output.src = reader.result;</span></span><br><span class="line"><span class="javascript">            &#125;</span></span><br><span class="line"><span class="javascript">            reader.readAsDataURL(event.target.files[<span class="number">0</span>]);</span></span><br><span class="line"><span class="javascript">            curFile = event.target.files[<span class="number">0</span>];</span></span><br><span class="line"><span class="javascript">        &#125;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">upload</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">const</span> file = curFile;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">for</span>(start; start &lt; file.size; start += chunkSize)&#123;</span></span><br><span class="line"><span class="javascript">                <span class="keyword">if</span>(isPause) <span class="keyword">return</span>;</span></span><br><span class="line"><span class="javascript">                <span class="keyword">const</span> chunk = file.slice(start, start + chunkSize + <span class="number">1</span>);</span></span><br><span class="line"><span class="javascript">                <span class="keyword">const</span> fd = <span class="keyword">new</span> FormData();</span></span><br><span class="line"><span class="javascript">                fd.append(<span class="string">&quot;data&quot;</span>, chunk);</span></span><br><span class="line"><span class="javascript">                <span class="keyword">await</span> fetch(url, &#123; <span class="attr">method</span>: <span class="string">&quot;post&quot;</span>, <span class="attr">body</span>: fd &#125;).then(<span class="function">(<span class="params">res</span>) =&gt;</span>&#123;</span></span><br><span class="line"><span class="javascript">                        res.text()</span></span><br><span class="line"><span class="javascript">                    &#125;</span></span><br><span class="line"><span class="javascript">                );</span></span><br><span class="line"><span class="javascript">                <span class="keyword">if</span>(chunk.size &lt; chunkSize)&#123;</span></span><br><span class="line"><span class="javascript">                    uploadSuccess();</span></span><br><span class="line"><span class="javascript">                    <span class="keyword">return</span>;</span></span><br><span class="line"><span class="javascript">                &#125;</span></span><br><span class="line"><span class="javascript">            &#125;</span></span><br><span class="line"><span class="javascript">        &#125;</span></span><br><span class="line"><span class="javascript">        <span class="function"><span class="keyword">function</span> <span class="title">pause</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">            isPause = <span class="literal">true</span>;</span></span><br><span class="line"><span class="javascript">        &#125;</span></span><br><span class="line"><span class="javascript">        <span class="function"><span class="keyword">function</span> <span class="title">continues</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">            isPause = <span class="literal">false</span>;</span></span><br><span class="line"><span class="javascript">            upload();</span></span><br><span class="line"><span class="javascript">        &#125;</span></span><br><span class="line"><span class="javascript">        <span class="function"><span class="keyword">function</span> <span class="title">uploadSuccess</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">            isPause = <span class="literal">false</span>;</span></span><br><span class="line"><span class="javascript">            start = <span class="number">0</span>;</span></span><br><span class="line"><span class="javascript">        &#125;</span></span><br><span class="line"><span class="javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure>


<h2 id="4-从互联网下载数据"><a href="#4-从互联网下载数据" class="headerlink" title="4. 从互联网下载数据"></a>4. 从互联网下载数据</h2><p>在实现“从互联网下载数据”方法时，我们使用 <code>createObjectURL</code> 显示图片，在请求互联网图片时，我们有两种方式：</p>
<ul>
<li>使用 <code>XMLHttpRequest</code> ；</li>
<li>使用 <code>fetch</code> ；<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">&quot;download1()&quot;</span>&gt;</span>使用 XMLHttpRequest 下载<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">&quot;download2()&quot;</span>&gt;</span>使用 fetch 下载<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">id</span>=<span class="string">&quot;pingan&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></span></span><br><span class="line"><span class="javascript">        <span class="keyword">const</span> url = <span class="string">&quot;http://images.pingan8787.com/TinyCompiler/111.png&quot;</span>;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">const</span> pingan = <span class="built_in">document</span>.querySelector(<span class="string">&#x27;#pingan&#x27;</span>);</span></span><br><span class="line"><span class="javascript">        <span class="function"><span class="keyword">function</span> <span class="title">download1</span> (<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">const</span> xhr = <span class="keyword">new</span> XMLHttpRequest();</span></span><br><span class="line"><span class="javascript">            xhr.open(<span class="string">&#x27;GET&#x27;</span>, url);</span></span><br><span class="line"><span class="javascript">            xhr.responseType = <span class="string">&#x27;blob&#x27;</span>;</span></span><br><span class="line"><span class="javascript">            xhr.onload = <span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">                renderImage(xhr.response);</span></span><br><span class="line"><span class="javascript">            &#125;</span></span><br><span class="line"><span class="javascript">            xhr.send(<span class="literal">null</span>);</span></span><br><span class="line"><span class="javascript">        &#125;</span></span><br><span class="line"><span class="javascript">        <span class="function"><span class="keyword">function</span> <span class="title">download2</span> (<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">            fetch(url).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">                <span class="keyword">return</span> res.blob();</span></span><br><span class="line"><span class="javascript">            &#125;).then(<span class="function"><span class="params">myBlob</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">                renderImage(myBlob);</span></span><br><span class="line"><span class="javascript">            &#125;)</span></span><br><span class="line"><span class="javascript">        &#125;</span></span><br><span class="line"><span class="javascript"></span></span><br><span class="line"><span class="javascript">        <span class="function"><span class="keyword">function</span> <span class="title">renderImage</span> (<span class="params">data</span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">let</span> objectURL = URL.createObjectURL(data);</span></span><br><span class="line"><span class="javascript">            pingan.src = objectURL;</span></span><br><span class="line"><span class="javascript">          	<span class="comment">// 根据业务需要手动调用 URL.revokeObjectURL(imgUrl)</span></span></span><br><span class="line"><span class="javascript">        &#125;</span></span><br><span class="line"><span class="javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="5-下载文件"><a href="#5-下载文件" class="headerlink" title="5. 下载文件"></a>5. 下载文件</h2><p>通过调用 Blob 的构造函数来创建类型为 <code>&quot;text/plain&quot;</code> 的 Blob 对象，然后通过动态创建 <code>a</code> 标签来实现文件的下载。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">&quot;download()&quot;</span>&gt;</span>Blob 文件下载<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></span></span><br><span class="line"><span class="javascript">        <span class="function"><span class="keyword">function</span> <span class="title">download</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">const</span> fileName= <span class="string">&quot;Blob文件.txt&quot;</span>;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">const</span> myBlob = <span class="keyword">new</span> Blob([<span class="string">&quot;一文彻底掌握 Blob Web API&quot;</span>], &#123; <span class="attr">type</span>: <span class="string">&quot;text/plain&quot;</span> &#125;);</span></span><br><span class="line"><span class="javascript">            downloadFun(fileName, myBlob);</span></span><br><span class="line"><span class="javascript">        &#125;</span></span><br><span class="line"><span class="javascript">        <span class="function"><span class="keyword">function</span> <span class="title">downloadFun</span>(<span class="params">fileName, blob</span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">const</span> link = <span class="built_in">document</span>.createElement(<span class="string">&quot;a&quot;</span>);</span></span><br><span class="line"><span class="javascript">            link.href = URL.createObjectURL(blob);</span></span><br><span class="line"><span class="javascript">            link.download = fileName;</span></span><br><span class="line"><span class="javascript">            link.click();</span></span><br><span class="line"><span class="javascript">            link.remove();</span></span><br><span class="line"><span class="javascript">            URL.revokeObjectURL(link.href);</span></span><br><span class="line"><span class="javascript">        &#125;</span></span><br><span class="line"><span class="javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="6-图片压缩"><a href="#6-图片压缩" class="headerlink" title="6. 图片压缩"></a>6. 图片压缩</h2><p>当我们希望本地图片在上传之前，先进行一定压缩，再提交，从而减少传输的数据量。<br />在前端我们可以使用 Canvas 提供的 <code>toDataURL()</code> 方法来实现，该方法接收 <code>type</code> 和 <code>encoderOptions</code> 两个可选参数：</p>
<ul>
<li><code>type</code> 表示<strong>图片格式</strong>，默认为 <code>image/png</code> ；</li>
<li><code>encoderOptions</code> 表示<strong>图片质量</strong>，在指定图片格式为 <code>image/jpeg</code> 或 <code>image/webp</code> 的情况下，可以从 0 到 1 区间内选择图片质量。如果超出取值范围，将会使用默认值 <code>0.92</code>，其他参数会被忽略。<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">accept</span>=<span class="string">&quot;image/*&quot;</span> <span class="attr">onchange</span>=<span class="string">&quot;loadFile(event)&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></span></span><br><span class="line"><span class="javascript">        <span class="comment">// compress.js</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">const</span> MAX_WIDTH = <span class="number">800</span>; <span class="comment">// 图片最大宽度</span></span></span><br><span class="line"><span class="javascript">      	<span class="comment">// 图片压缩方法</span></span></span><br><span class="line"><span class="javascript">        <span class="function"><span class="keyword">function</span> <span class="title">compress</span>(<span class="params">base64, quality, mimeType</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">let</span> canvas = <span class="built_in">document</span>.createElement(<span class="string">&quot;canvas&quot;</span>);</span></span><br><span class="line"><span class="javascript">            <span class="keyword">let</span> img = <span class="built_in">document</span>.createElement(<span class="string">&quot;img&quot;</span>);</span></span><br><span class="line"><span class="javascript">            img.crossOrigin = <span class="string">&quot;anonymous&quot;</span>;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">                img.src = base64;</span></span><br><span class="line"><span class="javascript">                img.onload = <span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">                    <span class="keyword">let</span> targetWidth, targetHeight;</span></span><br><span class="line"><span class="javascript">                    <span class="keyword">if</span> (img.width &gt; MAX_WIDTH) &#123;</span></span><br><span class="line"><span class="javascript">                        targetWidth = MAX_WIDTH;</span></span><br><span class="line"><span class="javascript">                        targetHeight = (img.height * MAX_WIDTH) / img.width;</span></span><br><span class="line"><span class="javascript">                    &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="javascript">                        targetWidth = img.width;</span></span><br><span class="line"><span class="javascript">                        targetHeight = img.height;</span></span><br><span class="line"><span class="javascript">                    &#125;</span></span><br><span class="line"><span class="javascript">                    canvas.width = targetWidth;</span></span><br><span class="line"><span class="javascript">                    canvas.height = targetHeight;</span></span><br><span class="line"><span class="javascript">                    <span class="keyword">let</span> ctx = canvas.getContext(<span class="string">&quot;2d&quot;</span>);</span></span><br><span class="line"><span class="javascript">                    ctx.clearRect(<span class="number">0</span>, <span class="number">0</span>, targetWidth, targetHeight); <span class="comment">// 清除画布</span></span></span><br><span class="line"><span class="javascript">                    ctx.drawImage(img, <span class="number">0</span>, <span class="number">0</span>, canvas.width, canvas.height);</span></span><br><span class="line"><span class="javascript">                    <span class="keyword">let</span> imageData = canvas.toDataURL(mimeType, quality / <span class="number">100</span>); <span class="comment">// 设置图片质量</span></span></span><br><span class="line"><span class="javascript">                    resolve(imageData);</span></span><br><span class="line"><span class="javascript">                &#125;;</span></span><br><span class="line"><span class="javascript">            &#125;);</span></span><br><span class="line"><span class="javascript">        &#125;</span></span><br><span class="line"><span class="javascript"></span></span><br><span class="line"><span class="javascript">        <span class="comment">// 为了进一步减少传输的数据量，我们可以把它转换为 Blob 对象</span></span></span><br><span class="line"><span class="javascript">        <span class="function"><span class="keyword">function</span> <span class="title">dataUrlToBlob</span>(<span class="params">base64, mimeType</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">let</span> bytes = <span class="built_in">window</span>.atob(base64.split(<span class="string">&quot;,&quot;</span>)[<span class="number">1</span>]);</span></span><br><span class="line"><span class="javascript">            <span class="keyword">let</span> ab = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(bytes.length);</span></span><br><span class="line"><span class="javascript">            <span class="keyword">let</span> ia = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>(ab);</span></span><br><span class="line"><span class="javascript">            <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; bytes.length; i++) &#123;</span></span><br><span class="line"><span class="javascript">                ia[i] = bytes.charCodeAt(i);</span></span><br><span class="line"><span class="javascript">            &#125;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">return</span> <span class="keyword">new</span> Blob([ab], &#123; <span class="attr">type</span>: mimeType &#125;);</span></span><br><span class="line"><span class="javascript">        &#125;</span></span><br><span class="line"><span class="javascript"></span></span><br><span class="line"><span class="javascript">        <span class="comment">// 通过 AJAX 提交到服务器</span></span></span><br><span class="line"><span class="javascript">        <span class="function"><span class="keyword">function</span> <span class="title">uploadFile</span>(<span class="params">url, blob</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">let</span> formData = <span class="keyword">new</span> FormData();</span></span><br><span class="line"><span class="javascript">            <span class="keyword">let</span> request = <span class="keyword">new</span> XMLHttpRequest();</span></span><br><span class="line"><span class="javascript">            formData.append(<span class="string">&quot;image&quot;</span>, blob);</span></span><br><span class="line"><span class="javascript">            request.open(<span class="string">&quot;POST&quot;</span>, url, <span class="literal">true</span>);</span></span><br><span class="line"><span class="javascript">            request.send(formData);</span></span><br><span class="line"><span class="javascript">        &#125;</span></span><br><span class="line"><span class="javascript"></span></span><br><span class="line"><span class="javascript">        <span class="function"><span class="keyword">function</span> <span class="title">loadFile</span>(<span class="params">event</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">const</span> reader = <span class="keyword">new</span> FileReader();</span></span><br><span class="line"><span class="javascript">            reader.onload = <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                <span class="keyword">let</span> compressedDataURL = <span class="keyword">await</span> compress(</span></span><br><span class="line"><span class="javascript">                    reader.result,</span></span><br><span class="line"><span class="javascript">                    <span class="number">90</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="string">&quot;image/jpeg&quot;</span></span></span><br><span class="line"><span class="javascript">                );</span></span><br><span class="line"><span class="javascript">                <span class="keyword">let</span> compressedImageBlob = dataUrlToBlob(compressedDataURL);</span></span><br><span class="line"><span class="javascript">                uploadFile(<span class="string">&quot;https://httpbin.org/post&quot;</span>, compressedImageBlob);</span></span><br><span class="line"><span class="javascript">            &#125;;</span></span><br><span class="line"><span class="javascript">            reader.readAsDataURL(event.target.files[<span class="number">0</span>]);</span></span><br><span class="line"><span class="javascript">        &#125;;</span></span><br><span class="line"><span class="javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure>
其实 Canvas 对象除了提供 <code>toDataURL()</code> 方法之外，它还提供了一个 <code>toBlob()</code> 方法，该方法的语法如下：</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">canvas.toBlob(callback, mimeType, qualityArgument)</span><br></pre></td></tr></table></figure>

<p>和 <code>toDataURL()</code> 方法相比，<code>toBlob()</code> 方法是异步的，因此多了个 <code>callback</code> 参数，这个 <code>callback</code> 回调方法默认的第一个参数就是转换好的 <code>blob</code>文件信息。<br /></p>
<h2 id="7-生成-PDF-文档"><a href="#7-生成-PDF-文档" class="headerlink" title="7. 生成 PDF 文档"></a>7. 生成 PDF 文档</h2><p>在浏览器端，利用一些现成的开源库，比如 jsPDF，我们也可以方便地生成 PDF 文档。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">h3</span>&gt;</span>客户端生成 PDF 示例<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://unpkg.com/jspdf@latest/dist/jspdf.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></span></span><br><span class="line"><span class="javascript">    (<span class="function"><span class="keyword">function</span> <span class="title">generatePdf</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">const</span> doc = <span class="keyword">new</span> jsPDF();</span></span><br><span class="line"><span class="javascript">      doc.text(<span class="string">&quot;Hello semlinker!&quot;</span>, <span class="number">66</span>, <span class="number">88</span>);</span></span><br><span class="line"><span class="javascript">      <span class="keyword">const</span> blob = <span class="keyword">new</span> Blob([doc.output()], &#123; <span class="attr">type</span>: <span class="string">&quot;application/pdf&quot;</span> &#125;);</span></span><br><span class="line"><span class="javascript">      blob.text().then(<span class="function">(<span class="params">blobAsText</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">        <span class="built_in">console</span>.log(blobAsText);</span></span><br><span class="line"><span class="javascript">      &#125;);</span></span><br><span class="line"><span class="javascript">    &#125;)();</span></span><br><span class="line"><span class="javascript">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>其实 jsPDF 除了支持纯文本之外，它也可以生成带图片的 PDF 文档，比如：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> imgData = <span class="string">&#x27;data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEASABIAAD/...&#x27;</span></span><br><span class="line"><span class="keyword">let</span> doc = <span class="keyword">new</span> jsPDF();</span><br><span class="line"></span><br><span class="line">doc.setFontSize(<span class="number">40</span>);</span><br><span class="line">doc.text(<span class="number">35</span>, <span class="number">25</span>, <span class="string">&#x27;Paranyan loves jsPDF&#x27;</span>);</span><br><span class="line">doc.addImage(imgData, <span class="string">&#x27;JPEG&#x27;</span>, <span class="number">15</span>, <span class="number">40</span>, <span class="number">180</span>, <span class="number">160</span>);</span><br></pre></td></tr></table></figure>

<h1 id="四、Blob-与-ArrayBuffer-有何区别？"><a href="#四、Blob-与-ArrayBuffer-有何区别？" class="headerlink" title="四、Blob 与 ArrayBuffer 有何区别？"></a>四、Blob 与 ArrayBuffer 有何区别？</h1><h2 id="1-定义区别"><a href="#1-定义区别" class="headerlink" title="1. 定义区别"></a>1. 定义区别</h2><p><code>ArrayBuffer</code> 对象用于表示<strong>通用的，固定长度的原始二进制数据缓冲区</strong>。且<strong>不能直接操纵</strong> ArrayBuffer 的内容，需要创建一个类型化数组对象或 <code>DataView</code> 对象，该对象以特定格式表示缓冲区，并使用该对象读取和写入缓冲区的内容。<br /><br><br /><code>Blob</code> 类型的对象表示<strong>不可变的类似文件对象的原始数据</strong>。<code>Blob</code> 表示的不一定是 JavaScript 原生格式的数据。<code>File</code> 接口基于 <code>Blob</code>，继承了<code>Blob</code> 功能并将其扩展为支持用户系统上的文件。<br /><br><br /><code>Blob</code> 类型只有 <code>slice</code> 方法，用于返回一个新的 <code>Blob</code> 对象，包含了源 <code>Blob</code> 对象中指定范围内的数据。 对比发现，<code>ArrayBuffer</code> 的数据，是可以<strong>按照字节去操作</strong>的，而 <code>Blob</code> 只能作为一个完整对象去处理。所以说，<code>ArrayBuffer</code> 相比 <code>Blob</code> 更接近真实的二进制，更底层。<br /></p>
<h2 id="2-两者互转"><a href="#2-两者互转" class="headerlink" title="2. 两者互转"></a>2. 两者互转</h2><h3 id="2-1-ArrayBuffer-转-Blob"><a href="#2-1-ArrayBuffer-转-Blob" class="headerlink" title="2.1 ArrayBuffer 转 Blob"></a>2.1 ArrayBuffer 转 Blob</h3><p>只需将 <code>ArrayBuffer</code> 作为参数传入即可：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> buffer = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">16</span>);</span><br><span class="line"><span class="keyword">const</span> blob = <span class="keyword">new</span> Blob([buffer]);</span><br></pre></td></tr></table></figure>

<h3 id="2-2-Blob-转-ArrayBuffer"><a href="#2-2-Blob-转-ArrayBuffer" class="headerlink" title="2.2 Blob 转 ArrayBuffer"></a>2.2 Blob 转 ArrayBuffer</h3><p>需要借助 <code>FileReader</code> 对象：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> blob = <span class="keyword">new</span> Blob([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>]);</span><br><span class="line"><span class="keyword">const</span> reader = <span class="keyword">new</span> FileReader();</span><br><span class="line"></span><br><span class="line">reader.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">this</span>.result);</span><br><span class="line">&#125;</span><br><span class="line">reader.readAsArrayBuffer(blob);</span><br></pre></td></tr></table></figure>

<h2 id="3-其他区别"><a href="#3-其他区别" class="headerlink" title="3. 其他区别"></a>3. 其他区别</h2><ol>
<li>需要使用写入/编辑操作时使用 ArrayBuffer，否则使用 Blob 即可；</li>
<li>Blob 对象不可变，而 ArrayBuffer 可以通过 TypedArrays 或 DataView 操作；</li>
<li>Blob 可以位于磁盘、高速缓存内存和其他不同用位置，而 ArrayBuffer 存在内存中，可以直接操作；</li>
</ol>
<h2 id="4-Ajax-中使用-Blob-和-ArrayBuffer"><a href="#4-Ajax-中使用-Blob-和-ArrayBuffer" class="headerlink" title="4. Ajax 中使用 Blob 和 ArrayBuffer"></a>4. Ajax 中使用 Blob 和 ArrayBuffer</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">GET</span>(<span class="params">url, callback</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> xhr = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">  xhr.open(<span class="string">&#x27;GET&#x27;</span>, url, <span class="literal">true</span>);</span><br><span class="line">  xhr.responseType = <span class="string">&#x27;arraybuffer&#x27;</span>; <span class="comment">// or xhr.responseType = &quot;blob&quot;;</span></span><br><span class="line">  xhr.send();</span><br><span class="line"></span><br><span class="line">  xhr.onload = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (xhr.status != <span class="number">200</span>) &#123;</span><br><span class="line">      alert(<span class="string">&quot;Unexpected status code &quot;</span> + xhr.status + <span class="string">&quot; for &quot;</span> + url);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    callback(<span class="keyword">new</span> <span class="built_in">Uint8Array</span>(xhr.response)); <span class="comment">// or new Blob([xhr.response]);</span></span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="五、拓展"><a href="#五、拓展" class="headerlink" title="五、拓展"></a>五、拓展</h1><h2 id="1-Blob-URL-和-Data-URL-区别"><a href="#1-Blob-URL-和-Data-URL-区别" class="headerlink" title="1. Blob URL 和 Data URL 区别"></a>1. Blob URL 和 Data URL 区别</h2><h3 id="1-1-格式不同"><a href="#1-1-格式不同" class="headerlink" title="1.1 格式不同"></a>1.1 格式不同</h3><p><code>Blob URL</code> 格式如 <code>blob:域名/uuid</code> ， <code>Data URL</code> 格式如： <code>data:[&lt;mediatype&gt;][;base64],&lt;data&gt;</code>  。<br /><code>mediatype</code> 是个 MIME 类型的字符串，例如 “<code>image/jpeg</code>“ 表示 JPEG 图像文件。如果被省略，则默认值为 <code>text/plain;charset=US-ASCII</code>。<br /><img src="http://images.pingan8787.com/blog/you-dont-know-blob/code.png" alt="image.png"></p>
<h3 id="1-2-长度不同"><a href="#1-2-长度不同" class="headerlink" title="1.2 长度不同"></a>1.2 长度不同</h3><p><code>Blob URL</code> 一般长度较短，而 <code>Data URL</code> 因为直接存储图片 base64 编码后的数据，往往比较长。<br /></p>
<h3 id="1-3-XMLHttpRequest-支持情况不同"><a href="#1-3-XMLHttpRequest-支持情况不同" class="headerlink" title="1.3 XMLHttpRequest 支持情况不同"></a>1.3 XMLHttpRequest 支持情况不同</h3><p><code>Blob URL</code>  可以很方便使用 XMLHttpRequest 获取源数据（ <code>xhr.responseType = &#39;blob&#39;</code> ），而 <code>Data URL</code> 并不是所有浏览器都支持通过 XMLHttpRequest 获取源数据的。<br /></p>
<h3 id="1-4-使用场景不同"><a href="#1-4-使用场景不同" class="headerlink" title="1.4 使用场景不同"></a>1.4 使用场景不同</h3><p><code>Blob URL</code>  只能在当前应用内使用，把 <code>Blob URL</code>  复制到浏览器地址栏是无法获取数据，而 <code>Data URL</code> 则可以在任意浏览器中使用。<br /></p>
<h1 id="六、总结"><a href="#六、总结" class="headerlink" title="六、总结"></a>六、总结</h1><p>本文中我们主要通过 4 个问题来复习了 Blob 知识点：“Blob 是什么”、“Blob 怎么用”、“Blob 使用场景”和“Blob 与 ArrayBuffer 区别”，在“Blob 使用场景”部分中，也主要介绍了我们实际开发中非常常见的“图片预览”、“图片下载”和“生成文件”的场景。在文章最后，也通过和大家复习了“Blob URL 和 Data URL 区别”，让我们对 Blob 有更深的认识。</p>
<table>
<thead>
<tr>
<th>Author</th>
<th>王平安</th>
</tr>
</thead>
<tbody><tr>
<td>E-mail</td>
<td><a href="mailto:&#112;&#x69;&#110;&#103;&#x61;&#110;&#56;&#x37;&#x38;&#55;&#x40;&#x71;&#x71;&#46;&#x63;&#111;&#109;">&#112;&#x69;&#110;&#103;&#x61;&#110;&#56;&#x37;&#x38;&#55;&#x40;&#x71;&#x71;&#46;&#x63;&#111;&#109;</a></td>
</tr>
<tr>
<td>博  客</td>
<td><a target="_blank" rel="noopener" href="http://www.pingan8787.com/">www.pingan8787.com</a></td>
</tr>
<tr>
<td>微  信</td>
<td>pingan8787</td>
</tr>
<tr>
<td>每日文章推荐</td>
<td><a target="_blank" rel="noopener" href="https://github.com/pingan8787/Leo_Reading/issues">https://github.com/pingan8787/Leo_Reading/issues</a></td>
</tr>
<tr>
<td>ES小册</td>
<td>js.pingan8787.com</td>
</tr>
<tr>
<td>语雀知识库</td>
<td><a target="_blank" rel="noopener" href="https://www.yuque.com/wangpingan/cute-frontend">Cute-FrontEnd</a></td>
</tr>
</tbody></table>
<p><img src="http://images.pingan8787.com/2019_07_12guild_page.png" alt="bg">  </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/06/06/205-%E3%80%90%E8%AF%BB%E4%B9%A6%E3%80%91%E8%AF%BB%E3%80%8A%E4%BD%A0%E4%B8%8D%E7%9F%A5%E9%81%93%E7%9A%84Blob%E3%80%8B%E6%80%BB%E7%BB%93/" data-id="ckts3ejyp00n24d9k7jzt1ddl" data-title="205-【读书】读《你不知道的Blob》总结" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/" rel="tag">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/" rel="tag">前端开发</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%8E%9F%E5%88%9B/" rel="tag">原创</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" rel="tag">读书笔记</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-204-【TypeScript】TypeScript代码整洁之道" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/05/23/204-%E3%80%90TypeScript%E3%80%91TypeScript%E4%BB%A3%E7%A0%81%E6%95%B4%E6%B4%81%E4%B9%8B%E9%81%93/" class="article-date">
  <time class="dt-published" datetime="2020-05-23T14:41:39.000Z" itemprop="datePublished">2020-05-23</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/05/23/204-%E3%80%90TypeScript%E3%80%91TypeScript%E4%BB%A3%E7%A0%81%E6%95%B4%E6%B4%81%E4%B9%8B%E9%81%93/">204-【TypeScript】TypeScript代码整洁之道</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p><a target="_blank" rel="noopener" href="https://github.com/pipiliang/clean-code-typescript">中文</a> | <a target="_blank" rel="noopener" href="https://github.com/labs42io/clean-code-typescript">English</a></p>
<blockquote>
<p>将 Clean Code 的概念适用到 TypeScript，灵感来自 <a target="_blank" rel="noopener" href="https://github.com/ryanmcdermott/clean-code-javascript">clean-code-javascript</a>。</p>
</blockquote>
<h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a><a href="#%E7%9B%AE%E5%BD%95"></a>目录</h2><ol>
<li> <a href="#%E7%AE%80%E4%BB%8B">简介</a></li>
<li> <a href="#%E5%8F%98%E9%87%8F">变量</a></li>
<li> <a href="#%E5%87%BD%E6%95%B0">函数</a></li>
<li> <a href="#%E5%AF%B9%E8%B1%A1%E5%92%8C%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84">对象与数据结构</a></li>
<li> <a href="#%E7%B1%BB">类</a></li>
<li> <a href="#SOLID%E5%8E%9F%E5%88%99">SOLID原则</a></li>
<li> <a href="#%E6%B5%8B%E8%AF%95">测试</a></li>
<li> <a href="#%E5%B9%B6%E5%8F%91">并发</a></li>
<li> <a href="#%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86">错误处理</a></li>
<li> <a href="#%E6%A0%BC%E5%BC%8F%E5%8C%96">格式化</a></li>
<li> <a href="#%E6%B3%A8%E9%87%8A">注释</a></li>
</ol>
<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a><a href="#%E7%AE%80%E4%BB%8B"></a>简介</h2><p><a target="_blank" rel="noopener" href="https://camo.githubusercontent.com/0607e034aee88cce40b832367d44265e01b42654/68747470733a2f2f7777772e6f736e6577732e636f6d2f696d616765732f636f6d6963732f7774666d2e6a7067"><img src="https://camo.githubusercontent.com/0607e034aee88cce40b832367d44265e01b42654/68747470733a2f2f7777772e6f736e6577732e636f6d2f696d616765732f636f6d6963732f7774666d2e6a7067" alt="Humorous image of software quality estimation as a count of how many expletives you shout when reading code"></a></p>
<p>这不是一份 TypeScript 编码风格规范，而是将 Robert C. Martin 的软件工程著作 <a target="_blank" rel="noopener" href="https://www.amazon.com/Clean-Code-Handbook-Software-Craftsmanship/dp/0132350882">《Clean Code》</a> 适用到 TypeScript，引导读者使用 TypeScript 编写<a target="_blank" rel="noopener" href="https://github.com/ryanmcdermott/3rs-of-software-architecture">易读、复用和可扩展</a>的软件。</p>
<p>实际上，并不是每一个原则都要严格遵守，能被广泛认同的原则就更少了。这看起来虽然只是一份指导原则，但却是 <em>Clean Code</em> 作者对多年编程经验的凝练。</p>
<p>软件工程技术已有50多年的历史了，我们仍然要学习很多的东西。当软件架构和架构本身一样古老的时候，也许我们需要遵守更严格的规则。但是现在，让这些指导原则作为评估您和您的团队代码质量的试金石。</p>
<p>另外，理解这些原则不会立即让您变的优秀，也不意味着不会犯错。每一段代码都是从不完美开始的，通过反复走查不断趋于完美，就像黏土制作成陶艺一样，享受这个过程吧!</p>
<p><strong><a href="#%E7%9B%AE%E5%BD%95">↑ 回到顶部</a></strong></p>
<h2 id="变量"><a href="#变量" class="headerlink" title="变量"></a><a href="#%E5%8F%98%E9%87%8F"></a>变量</h2><blockquote>
<p>计算机科学只存在两个难题：缓存失效和命名。—— Phil KarIton</p>
</blockquote>
<h3 id="使用有意义的变量名"><a href="#使用有意义的变量名" class="headerlink" title="使用有意义的变量名"></a><a href="#%E4%BD%BF%E7%94%A8%E6%9C%89%E6%84%8F%E4%B9%89%E7%9A%84%E5%8F%98%E9%87%8F%E5%90%8D"></a>使用有意义的变量名</h3><p>做有意义的区分，让读者更容易理解变量的含义。</p>
<p><strong>👎 反例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">between</span>&lt;<span class="title">T</span>&gt;(<span class="params">a1: T, a2: T, a3: T</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> a2 &lt;= a1 &amp;&amp; a1 &lt;= a3;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>👍 正例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">between</span>&lt;<span class="title">T</span>&gt;(<span class="params">value: T, left: T, right: T</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> left &lt;= value &amp;&amp; value &lt;= right;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><a href="#%E7%9B%AE%E5%BD%95">↑ 回到顶部</a></strong></p>
<h3 id="可读的变量名"><a href="#可读的变量名" class="headerlink" title="可读的变量名"></a><a href="#%E5%8F%AF%E8%AF%BB%E7%9A%84%E5%8F%98%E9%87%8F%E5%90%8D"></a>可读的变量名</h3><p>如果你不能正确读出它，那么你在讨论它时听起来就会像个白痴。</p>
<p><strong>👎 反例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DtaRcrd102</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> genymdhms: <span class="built_in">Date</span>; #  <span class="comment">// 你能读出这个变量名么？</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> modymdhms: <span class="built_in">Date</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> pszqint = <span class="string">&#x27;102&#x27;</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>👍 正例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Customer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> generationTimestamp: <span class="built_in">Date</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> modificationTimestamp: <span class="built_in">Date</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> recordId = <span class="string">&#x27;102&#x27;</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><a href="#%E7%9B%AE%E5%BD%95">↑ 回到顶部</a></strong></p>
<h3 id="合并功能一致的变量"><a href="#合并功能一致的变量" class="headerlink" title="合并功能一致的变量"></a><a href="#%E5%90%88%E5%B9%B6%E5%8A%9F%E8%83%BD%E4%B8%80%E8%87%B4%E7%9A%84%E5%8F%98%E9%87%8F"></a>合并功能一致的变量</h3><p><strong>👎 反例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getUserInfo</span>(<span class="params"></span>): <span class="title">User</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getUserDetails</span>(<span class="params"></span>): <span class="title">User</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getUserData</span>(<span class="params"></span>): <span class="title">User</span></span>;</span><br></pre></td></tr></table></figure>

<p><strong>👍 正例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getUser</span>(<span class="params"></span>): <span class="title">User</span></span>;</span><br></pre></td></tr></table></figure>

<p><strong><a href="#%E7%9B%AE%E5%BD%95">↑ 回到顶部</a></strong></p>
<h3 id="便于搜索的名字"><a href="#便于搜索的名字" class="headerlink" title="便于搜索的名字"></a><a href="#%E4%BE%BF%E4%BA%8E%E6%90%9C%E7%B4%A2%E7%9A%84%E5%90%8D%E5%AD%97"></a>便于搜索的名字</h3><p>往往我们读代码要比写的多，所以易读性和可搜索非常重要。如果不抽取并命名有意义的变量名，那就坑了读代码的人。代码一定要便于搜索，<a target="_blank" rel="noopener" href="https://palantir.github.io/tslint/rules/no-magic-numbers/">TSLint</a> 就可以帮助识别未命名的常量。</p>
<p><strong>👎 反例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//86400000 代表什么？</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(restart, <span class="number">86400000</span>);</span><br></pre></td></tr></table></figure>

<p><strong>👍 正例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 声明为常量，要大写且有明确含义。</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> MILLISECONDS_IN_A_DAY = <span class="number">24</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(restart, MILLISECONDS_IN_A_DAY);</span><br></pre></td></tr></table></figure>

<p><strong><a href="#%E7%9B%AE%E5%BD%95">↑ 回到顶部</a></strong></p>
<h3 id="使用自解释的变量名"><a href="#使用自解释的变量名" class="headerlink" title="使用自解释的变量名"></a><a href="#%E4%BD%BF%E7%94%A8%E8%87%AA%E8%A7%A3%E9%87%8A%E7%9A%84%E5%8F%98%E9%87%8F%E5%90%8D"></a>使用自解释的变量名</h3><p><strong>👎 反例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span> <span class="keyword">const</span> users:<span class="built_in">Map</span>&lt;<span class="built_in">string</span>, User&gt;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">const</span> keyValue <span class="keyword">of</span> users) &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>👍 正例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span> <span class="keyword">const</span> users:<span class="built_in">Map</span>&lt;<span class="built_in">string</span>, User&gt;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">const</span> [id, user] <span class="keyword">of</span> users) &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><a href="#%E7%9B%AE%E5%BD%95">↑ 回到顶部</a></strong></p>
<h3 id="避免思维映射"><a href="#避免思维映射" class="headerlink" title="避免思维映射"></a><a href="#%E9%81%BF%E5%85%8D%E6%80%9D%E7%BB%B4%E6%98%A0%E5%B0%84"></a>避免思维映射</h3><p>不要让人去猜测或想象变量的含义，<em>明确是王道。</em></p>
<p><strong>👎 反例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> u = getUser();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> s = getSubscription();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> t = charge(u, s);</span><br></pre></td></tr></table></figure>

<p><strong>👍 正例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> user = getUser();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> subscription = getSubscription();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> transaction = charge(user, subscription);</span><br></pre></td></tr></table></figure>

<p><strong><a href="#%E7%9B%AE%E5%BD%95">↑ 回到顶部</a></strong></p>
<h3 id="不添加无用的上下文"><a href="#不添加无用的上下文" class="headerlink" title="不添加无用的上下文"></a><a href="#%E4%B8%8D%E6%B7%BB%E5%8A%A0%E6%97%A0%E7%94%A8%E7%9A%84%E4%B8%8A%E4%B8%8B%E6%96%87"></a>不添加无用的上下文</h3><p>如果类名或对象名已经表达了某些信息，在内部变量名中不要再重复表达。</p>
<p><strong>👎 反例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Car = &#123;</span><br><span class="line"></span><br><span class="line">  <span class="attr">carMake</span>: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">  carModel: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">  carColor: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">print</span>(<span class="params">car: Car</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`<span class="subst">$&#123;<span class="built_in">this</span>.carMake&#125;</span> <span class="subst">$&#123;<span class="built_in">this</span>.carModel&#125;</span> (<span class="subst">$&#123;<span class="built_in">this</span>.carColor&#125;</span>)`</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>👍 正例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Car = &#123;</span><br><span class="line"></span><br><span class="line">  <span class="attr">make</span>: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">  model: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">  color: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">print</span>(<span class="params">car: Car</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`<span class="subst">$&#123;<span class="built_in">this</span>.make&#125;</span> <span class="subst">$&#123;<span class="built_in">this</span>.model&#125;</span> (<span class="subst">$&#123;<span class="built_in">this</span>.color&#125;</span>)`</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><a href="#%E7%9B%AE%E5%BD%95">↑ 回到顶部</a></strong></p>
<h3 id="使用默认参数，而非短路或条件判断"><a href="#使用默认参数，而非短路或条件判断" class="headerlink" title="使用默认参数，而非短路或条件判断"></a><a href="#%E4%BD%BF%E7%94%A8%E9%BB%98%E8%AE%A4%E5%8F%82%E6%95%B0%E8%80%8C%E9%9D%9E%E7%9F%AD%E8%B7%AF%E6%88%96%E6%9D%A1%E4%BB%B6%E5%88%A4%E6%96%AD"></a>使用默认参数，而非短路或条件判断</h3><p>通常，默认参数比短路更整洁。</p>
<p><strong>👎 反例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">loadPages</span>(<span class="params">count: <span class="built_in">number</span></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> loadCount = count !== <span class="literal">undefined</span> ? count : <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>👍 正例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">loadPages</span>(<span class="params">count: <span class="built_in">number</span> = <span class="number">10</span></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><a href="#%E7%9B%AE%E5%BD%95">↑ 回到顶部</a></strong></p>
<h2 id="函数"><a href="#函数" class="headerlink" title="函数"></a><a href="#%E5%87%BD%E6%95%B0"></a>函数</h2><h3 id="参数越少越好-理想情况不超过2个"><a href="#参数越少越好-理想情况不超过2个" class="headerlink" title="参数越少越好 (理想情况不超过2个)"></a><a href="#%E5%8F%82%E6%95%B0%E8%B6%8A%E5%B0%91%E8%B6%8A%E5%A5%BD-%E7%90%86%E6%83%B3%E6%83%85%E5%86%B5%E4%B8%8D%E8%B6%85%E8%BF%872%E4%B8%AA"></a>参数越少越好 (理想情况不超过2个)</h3><p>限制参数个数，这样函数测试会更容易。超过三个参数会导致测试复杂度激增，需要测试众多不同参数的组合场景。 理想情况，只有一两个参数。如果有两个以上的参数，那么您的函数可能就太过复杂了。</p>
<p>如果需要很多参数，请您考虑使用对象。为了使函数的属性更清晰，可以使用<a target="_blank" rel="noopener" href="https://basarat.gitbooks.io/typescript/docs/destructuring.html">解构</a>，它有以下优点：</p>
<ol>
<li> 当有人查看函数签名时，会立即清楚使用了哪些属性。</li>
<li> 解构对传递给函数的参数对象做深拷贝，这可预防副作用。(注意：<strong>不会克隆</strong>从参数对象中解构的对象和数组)</li>
<li> TypeScript 会对未使用的属性显示警告。</li>
</ol>
<p><strong>👎 反例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createMenu</span>(<span class="params">title: <span class="built_in">string</span>, body: <span class="built_in">string</span>, buttonText: <span class="built_in">string</span>, cancellable: <span class="built_in">boolean</span></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">createMenu(<span class="string">&#x27;Foo&#x27;</span>, <span class="string">&#x27;Bar&#x27;</span>, <span class="string">&#x27;Baz&#x27;</span>, <span class="literal">true</span>);</span><br></pre></td></tr></table></figure>

<p><strong>👍 正例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createMenu</span>(<span class="params">options: &#123;title: <span class="built_in">string</span>, body: <span class="built_in">string</span>, buttonText: <span class="built_in">string</span>, cancellable: <span class="built_in">boolean</span>&#125;</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">createMenu(</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">title</span>: <span class="string">&#x27;Foo&#x27;</span>,</span><br><span class="line">    <span class="attr">body</span>: <span class="string">&#x27;Bar&#x27;</span>,</span><br><span class="line">    <span class="attr">buttonText</span>: <span class="string">&#x27;Baz&#x27;</span>,</span><br><span class="line">    <span class="attr">cancellable</span>: <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>通过 TypeScript 的<a target="_blank" rel="noopener" href="https://www.typescriptlang.org/docs/handbook/advanced-types.html#type-aliases">类型别名</a>，可以进一步提高可读性。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> MenuOptions = &#123;<span class="attr">title</span>: <span class="built_in">string</span>, <span class="attr">body</span>: <span class="built_in">string</span>, <span class="attr">buttonText</span>: <span class="built_in">string</span>, <span class="attr">cancellable</span>: <span class="built_in">boolean</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createMenu</span>(<span class="params">options: MenuOptions</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">createMenu(</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">title</span>: <span class="string">&#x27;Foo&#x27;</span>,</span><br><span class="line">    <span class="attr">body</span>: <span class="string">&#x27;Bar&#x27;</span>,</span><br><span class="line">    <span class="attr">buttonText</span>: <span class="string">&#x27;Baz&#x27;</span>,</span><br><span class="line">    <span class="attr">cancellable</span>: <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p><strong><a href="#%E7%9B%AE%E5%BD%95">↑ 回到顶部</a></strong></p>
<h3 id="只做一件事"><a href="#只做一件事" class="headerlink" title="只做一件事"></a><a href="#%E5%8F%AA%E5%81%9A%E4%B8%80%E4%BB%B6%E4%BA%8B"></a>只做一件事</h3><p>这是目前软件工程中最重要的规则。如果函数做不止一件事，它就更难组合、测试以及理解。反之，函数只有一个行为，它就更易于重构、代码就更清晰。如果能做好这一点，你一定很优秀！</p>
<p><strong>👎 反例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">emailClients</span>(<span class="params">clients: Client</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  clients.forEach(<span class="function">(<span class="params">client</span>) =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> clientRecord = database.lookup(client);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (clientRecord.isActive()) &#123;</span><br><span class="line"></span><br><span class="line">      email(client);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>👍 正例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">emailClients</span>(<span class="params">clients: Client</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  clients.filter(isActiveClient).forEach(email);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isActiveClient</span>(<span class="params">client: Client</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> clientRecord = database.lookup(client);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> clientRecord.isActive();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><a href="#%E7%9B%AE%E5%BD%95">↑ 回到顶部</a></strong></p>
<h3 id="名副其实"><a href="#名副其实" class="headerlink" title="名副其实"></a><a href="#%E5%90%8D%E5%89%AF%E5%85%B6%E5%AE%9E"></a>名副其实</h3><p>通过函数名就可以看得出函数实现的功能。</p>
<p><strong>👎 反例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addToDate</span>(<span class="params">date: <span class="built_in">Date</span>, month: <span class="built_in">number</span></span>): <span class="title">Date</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> date = <span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从函数名很难看的出需要加什么？</span></span><br><span class="line">addToDate(date, <span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<p><strong>👍 正例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addMonthToDate</span>(<span class="params">date: <span class="built_in">Date</span>, month: <span class="built_in">number</span></span>): <span class="title">Date</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> date = <span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line"></span><br><span class="line">addMonthToDate(date, <span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<p><strong><a href="#%E7%9B%AE%E5%BD%95">↑ 回到顶部</a></strong></p>
<h3 id="每个函数只包含同一个层级的抽象"><a href="#每个函数只包含同一个层级的抽象" class="headerlink" title="每个函数只包含同一个层级的抽象"></a><a href="#%E6%AF%8F%E4%B8%AA%E5%87%BD%E6%95%B0%E5%8F%AA%E5%8C%85%E5%90%AB%E5%90%8C%E4%B8%80%E4%B8%AA%E5%B1%82%E7%BA%A7%E7%9A%84%E6%8A%BD%E8%B1%A1"></a>每个函数只包含同一个层级的抽象</h3><p>当有多个抽象级别时，函数应该是做太多事了。拆分函数以便可复用，也让测试更容易。</p>
<p><strong>👎 反例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">parseCode</span>(<span class="params">code:<span class="built_in">string</span></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> REGEXES = [ <span class="comment">/* ... */</span> ];</span><br><span class="line">  <span class="keyword">const</span> statements = code.split(<span class="string">&#x27; &#x27;</span>);</span><br><span class="line">  <span class="keyword">const</span> tokens = [];</span><br><span class="line"></span><br><span class="line">  REGEXES.forEach(<span class="function">(<span class="params">regex</span>) =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">    statements.forEach(<span class="function">(<span class="params">statement</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> ast = [];</span><br><span class="line"></span><br><span class="line">  tokens.forEach(<span class="function">(<span class="params">token</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// lex...</span></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  ast.forEach(<span class="function">(<span class="params">node</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 解析 ...</span></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>👍 正例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> REGEXES = [ <span class="comment">/* ... */</span> ];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">parseCode</span>(<span class="params">code:<span class="built_in">string</span></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> tokens = tokenize(code);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> syntaxTree = parse(tokens);</span><br><span class="line"></span><br><span class="line">  syntaxTree.forEach(<span class="function">(<span class="params">node</span>) =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// parse...</span></span><br><span class="line"></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">tokenize</span>(<span class="params">code: <span class="built_in">string</span></span>):<span class="title">Token</span>[] </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> statements = code.split(<span class="string">&#x27; &#x27;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> tokens:Token[] = [];</span><br><span class="line"></span><br><span class="line">  REGEXES.forEach(<span class="function">(<span class="params">regex</span>) =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">    statements.forEach(<span class="function">(<span class="params">statement</span>) =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">      tokens.push( <span class="comment">/* ... */</span> );</span><br><span class="line"></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> tokens;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">parse</span>(<span class="params">tokens: Token[]</span>): <span class="title">SyntaxTree</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> syntaxTree:SyntaxTree[] = [];</span><br><span class="line"></span><br><span class="line">  tokens.forEach(<span class="function">(<span class="params">token</span>) =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">    syntaxTree.push( <span class="comment">/* ... */</span> );</span><br><span class="line"></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> syntaxTree;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><a href="#%E7%9B%AE%E5%BD%95">↑ 回到顶部</a></strong></p>
<h3 id="删除重复代码"><a href="#删除重复代码" class="headerlink" title="删除重复代码"></a><a href="#%E5%88%A0%E9%99%A4%E9%87%8D%E5%A4%8D%E4%BB%A3%E7%A0%81"></a>删除重复代码</h3><p>重复乃万恶之源！重复意味着如果要修改某个逻辑，需要修改多处代码 😢。 想象一下，如果你经营一家餐厅，要记录你的库存:所有的西红柿、洋葱、大蒜、香料等等。如果要维护多个库存列表，那是多么痛苦的事!</p>
<p>存在重复代码，是因为有两个或两个以上很近似的功能，只有一点不同，但是这点不同迫使你用多个独立的函数来做很多几乎相同的事情。删除重复代码，则意味着创建一个抽象，该抽象仅用一个函数/模块/类就可以处理这组不同的东西。</p>
<p>合理的抽象至关重要，这就是为什么您应该遵循<a href="#SOLID%E5%8E%9F%E5%88%99">SOLID原则</a>。糟糕的抽象可能还不如重复代码，所以要小心！话虽如此，还是要做好抽象！尽量不要重复。</p>
<p><strong>👎 反例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">showDeveloperList</span>(<span class="params">developers: Developer[]</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  developers.forEach(<span class="function">(<span class="params">developer</span>) =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> expectedSalary = developer.calculateExpectedSalary();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> experience = developer.getExperience();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> githubLink = developer.getGithubLink();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> data = &#123;</span><br><span class="line"></span><br><span class="line">      expectedSalary,</span><br><span class="line"></span><br><span class="line">      experience,</span><br><span class="line"></span><br><span class="line">      githubLink</span><br><span class="line"></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    render(data);</span><br><span class="line"></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">showManagerList</span>(<span class="params">managers: Manager[]</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  managers.forEach(<span class="function">(<span class="params">manager</span>) =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> expectedSalary = manager.calculateExpectedSalary();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> experience = manager.getExperience();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> portfolio = manager.getMBAProjects();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> data = &#123;</span><br><span class="line"></span><br><span class="line">      expectedSalary,</span><br><span class="line"></span><br><span class="line">      experience,</span><br><span class="line"></span><br><span class="line">      portfolio</span><br><span class="line"></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    render(data);</span><br><span class="line"></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>👍 正例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Developer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">getExtraDetails</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line"></span><br><span class="line">      <span class="attr">githubLink</span>: <span class="built_in">this</span>.githubLink,</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Manager</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">getExtraDetails</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line"></span><br><span class="line">      <span class="attr">portfolio</span>: <span class="built_in">this</span>.portfolio,</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">showEmployeeList</span>(<span class="params">employee: Developer | Manager</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  employee.forEach(<span class="function">(<span class="params">employee</span>) =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> expectedSalary = developer.calculateExpectedSalary();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> experience = developer.getExperience();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> extra = employee.getExtraDetails();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> data = &#123;</span><br><span class="line"></span><br><span class="line">      expectedSalary,</span><br><span class="line"></span><br><span class="line">      experience,</span><br><span class="line"></span><br><span class="line">      extra,</span><br><span class="line"></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    render(data);</span><br><span class="line"></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有时，在重复代码和引入不必要的抽象而增加的复杂性之间，需要做权衡。当来自不同领域的两个不同模块，它们的实现看起来相似，复制也是可以接受的，并且比抽取公共代码要好一点。因为抽取公共代码会导致两个模块产生间接的依赖关系。</p>
<p><strong><a href="#%E7%9B%AE%E5%BD%95">↑ 回到顶部</a></strong></p>
<h3 id="使用Object-assign或解构来设置默认对象"><a href="#使用Object-assign或解构来设置默认对象" class="headerlink" title="使用Object.assign或解构来设置默认对象"></a><a href="#%E4%BD%BF%E7%94%A8objectassign%E6%88%96%E8%A7%A3%E6%9E%84%E6%9D%A5%E8%AE%BE%E7%BD%AE%E9%BB%98%E8%AE%A4%E5%AF%B9%E8%B1%A1"></a>使用<code>Object.assign</code>或<code>解构</code>来设置默认对象</h3><p><strong>👎 反例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> MenuConfig = &#123;title?: <span class="built_in">string</span>, body?: <span class="built_in">string</span>, buttonText?: <span class="built_in">string</span>, cancellable?: <span class="built_in">boolean</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createMenu</span>(<span class="params">config: MenuConfig</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  config.title = config.title || <span class="string">&#x27;Foo&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  config.body = config.body || <span class="string">&#x27;Bar&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  config.buttonText = config.buttonText || <span class="string">&#x27;Baz&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  config.cancellable = config.cancellable !== <span class="literal">undefined</span> ? config.cancellable : <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> menuConfig = &#123;</span><br><span class="line"></span><br><span class="line">  <span class="attr">title</span>: <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">  <span class="attr">body</span>: <span class="string">&#x27;Bar&#x27;</span>,</span><br><span class="line"></span><br><span class="line">  <span class="attr">buttonText</span>: <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">  <span class="attr">cancellable</span>: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">createMenu(menuConfig);</span><br></pre></td></tr></table></figure>

<p><strong>👍 正例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> MenuConfig = &#123;title?: <span class="built_in">string</span>, body?: <span class="built_in">string</span>, buttonText?: <span class="built_in">string</span>, cancellable?: <span class="built_in">boolean</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createMenu</span>(<span class="params">config: MenuConfig</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> menuConfig = <span class="built_in">Object</span>.assign(&#123;</span><br><span class="line"></span><br><span class="line">    <span class="attr">title</span>: <span class="string">&#x27;Foo&#x27;</span>,</span><br><span class="line"></span><br><span class="line">    <span class="attr">body</span>: <span class="string">&#x27;Bar&#x27;</span>,</span><br><span class="line"></span><br><span class="line">    <span class="attr">buttonText</span>: <span class="string">&#x27;Baz&#x27;</span>,</span><br><span class="line"></span><br><span class="line">    <span class="attr">cancellable</span>: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  &#125;, config);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">createMenu(&#123; <span class="attr">body</span>: <span class="string">&#x27;Bar&#x27;</span> &#125;);</span><br></pre></td></tr></table></figure>

<p>或者，您可以使用默认值的解构:</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> MenuConfig = &#123;title?: <span class="built_in">string</span>, body?: <span class="built_in">string</span>, buttonText?: <span class="built_in">string</span>, cancellable?: <span class="built_in">boolean</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createMenu</span>(<span class="params">&#123;title = <span class="string">&#x27;Foo&#x27;</span>, body = <span class="string">&#x27;Bar&#x27;</span>, buttonText = <span class="string">&#x27;Baz&#x27;</span>, cancellable = <span class="literal">true</span>&#125;: MenuConfig</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">createMenu(&#123; <span class="attr">body</span>: <span class="string">&#x27;Bar&#x27;</span> &#125;);</span><br></pre></td></tr></table></figure>

<p>为了避免副作用，不允许显式传递<code>undefined</code>或<code>null</code>值。参见 TypeScript 编译器的<code>--strictnullcheck</code>选项。</p>
<p><strong><a href="#%E7%9B%AE%E5%BD%95">↑ 回到顶部</a></strong></p>
<h3 id="不要使用Flag参数"><a href="#不要使用Flag参数" class="headerlink" title="不要使用Flag参数"></a><a href="#%E4%B8%8D%E8%A6%81%E4%BD%BF%E7%94%A8flag%E5%8F%82%E6%95%B0"></a>不要使用Flag参数</h3><p>Flag参数告诉用户这个函数做了不止一件事。如果函数使用布尔值实现不同的代码逻辑路径，则考虑将其拆分。</p>
<p><strong>👎 反例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createFile</span>(<span class="params">name:<span class="built_in">string</span>, temp:<span class="built_in">boolean</span></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (temp) &#123;</span><br><span class="line"></span><br><span class="line">    fs.create(<span class="string">`./temp/<span class="subst">$&#123;name&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">    fs.create(name);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>👍 正例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createFile</span>(<span class="params">name:<span class="built_in">string</span></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  fs.create(name);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createTempFile</span>(<span class="params">name:<span class="built_in">string</span></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  fs.create(<span class="string">`./temp/<span class="subst">$&#123;name&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><a href="#%E7%9B%AE%E5%BD%95">↑ 回到顶部</a></strong></p>
<h3 id="避免副作用-part1"><a href="#避免副作用-part1" class="headerlink" title="避免副作用 (part1)"></a><a href="#%E9%81%BF%E5%85%8D%E5%89%AF%E4%BD%9C%E7%94%A8-part1"></a>避免副作用 (part1)</h3><p>当函数产生除了“一个输入一个输出”之外的行为时，称该函数产生了副作用。比如写文件、修改全局变量或将你的钱全转给了一个陌生人等。</p>
<p>在某些情况下，程序需要一些副作用。如先前例子中的写文件，这时应该将这些功能集中在一起，不要用多个函数/类修改某个文件。用且只用一个 service 完成这一需求。</p>
<p>重点是要规避常见陷阱，比如，在无结构对象之间共享状态、使用可变数据类型，以及不确定副作用发生的位置。如果你能做到这点，你才可能笑到最后！</p>
<p><strong>👎 反例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Global variable referenced by following function.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// If we had another function that used this name, now it&#x27;d be an array and it could break it.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> name = <span class="string">&#x27;Robert C. Martin&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">toBase64</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  name = btoa(name);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">toBase64(); <span class="comment">// produces side effects to `name` variable</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(name); <span class="comment">// expected to print &#x27;Robert C. Martin&#x27; but instead &#x27;Um9iZXJ0IEMuIE1hcnRpbg==&#x27;</span></span><br></pre></td></tr></table></figure>

<p><strong>👍 正例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Global variable referenced by following function.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// If we had another function that used this name, now it&#x27;d be an array and it could break it.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> name = <span class="string">&#x27;Robert C. Martin&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">toBase64</span>(<span class="params">text:<span class="built_in">string</span></span>):<span class="title">string</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> btoa(text);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> encodedName = toBase64(name);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(name);</span><br></pre></td></tr></table></figure>

<p><strong><a href="#%E7%9B%AE%E5%BD%95">↑ 回到顶部</a></strong></p>
<h3 id="避免副作用-part2"><a href="#避免副作用-part2" class="headerlink" title="避免副作用 (part2)"></a><a href="#%E9%81%BF%E5%85%8D%E5%89%AF%E4%BD%9C%E7%94%A8-part2"></a>避免副作用 (part2)</h3><p>在 JavaScript 中，原类型是值传递，对象、数组是引用传递。</p>
<p>有这样一种情况，如果您的函数修改了购物车数组，用来添加购买的商品，那么其他使用该<code>cart</code>数组的函数都将受此添加操作的影响。想象一个糟糕的情况:</p>
<p>用户点击“购买”按钮，该按钮调用<code>purchase</code>函数，函数请求网络并将<code>cart</code>数组发送到服务器。由于网络连接不好，购买功能必须不断重试请求。恰巧在网络请求开始前，用户不小心点击了某个不想要的项目上的“Add to Cart”按钮，该怎么办？而此时网络请求开始，那么<code>purchase</code>函数将发送意外添加的项，因为它引用了一个购物车数组，<code>addItemToCart</code>函数修改了该数组，添加了不需要的项。</p>
<p>一个很好的解决方案是<code>addItemToCart</code>总是克隆<code>cart</code>，编辑它，并返回克隆。这确保引用购物车的其他函数不会受到任何更改的影响。</p>
<p>注意两点:</p>
<ol>
<li><p> 在某些情况下，可能确实想要修改输入对象，这种情况非常少见。且大多数可以重构，确保没副作用！(见<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Pure_function">纯函数</a>)</p>
</li>
<li><p> 性能方面，克隆大对象代价确实比较大。还好有一些很好的库，它提供了一些高效快速的方法，且不像手动克隆对象和数组那样占用大量内存。</p>
</li>
</ol>
<p><strong>👎 反例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addItemToCart</span>(<span class="params">cart: CartItem[], item:Item</span>):<span class="title">void</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  cart.push(&#123; item, <span class="attr">date</span>: <span class="built_in">Date</span>.now() &#125;);</span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><strong>👍 正例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addItemToCart</span>(<span class="params">cart: CartItem[], item:Item</span>):<span class="title">CartItem</span>[] </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> [...cart, &#123; item, <span class="attr">date</span>: <span class="built_in">Date</span>.now() &#125;];</span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><strong><a href="#%E7%9B%AE%E5%BD%95">↑ 回到顶部</a></strong></p>
<h3 id="不要写全局函数"><a href="#不要写全局函数" class="headerlink" title="不要写全局函数"></a><a href="#%E4%B8%8D%E8%A6%81%E5%86%99%E5%85%A8%E5%B1%80%E5%87%BD%E6%95%B0"></a>不要写全局函数</h3><p>在 JavaScript 中污染全局的做法非常糟糕，这可能导致和其他库冲突，而调用你的 API 的用户在实际环境中得到一个 exception 前对这一情况是一无所知的。</p>
<p>考虑这样一个例子：如果想要扩展 JavaScript 的 <code>Array</code>，使其拥有一个可以显示两个数组之间差异的 <code>diff</code>方法，该怎么做呢？可以将新函数写入<code>Array.prototype</code> ，但它可能与另一个尝试做同样事情的库冲突。如果另一个库只是使用<code>diff</code>来查找数组的第一个元素和最后一个元素之间的区别呢？</p>
<p>更好的做法是扩展<code>Array</code>，实现对应的函数功能。</p>
<p><strong>👎 反例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span> <span class="built_in">global</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">interface</span> Array&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">    diff(other: T[]): <span class="built_in">Array</span>&lt;T&gt;;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">Array</span>.prototype.diff)&#123;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">Array</span>.prototype.diff = <span class="function"><span class="keyword">function</span> &lt;<span class="title">T</span>&gt;(<span class="params">other: T[]</span>): <span class="title">T</span>[] </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> hash = <span class="keyword">new</span> <span class="built_in">Set</span>(other);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.filter(<span class="function"><span class="params">elem</span> =&gt;</span> !hash.has(elem));</span><br><span class="line"></span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>👍 正例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyArray</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">Array</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">  diff(other: T[]): T[] &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> hash = <span class="keyword">new</span> <span class="built_in">Set</span>(other);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.filter(<span class="function"><span class="params">elem</span> =&gt;</span> !hash.has(elem));</span><br><span class="line"></span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><a href="#%E7%9B%AE%E5%BD%95">↑ 回到顶部</a></strong></p>
<h3 id="函数式编程优于命令式编程"><a href="#函数式编程优于命令式编程" class="headerlink" title="函数式编程优于命令式编程"></a><a href="#%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8B%E4%BC%98%E4%BA%8E%E5%91%BD%E4%BB%A4%E5%BC%8F%E7%BC%96%E7%A8%8B"></a>函数式编程优于命令式编程</h3><p>尽量使用函数式编程！</p>
<p><strong>👎 反例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> contributions = [</span><br><span class="line"></span><br><span class="line">  &#123;</span><br><span class="line"></span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Uncle Bobby&#x27;</span>,</span><br><span class="line"></span><br><span class="line">    <span class="attr">linesOfCode</span>: <span class="number">500</span></span><br><span class="line"></span><br><span class="line">  &#125;, &#123;</span><br><span class="line"></span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Suzie Q&#x27;</span>,</span><br><span class="line"></span><br><span class="line">    <span class="attr">linesOfCode</span>: <span class="number">1500</span></span><br><span class="line"></span><br><span class="line">  &#125;, &#123;</span><br><span class="line"></span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Jimmy Gosling&#x27;</span>,</span><br><span class="line"></span><br><span class="line">    <span class="attr">linesOfCode</span>: <span class="number">150</span></span><br><span class="line"></span><br><span class="line">  &#125;, &#123;</span><br><span class="line"></span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Gracie Hopper&#x27;</span>,</span><br><span class="line"></span><br><span class="line">    <span class="attr">linesOfCode</span>: <span class="number">1000</span></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> totalOutput = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; contributions.length; i++) &#123;</span><br><span class="line"></span><br><span class="line">  totalOutput += contributions[i].linesOfCode;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>👍 正例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> contributions = [</span><br><span class="line"></span><br><span class="line">  &#123;</span><br><span class="line"></span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Uncle Bobby&#x27;</span>,</span><br><span class="line"></span><br><span class="line">    <span class="attr">linesOfCode</span>: <span class="number">500</span></span><br><span class="line"></span><br><span class="line">  &#125;, &#123;</span><br><span class="line"></span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Suzie Q&#x27;</span>,</span><br><span class="line"></span><br><span class="line">    <span class="attr">linesOfCode</span>: <span class="number">1500</span></span><br><span class="line"></span><br><span class="line">  &#125;, &#123;</span><br><span class="line"></span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Jimmy Gosling&#x27;</span>,</span><br><span class="line"></span><br><span class="line">    <span class="attr">linesOfCode</span>: <span class="number">150</span></span><br><span class="line"></span><br><span class="line">  &#125;, &#123;</span><br><span class="line"></span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Gracie Hopper&#x27;</span>,</span><br><span class="line"></span><br><span class="line">    <span class="attr">linesOfCode</span>: <span class="number">1000</span></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> totalOutput = contributions</span><br><span class="line"></span><br><span class="line">  .reduce(<span class="function">(<span class="params">totalLines, output</span>) =&gt;</span> totalLines + output.linesOfCode, <span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<p><strong><a href="#%E7%9B%AE%E5%BD%95">↑ 回到顶部</a></strong></p>
<h3 id="封装判断条件"><a href="#封装判断条件" class="headerlink" title="封装判断条件"></a><a href="#%E5%B0%81%E8%A3%85%E5%88%A4%E6%96%AD%E6%9D%A1%E4%BB%B6"></a>封装判断条件</h3><p><strong>👎 反例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (subscription.isTrial || account.balance &gt; <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>👍 正例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">canActivateService</span>(<span class="params">subscription: Subscription, account: Account</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> subscription.isTrial || account.balance &gt; <span class="number">0</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (canActivateService(subscription, account)) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><a href="#%E7%9B%AE%E5%BD%95">↑ 回到顶部</a></strong></p>
<h3 id="避免“否定”的判断"><a href="#避免“否定”的判断" class="headerlink" title="避免“否定”的判断"></a><a href="#%E9%81%BF%E5%85%8D%E5%90%A6%E5%AE%9A%E7%9A%84%E5%88%A4%E6%96%AD"></a>避免“否定”的判断</h3><p><strong>👎 反例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isEmailNotUsed</span>(<span class="params">email: <span class="built_in">string</span></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (isEmailNotUsed(email)) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>👍 正例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isEmailUsed</span>(<span class="params">email</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!isEmailUsed(node)) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><a href="#%E7%9B%AE%E5%BD%95">↑ 回到顶部</a></strong></p>
<h3 id="避免判断条件"><a href="#避免判断条件" class="headerlink" title="避免判断条件"></a><a href="#%E9%81%BF%E5%85%8D%E5%88%A4%E6%96%AD%E6%9D%A1%E4%BB%B6"></a>避免判断条件</h3><p>这看起来似乎不太可能完成啊。大多数人听到后第一反应是，“没有if语句怎么实现功能呢？” 在多数情况下，可以使用多态性来实现相同的功能。接下来的问题是 “为什么要这么做？” 原因就是之前提到的：函数只做一件事。</p>
<p><strong>👎 反例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Airplane</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">type</span>: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">getCruisingAltitude</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (<span class="built_in">this</span>.type) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;777&#x27;</span>:</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.getMaxAltitude() - <span class="built_in">this</span>.getPassengerCount();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;Air Force One&#x27;</span>:</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.getMaxAltitude();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;Cessna&#x27;</span>:</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.getMaxAltitude() - <span class="built_in">this</span>.getFuelExpenditure();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line"></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&#x27;Unknown airplane type.&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>👍 正例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Airplane</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Boeing777</span> <span class="keyword">extends</span> <span class="title">Airplane</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">getCruisingAltitude</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.getMaxAltitude() - <span class="built_in">this</span>.getPassengerCount();</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AirForceOne</span> <span class="keyword">extends</span> <span class="title">Airplane</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">getCruisingAltitude</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.getMaxAltitude();</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cessna</span> <span class="keyword">extends</span> <span class="title">Airplane</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">getCruisingAltitude</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.getMaxAltitude() - <span class="built_in">this</span>.getFuelExpenditure();</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><a href="#%E7%9B%AE%E5%BD%95">↑ 回到顶部</a></strong></p>
<h3 id="避免类型检查"><a href="#避免类型检查" class="headerlink" title="避免类型检查"></a><a href="#%E9%81%BF%E5%85%8D%E7%B1%BB%E5%9E%8B%E6%A3%80%E6%9F%A5"></a>避免类型检查</h3><p>TypeScript 是 JavaScript 的一个严格的语法超集，具有静态类型检查的特性。所以指定变量、参数和返回值的类型，以充分利用此特性，能让重构更容易。</p>
<p><strong>👎 反例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">travelToTexas</span>(<span class="params">vehicle: Bicycle | Car</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (vehicle <span class="keyword">instanceof</span> Bicycle) &#123;</span><br><span class="line"></span><br><span class="line">    vehicle.pedal(<span class="built_in">this</span>.currentLocation, <span class="keyword">new</span> Location(<span class="string">&#x27;texas&#x27;</span>));</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (vehicle <span class="keyword">instanceof</span> Car) &#123;</span><br><span class="line"></span><br><span class="line">    vehicle.drive(<span class="built_in">this</span>.currentLocation, <span class="keyword">new</span> Location(<span class="string">&#x27;texas&#x27;</span>));</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>👍 正例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Vehicle = Bicycle | Car;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">travelToTexas</span>(<span class="params">vehicle: Vehicle</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  vehicle.move(<span class="built_in">this</span>.currentLocation, <span class="keyword">new</span> Location(<span class="string">&#x27;texas&#x27;</span>));</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><a href="#%E7%9B%AE%E5%BD%95">↑ 回到顶部</a></strong></p>
<h3 id="不要过度优化"><a href="#不要过度优化" class="headerlink" title="不要过度优化"></a><a href="#%E4%B8%8D%E8%A6%81%E8%BF%87%E5%BA%A6%E4%BC%98%E5%8C%96"></a>不要过度优化</h3><p>现代浏览器在运行时进行大量的底层优化。很多时候，你做优化只是在浪费时间。有些优秀<a target="_blank" rel="noopener" href="https://github.com/petkaantonov/bluebird/wiki/Optimization-killers">资源</a>可以帮助定位哪里需要优化，找到并修复它。</p>
<p><strong>👎 反例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// On old browsers, each iteration with uncached `list.length` would be costly</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// because of `list.length` recomputation. In modern browsers, this is optimized.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, len = list.length; i &lt; len; i++) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>👍 正例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; list.length; i++) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><a href="#%E7%9B%AE%E5%BD%95">↑ 回到顶部</a></strong></p>
<h3 id="删除无用代码"><a href="#删除无用代码" class="headerlink" title="删除无用代码"></a><a href="#%E5%88%A0%E9%99%A4%E6%97%A0%E7%94%A8%E4%BB%A3%E7%A0%81"></a>删除无用代码</h3><p>无用代码和重复代码一样无需保留。如果没有地方调用它，请删除！如果仍然需要它，可以查看版本历史。</p>
<p><strong>👎 反例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">oldRequestModule</span>(<span class="params">url: <span class="built_in">string</span></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">requestModule</span>(<span class="params">url: <span class="built_in">string</span></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> req = requestModule;</span><br><span class="line"></span><br><span class="line">inventoryTracker(<span class="string">&#x27;apples&#x27;</span>, req, <span class="string">&#x27;www.inventory-awesome.io&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p><strong>👍 正例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">requestModule</span>(<span class="params">url: <span class="built_in">string</span></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> req = requestModule;</span><br><span class="line"></span><br><span class="line">inventoryTracker(<span class="string">&#x27;apples&#x27;</span>, req, <span class="string">&#x27;www.inventory-awesome.io&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p><strong><a href="#%E7%9B%AE%E5%BD%95">↑ 回到顶部</a></strong></p>
<h3 id="使用迭代器和生成器"><a href="#使用迭代器和生成器" class="headerlink" title="使用迭代器和生成器"></a><a href="#%E4%BD%BF%E7%94%A8%E8%BF%AD%E4%BB%A3%E5%99%A8%E5%92%8C%E7%94%9F%E6%88%90%E5%99%A8"></a>使用迭代器和生成器</h3><p>像使用流一样处理数据集合时，请使用生成器和迭代器。</p>
<p>理由如下:</p>
<ul>
<li>  将调用者与生成器实现解耦，在某种意义上，调用者决定要访问多少项。</li>
<li>  延迟执行，按需使用。</li>
<li>  内置支持使用<code>for-of</code>语法进行迭代</li>
<li>  允许实现优化的迭代器模式</li>
</ul>
<p><strong>👎 反例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fibonacci</span>(<span class="params">n: <span class="built_in">number</span></span>): <span class="title">number</span>[] </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (n === <span class="number">1</span>) <span class="keyword">return</span> [<span class="number">0</span>];</span><br><span class="line">  <span class="keyword">if</span> (n === <span class="number">2</span>) <span class="keyword">return</span> [<span class="number">0</span>, <span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> items: <span class="built_in">number</span>[] = [<span class="number">0</span>, <span class="number">1</span>];</span><br><span class="line">  <span class="keyword">while</span> (items.length &lt; n) &#123;</span><br><span class="line">    items.push(items[items.length - <span class="number">2</span>] + items[items.length - <span class="number">1</span>]);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> items;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">print</span>(<span class="params">n: <span class="built_in">number</span></span>) </span>&#123;</span><br><span class="line">  fibonacci(n).forEach(<span class="function"><span class="params">fib</span> =&gt;</span> <span class="built_in">console</span>.log(fib));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Print first 10 Fibonacci numbers.</span></span><br><span class="line">print(<span class="number">10</span>);</span><br></pre></td></tr></table></figure>

<p><strong>👍 正例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Generates an infinite stream of Fibonacci numbers.</span></span><br><span class="line"><span class="comment">// The generator doesn&#x27;t keep the array of all numbers.</span></span><br><span class="line"><span class="function"><span class="keyword">function</span>* <span class="title">fibonacci</span>(<span class="params"></span>): <span class="title">IterableIterator</span>&lt;<span class="title">number</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> [a, b] = [<span class="number">0</span>, <span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="keyword">yield</span> a;</span><br><span class="line">    [a, b] = [b, a + b];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">print</span>(<span class="params">n: <span class="built_in">number</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> i = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> fib <span class="keyword">in</span> fibonacci()) &#123;</span><br><span class="line">    <span class="keyword">if</span> (i++ === n) <span class="keyword">break</span>;</span><br><span class="line">    <span class="built_in">console</span>.log(fib);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Print first 10 Fibonacci numbers.</span></span><br><span class="line">print(<span class="number">10</span>);</span><br></pre></td></tr></table></figure>

<p>有些库通过链接“map”、“slice”、“forEach”等方法，达到与原生数组类似的方式处理迭代。参见 <a target="_blank" rel="noopener" href="https://www.npmjs.com/package/itiriri">itiriri</a> 里面有一些使用迭代器的高级操作示例（或异步迭代的操作 <a target="_blank" rel="noopener" href="https://www.npmjs.com/package/itiriri-async">itiriri-async</a>）。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> itiriri <span class="keyword">from</span> <span class="string">&#x27;itiriri&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span>* <span class="title">fibonacci</span>(<span class="params"></span>): <span class="title">IterableIterator</span>&lt;<span class="title">number</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> [a, b] = [<span class="number">0</span>, <span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="keyword">yield</span> a;</span><br><span class="line">    [a, b] = [b, a + b];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">itiriri(fibonacci())</span><br><span class="line">  .take(<span class="number">10</span>)</span><br><span class="line">  .forEach(<span class="function"><span class="params">fib</span> =&gt;</span> <span class="built_in">console</span>.log(fib));</span><br></pre></td></tr></table></figure>

<p><strong><a href="#%E7%9B%AE%E5%BD%95">↑ 回到顶部</a></strong></p>
<h2 id="对象和数据结构"><a href="#对象和数据结构" class="headerlink" title="对象和数据结构"></a><a href="#%E5%AF%B9%E8%B1%A1%E5%92%8C%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"></a>对象和数据结构</h2><h3 id="使用getters和setters"><a href="#使用getters和setters" class="headerlink" title="使用getters和setters"></a><a href="#%E4%BD%BF%E7%94%A8getters%E5%92%8Csetters"></a>使用<code>getters</code>和<code>setters</code></h3><p>TypeScript 支持 getter/setter 语法。使用 getter 和 setter 从对象中访问数据比简单地在对象上查找属性要好。原因如下:</p>
<ul>
<li>  当需要在获取对象属性之前做一些事情时，不必在代码中查找并修改每个访问器。</li>
<li>  执行<code>set</code>时添加验证更简单。</li>
<li>  封装内部表示。</li>
<li>  更容易添加日志和错误处理。</li>
<li>  可以延迟加载对象的属性，比如从服务器获取它。</li>
</ul>
<p><strong>👎 反例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BankAccount</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="attr">balance</span>: <span class="built_in">number</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> value = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> account = <span class="keyword">new</span> BankAccount();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (value &lt; <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&#x27;Cannot set negative balance.&#x27;</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">account.balance = value;</span><br></pre></td></tr></table></figure>

<p><strong>👍 正例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BankAccount</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> accountBalance: <span class="built_in">number</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">get</span> <span class="title">balance</span>(): <span class="title">number</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.accountBalance;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">set</span> <span class="title">balance</span>(<span class="params">value: <span class="built_in">number</span></span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (value &lt; <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&#x27;Cannot set negative balance.&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.accountBalance = value;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> account = <span class="keyword">new</span> BankAccount();</span><br><span class="line"></span><br><span class="line">account.balance = <span class="number">100</span>;</span><br></pre></td></tr></table></figure>

<p><strong><a href="#%E7%9B%AE%E5%BD%95">↑ 回到顶部</a></strong></p>
<h3 id="让对象拥有-private-protected-成员"><a href="#让对象拥有-private-protected-成员" class="headerlink" title="让对象拥有 private/protected 成员"></a><a href="#%E8%AE%A9%E5%AF%B9%E8%B1%A1%E6%8B%A5%E6%9C%89-privateprotected-%E6%88%90%E5%91%98"></a>让对象拥有 private/protected 成员</h3><p>TypeScript 类成员支持 <code>public</code>*(默认)*、<code>protected</code> 以及 <code>private</code>的访问限制。</p>
<p><strong>👎 反例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Circle</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="attr">radius</span>: <span class="built_in">number</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">radius: <span class="built_in">number</span></span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.radius = radius;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">perimeter</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span> * <span class="built_in">Math</span>.PI * <span class="built_in">this</span>.radius;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">surface</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Math</span>.PI * <span class="built_in">this</span>.radius * <span class="built_in">this</span>.radius;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>👍 正例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Circle</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params"><span class="keyword">private</span> <span class="keyword">readonly</span> radius: <span class="built_in">number</span></span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">perimeter</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span> * <span class="built_in">Math</span>.PI * <span class="built_in">this</span>.radius;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">surface</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Math</span>.PI * <span class="built_in">this</span>.radius * <span class="built_in">this</span>.radius;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><a href="#%E7%9B%AE%E5%BD%95">↑ 回到顶部</a></strong></p>
<h3 id="不变性"><a href="#不变性" class="headerlink" title="不变性"></a><a href="#%E4%B8%8D%E5%8F%98%E6%80%A7"></a>不变性</h3><p>TypeScript 类型系统允许将接口、类上的单个属性设置为只读，能以函数的方式运行。</p>
<p>还有个高级场景，可以使用内置类型<code>Readonly</code>，它接受类型 T 并使用<a target="_blank" rel="noopener" href="https://www.typescriptlang.org/docs/handbook/advanced-types.html#mapped-types">映射类型</a>将其所有属性标记为只读。</p>
<p><strong>👎 反例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> Config &#123;</span><br><span class="line"></span><br><span class="line">  <span class="attr">host</span>: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">  port: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">  db: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>👍 正例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> Config &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">readonly</span> host: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">readonly</span> port: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">readonly</span> db: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><a href="#%E7%9B%AE%E5%BD%95">↑ 回到顶部</a></strong></p>
<h3 id="类型-vs-接口"><a href="#类型-vs-接口" class="headerlink" title="类型 vs 接口"></a><a href="#%E7%B1%BB%E5%9E%8B-vs-%E6%8E%A5%E5%8F%A3"></a>类型 vs 接口</h3><p>当可能需要联合或交集时，请使用类型。如果需要<code>扩展</code>或<code>实现</code>，请使用接口。然而，没有严格的规则，只有适合的规则。</p>
<p>详细解释参考关于 Typescript 中<code>type</code>和<code>interface</code>区别的<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/37233735/typescript-interfaces-vs-types/54101543#54101543">解答</a> 。</p>
<p><strong>👎 反例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> EmailConfig &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> DbConfig &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> Config &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Shape &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>👍 正例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> EmailConfig &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> DbConfig &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Config  = EmailConfig | DbConfig;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> Shape &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Circle</span> <span class="title">implements</span> <span class="title">Shape</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Square</span> <span class="title">implements</span> <span class="title">Shape</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><a href="#%E7%9B%AE%E5%BD%95">↑ 回到顶部</a></strong></p>
<h2 id="类"><a href="#类" class="headerlink" title="类"></a><a href="#%E7%B1%BB"></a>类</h2><h3 id="小、小、小！要事情说三遍"><a href="#小、小、小！要事情说三遍" class="headerlink" title="小、小、小！要事情说三遍"></a><a href="#%E5%B0%8F%E5%B0%8F%E5%B0%8F%E8%A6%81%E4%BA%8B%E6%83%85%E8%AF%B4%E4%B8%89%E9%81%8D"></a>小、小、小！要事情说三遍</h3><p>类的大小是由它的职责来度量的。按照<em>单一职责原则</em>，类要小。</p>
<p><strong>👎 反例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dashboard</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  getLanguage(): <span class="built_in">string</span> &#123; <span class="comment">/* ... */</span> &#125;</span><br><span class="line"></span><br><span class="line">  setLanguage(language: <span class="built_in">string</span>): <span class="built_in">void</span> &#123; <span class="comment">/* ... */</span> &#125;</span><br><span class="line"></span><br><span class="line">  showProgress(): <span class="built_in">void</span> &#123; <span class="comment">/* ... */</span> &#125;</span><br><span class="line"></span><br><span class="line">  hideProgress(): <span class="built_in">void</span> &#123; <span class="comment">/* ... */</span> &#125;</span><br><span class="line"></span><br><span class="line">  isDirty(): <span class="built_in">boolean</span> &#123; <span class="comment">/* ... */</span> &#125;</span><br><span class="line"></span><br><span class="line">  disable(): <span class="built_in">void</span> &#123; <span class="comment">/* ... */</span> &#125;</span><br><span class="line"></span><br><span class="line">  enable(): <span class="built_in">void</span> &#123; <span class="comment">/* ... */</span> &#125;</span><br><span class="line"></span><br><span class="line">  addSubscription(subscription: Subscription): <span class="built_in">void</span> &#123; <span class="comment">/* ... */</span> &#125;</span><br><span class="line"></span><br><span class="line">  removeSubscription(subscription: Subscription): <span class="built_in">void</span> &#123; <span class="comment">/* ... */</span> &#125;</span><br><span class="line"></span><br><span class="line">  addUser(user: User): <span class="built_in">void</span> &#123; <span class="comment">/* ... */</span> &#125;</span><br><span class="line"></span><br><span class="line">  removeUser(user: User): <span class="built_in">void</span> &#123; <span class="comment">/* ... */</span> &#125;</span><br><span class="line"></span><br><span class="line">  goToHomePage(): <span class="built_in">void</span> &#123; <span class="comment">/* ... */</span> &#125;</span><br><span class="line"></span><br><span class="line">  updateProfile(details: UserDetails): <span class="built_in">void</span> &#123; <span class="comment">/* ... */</span> &#125;</span><br><span class="line"></span><br><span class="line">  getVersion(): <span class="built_in">string</span> &#123; <span class="comment">/* ... */</span> &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>👍 正例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dashboard</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  disable(): <span class="built_in">void</span> &#123; <span class="comment">/* ... */</span> &#125;</span><br><span class="line"></span><br><span class="line">  enable(): <span class="built_in">void</span> &#123; <span class="comment">/* ... */</span> &#125;</span><br><span class="line"></span><br><span class="line">  getVersion(): <span class="built_in">string</span> &#123; <span class="comment">/* ... */</span> &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// split the responsibilities by moving the remaining methods to other classes</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure>

<p><strong><a href="#%E7%9B%AE%E5%BD%95">↑ 回到顶部</a></strong></p>
<h3 id="高内聚低耦合"><a href="#高内聚低耦合" class="headerlink" title="高内聚低耦合"></a><a href="#%E9%AB%98%E5%86%85%E8%81%9A%E4%BD%8E%E8%80%A6%E5%90%88"></a>高内聚低耦合</h3><p>内聚：定义了类成员之间相互关联的程度。理想情况下，高内聚类的每个方法都应该使用类中的所有字段，实际上这不可能也不可取。但我们依然提倡高内聚。</p>
<p>耦合：指的是两个类之间的关联程度。如果其中一个类的更改不影响另一个类，则称为低耦合类。</p>
<p>好的软件设计具有<strong>高内聚性</strong>和<strong>低耦合性</strong>。</p>
<p><strong>👎 反例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserManager</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Bad: each private variable is used by one or another group of methods.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// It makes clear evidence that the class is holding more than a single responsibility.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// If I need only to create the service to get the transactions for a user,</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// I&#x27;m still forced to pass and instance of emailSender.</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function"></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">private</span> <span class="keyword">readonly</span> db: Database,</span></span></span><br><span class="line"><span class="params"><span class="function"></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">private</span> <span class="keyword">readonly</span> emailSender: EmailSender</span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> getUser(id: <span class="built_in">number</span>): <span class="built_in">Promise</span>&lt;User&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> db.users.findOne(&#123; id &#125;)</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> getTransactions(userId: <span class="built_in">number</span>): <span class="built_in">Promise</span>&lt;Transaction[]&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> db.transactions.find(&#123; userId &#125;)</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> sendGreeting(): <span class="built_in">Promise</span>&lt;<span class="built_in">void</span>&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> emailSender.send(<span class="string">&#x27;Welcome!&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> sendNotification(text: <span class="built_in">string</span>): <span class="built_in">Promise</span>&lt;<span class="built_in">void</span>&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> emailSender.send(text);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> sendNewsletter(): <span class="built_in">Promise</span>&lt;<span class="built_in">void</span>&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>👍 正例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params"><span class="keyword">private</span> <span class="keyword">readonly</span> db: Database</span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> getUser(id: <span class="built_in">number</span>): <span class="built_in">Promise</span>&lt;User&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> db.users.findOne(&#123; id &#125;)</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> getTransactions(userId: <span class="built_in">number</span>): <span class="built_in">Promise</span>&lt;Transaction[]&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> db.transactions.find(&#123; userId &#125;)</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserNotifier</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params"><span class="keyword">private</span> <span class="keyword">readonly</span> emailSender: EmailSender</span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> sendGreeting(): <span class="built_in">Promise</span>&lt;<span class="built_in">void</span>&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> emailSender.send(<span class="string">&#x27;Welcome!&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> sendNotification(text: <span class="built_in">string</span>): <span class="built_in">Promise</span>&lt;<span class="built_in">void</span>&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> emailSender.send(text);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> sendNewsletter(): <span class="built_in">Promise</span>&lt;<span class="built_in">void</span>&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><a href="#%E7%9B%AE%E5%BD%95">↑ 回到顶部</a></strong></p>
<h3 id="组合大于继承"><a href="#组合大于继承" class="headerlink" title="组合大于继承"></a><a href="#%E7%BB%84%E5%90%88%E5%A4%A7%E4%BA%8E%E7%BB%A7%E6%89%BF"></a>组合大于继承</h3><p>正如“四人帮”在<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Design_Patterns">设计模式</a>中所指出的那样，您尽可能使用组合而不是继承。组合和继承各有优劣。这个准则的主要观点是，如果你潜意识地倾向于继承，试着想想组合是否能更好地给你的问题建模，在某些情况下可以。</p>
<p>什么时候应该使用继承？这取决于你面临的问题。以下场景使用继承更好:</p>
<ol>
<li> 继承代表的是“is-a”关系，而不是“has-a”关系 (人 -&gt; 动物 vs. 用户 -&gt; 用户详情)。</li>
<li> 可复用基类的代码 (人类可以像所有动物一样移动)。</li>
<li> 希望通过更改基类对派生类进行全局更改(改变所有动物在运动时的热量消耗)。</li>
</ol>
<p><strong>👎 反例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Employee</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function"></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">private</span> <span class="keyword">readonly</span> name: <span class="built_in">string</span>,</span></span></span><br><span class="line"><span class="params"><span class="function"></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">private</span> <span class="keyword">readonly</span> email:<span class="built_in">string</span></span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Bad because Employees &quot;have&quot; tax data. EmployeeTaxData is not a type of Employee</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EmployeeTaxData</span> <span class="keyword">extends</span> <span class="title">Employee</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function"></span></span></span><br><span class="line"><span class="params"><span class="function">    name: <span class="built_in">string</span>,</span></span></span><br><span class="line"><span class="params"><span class="function"></span></span></span><br><span class="line"><span class="params"><span class="function">    email:<span class="built_in">string</span>,</span></span></span><br><span class="line"><span class="params"><span class="function"></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">private</span> <span class="keyword">readonly</span> ssn: <span class="built_in">string</span>,</span></span></span><br><span class="line"><span class="params"><span class="function"></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">private</span> <span class="keyword">readonly</span> salary: <span class="built_in">number</span></span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">super</span>(name, email);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>👍 正例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Employee</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> taxData: EmployeeTaxData;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function"></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">private</span> <span class="keyword">readonly</span> name: <span class="built_in">string</span>,</span></span></span><br><span class="line"><span class="params"><span class="function"></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">private</span> <span class="keyword">readonly</span> email:<span class="built_in">string</span></span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  setTaxData(ssn: <span class="built_in">string</span>, <span class="attr">salary</span>: <span class="built_in">number</span>): Employee &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.taxData = <span class="keyword">new</span> EmployeeTaxData(ssn, salary);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EmployeeTaxData</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function"></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">public</span> <span class="keyword">readonly</span> ssn: <span class="built_in">string</span>,</span></span></span><br><span class="line"><span class="params"><span class="function"></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">public</span> <span class="keyword">readonly</span> salary: <span class="built_in">number</span></span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><a href="#%E7%9B%AE%E5%BD%95">↑ 回到顶部</a></strong></p>
<h3 id="使用方法链"><a href="#使用方法链" class="headerlink" title="使用方法链"></a><a href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95%E9%93%BE"></a>使用方法链</h3><p>非常有用的模式，在许多库中都可以看到。它让代码表达力更好，也更简洁。</p>
<p><strong>👎 反例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">QueryBuilder</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> collection: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> pageNumber: <span class="built_in">number</span> = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> itemsPerPage: <span class="built_in">number</span> = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> orderByFields: <span class="built_in">string</span>[] = [];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">from</span>(collection: <span class="built_in">string</span>): <span class="built_in">void</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.collection = collection;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  page(<span class="built_in">number</span>: <span class="built_in">number</span>, <span class="attr">itemsPerPage</span>: <span class="built_in">number</span> = <span class="number">100</span>): <span class="built_in">void</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.pageNumber = <span class="built_in">number</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.itemsPerPage = itemsPerPage;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  orderBy(...fields: <span class="built_in">string</span>[]): <span class="built_in">void</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.orderByFields = fields;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  build(): Query &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> query = <span class="keyword">new</span> QueryBuilder();</span><br><span class="line"></span><br><span class="line">query.from(<span class="string">&#x27;users&#x27;</span>);</span><br><span class="line"></span><br><span class="line">query.page(<span class="number">1</span>, <span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">query.orderBy(<span class="string">&#x27;firstName&#x27;</span>, <span class="string">&#x27;lastName&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> query = queryBuilder.build();</span><br></pre></td></tr></table></figure>

<p><strong>👍 正例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">QueryBuilder</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> collection: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> pageNumber: <span class="built_in">number</span> = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> itemsPerPage: <span class="built_in">number</span> = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> orderByFields: <span class="built_in">string</span>[] = [];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">from</span>(collection: <span class="built_in">string</span>): <span class="built_in">this</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.collection = collection;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  page(<span class="built_in">number</span>: <span class="built_in">number</span>, <span class="attr">itemsPerPage</span>: <span class="built_in">number</span> = <span class="number">100</span>): <span class="built_in">this</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.pageNumber = <span class="built_in">number</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.itemsPerPage = itemsPerPage;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  orderBy(...fields: <span class="built_in">string</span>[]): <span class="built_in">this</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.orderByFields = fields;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  build(): Query &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> query = <span class="keyword">new</span> QueryBuilder()</span><br><span class="line"></span><br><span class="line">  .from(<span class="string">&#x27;users&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  .page(<span class="number">1</span>, <span class="number">100</span>)</span><br><span class="line"></span><br><span class="line">  .orderBy(<span class="string">&#x27;firstName&#x27;</span>, <span class="string">&#x27;lastName&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  .build();</span><br></pre></td></tr></table></figure>

<p><strong><a href="#%E7%9B%AE%E5%BD%95">↑ 回到顶部</a></strong></p>
<h2 id="SOLID原则"><a href="#SOLID原则" class="headerlink" title="SOLID原则"></a><a href="#solid%E5%8E%9F%E5%88%99"></a>SOLID原则</h2><h3 id="单一职责原则-SRP"><a href="#单一职责原则-SRP" class="headerlink" title="单一职责原则 (SRP)"></a><a href="#%E5%8D%95%E4%B8%80%E8%81%8C%E8%B4%A3%E5%8E%9F%E5%88%99-srp"></a>单一职责原则 (SRP)</h3><p>正如 Clean Code 中所述，“类更改的原因不应该超过一个”。将很多功能打包在一个类看起来很诱人，就像在航班上您只能带一个手提箱。这样带来的问题是，在概念上类不具有内聚性，且有很多原因去修改类。而我们应该尽量减少修改类的次数。如果一个类功能太多，修改了其中一处很难确定对代码库中其他依赖模块的影响。</p>
<p><strong>👎 反例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserSettings</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params"><span class="keyword">private</span> <span class="keyword">readonly</span> user: User</span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">changeSettings</span>(<span class="params">settings: UserSettings</span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.verifyCredentials()) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">verifyCredentials</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>👍 正例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserAuth</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params"><span class="keyword">private</span> <span class="keyword">readonly</span> user: User</span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">verifyCredentials</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserSettings</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">readonly</span> auth: UserAuth;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params"><span class="keyword">private</span> <span class="keyword">readonly</span> user: User</span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.auth = <span class="keyword">new</span> UserAuth(user);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">changeSettings</span>(<span class="params">settings: UserSettings</span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.auth.verifyCredentials()) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><a href="#%E7%9B%AE%E5%BD%95">↑ 回到顶部</a></strong></p>
<h3 id="开闭原则-OCP"><a href="#开闭原则-OCP" class="headerlink" title="开闭原则 (OCP)"></a><a href="#%E5%BC%80%E9%97%AD%E5%8E%9F%E5%88%99-ocp"></a>开闭原则 (OCP)</h3><p>正如 Bertrand Meyer 所说，“软件实体(类、模块、函数等)应该对扩展开放，对修改封闭。” 换句话说，就是允许在不更改现有代码的情况下添加新功能。</p>
<p><strong>👎 反例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AjaxAdapter</span> <span class="keyword">extends</span> <span class="title">Adapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">super</span>();</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NodeAdapter</span> <span class="keyword">extends</span> <span class="title">Adapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">super</span>();</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HttpRequester</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params"><span class="keyword">private</span> <span class="keyword">readonly</span> adapter: Adapter</span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> fetch&lt;T&gt;(url: <span class="built_in">string</span>): <span class="built_in">Promise</span>&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.adapter <span class="keyword">instanceof</span> AjaxAdapter) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> response = <span class="keyword">await</span> makeAjaxCall&lt;T&gt;(url);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// transform response and return</span></span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.adapter <span class="keyword">instanceof</span> NodeAdapter) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> response = <span class="keyword">await</span> makeHttpCall&lt;T&gt;(url);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// transform response and return</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeAjaxCall</span>&lt;<span class="title">T</span>&gt;(<span class="params">url: <span class="built_in">string</span></span>): <span class="title">Promise</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// request and return promise</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeHttpCall</span>&lt;<span class="title">T</span>&gt;(<span class="params">url: <span class="built_in">string</span></span>): <span class="title">Promise</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// request and return promise</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>👍 正例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Adapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">abstract</span> <span class="keyword">async</span> request&lt;T&gt;(url: <span class="built_in">string</span>): <span class="built_in">Promise</span>&lt;T&gt;;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AjaxAdapter</span> <span class="keyword">extends</span> <span class="title">Adapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">super</span>();</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> request&lt;T&gt;(url: <span class="built_in">string</span>): <span class="built_in">Promise</span>&lt;T&gt;&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// request and return promise</span></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NodeAdapter</span> <span class="keyword">extends</span> <span class="title">Adapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">super</span>();</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> request&lt;T&gt;(url: <span class="built_in">string</span>): <span class="built_in">Promise</span>&lt;T&gt;&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// request and return promise</span></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HttpRequester</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params"><span class="keyword">private</span> <span class="keyword">readonly</span> adapter: Adapter</span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> fetch&lt;T&gt;(url: <span class="built_in">string</span>): <span class="built_in">Promise</span>&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="built_in">this</span>.adapter.request&lt;T&gt;(url);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// transform response and return</span></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><a href="#%E7%9B%AE%E5%BD%95">↑ 回到顶部</a></strong></p>
<h3 id="里氏替换原则-LSP"><a href="#里氏替换原则-LSP" class="headerlink" title="里氏替换原则 (LSP)"></a><a href="#%E9%87%8C%E6%B0%8F%E6%9B%BF%E6%8D%A2%E5%8E%9F%E5%88%99-lsp"></a>里氏替换原则 (LSP)</h3><p>对一个非常简单的概念来说，这是个可怕的术语。</p>
<p>它的正式定义是：“如果 S 是 T 的一个子类型，那么类型 T 的对象可以被替换为类型 S 的对象，而不会改变程序任何期望的属性(正确性、执行的任务等)“。这是一个更可怕的定义。</p>
<p>更好的解释是，如果您有一个父类和一个子类，那么父类和子类可以互换使用，而不会出现问题。这可能仍然令人困惑，所以让我们看一看经典的正方形矩形的例子。从数学上讲，正方形是矩形，但是如果您通过继承使用 “is-a” 关系对其建模，您很快就会遇到麻烦。</p>
<p><strong>👎 反例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Rectangle</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function"></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">protected</span> width: <span class="built_in">number</span> = <span class="number">0</span>,</span></span></span><br><span class="line"><span class="params"><span class="function"></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">protected</span> height: <span class="built_in">number</span> = <span class="number">0</span></span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">setColor</span>(<span class="params">color: <span class="built_in">string</span></span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params">area: <span class="built_in">number</span></span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">setWidth</span>(<span class="params">width: <span class="built_in">number</span></span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.width = width;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">setHeight</span>(<span class="params">height: <span class="built_in">number</span></span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.height = height;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  getArea(): <span class="built_in">number</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.width * <span class="built_in">this</span>.height;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Square</span> <span class="keyword">extends</span> <span class="title">Rectangle</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">setWidth</span>(<span class="params">width: <span class="built_in">number</span></span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.width = width;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.height = width;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">setHeight</span>(<span class="params">height: <span class="built_in">number</span></span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.width = height;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.height = height;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">renderLargeRectangles</span>(<span class="params">rectangles: Rectangle[]</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  rectangles.forEach(<span class="function">(<span class="params">rectangle</span>) =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">    rectangle.setWidth(<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">    rectangle.setHeight(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> area = rectangle.getArea(); <span class="comment">// BAD: Returns 25 for Square. Should be 20.</span></span><br><span class="line"></span><br><span class="line">    rectangle.render(area);</span><br><span class="line"></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> rectangles = [<span class="keyword">new</span> Rectangle(), <span class="keyword">new</span> Rectangle(), <span class="keyword">new</span> Square()];</span><br><span class="line"></span><br><span class="line">renderLargeRectangles(rectangles);</span><br></pre></td></tr></table></figure>

<p><strong>👍 正例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Shape</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">setColor</span>(<span class="params">color: <span class="built_in">string</span></span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params">area: <span class="built_in">number</span></span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">abstract</span> getArea(): <span class="built_in">number</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Rectangle</span> <span class="keyword">extends</span> <span class="title">Shape</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function"></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">private</span> <span class="keyword">readonly</span> width = <span class="number">0</span>,</span></span></span><br><span class="line"><span class="params"><span class="function"></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">private</span> <span class="keyword">readonly</span> height = <span class="number">0</span></span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">super</span>();</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  getArea(): <span class="built_in">number</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.width * <span class="built_in">this</span>.height;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Square</span> <span class="keyword">extends</span> <span class="title">Shape</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params"><span class="keyword">private</span> <span class="keyword">readonly</span> length: <span class="built_in">number</span></span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">super</span>();</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  getArea(): <span class="built_in">number</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.length * <span class="built_in">this</span>.length;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">renderLargeShapes</span>(<span class="params">shapes: Shape[]</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  shapes.forEach(<span class="function">(<span class="params">shape</span>) =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> area = shape.getArea();</span><br><span class="line"></span><br><span class="line">    shape.render(area);</span><br><span class="line"></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> shapes = [<span class="keyword">new</span> Rectangle(<span class="number">4</span>, <span class="number">5</span>), <span class="keyword">new</span> Rectangle(<span class="number">4</span>, <span class="number">5</span>), <span class="keyword">new</span> Square(<span class="number">5</span>)];</span><br><span class="line"></span><br><span class="line">renderLargeShapes(shapes);</span><br></pre></td></tr></table></figure>

<p><strong><a href="#%E7%9B%AE%E5%BD%95">↑ 回到顶部</a></strong></p>
<h3 id="接口隔离原则-ISP"><a href="#接口隔离原则-ISP" class="headerlink" title="接口隔离原则 (ISP)"></a><a href="#%E6%8E%A5%E5%8F%A3%E9%9A%94%E7%A6%BB%E5%8E%9F%E5%88%99-isp"></a>接口隔离原则 (ISP)</h3><p>“客户不应该被迫依赖于他们不使用的接口。” 这一原则与单一责任原则密切相关。这意味着不应该设计一个大而全的抽象，否则会增加客户的负担，因为他们需要实现一些不需要的方法。</p>
<p><strong>👎 反例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> ISmartPrinter &#123;</span><br><span class="line"></span><br><span class="line">  print();</span><br><span class="line"></span><br><span class="line">  fax();</span><br><span class="line"></span><br><span class="line">  scan();</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AllInOnePrinter</span> <span class="title">implements</span> <span class="title">ISmartPrinter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">print</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">fax</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">scan</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EconomicPrinter</span> <span class="title">implements</span> <span class="title">ISmartPrinter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">print</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">fax</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&#x27;Fax not supported.&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">scan</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&#x27;Scan not supported.&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>👍 正例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> IPrinter &#123;</span><br><span class="line"></span><br><span class="line">  print();</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> IFax &#123;</span><br><span class="line"></span><br><span class="line">  fax();</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> IScanner &#123;</span><br><span class="line"></span><br><span class="line">  scan();</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AllInOnePrinter</span> <span class="title">implements</span> <span class="title">IPrinter</span>, <span class="title">IFax</span>, <span class="title">IScanner</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">print</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">fax</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">scan</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EconomicPrinter</span> <span class="title">implements</span> <span class="title">IPrinter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">print</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><a href="#%E7%9B%AE%E5%BD%95">↑ 回到顶部</a></strong></p>
<h3 id="依赖反转原则-Dependency-Inversion-Principle"><a href="#依赖反转原则-Dependency-Inversion-Principle" class="headerlink" title="依赖反转原则(Dependency Inversion Principle)"></a><a href="#%E4%BE%9D%E8%B5%96%E5%8F%8D%E8%BD%AC%E5%8E%9F%E5%88%99dependency-inversion-principle"></a>依赖反转原则(Dependency Inversion Principle)</h3><p>这个原则有两个要点:</p>
<ol>
<li> 高层模块不应该依赖于低层模块，两者都应该依赖于抽象。</li>
<li> 抽象不依赖实现，实现应依赖抽象。</li>
</ol>
<p>一开始这难以理解，但是如果你使用过 Angular，你就会看到以依赖注入(DI)的方式实现了这一原则。虽然概念不同，但是 DIP 阻止高级模块了解其低级模块的细节并进行设置。它可以通过 DI 实现这一点。这样做的一个巨大好处是减少了模块之间的耦合。耦合非常糟糕，它让代码难以重构。</p>
<p>DIP 通常是通过使用控制反转(IoC)容器来实现的。比如：TypeScript 的 IoC 容器 <a target="_blank" rel="noopener" href="https://www.npmjs.com/package/inversify">InversifyJs</a></p>
<p><strong>👎 反例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; readFile <span class="keyword">as</span> readFileCb &#125; <span class="keyword">from</span> <span class="string">&#x27;fs&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; promisify &#125; <span class="keyword">from</span> <span class="string">&#x27;util&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> readFile = promisify(readFileCb);</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> ReportData = &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ..</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">XmlFormatter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  parse&lt;T&gt;(content: <span class="built_in">string</span>): T &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Converts an XML string to an object T</span></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReportReader</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// BAD: We have created a dependency on a specific request implementation.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// We should just have ReportReader depend on a parse method: `parse`</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">readonly</span> formatter = <span class="keyword">new</span> XmlFormatter();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> read(path: <span class="built_in">string</span>): <span class="built_in">Promise</span>&lt;ReportData&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> text = <span class="keyword">await</span> readFile(path, <span class="string">&#x27;UTF8&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.formatter.parse&lt;ReportData&gt;(text);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> reader = <span class="keyword">new</span> ReportReader();</span><br><span class="line"></span><br><span class="line"><span class="keyword">await</span> report = <span class="keyword">await</span> reader.read(<span class="string">&#x27;report.xml&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p><strong>👍 正例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; readFile <span class="keyword">as</span> readFileCb &#125; <span class="keyword">from</span> <span class="string">&#x27;fs&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; promisify &#125; <span class="keyword">from</span> <span class="string">&#x27;util&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> readFile = promisify(readFileCb);</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> ReportData = &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ..</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> Formatter &#123;</span><br><span class="line"></span><br><span class="line">  parse&lt;T&gt;(content: <span class="built_in">string</span>): T;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">XmlFormatter</span> <span class="title">implements</span> <span class="title">Formatter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  parse&lt;T&gt;(content: <span class="built_in">string</span>): T &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Converts an XML string to an object T</span></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">JsonFormatter</span> <span class="title">implements</span> <span class="title">Formatter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  parse&lt;T&gt;(content: <span class="built_in">string</span>): T &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Converts a JSON string to an object T</span></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReportReader</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params"><span class="keyword">private</span> <span class="keyword">readonly</span> formatter: Formatter</span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> read(path: <span class="built_in">string</span>): <span class="built_in">Promise</span>&lt;ReportData&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> text = <span class="keyword">await</span> readFile(path, <span class="string">&#x27;UTF8&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.formatter.parse&lt;ReportData&gt;(text);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> reader = <span class="keyword">new</span> ReportReader(<span class="keyword">new</span> XmlFormatter());</span><br><span class="line"></span><br><span class="line"><span class="keyword">await</span> report = <span class="keyword">await</span> reader.read(<span class="string">&#x27;report.xml&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// or if we had to read a json report:</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> reader = <span class="keyword">new</span> ReportReader(<span class="keyword">new</span> JsonFormatter());</span><br><span class="line"></span><br><span class="line"><span class="keyword">await</span> report = <span class="keyword">await</span> reader.read(<span class="string">&#x27;report.json&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p><strong><a href="#%E7%9B%AE%E5%BD%95">↑ 回到顶部</a></strong></p>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a><a href="#%E6%B5%8B%E8%AF%95"></a>测试</h2><p>测试比发货更重要。如果没有测试或数量不足，那么每次发布代码时都无法确保不引入问题。怎样才算是足够的测试？这取决于团队，但是拥有100%的覆盖率(所有语句和分支)会让团队更有信心。这一切都要基于好的测试框架以及<a target="_blank" rel="noopener" href="https://github.com/gotwarlost/istanbul">覆盖率工具</a>。</p>
<p>没有任何理由不编写测试。有<a target="_blank" rel="noopener" href="http://jstherightway.org/#testing-tools">很多优秀的 JS 测试框架</a>都支持 TypeScript，找个团队喜欢的。然后为每个新特性/模块编写测试。如果您喜欢测试驱动开发(TDD)，那就太好了，重点是确保在开发任何特性或重构现有特性之前，代码覆盖率已经达到要求。</p>
<h3 id="TDD（测试驱动开发）三定律"><a href="#TDD（测试驱动开发）三定律" class="headerlink" title="TDD（测试驱动开发）三定律"></a><a href="#tdd%E6%B5%8B%E8%AF%95%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91%E4%B8%89%E5%AE%9A%E5%BE%8B"></a>TDD（测试驱动开发）三定律</h3><ol>
<li> 在编写不能通过的单元测试前，不可编写生产代码。</li>
<li> 只可编写刚好无法通过的单元测试，不能编译也算不过。</li>
<li> 只可编写刚好足以通过当前失败测试的生产代码。</li>
</ol>
<p><strong><a href="#%E7%9B%AE%E5%BD%95">↑ 回到顶部</a></strong></p>
<h3 id="F-I-R-S-T-准则"><a href="#F-I-R-S-T-准则" class="headerlink" title="F.I.R.S.T.准则"></a><a href="#first%E5%87%86%E5%88%99"></a>F.I.R.S.T.准则</h3><p>整洁的测试应遵循以下准则:</p>
<ul>
<li>  <strong>快速</strong>（Fast），测试应该快（及时反馈出业务代码的问题）。</li>
<li>  <strong>独立</strong>（Independent），每个测试流程应该独立。</li>
<li>  <strong>可重复</strong>（Repeatable），测试应该在任何环境上都能重复通过。</li>
<li>  <strong>自我验证</strong>（Self-Validating），测试结果应该明确<em>通过</em>或者<em>失败</em>。</li>
<li>  <strong>及时</strong>（Timely），测试代码应该在产品代码之前编写。</li>
</ul>
<p><strong><a href="#%E7%9B%AE%E5%BD%95">↑ 回到顶部</a></strong></p>
<h3 id="单一的测试每个概念"><a href="#单一的测试每个概念" class="headerlink" title="单一的测试每个概念"></a><a href="#%E5%8D%95%E4%B8%80%E7%9A%84%E6%B5%8B%E8%AF%95%E6%AF%8F%E4%B8%AA%E6%A6%82%E5%BF%B5"></a>单一的测试每个概念</h3><p>测试也应该遵循<em>单一职责原则</em>，每个单元测试只做一个断言。</p>
<p><strong>👎 反例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; assert &#125; <span class="keyword">from</span> <span class="string">&#x27;chai&#x27;</span>;</span><br><span class="line"></span><br><span class="line">describe(<span class="string">&#x27;AwesomeDate&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">  it(<span class="string">&#x27;handles date boundaries&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> date: AwesomeDate;</span><br><span class="line"></span><br><span class="line">    date = <span class="keyword">new</span> AwesomeDate(<span class="string">&#x27;1/1/2015&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    date.addDays(<span class="number">30</span>);</span><br><span class="line"></span><br><span class="line">    assert.equal(<span class="string">&#x27;1/31/2015&#x27;</span>, date);</span><br><span class="line"></span><br><span class="line">    date = <span class="keyword">new</span> AwesomeDate(<span class="string">&#x27;2/1/2016&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    date.addDays(<span class="number">28</span>);</span><br><span class="line"></span><br><span class="line">    assert.equal(<span class="string">&#x27;02/29/2016&#x27;</span>, date);</span><br><span class="line"></span><br><span class="line">    date = <span class="keyword">new</span> AwesomeDate(<span class="string">&#x27;2/1/2015&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    date.addDays(<span class="number">28</span>);</span><br><span class="line"></span><br><span class="line">    assert.equal(<span class="string">&#x27;03/01/2015&#x27;</span>, date);</span><br><span class="line"></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><strong>👍 正例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; assert &#125; <span class="keyword">from</span> <span class="string">&#x27;chai&#x27;</span>;</span><br><span class="line"></span><br><span class="line">describe(<span class="string">&#x27;AwesomeDate&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">  it(<span class="string">&#x27;handles 30-day months&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> date = <span class="keyword">new</span> AwesomeDate(<span class="string">&#x27;1/1/2015&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    date.addDays(<span class="number">30</span>);</span><br><span class="line"></span><br><span class="line">    assert.equal(<span class="string">&#x27;1/31/2015&#x27;</span>, date);</span><br><span class="line"></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  it(<span class="string">&#x27;handles leap year&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> date = <span class="keyword">new</span> AwesomeDate(<span class="string">&#x27;2/1/2016&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    date.addDays(<span class="number">28</span>);</span><br><span class="line"></span><br><span class="line">    assert.equal(<span class="string">&#x27;02/29/2016&#x27;</span>, date);</span><br><span class="line"></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  it(<span class="string">&#x27;handles non-leap year&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> date = <span class="keyword">new</span> AwesomeDate(<span class="string">&#x27;2/1/2015&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    date.addDays(<span class="number">28</span>);</span><br><span class="line"></span><br><span class="line">    assert.equal(<span class="string">&#x27;03/01/2015&#x27;</span>, date);</span><br><span class="line"></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><strong><a href="#%E7%9B%AE%E5%BD%95">↑ 回到顶部</a></strong></p>
<h3 id="测试用例名称应该显示它的意图"><a href="#测试用例名称应该显示它的意图" class="headerlink" title="测试用例名称应该显示它的意图"></a><a href="#%E6%B5%8B%E8%AF%95%E7%94%A8%E4%BE%8B%E5%90%8D%E7%A7%B0%E5%BA%94%E8%AF%A5%E6%98%BE%E7%A4%BA%E5%AE%83%E7%9A%84%E6%84%8F%E5%9B%BE"></a>测试用例名称应该显示它的意图</h3><p>当测试失败时，出错的第一个迹象可能就是它的名字。</p>
<p><strong>👎 反例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">describe(<span class="string">&#x27;Calendar&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">  it(<span class="string">&#x27;2/29/2020&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  it(<span class="string">&#x27;throws&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><strong>👍 正例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">describe(<span class="string">&#x27;Calendar&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">  it(<span class="string">&#x27;should handle leap year&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  it(<span class="string">&#x27;should throw when format is invalid&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><strong><a href="#%E7%9B%AE%E5%BD%95">↑ 回到顶部</a></strong></p>
<h2 id="并发"><a href="#并发" class="headerlink" title="并发"></a><a href="#%E5%B9%B6%E5%8F%91"></a>并发</h2><h3 id="用-Promises-替代回调"><a href="#用-Promises-替代回调" class="headerlink" title="用 Promises 替代回调"></a><a href="#%E7%94%A8-promises-%E6%9B%BF%E4%BB%A3%E5%9B%9E%E8%B0%83"></a>用 Promises 替代回调</h3><p>回调不够整洁而且会导致过多的嵌套*(回调地狱)*。</p>
<p>有些工具使用回调的方式将现有函数转换为 promise 对象：</p>
<ul>
<li>  Node.js 参见<a target="_blank" rel="noopener" href="https://nodejs.org/dist/latest-v8.x/docs/api/util.html#util_util_promisify_original"><code>util.promisify</code></a></li>
<li>  通用参见 <a target="_blank" rel="noopener" href="https://www.npmjs.com/package/pify">pify</a>, <a target="_blank" rel="noopener" href="https://www.npmjs.com/package/es6-promisify">es6-promisify</a></li>
</ul>
<p><strong>👎 反例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; get &#125; <span class="keyword">from</span> <span class="string">&#x27;request&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; writeFile &#125; <span class="keyword">from</span> <span class="string">&#x27;fs&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">downloadPage</span>(<span class="params">url: <span class="built_in">string</span>, saveTo: <span class="built_in">string</span>, callback: (error: <span class="built_in">Error</span>, content?: <span class="built_in">string</span>) =&gt; <span class="built_in">void</span></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">  get(url, <span class="function">(<span class="params">error, response</span>) =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (error) &#123;</span><br><span class="line"></span><br><span class="line">      callback(error);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">      writeFile(saveTo, response.body, <span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (error) &#123;</span><br><span class="line"></span><br><span class="line">          callback(error);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">          callback(<span class="literal">null</span>, response.body);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">downloadPage(<span class="string">&#x27;https://en.wikipedia.org/wiki/Robert_Cecil_Martin&#x27;</span>, <span class="string">&#x27;article.html&#x27;</span>, <span class="function">(<span class="params">error, content</span>) =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (error) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.error(error);</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(content);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><strong>👍 正例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; get &#125; <span class="keyword">from</span> <span class="string">&#x27;request&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; writeFile &#125; <span class="keyword">from</span> <span class="string">&#x27;fs&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; promisify &#125; <span class="keyword">from</span> <span class="string">&#x27;util&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> write = promisify(writeFile);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">downloadPage</span>(<span class="params">url: <span class="built_in">string</span>, saveTo: <span class="built_in">string</span></span>): <span class="title">Promise</span>&lt;<span class="title">string</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> get(url)</span><br><span class="line"></span><br><span class="line">    .then(<span class="function"><span class="params">response</span> =&gt;</span> write(saveTo, response))</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">downloadPage(<span class="string">&#x27;https://en.wikipedia.org/wiki/Robert_Cecil_Martin&#x27;</span>, <span class="string">&#x27;article.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  .then(<span class="function"><span class="params">content</span> =&gt;</span> <span class="built_in">console</span>.log(content))</span><br><span class="line"></span><br><span class="line">  .catch(<span class="function"><span class="params">error</span> =&gt;</span> <span class="built_in">console</span>.error(error));</span><br></pre></td></tr></table></figure>

<p>Promise 提供了一些辅助方法，能让代码更简洁：</p>
<table>
<thead>
<tr>
<th>方法</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>Promise.resolve(value)</code></td>
<td>返回一个传入值解析后的 promise 。</td>
</tr>
<tr>
<td><code>Promise.reject(error)</code></td>
<td>返回一个带有拒绝原因的 promise 。</td>
</tr>
<tr>
<td><code>Promise.all(promises)</code></td>
<td>返回一个新的 promise，传入数组中的<strong>每个</strong> promise 都执行完成后返回的 promise 才算完成，或第一个 promise 拒绝而拒绝。</td>
</tr>
<tr>
<td><code>Promise.race(promises)</code></td>
<td>返回一个新的 promise，传入数组中的<strong>某个</strong> promise 解决或拒绝，返回的 promise 就会解决或拒绝。</td>
</tr>
</tbody></table>
<p><code>Promise.all</code>在并行运行任务时尤其有用，<code>Promise.race</code>让为 Promise 更容易实现超时。</p>
<p><strong><a href="#%E7%9B%AE%E5%BD%95">↑ 回到顶部</a></strong></p>
<h3 id="Async-Await-比-Promises-更好"><a href="#Async-Await-比-Promises-更好" class="headerlink" title="Async/Await 比 Promises 更好"></a><a href="#asyncawait-%E6%AF%94-promises-%E6%9B%B4%E5%A5%BD"></a><code>Async/Await</code> 比 <code>Promises</code> 更好</h3><p>使用<code>async</code>/<code>await</code>语法，可以编写更简洁、更易理解的链式 promise 的代码。一个函数使用<code>async</code>关键字作为前缀，JavaScript 运行时会暂停<code>await</code>关键字上的代码执行(当使用 promise 时)。</p>
<p><strong>👎 反例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; get &#125; <span class="keyword">from</span> <span class="string">&#x27;request&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; writeFile &#125; <span class="keyword">from</span> <span class="string">&#x27;fs&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; promisify &#125; <span class="keyword">from</span> <span class="string">&#x27;util&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> write = util.promisify(writeFile);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">downloadPage</span>(<span class="params">url: <span class="built_in">string</span>, saveTo: <span class="built_in">string</span></span>): <span class="title">Promise</span>&lt;<span class="title">string</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> get(url).then(<span class="function"><span class="params">response</span> =&gt;</span> write(saveTo, response))</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">downloadPage(<span class="string">&#x27;https://en.wikipedia.org/wiki/Robert_Cecil_Martin&#x27;</span>, <span class="string">&#x27;article.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  .then(<span class="function"><span class="params">content</span> =&gt;</span> <span class="built_in">console</span>.log(content))</span><br><span class="line"></span><br><span class="line">  .catch(<span class="function"><span class="params">error</span> =&gt;</span> <span class="built_in">console</span>.error(error));</span><br></pre></td></tr></table></figure>

<p><strong>👍 正例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; get &#125; <span class="keyword">from</span> <span class="string">&#x27;request&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; writeFile &#125; <span class="keyword">from</span> <span class="string">&#x27;fs&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; promisify &#125; <span class="keyword">from</span> <span class="string">&#x27;util&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> write = promisify(writeFile);</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">downloadPage</span>(<span class="params">url: <span class="built_in">string</span>, saveTo: <span class="built_in">string</span></span>): <span class="title">Promise</span>&lt;<span class="title">string</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> response = <span class="keyword">await</span> get(url);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">await</span> write(saveTo, response);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> response;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// somewhere in an async function</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> content = <span class="keyword">await</span> downloadPage(<span class="string">&#x27;https://en.wikipedia.org/wiki/Robert_Cecil_Martin&#x27;</span>, <span class="string">&#x27;article.html&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">console</span>.log(content);</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">console</span>.error(error);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><a href="#%E7%9B%AE%E5%BD%95">↑ 回到顶部</a></strong></p>
<h2 id="错误处理"><a href="#错误处理" class="headerlink" title="错误处理"></a><a href="#%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86"></a>错误处理</h2><p>抛出错误是件好事！它表示着运行时已经成功识别出程序中的错误，通过停止当前堆栈上的函数执行，终止进程(在Node.js)，以及在控制台中打印堆栈信息来让你知晓。</p>
<h3 id="抛出Error或-使用reject"><a href="#抛出Error或-使用reject" class="headerlink" title="抛出Error或 使用reject"></a><a href="#%E6%8A%9B%E5%87%BAerror%E6%88%96-%E4%BD%BF%E7%94%A8reject"></a>抛出<code>Error</code>或 使用<code>reject</code></h3><p>JavaScript 和 TypeScript 允许你 <code>throw</code> 任何对象。Promise 也可以用任何理由对象拒绝。</p>
<p>建议使用 <code>Error</code> 类型的 <code>throw</code> 语法。因为你的错误可能在写有 <code>catch</code>语法的高级代码中被捕获。在那里捕获字符串消息显得非常混乱，并且会使<a target="_blank" rel="noopener" href="https://basarat.gitbooks.io/typescript/docs/types/exceptions.html#always-use-error">调试更加痛苦</a>。出于同样的原因，也应该在拒绝 promise 时使用 <code>Error</code> 类型。</p>
<p><strong>👎 反例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">calculateTotal</span>(<span class="params">items: Item[]</span>): <span class="title">number</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">throw</span> <span class="string">&#x27;Not implemented.&#x27;</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params"></span>): <span class="title">Promise</span>&lt;<span class="title">Item</span>[]&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Promise</span>.reject(<span class="string">&#x27;Not implemented.&#x27;</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>👍 正例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">calculateTotal</span>(<span class="params">items: Item[]</span>): <span class="title">number</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&#x27;Not implemented.&#x27;</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params"></span>): <span class="title">Promise</span>&lt;<span class="title">Item</span>[]&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Promise</span>.reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&#x27;Not implemented.&#x27;</span>));</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// or equivalent to:</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params"></span>): <span class="title">Promise</span>&lt;<span class="title">Item</span>[]&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&#x27;Not implemented.&#x27;</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用 <code>Error</code> 类型的好处是 <code>try/catch/finally</code> 语法支持它，并且隐式地所有错误都具有 <code>stack</code> 属性，该属性对于调试非常有用。</p>
<p>另外，即使不用 <code>throw</code> 语法而是返回自定义错误对象，TypeScript在这块更容易。考虑下面的例子:</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Failable&lt;R, E&gt; = &#123;</span><br><span class="line"></span><br><span class="line">  <span class="attr">isError</span>: <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">  error: E;</span><br><span class="line"></span><br><span class="line">&#125; | &#123;</span><br><span class="line"></span><br><span class="line">  <span class="attr">isError</span>: <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  value: R;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">calculateTotal</span>(<span class="params">items: Item[]</span>): <span class="title">Failable</span>&lt;<span class="title">number</span>, &#x27;<span class="title">empty</span>&#x27;&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (items.length === <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">isError</span>: <span class="literal">true</span>, <span class="attr">error</span>: <span class="string">&#x27;empty&#x27;</span> &#125;;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">isError</span>: <span class="literal">false</span>, <span class="attr">value</span>: <span class="number">42</span> &#125;;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>详细解释请参考<a target="_blank" rel="noopener" href="https://medium.com/@dhruvrajvanshi/making-exceptions-type-safe-in-typescript-c4d200ee78e9">原文</a>。</p>
<p><strong><a href="#%E7%9B%AE%E5%BD%95">↑ 回到顶部</a></strong></p>
<h3 id="别忘了捕获错误"><a href="#别忘了捕获错误" class="headerlink" title="别忘了捕获错误"></a><a href="#%E5%88%AB%E5%BF%98%E4%BA%86%E6%8D%95%E8%8E%B7%E9%94%99%E8%AF%AF"></a>别忘了捕获错误</h3><p>捕获错误而不处理实际上也是没有修复错误，将错误记录到控制台(console.log）也好不到哪里去，因为它常常丢失在控制台大量的日志之中。如果将代码写在<code>try/catch</code> 中，说明那里可能会发生错误，因此应该考虑在错误发生时做一些处理。</p>
<p><strong>👎 反例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">  functionThatMightThrow();</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">console</span>.log(error);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// or even worse</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">  functionThatMightThrow();</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ignore error</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>👍 正例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; logger &#125; <span class="keyword">from</span> <span class="string">&#x27;./logging&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">  functionThatMightThrow();</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line"></span><br><span class="line">  logger.log(error);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><a href="#%E7%9B%AE%E5%BD%95">↑ 回到顶部</a></strong></p>
<h3 id="不要忽略被拒绝的-promises"><a href="#不要忽略被拒绝的-promises" class="headerlink" title="不要忽略被拒绝的 promises"></a><a href="#%E4%B8%8D%E8%A6%81%E5%BF%BD%E7%95%A5%E8%A2%AB%E6%8B%92%E7%BB%9D%E7%9A%84-promises"></a>不要忽略被拒绝的 promises</h3><p>理由和不能在<code>try/catch</code>中忽略<code>Error</code>一样。</p>
<p><strong>👎 反例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">getUser()</span><br><span class="line"></span><br><span class="line">  .then(<span class="function">(<span class="params">user: User</span>) =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> sendEmail(user.email, <span class="string">&#x27;Welcome!&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  .catch(<span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(error);</span><br><span class="line"></span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<p><strong>👍 正例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; logger &#125; <span class="keyword">from</span> <span class="string">&#x27;./logging&#x27;</span></span><br><span class="line"></span><br><span class="line">getUser()</span><br><span class="line"></span><br><span class="line">  .then(<span class="function">(<span class="params">user: User</span>) =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> sendEmail(user.email, <span class="string">&#x27;Welcome!&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  .catch(<span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">    logger.log(error);</span><br><span class="line"></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// or using the async/await syntax:</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> user = <span class="keyword">await</span> getUser();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">await</span> sendEmail(user.email, <span class="string">&#x27;Welcome!&#x27;</span>);</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line"></span><br><span class="line">  logger.log(error);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><a href="#%E7%9B%AE%E5%BD%95">↑ 回到顶部</a></strong></p>
<h2 id="格式化"><a href="#格式化" class="headerlink" title="格式化"></a><a href="#%E6%A0%BC%E5%BC%8F%E5%8C%96"></a>格式化</h2><p>就像这里的许多规则一样，没有什么是硬性规定，格式化也是。重点是<strong>不要争论</strong>格式，使用自动化工具实现格式化。对于工程师来说，争论格式就是浪费时间和金钱。通用的原则是<em>保持一致的格式规则</em>。</p>
<p>对于 TypeScript ，有一个强大的工具叫做 TSLint。它是一个静态分析工具，可以帮助您显著提高代码的可读性和可维护性。项目中使用可以参考以下 TSLint 配置:</p>
<ul>
<li><p>  <a target="_blank" rel="noopener" href="https://www.npmjs.com/package/tslint-config-standard">TSLint Config Standard</a> - 标准格式规则</p>
</li>
<li><p>  <a target="_blank" rel="noopener" href="https://www.npmjs.com/package/tslint-config-airbnb">TSLint Config Airbnb</a> - Airbnb 格式规则</p>
</li>
<li><p>  <a target="_blank" rel="noopener" href="https://www.npmjs.com/package/tslint-clean-code">TSLint Clean Code</a> - 灵感来自于<a target="_blank" rel="noopener" href="https://www.amazon.ca/Clean-Code-Handbook-Software-Craftsmanship/dp/0132350882">Clean Code: A Handbook of Agile Software Craftsmanship</a> 的 TSLint 规则。</p>
</li>
<li><p>  <a target="_blank" rel="noopener" href="https://www.npmjs.com/package/tslint-react">TSLint react</a> - React 相关的Lint规则</p>
</li>
<li><p>  <a target="_blank" rel="noopener" href="https://www.npmjs.com/package/tslint-config-prettier">TSLint + Prettier</a> - <a target="_blank" rel="noopener" href="https://github.com/prettier/prettier">Prettier</a> 代码格式化相关的 lint 规则</p>
</li>
<li><p>  <a target="_blank" rel="noopener" href="https://www.npmjs.com/package/tslint-eslint-rules">ESLint rules for TSLint</a> - TypeScript 的 ESLint</p>
</li>
<li><p>  <a target="_blank" rel="noopener" href="https://www.npmjs.com/package/tslint-immutable">Immutable</a> - 在 TypeScript 中禁用 mutation 的规则</p>
</li>
</ul>
<p>还可以参考<a target="_blank" rel="noopener" href="https://basarat.gitbooks.io/typescript/docs/styleguide/styleguide.html">TypeScript 风格指南和编码约定</a>的源代码。</p>
<h3 id="大小写一致"><a href="#大小写一致" class="headerlink" title="大小写一致"></a><a href="#%E5%A4%A7%E5%B0%8F%E5%86%99%E4%B8%80%E8%87%B4"></a>大小写一致</h3><p>大写可以告诉你很多关于变量、函数等的信息。这些都是主观规则，由你的团队做选择。关键是无论怎么选，都要<em>一致</em>。</p>
<p><strong>👎 反例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> DAYS_IN_WEEK = <span class="number">7</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> daysInMonth = <span class="number">30</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> songs = [<span class="string">&#x27;Back In Black&#x27;</span>, <span class="string">&#x27;Stairway to Heaven&#x27;</span>, <span class="string">&#x27;Hey Jude&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Artists = [<span class="string">&#x27;ACDC&#x27;</span>, <span class="string">&#x27;Led Zeppelin&#x27;</span>, <span class="string">&#x27;The Beatles&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">eraseDatabase</span>(<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">restore_database</span>(<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">animal</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Container</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>

<p><strong>👍 正例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> DAYS_IN_WEEK = <span class="number">7</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> DAYS_IN_MONTH = <span class="number">30</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> SONGS = [<span class="string">&#x27;Back In Black&#x27;</span>, <span class="string">&#x27;Stairway to Heaven&#x27;</span>, <span class="string">&#x27;Hey Jude&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ARTISTS = [<span class="string">&#x27;ACDC&#x27;</span>, <span class="string">&#x27;Led Zeppelin&#x27;</span>, <span class="string">&#x27;The Beatles&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">eraseDatabase</span>(<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">restoreDatabase</span>(<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Animal</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Container</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>

<p>类名、接口名、类型名和命名空间名最好使用“帕斯卡命名”。</p>
<p>变量、函数和类成员使用“驼峰式命名”。</p>
<p><strong><a href="#%E7%9B%AE%E5%BD%95">↑ 回到顶部</a></strong></p>
<h3 id="调用函数的函数和被调函数应靠近放置"><a href="#调用函数的函数和被调函数应靠近放置" class="headerlink" title="调用函数的函数和被调函数应靠近放置"></a><a href="#%E8%B0%83%E7%94%A8%E5%87%BD%E6%95%B0%E7%9A%84%E5%87%BD%E6%95%B0%E5%92%8C%E8%A2%AB%E8%B0%83%E5%87%BD%E6%95%B0%E5%BA%94%E9%9D%A0%E8%BF%91%E6%94%BE%E7%BD%AE"></a>调用函数的函数和被调函数应靠近放置</h3><p>当函数间存在相互调用的情况时，应将两者靠近放置。最好是应将调用者写在被调者的上方。这就像读报纸一样，我们都是从上往下读，那么读代码也是。</p>
<p><strong>👎 反例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PerformanceReview</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params"><span class="keyword">private</span> <span class="keyword">readonly</span> employee: Employee</span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="title">lookupPeers</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> db.lookup(<span class="built_in">this</span>.employee.id, <span class="string">&#x27;peers&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="title">lookupManager</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> db.lookup(<span class="built_in">this</span>.employee, <span class="string">&#x27;manager&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="title">getPeerReviews</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> peers = <span class="built_in">this</span>.lookupPeers();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">review</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.getPeerReviews();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.getManagerReview();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.getSelfReview();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="title">getManagerReview</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> manager = <span class="built_in">this</span>.lookupManager();</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="title">getSelfReview</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> review = <span class="keyword">new</span> PerformanceReview(employee);</span><br><span class="line"></span><br><span class="line">review.review();</span><br></pre></td></tr></table></figure>

<p><strong>👍 正例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PerformanceReview</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params"><span class="keyword">private</span> <span class="keyword">readonly</span> employee: Employee</span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">review</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.getPeerReviews();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.getManagerReview();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.getSelfReview();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="title">getPeerReviews</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> peers = <span class="built_in">this</span>.lookupPeers();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="title">lookupPeers</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> db.lookup(<span class="built_in">this</span>.employee.id, <span class="string">&#x27;peers&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="title">getManagerReview</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> manager = <span class="built_in">this</span>.lookupManager();</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="title">lookupManager</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> db.lookup(<span class="built_in">this</span>.employee, <span class="string">&#x27;manager&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="title">getSelfReview</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> review = <span class="keyword">new</span> PerformanceReview(employee);</span><br><span class="line"></span><br><span class="line">review.review();</span><br></pre></td></tr></table></figure>

<p><strong><a href="#%E7%9B%AE%E5%BD%95">↑ 回到顶部</a></strong></p>
<h3 id="组织导入"><a href="#组织导入" class="headerlink" title="组织导入"></a><a href="#%E7%BB%84%E7%BB%87%E5%AF%BC%E5%85%A5"></a>组织导入</h3><p>使用整洁且易于阅读的<code>import</code>语句，您可以快速查看当前代码的依赖关系。导入语句应遵循以下做法:</p>
<ul>
<li>  <code>Import</code>语句应该按字母顺序排列和分组。</li>
<li>  应该删除未使用的导入语句。</li>
<li>  命名导入必须按字母顺序(例如：<code>import &#123;A, B, C&#125; from &#39;foo&#39;;</code>)。</li>
<li>  导入源必须在组中按字母顺序排列。 例如: <code>import * as foo from &#39;a&#39;; import * as bar from &#39;b&#39;;</code></li>
<li>  导入组用空行隔开。</li>
<li>组内按照如下排序:<ul>
<li>  Polyfills (例如: <code>import &#39;reflect-metadata&#39;;</code>)</li>
<li>  Node 内置模块 (例如: <code>import fs from &#39;fs&#39;;</code>)</li>
<li>  外部模块 (例如: <code>import &#123; query &#125; from &#39;itiriri&#39;;</code>)</li>
<li>  内部模块 (例如: <code>import &#123; UserService &#125; from &#39;src/services/userService&#39;;</code>)</li>
<li>  父目录中的模块 (例如: <code>import foo from &#39;../foo&#39;; import qux from &#39;../../foo/qux&#39;;</code>)</li>
<li>  来自相同或兄弟目录的模块 (例如: <code>import bar from &#39;./bar&#39;; import baz from &#39;./bar/baz&#39;;</code>)</li>
</ul>
</li>
</ul>
<p><strong>👎 反例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; TypeDefinition &#125; <span class="keyword">from</span> <span class="string">&#x27;../types/typeDefinition&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AttributeTypes &#125; <span class="keyword">from</span> <span class="string">&#x27;../model/attribute&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ApiCredentials, Adapters &#125; <span class="keyword">from</span> <span class="string">&#x27;./common/api/authorization&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> fs <span class="keyword">from</span> <span class="string">&#x27;fs&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ConfigPlugin &#125; <span class="keyword">from</span> <span class="string">&#x27;./plugins/config/configPlugin&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; BindingScopeEnum, Container &#125; <span class="keyword">from</span> <span class="string">&#x27;inversify&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;reflect-metadata&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><strong>👍 正例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;reflect-metadata&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> fs <span class="keyword">from</span> <span class="string">&#x27;fs&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; BindingScopeEnum, Container &#125; <span class="keyword">from</span> <span class="string">&#x27;inversify&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; AttributeTypes &#125; <span class="keyword">from</span> <span class="string">&#x27;../model/attribute&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; TypeDefinition &#125; <span class="keyword">from</span> <span class="string">&#x27;../types/typeDefinition&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; ApiCredentials, Adapters &#125; <span class="keyword">from</span> <span class="string">&#x27;./common/api/authorization&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ConfigPlugin &#125; <span class="keyword">from</span> <span class="string">&#x27;./plugins/config/configPlugin&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><strong><a href="#%E7%9B%AE%E5%BD%95">↑ 回到顶部</a></strong></p>
<h3 id="使用-typescript-别名"><a href="#使用-typescript-别名" class="headerlink" title="使用 typescript 别名"></a><a href="#%E4%BD%BF%E7%94%A8-typescript-%E5%88%AB%E5%90%8D"></a>使用 typescript 别名</h3><p>为了创建整洁漂亮的导入语句，可以在<code>tsconfig.json</code>中设置编译器选项的<code>paths</code>和<code>baseUrl</code>属性。</p>
<p>这样可以避免导入时使用较长的相对路径。</p>
<p><strong>👎 反例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; UserService &#125; <span class="keyword">from</span> <span class="string">&#x27;../../../services/UserService&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><strong>👍 正例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; UserService &#125; <span class="keyword">from</span> <span class="string">&#x27;@services/UserService&#x27;</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// tsconfig.json</span></span><br><span class="line">...</span><br><span class="line">  <span class="string">&quot;compilerOptions&quot;</span>: &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="string">&quot;baseUrl&quot;</span>: <span class="string">&quot;src&quot;</span>,</span><br><span class="line">    <span class="string">&quot;paths&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;@services&quot;</span>: [<span class="string">&quot;services/*&quot;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p><strong><a href="#%E7%9B%AE%E5%BD%95">↑ 回到顶部</a></strong></p>
<h2 id="注释"><a href="#注释" class="headerlink" title="注释"></a><a href="#%E6%B3%A8%E9%87%8A"></a>注释</h2><p>写注释意味着没有注释就无法表达清楚，而最好用代码去表达。</p>
<blockquote>
<p>不要注释坏代码，重写吧！— <em>Brian W. Kernighan and P. J. Plaugher</em></p>
</blockquote>
<h3 id="代码自解释而不是用注释"><a href="#代码自解释而不是用注释" class="headerlink" title="代码自解释而不是用注释"></a><a href="#%E4%BB%A3%E7%A0%81%E8%87%AA%E8%A7%A3%E9%87%8A%E8%80%8C%E4%B8%8D%E6%98%AF%E7%94%A8%E6%B3%A8%E9%87%8A"></a>代码自解释而不是用注释</h3><p>代码即文档。</p>
<p><strong>👎 反例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Check if subscription is active.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (subscription.endDate &gt; <span class="built_in">Date</span>.now) &#123;  &#125;</span><br></pre></td></tr></table></figure>

<p><strong>👍 正例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> isSubscriptionActive = subscription.endDate &gt; <span class="built_in">Date</span>.now;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (isSubscriptionActive) &#123; <span class="comment">/* ... */</span> &#125;</span><br></pre></td></tr></table></figure>

<p><strong><a href="#%E7%9B%AE%E5%BD%95">↑ 回到顶部</a></strong></p>
<h3 id="不要将注释掉的代码留在代码库中"><a href="#不要将注释掉的代码留在代码库中" class="headerlink" title="不要将注释掉的代码留在代码库中"></a><a href="#%E4%B8%8D%E8%A6%81%E5%B0%86%E6%B3%A8%E9%87%8A%E6%8E%89%E7%9A%84%E4%BB%A3%E7%A0%81%E7%95%99%E5%9C%A8%E4%BB%A3%E7%A0%81%E5%BA%93%E4%B8%AD"></a>不要将注释掉的代码留在代码库中</h3><p>版本控制存在的一个理由，就是让旧代码成为历史。</p>
<p><strong>👎 反例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="attr">name</span>: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">  email: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// age: number;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// jobPosition: string;</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>👍 正例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="attr">name</span>: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">  email: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><a href="#%E7%9B%AE%E5%BD%95">↑ 回到顶部</a></strong></p>
<h3 id="不要像写日记一样写注释"><a href="#不要像写日记一样写注释" class="headerlink" title="不要像写日记一样写注释"></a><a href="#%E4%B8%8D%E8%A6%81%E5%83%8F%E5%86%99%E6%97%A5%E8%AE%B0%E4%B8%80%E6%A0%B7%E5%86%99%E6%B3%A8%E9%87%8A"></a>不要像写日记一样写注释</h3><p>记住，使用版本控制！不需要保留无用代码、注释掉的代码，尤其像日记一样的注释。使用<code>git log</code>来获取历史。</p>
<p><strong>👎 反例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> * 2016-12-20: Removed monads, didn&#x27;t understand them (RM)</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> * 2016-10-01: Improved using special monads (JP)</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> * 2016-02-03: Added type-checking (LI)</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> * 2015-03-14: Implemented combine (JR)</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">combine</span>(<span class="params">a:<span class="built_in">number</span>, b:<span class="built_in">number</span></span>): <span class="title">number</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> a + b;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>👍 正例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">combine</span>(<span class="params">a:<span class="built_in">number</span>, b:<span class="built_in">number</span></span>): <span class="title">number</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> a + b;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><a href="#%E7%9B%AE%E5%BD%95">↑ 回到顶部</a></strong></p>
<h3 id="避免使用注释标记位置"><a href="#避免使用注释标记位置" class="headerlink" title="避免使用注释标记位置"></a><a href="#%E9%81%BF%E5%85%8D%E4%BD%BF%E7%94%A8%E6%B3%A8%E9%87%8A%E6%A0%87%E8%AE%B0%E4%BD%8D%E7%BD%AE"></a>避免使用注释标记位置</h3><p>它们常常扰乱代码。要让代码结构化，函数和变量要有合适的缩进和格式。</p>
<p>另外，你可以使用支持代码折叠的IDE (看下 Visual Studio Code <a target="_blank" rel="noopener" href="https://code.visualstudio.com/updates/v1_17#_folding-regions">代码折叠</a>).</p>
<p><strong>👎 反例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Client class</span></span><br><span class="line"></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="attr">id</span>: <span class="built_in">number</span>;</span><br><span class="line"></span><br><span class="line">  name: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">  address: Address;</span><br><span class="line"></span><br><span class="line">  contact: Contact;</span><br><span class="line"></span><br><span class="line">  <span class="comment">////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// public methods</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> describe(): <span class="built_in">string</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// private methods</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> describeAddress(): <span class="built_in">string</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> describeContact(): <span class="built_in">string</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><strong>👍 正例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="attr">id</span>: <span class="built_in">number</span>;</span><br><span class="line"></span><br><span class="line">  name: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">  address: Address;</span><br><span class="line"></span><br><span class="line">  contact: Contact;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> describe(): <span class="built_in">string</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> describeAddress(): <span class="built_in">string</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> describeContact(): <span class="built_in">string</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><strong><a href="#%E7%9B%AE%E5%BD%95">↑ 回到顶部</a></strong></p>
<h3 id="TODO-注释"><a href="#TODO-注释" class="headerlink" title="TODO 注释"></a><a href="#todo-%E6%B3%A8%E9%87%8A"></a>TODO 注释</h3><p>当发现自己需要在代码中留下注释，以提醒后续改进时，使用<code>// TODO</code>注释。大多数IDE都对这类注释提供了特殊的支持，你可以快速浏览整个<code>TODO</code>列表。</p>
<p>但是，请记住<strong>TODO</strong>注释并不是坏代码的借口。</p>
<p><strong>👎 反例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getActiveSubscriptions</span>(<span class="params"></span>): <span class="title">Promise</span>&lt;<span class="title">Subscription</span>[]&gt; </span>&#123;</span><br><span class="line">  <span class="comment">// ensure `dueDate` is indexed.</span></span><br><span class="line">  <span class="keyword">return</span> db.subscriptions.find(&#123; <span class="attr">dueDate</span>: &#123; <span class="attr">$lte</span>: <span class="keyword">new</span> <span class="built_in">Date</span>() &#125; &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>👍 正例:</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getActiveSubscriptions</span>(<span class="params"></span>): <span class="title">Promise</span>&lt;<span class="title">Subscription</span>[]&gt; </span>&#123;</span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> ensure `dueDate` is indexed.</span></span><br><span class="line">  <span class="keyword">return</span> db.subscriptions.find(&#123; <span class="attr">dueDate</span>: &#123; <span class="attr">$lte</span>: <span class="keyword">new</span> <span class="built_in">Date</span>() &#125; &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><a href="#%E7%9B%AE%E5%BD%95">↑ 回到顶部</a></strong></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/05/23/204-%E3%80%90TypeScript%E3%80%91TypeScript%E4%BB%A3%E7%A0%81%E6%95%B4%E6%B4%81%E4%B9%8B%E9%81%93/" data-id="ckts3ek0000rw4d9kdj013w9f" data-title="204-【TypeScript】TypeScript代码整洁之道" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/TypeScript/" rel="tag">TypeScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/" rel="tag">前端开发</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-203-【JavaScript】送学妹满屏幕小爱心" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/04/27/203-%E3%80%90JavaScript%E3%80%91%E9%80%81%E5%AD%A6%E5%A6%B9%E6%BB%A1%E5%B1%8F%E5%B9%95%E5%B0%8F%E7%88%B1%E5%BF%83/" class="article-date">
  <time class="dt-published" datetime="2020-04-27T14:05:18.000Z" itemprop="datePublished">2020-04-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/04/27/203-%E3%80%90JavaScript%E3%80%91%E9%80%81%E5%AD%A6%E5%A6%B9%E6%BB%A1%E5%B1%8F%E5%B9%95%E5%B0%8F%E7%88%B1%E5%BF%83/">203-【JavaScript】送学妹满屏幕小爱心</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="故事开始"><a href="#故事开始" class="headerlink" title="故事开始"></a>故事开始</h2><p>午饭时间，暗恋已久的学妹拉着我的衣袖：“学长学长，你能不能让这些爱心变成五颜六色的吗~”。<br /><br><br />我在旁边笑开了花~~~<br /><br><br /><br>        <img src="https://cdn.nlark.com/yuque/0/2020/png/186051/1587909551332-26fa22bf-c7ee-4a7f-9286-a8e768d352af.png" alt="image.png"></p>
<p><br />诶呀，口水流出来了。<br /><br><br />我想最终效果是这样的（猜猜多少个爱心）：<br /><img src="https://cdn.nlark.com/yuque/0/2020/png/186051/1587910535131-d55a64ef-d77f-4d50-bb40-b0ef224782c6.png#align=left&display=inline&height=477&margin=%5Bobject%20Object%5D&name=image.png&originHeight=477&originWidth=305&size=36843&status=done&style=shadow&width=305" alt="image.png"><br />然后开始动手吧~<br /></p>
<p><a name="5bWDu"></a></p>
<h2 id="学啥本领"><a href="#学啥本领" class="headerlink" title="学啥本领"></a>学啥本领</h2><p>本文将带大家学习两个好东西：<br />1.生成随机色的方法；<br />2.Element.animate() 方法。<br /><br><br />当然，还有撩妹技巧了~<br /></p>
<p><a name="Jjdhe"></a></p>
<h2 id="代码走起"><a href="#代码走起" class="headerlink" title="代码走起"></a>代码走起</h2><p><a name="93zDM"></a></p>
<h3 id="1-画个小爱心"><a href="#1-画个小爱心" class="headerlink" title="1. 画个小爱心"></a>1. 画个小爱心</h3><p><br />爱心怎么画，不是咱们本文重点，so，SVG搞起：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;heart&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">svg</span> <span class="attr">t</span>=<span class="string">&quot;1587910011145&quot;</span> <span class="attr">class</span>=<span class="string">&quot;icon&quot;</span> <span class="attr">viewBox</span>=<span class="string">&quot;0 0 1024 1024&quot;</span> <span class="attr">version</span>=<span class="string">&quot;1.1&quot;</span> </span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns</span>=<span class="string">&quot;http://www.w3.org/2000/svg&quot;</span> <span class="attr">p-id</span>=<span class="string">&quot;1253&quot;</span> <span class="attr">width</span>=<span class="string">&quot;32&quot;</span> <span class="attr">height</span>=<span class="string">&quot;32&quot;</span></span></span><br><span class="line"><span class="tag">  &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">path</span> <span class="attr">d</span>=<span class="string">&quot;M677.51936 192.03072c113.1008 0 204.8 91.6992 204.8 204.77952 0 </span></span></span><br><span class="line"><span class="string"><span class="tag">             186.91072-370.3296 435.15904-370.3296 435.15904S141.68064 592.67072 141.68064 </span></span></span><br><span class="line"><span class="string"><span class="tag">             396.81024c0-140.78976 91.6992-204.77952 204.77952-204.77952 68.11648 0 </span></span></span><br><span class="line"><span class="string"><span class="tag">             128.28672 33.40288 165.5296 84.55168C549.24288 225.4336 609.41312 192.03072 </span></span></span><br><span class="line"><span class="string"><span class="tag">             677.51936 192.03072z&quot;</span> <span class="attr">p-id</span>=<span class="string">&quot;1254&quot;</span></span></span><br><span class="line"><span class="tag">    &gt;</span><span class="tag">&lt;/<span class="name">path</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>小爱心出来了：<br /><img src="https://cdn.nlark.com/yuque/0/2020/png/186051/1587912283717-9a2f58bd-742a-4cd0-bd01-09afa090c1d2.png#align=left&display=inline&height=205&margin=%5Bobject%20Object%5D&name=image.png&originHeight=205&originWidth=318&size=2348&status=done&style=shadow&width=318" alt="image.png"><br><a name="LuHFB"></a></p>
<h3 id="2-画一大堆爱心"><a href="#2-画一大堆爱心" class="headerlink" title="2. 画一大堆爱心"></a>2. 画一大堆爱心</h3><p>现在删除到之前的 SVG 标签，换成动态生成咯~~</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> heartList = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> n = <span class="number">99</span>;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt;= n; i++)&#123;</span><br><span class="line">    heartList += <span class="string">`</span></span><br><span class="line"><span class="string">      &lt;svg t=&quot;1587910011145&quot; class=&quot;icon&quot; viewBox=&quot;0 0 1024 1024&quot; version=&quot;1.1&quot; </span></span><br><span class="line"><span class="string">           xmlns=&quot;http://www.w3.org/2000/svg&quot; p-id=&quot;1253&quot; width=&quot;32&quot; height=&quot;32&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;path d=&quot;M677.51936 192.03072c113.1008 0 204.8 91.6992 204.8 204.77952 0 </span></span><br><span class="line"><span class="string">                 186.91072-370.3296 435.15904-370.3296 435.15904S141.68064 592.67072 141.68064 </span></span><br><span class="line"><span class="string">                 396.81024c0-140.78976 91.6992-204.77952 204.77952-204.77952 68.11648 0 </span></span><br><span class="line"><span class="string">                 128.28672 33.40288 165.5296 84.55168C549.24288 225.4336 609.41312 192.03072 </span></span><br><span class="line"><span class="string">                 677.51936 192.03072z&quot; p-id=&quot;1254&quot;</span></span><br><span class="line"><span class="string">        &gt;&lt;/path&gt;</span></span><br><span class="line"><span class="string">      &lt;/svg&gt;</span></span><br><span class="line"><span class="string">    `</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">document</span>.getElementById(<span class="string">&#x27;heart&#x27;</span>).innerHTML = heartList;</span><br></pre></td></tr></table></figure>
<p>一大堆小爱心出现啦：<br /><img src="https://cdn.nlark.com/yuque/0/2020/png/186051/1587912432701-df7c0a52-a234-485c-9b06-2eba6cf2d03a.png#align=left&display=inline&height=488&margin=%5Bobject%20Object%5D&name=image.png&originHeight=488&originWidth=313&size=12778&status=done&style=shadow&width=313" alt="image.png"><br /></p>
<p><a name="pHRtK"></a></p>
<h3 id="3-打造魔法棒"><a href="#3-打造魔法棒" class="headerlink" title="3. 打造魔法棒"></a>3. 打造魔法棒</h3><p>接下来我们要打造一把魔法棒，能让我们这些小爱心变成各种各样的颜色。<br />没错，这把魔法棒，就是用来生成随机颜色。<br /><br><br />方法很多，我搜集以下几种简单好用的生成随机颜色的方法，基本我们业务随便一个都能用：<br /></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getRandomColor</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">const</span> r = <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random()*<span class="number">255</span>);</span><br><span class="line">    <span class="keyword">const</span> g = <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random()*<span class="number">255</span>);</span><br><span class="line">    <span class="keyword">const</span> b = <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random()*<span class="number">255</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;rgba(&#x27;</span>+ r +<span class="string">&#x27;,&#x27;</span>+ g +<span class="string">&#x27;,&#x27;</span>+ b +<span class="string">&#x27;,0.8)&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getRandomColor</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;#&#x27;</span>+<span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random()*<span class="number">16777215</span>).toString(<span class="number">16</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getRandomColor</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;#&#x27;</span> + (<span class="function"><span class="keyword">function</span>(<span class="params">color</span>)</span>&#123;    </span><br><span class="line">        <span class="keyword">return</span> (color +=  <span class="string">&#x27;0123456789abcdef&#x27;</span>[<span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random()*<span class="number">16</span>)])    </span><br><span class="line">        &amp;&amp; (color.length == <span class="number">6</span>) ?  color : <span class="built_in">arguments</span>.callee(color);    </span><br><span class="line">    &#125;)(<span class="string">&#x27;&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getRandomColor</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;#&#x27;</span>+<span class="string">&#x27;0123456789abcdef&#x27;</span>.split(<span class="string">&#x27;&#x27;</span>).map(</span><br><span class="line">        <span class="function">(<span class="params">v,i,a</span>) =&gt;</span> i&gt;<span class="number">5</span> ? <span class="literal">null</span> : a[<span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random()*<span class="number">16</span>)] </span><br><span class="line">    ).join(<span class="string">&#x27;&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getRandomColor</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;#&#x27;</span>+(<span class="string">&#x27;00000&#x27;</span>+(<span class="built_in">Math</span>.random()*<span class="number">0x1000000</span>&lt;&lt;<span class="number">0</span>).toString(<span class="number">16</span>)).slice(-<span class="number">6</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getRandomColor</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">const</span> colorAngle = <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random()*<span class="number">360</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;hsla(&#x27;</span>+ colorAngle +<span class="string">&#x27;,100%,50%,1)&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getRandomColor</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="function"><span class="keyword">function</span>(<span class="params">m,s,c</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (c ? <span class="built_in">arguments</span>.callee(m,s,c-<span class="number">1</span>) : <span class="string">&#x27;#&#x27;</span>) +</span><br><span class="line">        s[m.floor(m.random() * <span class="number">16</span>)]</span><br><span class="line">    &#125;)(<span class="built_in">Math</span>,<span class="string">&#x27;0123456789abcdef&#x27;</span>,<span class="number">5</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>随机色真好玩~<br /></p>
<p><a name="VZS4r"></a></p>
<h3 id="4-五颜六色！变"><a href="#4-五颜六色！变" class="headerlink" title="4. 五颜六色！变~"></a>4. 五颜六色！变~</h3><p>最后，我们修改前面 SVG 的代码片段，加入 <code>getRandomColor</code> 方法的调用：<br /></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt;= n; i++)&#123;</span><br><span class="line">    heartList += <span class="string">`</span></span><br><span class="line"><span class="string">      &lt;svg t=&quot;1587910011145&quot; class=&quot;icon&quot; viewBox=&quot;0 0 1024 1024&quot; version=&quot;1.1&quot; </span></span><br><span class="line"><span class="string">           xmlns=&quot;http://www.w3.org/2000/svg&quot; p-id=&quot;1253&quot; width=&quot;32&quot; height=&quot;32&quot;</span></span><br><span class="line"><span class="string">					 fill=&quot;<span class="subst">$&#123;getRandomColor()&#125;</span>&quot;</span></span><br><span class="line"><span class="string">			&gt;</span></span><br><span class="line"><span class="string">        &lt;path d=&quot;M677.51936 192.03072c113.1008 0 204.8 91.6992 204.8 204.77952 0 </span></span><br><span class="line"><span class="string">                 186.91072-370.3296 435.15904-370.3296 435.15904S141.68064 592.67072 141.68064 </span></span><br><span class="line"><span class="string">                 396.81024c0-140.78976 91.6992-204.77952 204.77952-204.77952 68.11648 0 </span></span><br><span class="line"><span class="string">                 128.28672 33.40288 165.5296 84.55168C549.24288 225.4336 609.41312 192.03072 </span></span><br><span class="line"><span class="string">                 677.51936 192.03072z&quot; p-id=&quot;1254&quot;</span></span><br><span class="line"><span class="string">        &gt;&lt;/path&gt;</span></span><br><span class="line"><span class="string">      &lt;/svg&gt;</span></span><br><span class="line"><span class="string">    `</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>99 个小爱心，水灵灵的！<br /><img src="https://cdn.nlark.com/yuque/0/2020/png/186051/1587912884313-d52a18d6-0d62-4b1b-a897-96b02a5d4924.png#align=left&display=inline&height=517&margin=%5Bobject%20Object%5D&name=image.png&originHeight=517&originWidth=316&size=37711&status=done&style=none&width=316" alt="image.png"><br><a name="2uEER"></a></p>
<h3 id="5-动起来吧！"><a href="#5-动起来吧！" class="headerlink" title="5. 动起来吧！"></a>5. 动起来吧！</h3><p>这时候，每个爱心都静静躺着页面，是时候让它们动起来啦，为了学妹~<br /><br><br />继续改造前面 SVG 代码，为每个 SVG 标签添加连续 ID 值：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt;= n; i++)&#123;</span><br><span class="line">    heartList += <span class="string">`</span></span><br><span class="line"><span class="string">      &lt;svg id=&quot;heart_<span class="subst">$&#123;i&#125;</span>&quot; t=&quot;1587910011145&quot; class=&quot;icon&quot; viewBox=&quot;0 0 1024 1024&quot; version=&quot;1.1&quot; </span></span><br><span class="line"><span class="string">           xmlns=&quot;http://www.w3.org/2000/svg&quot; p-id=&quot;1253&quot; width=&quot;32&quot; height=&quot;32&quot;</span></span><br><span class="line"><span class="string">					 fill=&quot;<span class="subst">$&#123;getRandomColor()&#125;</span>&quot;</span></span><br><span class="line"><span class="string">			&gt;</span></span><br><span class="line"><span class="string">        &lt;path d=&quot;M677.51936 192.03072c113.1008 0 204.8 91.6992 204.8 204.77952 0 </span></span><br><span class="line"><span class="string">                 186.91072-370.3296 435.15904-370.3296 435.15904S141.68064 592.67072 141.68064 </span></span><br><span class="line"><span class="string">                 396.81024c0-140.78976 91.6992-204.77952 204.77952-204.77952 68.11648 0 </span></span><br><span class="line"><span class="string">                 128.28672 33.40288 165.5296 84.55168C549.24288 225.4336 609.41312 192.03072 </span></span><br><span class="line"><span class="string">                 677.51936 192.03072z&quot; p-id=&quot;1254&quot;</span></span><br><span class="line"><span class="string">        &gt;&lt;/path&gt;</span></span><br><span class="line"><span class="string">      &lt;/svg&gt;</span></span><br><span class="line"><span class="string">    `</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>生命随机放大倍数，并设置动画效果：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> getRandomNum = <span class="function">() =&gt;</span> <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random()*<span class="number">2</span>+<span class="number">1</span>);</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt;= n; i++) &#123;</span><br><span class="line">        <span class="keyword">const</span> item = <span class="string">`heart_<span class="subst">$&#123;i&#125;</span>`</span>;</span><br><span class="line">        <span class="built_in">document</span>.getElementById(item).animate([</span><br><span class="line">            <span class="comment">// keyframes translateY(0px)</span></span><br><span class="line">            &#123; <span class="attr">transform</span>: <span class="string">`scale(<span class="subst">$&#123;getRandomNum()&#125;</span>)`</span> &#125;,</span><br><span class="line">            &#123; <span class="attr">transform</span>: <span class="string">`scale(<span class="subst">$&#123;getRandomNum()&#125;</span>)`</span> &#125;,</span><br><span class="line">            &#123; <span class="attr">transform</span>: <span class="string">`scale(<span class="subst">$&#123;getRandomNum()&#125;</span>)`</span> &#125;,</span><br><span class="line">            &#123; <span class="attr">transform</span>: <span class="string">`scale(<span class="subst">$&#123;getRandomNum()&#125;</span>)`</span> &#125;,</span><br><span class="line">            &#123; <span class="attr">transform</span>: <span class="string">`scale(<span class="subst">$&#123;getRandomNum()&#125;</span>)`</span> &#125;,</span><br><span class="line">            &#123; <span class="attr">transform</span>: <span class="string">`scale(<span class="subst">$&#123;getRandomNum()&#125;</span>)`</span> &#125;,</span><br><span class="line">        ], &#123;</span><br><span class="line">            <span class="comment">// timing options</span></span><br><span class="line">            <span class="attr">duration</span>: <span class="number">5000</span>,</span><br><span class="line">            <span class="attr">iterations</span>: <span class="literal">Infinity</span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;, <span class="number">100</span>)</span><br></pre></td></tr></table></figure>
<p>然后，小爱心们动起来啦。<br /><br><br /><img src="https://cdn.nlark.com/yuque/0/2020/gif/186051/1587918816415-ff934e3e-f954-4767-b3ba-4f393f47a88a.gif#align=left&display=inline&height=480&margin=%5Bobject%20Object%5D&name=%E7%88%B1%E5%BF%83666%20%281%29.gif&originHeight=480&originWidth=270&size=3394858&status=done&style=none&width=270" alt="爱心666 (1).gif"><br><a name="KH8fL"></a></p>
<h3 id="6-飞起来吧"><a href="#6-飞起来吧" class="headerlink" title="6. 飞起来吧~"></a>6. 飞起来吧~</h3><p><br />接下来，要让这些小爱心飞起来~<br /><br><br /><img src="https://cdn.nlark.com/yuque/0/2020/gif/186051/1587919330721-201c7eb3-4196-49e0-b21a-ce6a2d558ed2.gif#align=left&display=inline&height=480&margin=%5Bobject%20Object%5D&name=%E7%88%B1%E5%BF%83666%20%283%29.gif&originHeight=480&originWidth=270&size=2612299&status=done&style=none&width=270" alt="爱心666 (3).gif"><br /><br><br />下面贴代码。</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">html</span>,<span class="selector-tag">body</span>&#123;</span><br><span class="line">    <span class="attribute">overflow</span>: hidden;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">100%</span>;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-id">#heart</span>&#123;</span><br><span class="line">    <span class="attribute">position</span>: relative;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.item</span>&#123;</span><br><span class="line">    <span class="attribute">position</span>: absolute;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>逻辑修改：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> heartList = <span class="string">&#x27;&#x27;</span>; </span><br><span class="line"><span class="keyword">const</span> n = <span class="number">666</span>; <span class="comment">// 总爱心数</span></span><br><span class="line"><span class="comment">// 生成随机颜色</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getRandomColor</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="function"><span class="keyword">function</span> (<span class="params">m, s, c</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (c ? <span class="built_in">arguments</span>.callee(m, s, c - <span class="number">1</span>) : <span class="string">&#x27;#&#x27;</span>) +</span><br><span class="line">            s[m.floor(m.random() * <span class="number">16</span>)]</span><br><span class="line">    &#125;)(<span class="built_in">Math</span>, <span class="string">&#x27;0123456789abcdef&#x27;</span>, <span class="number">5</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 生成爱心列表</span></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt;= n; i++)&#123;</span><br><span class="line">    heartList += <span class="string">`</span></span><br><span class="line"><span class="string">      &lt;svg id=&quot;heart_<span class="subst">$&#123;i&#125;</span>&quot; class=&quot;item&quot; t=&quot;1587910011145&quot; class=&quot;icon&quot; viewBox=&quot;0 0 1024 1024&quot; version=&quot;1.1&quot; </span></span><br><span class="line"><span class="string">           xmlns=&quot;http://www.w3.org/2000/svg&quot; p-id=&quot;1253&quot; width=&quot;32&quot; height=&quot;32&quot;</span></span><br><span class="line"><span class="string">					 fill=&quot;<span class="subst">$&#123;getRandomColor()&#125;</span>&quot;</span></span><br><span class="line"><span class="string">			&gt;</span></span><br><span class="line"><span class="string">        &lt;path d=&quot;M677.51936 192.03072c113.1008 0 204.8 91.6992 204.8 204.77952 0 </span></span><br><span class="line"><span class="string">                 186.91072-370.3296 435.15904-370.3296 435.15904S141.68064 592.67072 141.68064 </span></span><br><span class="line"><span class="string">                 396.81024c0-140.78976 91.6992-204.77952 204.77952-204.77952 68.11648 0 </span></span><br><span class="line"><span class="string">                 128.28672 33.40288 165.5296 84.55168C549.24288 225.4336 609.41312 192.03072 </span></span><br><span class="line"><span class="string">                 677.51936 192.03072z&quot; p-id=&quot;1254&quot;</span></span><br><span class="line"><span class="string">        &gt;&lt;/path&gt;</span></span><br><span class="line"><span class="string">      &lt;/svg&gt;</span></span><br><span class="line"><span class="string">    `</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 随机放大倍数</span></span><br><span class="line"><span class="keyword">const</span> getRandomNum = <span class="function">(<span class="params">scale</span>) =&gt;</span> <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random()*scale+<span class="number">1</span>);</span><br><span class="line"><span class="keyword">const</span> boxWidth = <span class="built_in">window</span>.innerWidth;</span><br><span class="line"><span class="keyword">const</span> boxHeight = <span class="built_in">window</span>.innerHeight;</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt;= n; i++) &#123;</span><br><span class="line">        <span class="keyword">const</span> item = <span class="string">`heart_<span class="subst">$&#123;i&#125;</span>`</span>;</span><br><span class="line">        <span class="keyword">const</span> width = getRandomNum(boxWidth);</span><br><span class="line">        <span class="keyword">const</span> height = getRandomNum(boxHeight);</span><br><span class="line">        <span class="keyword">const</span> cWidth = getRandomNum(<span class="number">1000</span>) - width;</span><br><span class="line">        <span class="keyword">const</span> cHeight = getRandomNum(<span class="number">1000</span>) - height;</span><br><span class="line">        <span class="built_in">document</span>.getElementById(item).animate([</span><br><span class="line">            &#123; <span class="attr">transform</span>: <span class="string">`scale(<span class="subst">$&#123;getRandomNum(<span class="number">2</span>)&#125;</span>)`</span>,<span class="attr">left</span>: <span class="string">`0px`</span>, <span class="attr">top</span>: <span class="string">`0px`</span> &#125;,</span><br><span class="line">            &#123; <span class="attr">transform</span>: <span class="string">`scale(<span class="subst">$&#123;getRandomNum(<span class="number">2</span>)&#125;</span>)`</span>,<span class="attr">left</span>: <span class="string">`<span class="subst">$&#123;boxWidth<span class="regexp">/2&#125;px`, top: `$&#123;boxHeight/</span><span class="number">2</span>&#125;</span>px`</span> &#125;,</span><br><span class="line">            &#123; <span class="attr">transform</span>: <span class="string">`scale(<span class="subst">$&#123;getRandomNum(<span class="number">2</span>)&#125;</span>)`</span>,<span class="attr">left</span>: <span class="string">`<span class="subst">$&#123;cWidth * <span class="number">2</span>&#125;</span>px`</span>, <span class="attr">top</span>: <span class="string">`<span class="subst">$&#123;cHeight * <span class="number">2</span>&#125;</span>px`</span> &#125;,</span><br><span class="line">        ], &#123;</span><br><span class="line">            <span class="attr">duration</span>: <span class="number">9000</span>,</span><br><span class="line">            <span class="attr">iterations</span>: <span class="literal">Infinity</span>,</span><br><span class="line">            <span class="attr">easing</span>: <span class="string">&#x27;ease-in-out&#x27;</span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;, <span class="number">100</span>)</span><br><span class="line"><span class="built_in">document</span>.getElementById(<span class="string">&#x27;heart&#x27;</span>).innerHTML = heartList;</span><br></pre></td></tr></table></figure>
<p>聪明的你，再配上BGM，浪漫~<br /><br><br />还能做更多有意思的小玩意，靠各位发挥啦。<br /></p>
<p><a name="R1cCr"></a></p>
<h2 id="故事结束"><a href="#故事结束" class="headerlink" title="故事结束"></a>故事结束</h2><p>继续~<br /><br><br />对了，送给学妹的代码我放在仓库：<br /><a target="_blank" rel="noopener" href="https://github.com/pingan8787/Leo-JavaScript/blob/master/Leo-Demo/7-WeiteHeartPop.html">https://github.com/pingan8787/Leo-JavaScript/blob/master/Leo-Demo/7-WeiteHeartPop.html</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/04/27/203-%E3%80%90JavaScript%E3%80%91%E9%80%81%E5%AD%A6%E5%A6%B9%E6%BB%A1%E5%B1%8F%E5%B9%95%E5%B0%8F%E7%88%B1%E5%BF%83/" data-id="ckts3eju5005q4d9k4gc198zm" data-title="203-【JavaScript】送学妹满屏幕小爱心" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/" rel="tag">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/" rel="tag">前端开发</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%8E%9F%E5%88%9B/" rel="tag">原创</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-202-【Babel】不容错过的Babel7知识" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/04/15/202-%E3%80%90Babel%E3%80%91%E4%B8%8D%E5%AE%B9%E9%94%99%E8%BF%87%E7%9A%84Babel7%E7%9F%A5%E8%AF%86/" class="article-date">
  <time class="dt-published" datetime="2020-04-15T15:14:47.000Z" itemprop="datePublished">2020-04-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/04/15/202-%E3%80%90Babel%E3%80%91%E4%B8%8D%E5%AE%B9%E9%94%99%E8%BF%87%E7%9A%84Babel7%E7%9F%A5%E8%AF%86/">202-【Babel】不容错过的Babel7知识</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>不容错过的 Babel7 知识  <a target="_blank" rel="noopener" href="https://juejin.im/post/5ddff3abe51d4502d56bd143">https://juejin.im/post/5ddff3abe51d4502d56bd143</a><br /></p>
<hr>
<p>对 <code>Babel</code> 的配置项的作用不那么了解，是否会影响日常开发呢？老实说，大多情况下没有特别大的影响（毕竟有搜索引擎）。<br />不过呢，还是想更进一步了解下，于是最近认真阅读了 <code>Babel</code> 的文档，外加不断编译验证，输出了本篇文章，为了更好的阅读体验，修修改改，最终算是以我个人比较喜欢的方式推进了每个知识点（每一个配置的引入都是有原因的），希望能够帮助你对 <code>Babel</code> 的各种配置有一个更清晰的认识 (已经很懂的小伙伴，无视本文) 。<br /></p>
<blockquote>
<p>Babel 是一个 JS 编译器</p>
</blockquote>
<p><br />Babel 是一个工具链，主要用于将 ECMAScript 2015+ 版本的代码转换为向后兼容的 JavaScript 语法，以便能够运行在当前和旧版本的浏览器或其他环境中。<br />我们先看看 <code>Babel</code> 能够做什么：</p>
<ul>
<li>语法转换</li>
<li>通过 <code>Polyfill</code> 方式在目标环境中添加缺失的特性(<code>@babel/polyfill模块</code>)</li>
<li>源码转换(codemods)</li>
</ul>
<p><br />本篇文章的目的是搞明白 <code>Babel</code> 的使用和配置，搞清楚 <code>@babel/runtime</code>，<code>@babel/polyfill</code>，<code>@babel/plugin-transform-runtime</code> 这些作用是什么，插件和预设都是用来干什么的，我们为什么需要配置它们，而不是讲如何进行 <code>AST</code> 转换，如果你对 <code>AST</code> 转换非常感兴趣，欢迎阅读我们的 <a target="_blank" rel="noopener" href="https://github.com/areslabs/alita">RN转小程序引擎 Alita</a> 的源码，其中应用了大量的 <code>AST</code> 转换。<br /></p>
<blockquote>
<p>更多文章可戳（如Star，谢谢你）：<a target="_blank" rel="noopener" href="https://github.com/YvetteLau/Blog">https://github.com/YvetteLau/Blog</a></p>
</blockquote>
<p><br />为了更清晰的了解每一步，首先创建一个新项目，例如 <code>babelTemp</code>(你爱取啥名取啥名)，使用 <code>npm init -y</code> 进行初始化，创建 <code>src/index.js</code>，文件内容如下（你也可以随便写点什么）:<br /></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fn = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;a&#x27;</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>OK，创建好的项目先放在一边，先了解下理论知识:<br><a name="2KaSH"></a></p>
<h3 id=""><a href="#" class="headerlink" title=""></a><br /></h3><p><a name="qkcsg"></a></p>
<h3 id="核心库-babel-core"><a href="#核心库-babel-core" class="headerlink" title="核心库 @babel/core"></a>核心库 @babel/core</h3><p>Babel 的核心功能包含在 <code>@babel/core</code> 模块中。看到 <code>core</code> 这个词了吧，意味着<strong>核心</strong>，没有它，在 <code>babel</code> 的世界里注定寸步难行。不安装 <code>@babel/core</code>，无法使用 <code>babel</code> 进行编译。<br /></p>
<p><a name="TC6LJ"></a></p>
<h3 id="CLI命令行工具-babel-cli"><a href="#CLI命令行工具-babel-cli" class="headerlink" title="CLI命令行工具 @babel/cli"></a>CLI命令行工具 @babel/cli</h3><p><code>babel</code> 提供的命令行工具，主要是提供 <code>babel</code> 这个命令，适合安装在项目里。<br /><code>@babel/node</code> 提供了 <code>babel-node</code> 命令，但是 <code>@babel/node</code> 更适合全局安装，不适合安装在项目里。<br /></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save-dev @babel/core @babel/cli</span><br></pre></td></tr></table></figure>

<p><br />现在你就可以在项目中使用 <code>babel</code> 进行编译啦（如果不安装 <code>@babel/core</code>，会报错噢）<br />将命令配置在 <code>package.json</code> 文件的 <code>scripts</code> 字段中:<br /></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="string">&quot;scripts&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;compiler&quot;</span>: <span class="string">&quot;babel src --out-dir lib --watch&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><br />使用 <code>npm run compiler</code> 来执行编译，现在我们没有配置任何插件，编译前后的代码是完全一样的。<br />因为 <code>Babel</code> 虽然开箱即用，但是什么动作也不做，如果想要 <code>Babel</code> 做一些实际的工作，就需要为其添加插件(<code>plugin</code>)。<br><a name="WRy33"></a></p>
<h3 id="插件"><a href="#插件" class="headerlink" title="插件"></a>插件</h3><p><code>Babel</code> 构建在插件之上，使用现有的或者自己编写的插件可以组成一个转换通道，<code>Babel</code> 的插件分为两种: 语法插件和转换插件。<br /></p>
<blockquote>
<p>语法插件</p>
</blockquote>
<p><br />这些插件只允许 <code>Babel</code> <strong>解析（parse）</strong> 特定类型的语法（不是转换），可以在 <code>AST</code> 转换时使用，以支持解析新语法，例如：<br /></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> babel <span class="keyword">from</span> <span class="string">&quot;@babel/core&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> code = babel.transformFromAstSync(ast, &#123;</span><br><span class="line">    <span class="comment">//支持可选链</span></span><br><span class="line">    <span class="attr">plugins</span>: [<span class="string">&quot;@babel/plugin-proposal-optional-chaining&quot;</span>],</span><br><span class="line">    <span class="attr">babelrc</span>: <span class="literal">false</span></span><br><span class="line">&#125;).code;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>转换插件</p>
</blockquote>
<p>转换插件会启用相应的语法插件(因此不需要同时指定这两种插件)，这点很容易理解，如果不启用相应的语法插件，意味着无法解析，连解析都不能解析，又何谈转换呢？<br><a name="AQ3WX"></a></p>
<h4 id="插件的使用"><a href="#插件的使用" class="headerlink" title="插件的使用"></a>插件的使用</h4><p>如果插件发布在 <code>npm</code> 上，可以直接填写插件的名称， <code>Babel</code> 会自动检查它是否已经被安装在 <code>node_modules</code> 目录下，在项目目录下新建 <code>.babelrc</code> 文件 (下文会具体介绍配置文件)，配置如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//.babelrc</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;plugins&quot;</span>: [<span class="string">&quot;@babel/plugin-transform-arrow-functions&quot;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><br />也可以指定插件的相对/绝对路径<br /></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;plugins&quot;</span>: [<span class="string">&quot;./node_modules/@babel/plugin-transform-arrow-functions&quot;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><br />执行 <code>npm run compiler</code>，可以看到箭头函数已经被编译OK， <code>lib/index.js</code> 内容如下:<br /></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fn = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;a&#x27;</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>现在，我们仅支持转换箭头函数，如果想将其它的新的JS特性转换成低版本，需要使用其它对应的 <code>plugin</code> 。如果我们一个个配置的话，会非常繁琐，因为你可能需要配置几十个插件，这显然非常不便，那么有没有什么办法可以简化这个配置呢？<br />有！预设！(感谢强大的 <code>Babel</code>)<br /><img src="https://cdn.nlark.com/yuque/0/2020/webp/186051/1585576545113-2af624c5-4388-470e-a4ab-4e2ee545a29a.webp#align=left&display=inline&height=260&originHeight=260&originWidth=250&size=0&status=done&style=none&width=250"><br><a name="lQ9Nw"></a></p>
<h3 id="预设"><a href="#预设" class="headerlink" title="预设"></a>预设</h3><p>通过使用或创建一个 <code>preset</code> 即可<strong>轻松</strong>使用一组插件。</p>
<blockquote>
<p>官方 Preset</p>
</blockquote>
<ul>
<li>@babel/preset-env</li>
<li>@babel/preset-flow</li>
<li>@babel/preset-react</li>
<li>@babel/preset-typescript</li>
</ul>
<p><strong>注:</strong> 从 Babel v7 开始，所有针对标准提案阶段的功能所编写的预设(stage preset)都已被弃用，官方已经移除了 <code>@babel/preset-stage-x</code>。<br><a name="0KCWe"></a></p>
<h4 id="babel-preset-env"><a href="#babel-preset-env" class="headerlink" title="@babel/preset-env"></a>@babel/preset-env</h4><p><code>@babel/preset-env</code> 主要作用是对我们所使用的并且目标浏览器中缺失的功能进行代码转换和加载 <code>polyfill</code>，在不进行任何配置的情况下，<code>@babel/preset-env</code> 所包含的插件将支持所有最新的JS特性(ES2015,ES2016等，不包含 stage 阶段)，将其转换成ES5代码。例如，如果你的代码中使用了可选链(目前，仍在 stage 阶段)，那么只配置 <code>@babel/preset-env</code>，转换时会抛出错误，需要另外安装相应的插件。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//.babelrc</span><br><span class="line">&#123;</span><br><span class="line">    &quot;presets&quot;: [&quot;@babel/preset-env&quot;]</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p>需要说明的是，<code>@babel/preset-env</code> 会根据你配置的目标环境，生成插件列表来编译。对于基于浏览器或 <code>Electron</code> 的项目，官方推荐使用 <code>.browserslistrc</code> 文件来指定目标环境。默认情况下，如果你没有在 <code>Babel</code> 配置文件中(如 .babelrc)设置 <code>targets</code> 或 <code>ignoreBrowserslistConfig</code>，<code>@babel/preset-env</code> 会使用 <code>browserslist</code> 配置源。<br />如果你不是要兼容所有的浏览器和环境，推荐你指定目标环境，这样你的编译代码能够保持最小。<br />例如，仅包括浏览器市场份额超过0.25％的用户所需的 <code>polyfill</code> 和代码转换（忽略没有安全更新的浏览器，如 IE10 和 BlackBerry）:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//.browserslistrc</span><br><span class="line">&gt; 0.25%</span><br><span class="line">not dead</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p>查看 <a target="_blank" rel="noopener" href="https://github.com/browserslist/browserslist"><code>browserslist</code> 的更多配置</a><br />例如，你将 <code>.browserslistrc</code> 的内容配置为:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">last 2 Chrome versions</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p>然后再执行 <code>npm run compiler</code>，你会发现箭头函数不会被编译成ES5，因为 <code>chrome</code> 的最新2个版本都能够支持箭头函数。现在，我们将 <code>.browserslistrc</code> 仍然换成之前的配置。<br />就咱们目前的代码来说，当前的配置似乎已经是OK的了。<br /><img src="https://cdn.nlark.com/yuque/0/2020/jpeg/186051/1585576545153-848f1a8d-ad56-4ec3-a9df-383b6de5f33a.jpeg#align=left&display=inline&height=245&originHeight=245&originWidth=316&size=0&status=done&style=none&width=316"><br />我们修改下 <code>src/index.js</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">const isHas = [1,2,3].includes(2);</span><br><span class="line">const p = new Promise((resolve, reject) =&gt; &#123;</span><br><span class="line">    resolve(100);</span><br><span class="line">&#125;);</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p>编译出来的结果为:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&quot;use strict&quot;;</span><br><span class="line">var isHas = [1, 2, 3].includes(2);</span><br><span class="line">var p = new Promise(function (resolve, reject) &#123;</span><br><span class="line">  resolve(100);</span><br><span class="line">&#125;);</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p>这个编译出来的代码在低版本浏览器中使用的话，显然是有问题的，因为低版本浏览器中数组实例上没有 <code>includes</code> 方法，也没有 <code>Promise</code> 构造函数。<br />这是为什么呢？因为语法转换只是将高版本的语法转换成低版本的，但是新的内置函数、实例方法无法转换。这时，就需要使用 <code>polyfill</code> 上场了，顾名思义，<code>polyfill</code>的中文意思是垫片，所谓垫片就是垫平不同浏览器或者不同环境下的差异，让新的内置函数、实例方法等在低版本浏览器中也可以使用。<br /><img src="https://cdn.nlark.com/yuque/0/2020/webp/186051/1585576545151-8518e5ef-31ad-47fc-91ae-812c51e02256.webp#align=left&display=inline&height=301&originHeight=301&originWidth=300&size=0&status=done&style=none&width=300"><br><a name="i3hpv"></a></p>
<h3 id="Polyfill"><a href="#Polyfill" class="headerlink" title="Polyfill"></a>Polyfill</h3><p><code>@babel/polyfill</code> 模块包括 <code>core-js</code> 和一个自定义的 <code>regenerator runtime</code> 模块，可以模拟完整的 ES2015+ 环境（不包含第4阶段前的提议）。<br />这意味着可以使用诸如 <code>Promise</code> 和 <code>WeakMap</code> 之类的新的内置组件、 <code>Array.from</code> 或 <code>Object.assign</code> 之类的静态方法、<code>Array.prototype.includes</code> 之类的实例方法以及生成器函数(前提是使用了 <code>@babel/plugin-transform-regenerator</code> 插件)。为了添加这些功能，<code>polyfill</code> 将添加到全局范围和类似 <code>String</code> 这样的内置原型中(会对全局环境造成污染，后面我们会介绍不污染全局环境的方法)。<br /><strong>补充说明 (2020/01/07)：</strong>V7.4.0 版本开始，<code>@babel/polyfill</code> 已经被废弃(前端发展日新月异)，需单独安装 <code>core-js</code> 和 <code>regenerator-runtime</code> 模块。<br />首先，安装 <code>@babel/polyfill</code> 依赖:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install --save @babel/polyfill</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p>注意：不使用 <code>--save-dev</code>，因为这是一个需要在源码之前运行的垫片。<br />我们需要将完整的 <code>polyfill</code> 在代码之前加载，修改我们的 <code>src/index.js</code>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">import &#x27;@babel/polyfill&#x27;;</span><br><span class="line">const isHas = [1,2,3].includes(2);</span><br><span class="line">const p = new Promise((resolve, reject) =&gt; &#123;</span><br><span class="line">    resolve(100);</span><br><span class="line">&#125;);</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p><code>@babel/polyfill</code> 需要在其它代码之前引入，我们也可以在 <code>webpack</code> 中进行配置。<br />例如:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">entry: [</span><br><span class="line">    require.resolve(&#x27;./polyfills&#x27;),</span><br><span class="line">    path.resolve(&#x27;./index&#x27;)</span><br><span class="line">]</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p><code>polyfills.js</code> 文件内容如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">//当然，还可能有一些其它的 polyfill，例如 stage 4之前的一些 polyfill</span><br><span class="line">import &#x27;@babel/polyfill&#x27;;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p>现在，我们的代码不管在低版本还是高版本浏览器(或node环境)中都能正常运行了。不过，很多时候，我们未必需要完整的 <code>@babel/polyfill</code>，这会导致我们最终构建出的包的体积增大，<code>@babel/polyfill</code>的包大小为89K (当前 <code>@babel/polyfill</code> 版本为 7.7.0)。<br />我们更期望的是，如果我使用了某个新特性，再引入对应的 <code>polyfill</code>，避免引入无用的代码。<br />值得庆幸的是， <code>Babel</code> 已经考虑到了这一点。<br /><img src="https://cdn.nlark.com/yuque/0/2020/jpeg/186051/1585576545130-83449582-6602-48c3-b141-a8e88ec06001.jpeg#align=left&display=inline&height=255&originHeight=255&originWidth=255&size=0&status=done&style=none&width=255"><br /><code>@babel/preset-env</code> 提供了一个 <code>useBuiltIns</code> 参数，设置值为 <code>usage</code> 时，就只会包含代码需要的 <code>polyfill</code> 。有一点需要注意：配置此参数的值为 <code>usage</code> ，必须要同时设置 <code>corejs</code> (如果不设置，会给出警告，默认使用的是”corejs”: 2) ，注意: 这里仍然需要安装 <code>@babel/polyfill</code>(当前 <code>@babel/polyfill</code> 版本默认会安装 “corejs”: 2):<br />首先说一下使用 <code>core-js@3</code> 的原因，<code>core-js@2</code> 分支中已经不会再添加新特性，新特性都会添加到 <code>core-js@3</code>。例如你使用了 <code>Array.prototype.flat()</code>，如果你使用的是 <code>core-js@2</code>，那么其不包含此新特性。为了可以使用更多的新特性，建议大家使用 <code>core-js@3</code>。<br />安装依赖依赖：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install --save core-js@3</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/zloirock/core-js">core-js (点击了解更多)</a> : JavaScript 的模块化标准库，包含 <code>Promise</code>、<code>Symbol</code>、<code>Iterator</code>和许多其他的特性，它可以让你仅加载必需的功能。</p>
</blockquote>
<p>现在，修改 <code>Babel</code> 的配置文件如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">//.babelrc</span><br><span class="line">const presets = [</span><br><span class="line">    [</span><br><span class="line">        &quot;@babel/env&quot;,</span><br><span class="line">        &#123;   </span><br><span class="line">            &quot;useBuiltIns&quot;: &quot;usage&quot;,</span><br><span class="line">            &quot;corejs&quot;: 3</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">]</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p><code>Babel</code> 会检查所有代码，以便查找在目标环境中缺失的功能，然后仅仅把需要的 <code>polyfill</code> 包含进来。<br />例如，<code>src/index.js</code> 代码不变：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">const isHas = [1,2,3].includes(2);</span><br><span class="line">const p = new Promise((resolve, reject) =&gt; &#123;</span><br><span class="line">    resolve(100);</span><br><span class="line">&#125;);</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p>我们看看编译出来的文件(<code>lib/index</code>):</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&quot;use strict&quot;;</span><br><span class="line">require(&quot;core-js/modules/es.array.includes&quot;);</span><br><span class="line">require(&quot;core-js/modules/es.object.to-string&quot;);</span><br><span class="line">require(&quot;core-js/modules/es.promise&quot;);</span><br><span class="line">var isHas = [1, 2, 3].includes(2);</span><br><span class="line">var p = new Promise(function (resolve, reject) &#123;</span><br><span class="line">    resolve(100);</span><br><span class="line">&#125;);</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p>同样的代码，我们用 <code>webpack</code> 构建一下(<code>production</code> 模式)，能看到最终的代码大小仅为: 20KB。而如果我们引入整个 <code>@babel/polyfill</code> 的话，构建出的包大小为：89KB<br />前面曾提到，在 <code>useBuiltIns</code> 参数值为 <code>usage</code> 时，仍然需要安装 <code>@babel/polyfill</code>，虽然我们上面的代码转换中看起来并没有使用到，但是，如果我们源码中使用到了 <code>async/await</code>，那么编译出来的代码需要 <code>require(&quot;regenerator-runtime/runtime&quot;)</code>，在 <code>@babel/polyfill</code> 的依赖中，当然啦，你也可以只安装 <code>regenerator-runtime/runtime</code> 取代安装 <code>@babel/polyfill</code>。<br />到了这一步，已经很棒棒了，是不是想跳起来转个圈圈？<br /><img src="https://cdn.nlark.com/yuque/0/2020/gif/186051/1585576545283-9cb5b8df-7d37-4cea-92ad-1afdad005035.gif#align=left&display=inline&height=232&originHeight=232&originWidth=188&size=0&status=done&style=none&width=188"><br />下面我要说的内容，也许你已经知道，也许你还不知道，这都不重要，但是此刻起，你要知道了: <code>Babel</code> 会使用很小的辅助函数来实现类似 <code>_createClass</code> 等公共方法。默认情况下，它将被添加(<code>inject</code>)到需要它的每个文件中。<br />假如，我们的 <code>src/index.js</code> 是这样的:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">class Point &#123;</span><br><span class="line">    constructor(x, y) &#123;</span><br><span class="line">        this.x = x;</span><br><span class="line">        this.y = y;</span><br><span class="line">    &#125;;</span><br><span class="line">    getX() &#123;</span><br><span class="line">        return this.x;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">let cp = new ColorPoint(25, 8);</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p>编译出来的 <code>lib/index.js</code>，如下所示:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&quot;use strict&quot;;</span><br><span class="line">require(&quot;core-js/modules/es.object.define-property&quot;);</span><br><span class="line">function _classCallCheck(instance, Constructor) &#123; if (!(instance instanceof Constructor)) &#123; throw new TypeError(&quot;Cannot call a class as a function&quot;); &#125; &#125;</span><br><span class="line">function _defineProperties(target, props) &#123; for (var i = 0; i &lt; props.length; i++) &#123; var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if (&quot;value&quot; in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); &#125; &#125;</span><br><span class="line">function _createClass(Constructor, protoProps, staticProps) &#123; if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; &#125;</span><br><span class="line">var Point =</span><br><span class="line">    /*#__PURE__*/</span><br><span class="line">    function () &#123;</span><br><span class="line">        function Point(x, y) &#123;</span><br><span class="line">            _classCallCheck(this, Point);</span><br><span class="line">            this.x = x;</span><br><span class="line">            this.y = y;</span><br><span class="line">        &#125;</span><br><span class="line">        _createClass(Point, [&#123;</span><br><span class="line">            key: &quot;getX&quot;,</span><br><span class="line">            value: function getX() &#123;</span><br><span class="line">                return this.x;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;]);</span><br><span class="line">        return Point;</span><br><span class="line">    &#125;();</span><br><span class="line">var cp = new ColorPoint(25, 8);</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p>看起来，似乎并没有什么问题，但是你想一下，如果你有10个文件中都使用了这个 <code>class</code>，是不是意味着 <code>_classCallCheck</code>、<code>_defineProperties</code>、<code>_createClass</code> 这些方法被 <code>inject</code> 了10次。这显然会导致包体积增大，最关键的是，我们并不需要它 <code>inject</code> 多次。<br />这个时候，就是 <code>@babel/plugin-transform-runtime</code> 插件大显身手的时候了，使用 <code>@babel/plugin-transform-runtime</code> 插件，所有帮助程序都将引用模块 <code>@babel/runtime</code>，这样就可以避免编译后的代码中出现重复的帮助程序，有效减少包体积。<br /><img src="https://cdn.nlark.com/yuque/0/2020/jpeg/186051/1585576545179-fbe6fba2-bab7-4b61-8a50-a19bab6d74d5.jpeg#align=left&display=inline&height=300&originHeight=300&originWidth=300&size=0&status=done&style=none&width=300"><br><a name="kGvQm"></a></p>
<h3 id="babel-plugin-transform-runtime"><a href="#babel-plugin-transform-runtime" class="headerlink" title="@babel/plugin-transform-runtime"></a>@babel/plugin-transform-runtime</h3><p><code>@babel/plugin-transform-runtime</code> 是一个可以重复使用 <code>Babel</code> 注入的帮助程序，以节省代码大小的插件。</p>
<blockquote>
<p>注意：诸如 <code>Array.prototype.flat()</code> 等实例方法将不起作用，因为这需要修改现有的内置函数(可以使用 <code>@babel/polyfill</code> 来解决这个问题) ——&gt; 对此需要说明的是如果你配置的是<code>corejs3</code>， <strong><code>core-js@3</code> 现在已经支持原型方法，同时不污染原型</strong>。</p>
</blockquote>
<p>另外，<code>@babel/plugin-transform-runtime</code> 需要和 <code>@babel/runtime</code> 配合使用。<br />首先安装依赖，<code>@babel/plugin-transform-runtime</code> 通常仅在开发时使用，但是运行时最终代码需要依赖 <code>@babel/runtime</code>，所以 <code>@babel/runtime</code> 必须要作为生产依赖被安装，如下 :</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm install --save-dev @babel/plugin-transform-runtime</span><br><span class="line">npm install --save @babel/runtime</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p>除了前文所说的，<code>@babel/plugin-transform-runtime</code> 可以减少编译后代码的体积外，我们使用它还有一个好处，它可以为代码创建一个沙盒环境，如果使用 <code>@babel/polyfill</code> 及其提供的内置程序（例如 <code>Promise</code> ，<code>Set</code> 和 <code>Map</code> ），则它们将污染全局范围。虽然这对于应用程序或命令行工具可能是可以的，但是如果你的代码是要发布供他人使用的库，或者无法完全控制代码运行的环境，则将成为一个问题。<br /><code>@babel/plugin-transform-runtime</code> 会将这些内置别名作为 <code>core-js</code> 的别名，因此您可以无缝使用它们，而无需 <code>polyfill</code>。<br />修改 <code>.babelrc</code> 的配置，如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">//.babelrc</span><br><span class="line">&#123;</span><br><span class="line">    &quot;presets&quot;: [</span><br><span class="line">        [</span><br><span class="line">            &quot;@babel/preset-env&quot;,</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;useBuiltIns&quot;: &quot;usage&quot;,</span><br><span class="line">                &quot;corejs&quot;: 3</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    ],</span><br><span class="line">    &quot;plugins&quot;: [</span><br><span class="line">        [</span><br><span class="line">            &quot;@babel/plugin-transform-runtime&quot;</span><br><span class="line">        ]</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p>重新编译 <code>npm run compiler</code> , 现在，编译出来的内容为(<code>lib/index.js</code>):</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&quot;use strict&quot;;</span><br><span class="line">var _interopRequireDefault = require(&quot;@babel/runtime/helpers/interopRequireDefault&quot;);</span><br><span class="line">var _classCallCheck2 = _interopRequireDefault(require(&quot;@babel/runtime/helpers/classCallCheck&quot;));</span><br><span class="line">var _createClass2 = _interopRequireDefault(require(&quot;@babel/runtime/helpers/createClass&quot;));</span><br><span class="line">var Point =</span><br><span class="line">    /*#__PURE__*/</span><br><span class="line">    function () &#123;</span><br><span class="line">        function Point(x, y) &#123;</span><br><span class="line">            (0, _classCallCheck2.default)(this, Point);</span><br><span class="line">            this.x = x;</span><br><span class="line">            this.y = y;</span><br><span class="line">        &#125;</span><br><span class="line">        (0, _createClass2.default)(Point, [&#123;</span><br><span class="line">            key: &quot;getX&quot;,</span><br><span class="line">            value: function getX() &#123;</span><br><span class="line">                return this.x;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;]);</span><br><span class="line">        return Point;</span><br><span class="line">    &#125;();</span><br><span class="line">var cp = new ColorPoint(25, 8);</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p>可以看出，帮助函数现在不是直接被 <code>inject</code> 到代码中，而是从 <code>@babel/runtime</code> 中引入。前文说了使用 <code>@babel/plugin-transform-runtime</code> 可以避免全局污染，我们来看看是如何避免污染的。<br />修改 <code>src/index.js</code> 如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">let isHas = [1,2,3].includes(2);</span><br><span class="line">new Promise((resolve, reject) =&gt; &#123;</span><br><span class="line">    resolve(100);</span><br><span class="line">&#125;);</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p>编译出来的代码如下(<code>lib/index.js</code>):</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&quot;use strict&quot;;</span><br><span class="line">require(&quot;core-js/modules/es.array.includes&quot;);</span><br><span class="line">require(&quot;core-js/modules/es.object.to-string&quot;);</span><br><span class="line">require(&quot;core-js/modules/es.promise&quot;);</span><br><span class="line">var isHas = [1, 2, 3].includes(2);</span><br><span class="line">new Promise(function (resolve, reject) &#123;</span><br><span class="line">    resolve(100);</span><br><span class="line">&#125;);</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p><code>Array.prototype</code> 上新增了 <code>includes</code> 方法，并且新增了全局的 <code>Promise</code> 方法，污染了全局环境，这跟不使用 <code>@babel/plugin-transform-runtime</code> 没有区别嘛。<br /><img src="https://cdn.nlark.com/yuque/0/2020/jpeg/186051/1585576545179-2c767cc2-48ba-4f1a-8e42-aa3febf5604c.jpeg#align=left&display=inline&height=240&originHeight=240&originWidth=240&size=0&status=done&style=none&width=240"><br />如果我们希望 <code>@babel/plugin-transform-runtime</code> 不仅仅处理帮助函数，同时也能加载 <code>polyfill</code> 的话，我们需要给 <code>@babel/plugin-transform-runtime</code> 增加配置信息。<br />首先新增依赖 <code>@babel/runtime-corejs3</code>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install @babel/runtime-corejs3 --save</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p>修改配置文件如下(移除了 <code>@babel/preset-env</code> 的 <code>useBuiltIns</code> 的配置，不然不就重复了嘛嘛嘛，不信的话，你用 <code>async/await</code> 编译下试试咯):</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;presets&quot;: [</span><br><span class="line">        [</span><br><span class="line">            &quot;@babel/preset-env&quot;</span><br><span class="line">        ]</span><br><span class="line">    ],</span><br><span class="line">    &quot;plugins&quot;: [</span><br><span class="line">        [</span><br><span class="line">            &quot;@babel/plugin-transform-runtime&quot;,&#123;</span><br><span class="line">                &quot;corejs&quot;: 3</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p>然后重新编译，看一下，编译出来的结果(<code>lib/index.js</code>):</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&quot;use strict&quot;;</span><br><span class="line">var _interopRequireDefault = require(&quot;@babel/runtime-corejs3/helpers/interopRequireDefault&quot;);</span><br><span class="line">var _promise = _interopRequireDefault(require(&quot;@babel/runtime-corejs3/core-js-stable/promise&quot;));</span><br><span class="line">var _includes = _interopRequireDefault(require(&quot;@babel/runtime-corejs3/core-js-stable/instance/includes&quot;));</span><br><span class="line">var _context;</span><br><span class="line">var isHas = (0, _includes.default)(_context = [1, 2, 3]).call(_context, 2);</span><br><span class="line">new _promise.default(function (resolve, reject) &#123;</span><br><span class="line">  resolve(100);</span><br><span class="line">&#125;);</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p>可以看出，没有直接去修改 <code>Array.prototype</code>，或者是新增 <code>Promise</code> 方法，避免了全局污染。如果上面 <code>@babel/plugin-transform-runtime</code> 配置的 <code>core-js</code> 是 “2”，其中不包含实例的 <code>polyfill</code> 需要单独引入。</p>
<blockquote>
<p>划重点：如果我们配置的 <code>corejs</code> 是 <code>3</code> 版本，那么不管是实例方法还是全局方法，都不会再污染全局环境。</p>
</blockquote>
<p>看到这里，不知道大家有没有这样一个疑问？给 <code>@babel/plugin-transform-runtime</code> 配置 <code>corejs</code> 是如此的完美，既可以将帮助函数变成引用的形式，又可以动态引入 <code>polyfill</code>，并且不会污染全局环境。何必要给 <code>@babel/preset-env</code> 提供 <code>useBuiltIns</code> 功能呢，看起来似乎不需要呀。<br />带着这样的疑问，我新建了几个文件(内容简单且基本一致，使用了些新特性)，然后使用 <code>webpack</code> 构建，以下是我对比的数据:</p>
<table>
<thead>
<tr>
<th align="left">序号</th>
<th align="left">.babelrc 配置</th>
<th align="left">webpack mode production</th>
</tr>
</thead>
<tbody><tr>
<td align="left">0</td>
<td align="left">不使用 <code>@babel/plugin-transform-runtime</code></td>
<td align="left">36KB</td>
</tr>
<tr>
<td align="left">1</td>
<td align="left">使用<code>@babel/plugin-transform-runtime</code>，并配置参数 <code>corejs</code>: 3。不会污染全局环境</td>
<td align="left">37KB</td>
</tr>
<tr>
<td align="left">2</td>
<td align="left">使用<code>@babel/plugin-transform-runtime</code>，不配置 <code>corejs</code></td>
<td align="left">22KB</td>
</tr>
</tbody></table>
<p>我猜测是 <code>@babel/runtime-corejs3/XXX</code> 的包本身比 <code>core-js/modules/XXX</code> 要大一些~<br /><img src="https://cdn.nlark.com/yuque/0/2020/jpeg/186051/1585576545195-d06e89e4-eee3-4316-8a96-244554496a45.jpeg#align=left&display=inline&height=180&originHeight=180&originWidth=180&size=0&status=done&style=none&width=180"><br><a name="V6jys"></a></p>
<h3 id="插件-预设补充知识"><a href="#插件-预设补充知识" class="headerlink" title="插件/预设补充知识"></a>插件/预设补充知识</h3><blockquote>
<p><strong>插件的排列顺序很重要！！！</strong></p>
</blockquote>
<p>如果两个转换插件都将处理“程序（Program）”的某个代码片段，则将根据转换插件或 <code>preset</code> 的排列顺序依次执行。</p>
<ul>
<li>插件在 Presets 前运行。</li>
<li>插件顺序从前往后排列。</li>
<li>Preset 顺序是颠倒的（从后往前）。</li>
</ul>
<p>例如:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;plugins&quot;: [&quot;@babel/plugin-proposal-class-properties&quot;, &quot;@babel/plugin-syntax-dynamic-import&quot;]</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p>先执行 <code>@babel/plugin-proposal-class-properties</code>，后执行 <code>@babel/plugin-syntax-dynamic-import</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;presets&quot;: [&quot;@babel/preset-env&quot;, &quot;@babel/preset-react&quot;]</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p><code>preset</code> 的执行顺序是<strong>颠倒</strong>的，先执行 <code>@babel/preset-react</code>， 后执行 <code>@babel/preset-env</code>。<br><a name="b0nQx"></a></p>
<h4 id="插件参数"><a href="#插件参数" class="headerlink" title="插件参数"></a>插件参数</h4><p>插件和 <code>preset</code> 都可以接受参数，参数由插件名和参数对象组成一个数组。<code>preset</code> 设置参数也是这种格式。<br />如:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;plugins&quot;: [</span><br><span class="line">        [</span><br><span class="line">            &quot;@babel/plugin-proposal-class-properties&quot;, </span><br><span class="line">            &#123; &quot;loose&quot;: true &#125;</span><br><span class="line">        ]</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p><a name="vpDVE"></a></p>
<h5 id="插件的短名称"><a href="#插件的短名称" class="headerlink" title="插件的短名称"></a>插件的短名称</h5><p>如果插件名称为 <code>@babel/plugin-XXX</code>，可以使用短名称<code>@babel/XXX</code> :</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;plugins&quot;: [</span><br><span class="line">        &quot;@babel/transform-arrow-functions&quot; //同 &quot;@babel/plugin-transform-arrow-functions&quot;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p>如果插件名称为 <code>babel-plugin-XXX</code>，可以使用短名称 <code>XXX</code>，该规则同样适用于带有 <code>scope</code> 的插件:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;plugins&quot;: [</span><br><span class="line">        &quot;newPlugin&quot;, //同 &quot;babel-plugin-newPlugin&quot;</span><br><span class="line">        &quot;@scp/myPlugin&quot; //同 &quot;@scp/babel-plugin-myPlugin&quot;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p><a name="vusUk"></a></p>
<h4 id="创建-Preset"><a href="#创建-Preset" class="headerlink" title="创建 Preset"></a>创建 Preset</h4><blockquote>
<p>可以简单的返回一个插件数组</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">module.exports = function() &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">        plugins: [</span><br><span class="line">            &quot;A&quot;,</span><br><span class="line">            &quot;B&quot;,</span><br><span class="line">            &quot;C&quot;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>preset</code> 中也可以包含其他的 <code>preset</code>，以及带有参数的插件。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">module.exports = function() &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">        presets: [</span><br><span class="line">            require(&quot;@babel/preset-env&quot;)</span><br><span class="line">        ],</span><br><span class="line">        plugins: [</span><br><span class="line">            [require(&quot;@babel/plugin-proposal-class-properties&quot;), &#123; loose: true &#125;],</span><br><span class="line">            require(&quot;@babel/plugin-proposal-object-rest-spread&quot;)</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p><a name="SIthI"></a></p>
<h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><p>Babel 支持多种格式的配置文件。这部分内容补充了解下即可，谁管你用哪种配置文件，只要你的配置是OK的就可以了(敷衍)~<br />所有的 <code>Babel</code> API 参数都可以被配置，但是如果该参数需要使用的 JS 代码，那么可能需要使用 JS 代码版的配置文件。</p>
<blockquote>
<p>根据使用场景可以选择不同的配置文件:</p>
</blockquote>
<p>如果希望以编程的方式创建配置文件或者希望编译 <code>node_modules</code> 目录下的模块：那么 <code>babel.config.js</code> 可以满足你的需求。<br />如果只是需要一个简单的并且中用于单个软件包的配置：那么 <code>.babelrc</code> 即可满足你的需求。<br><a name="XAeLF"></a></p>
<h4 id="babel-config-js"><a href="#babel-config-js" class="headerlink" title="babel.config.js"></a>babel.config.js</h4><p>在项目根目录下创建一个名为 <code>babel.config.js</code> 的文件。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">module.exports = function(api) &#123;</span><br><span class="line">    api.cache(true);</span><br><span class="line">    const presets = [...];</span><br><span class="line">    const plugins = [...];</span><br><span class="line">    return &#123;</span><br><span class="line">        presets,</span><br><span class="line">        plugins</span><br><span class="line">    &#125;;</span><br><span class="line">&#125; </span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p>具体的配置可以查看：<a target="_blank" rel="noopener" href="https://www.babeljs.cn/docs/config-files#project-wide-configuration">babel.config.js 文档</a><br><a name="otlk1"></a></p>
<h4 id="babelrc"><a href="#babelrc" class="headerlink" title=".babelrc"></a>.babelrc</h4><p>在项目根目录下创建一个名为 <code>.babelrc</code> 的文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;presets&quot;: [],</span><br><span class="line">    &quot;plugins&quot;: []</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p>具体的配置可以参考 <a target="_blank" rel="noopener" href="https://www.babeljs.cn/docs/config-files#file-relative-configuration">.babelrc 文档 </a><br><a name="bSz1c"></a></p>
<h4 id="package-json"><a href="#package-json" class="headerlink" title="package.json"></a>package.json</h4><p>可以将 <code>.babelrc</code> 中的配置信息作为 <code>babel</code> 键(key) 添加到 <code>package.json</code> 文件中:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;name&quot;: &quot;my-package&quot;,</span><br><span class="line">    &quot;babel&quot;: &#123;</span><br><span class="line">        &quot;presets&quot;: [],</span><br><span class="line">        &quot;plugins&quot;: []</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p><a name="VDxQV"></a></p>
<h4 id="babelrc-js"><a href="#babelrc-js" class="headerlink" title=".babelrc.js"></a>.babelrc.js</h4><p>与 <code>.babelrc</code> 配置相同，但是可以使用JS编写。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//可以在其中调用 Node.js 的API</span><br><span class="line">const presets = [];</span><br><span class="line">const plugins = [];</span><br><span class="line">module.exports = &#123; presets, plugins &#125;;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2020/gif/186051/1585576545181-dd51b87f-bc43-413d-815f-858922073cb7.gif#align=left&display=inline&height=300&originHeight=300&originWidth=300&size=0&status=done&style=none&width=300"><br />不知道是否全面，不过真的写不动了（如有不全，后续再补充）<del>就酱</del>如果有错误，欢迎指正。</p>
<blockquote>
<p>参考链接</p>
</blockquote>
<ol>
<li><a target="_blank" rel="noopener" href="https://www.babeljs.cn/docs/">babel文档</a><br /></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/cbd48919a0cc">babel 7 的使用的个人理解</a><br /></li>
<li><a target="_blank" rel="noopener" href="https://juejin.im/post/5c19c5e0e51d4502a232c1c6">一口(很长的)气了解 babel</a><br /></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/sefaultment/p/11631314.html">core-js@3带来的惊喜</a><br /></li>
</ol>
<p><br />作者：刘小夕<br />链接：<a target="_blank" rel="noopener" href="https://juejin.im/post/5ddff3abe51d4502d56bd143">https://juejin.im/post/5ddff3abe51d4502d56bd143</a><br />来源：掘金<br />著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/04/15/202-%E3%80%90Babel%E3%80%91%E4%B8%8D%E5%AE%B9%E9%94%99%E8%BF%87%E7%9A%84Babel7%E7%9F%A5%E8%AF%86/" data-id="ckts3ejyo00n04d9k8nw3ewqd" data-title="202-【Babel】不容错过的Babel7知识" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/" rel="tag">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/" rel="tag">前端开发</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-201-【编译原理】200行JS代码带你实现微型编译器（人人都能学会）" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/03/30/201-%E3%80%90%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86%E3%80%91200%E8%A1%8CJS%E4%BB%A3%E7%A0%81%E5%B8%A6%E4%BD%A0%E5%AE%9E%E7%8E%B0%E5%BE%AE%E5%9E%8B%E7%BC%96%E8%AF%91%E5%99%A8%EF%BC%88%E4%BA%BA%E4%BA%BA%E9%83%BD%E8%83%BD%E5%AD%A6%E4%BC%9A%EF%BC%89/" class="article-date">
  <time class="dt-published" datetime="2020-03-30T13:31:34.000Z" itemprop="datePublished">2020-03-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/03/30/201-%E3%80%90%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86%E3%80%91200%E8%A1%8CJS%E4%BB%A3%E7%A0%81%E5%B8%A6%E4%BD%A0%E5%AE%9E%E7%8E%B0%E5%BE%AE%E5%9E%8B%E7%BC%96%E8%AF%91%E5%99%A8%EF%BC%88%E4%BA%BA%E4%BA%BA%E9%83%BD%E8%83%BD%E5%AD%A6%E4%BC%9A%EF%BC%89/">201-【编译原理】200行JS代码带你实现微型编译器（人人都能学会）</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p><img src="http://images.pingan8787.com/TinyCompiler/1585365502950-d474962e-f17c-4aec-bcf4-1252dd5f0e5d.jpeg"><br /></p>
<blockquote>
<p>最近看到掘金、前端公众号好多 ES2020 的文章，想说一句：放开我，我还学得动！</p>
</blockquote>
<p><br />先问大家一句，日常项目开发中你能离开 ES6 吗？<br /></p>
<h1 id="一、前言"><a href="#一、前言" class="headerlink" title="一、前言"></a>一、前言</h1><p>对于前端同学来说，编译器可能适合神奇的魔盒🎁，表面普通，但常常给我们惊喜。<br />编译器，顾名思义，用来编译，编译什么呢？当然是编译代码咯🌹。<br /><br><img src="https://st-gdx.dancf.com/gaodingx/0/design/20191125-144728-7a47.gif"><br><br />其实我们也经常接触到编译器的使用场景：</p>
<ul>
<li>React 中 JSX 转换成 JS 代码；</li>
<li>通过 Babel 将 ES6 及以上规范的代码转换成 ES5 代码；</li>
<li>通过各种 Loader 将 Less / Scss 代码转换成浏览器支持的 CSS 代码；</li>
<li>将 TypeScript 转换为 JavaScript 代码。</li>
<li>and so on…</li>
</ul>
<p><br />使用场景非常之多，我的双手都数不过来了。😄<br />虽然现在社区已经有非常多工具能为我们完成上述工作，但了解一些编译原理是很有必要的。接下来进入本文主题：<strong>200行JS代码，带你实现代码编译器</strong>。<br /></p>
<h1 id="二、编译器介绍"><a href="#二、编译器介绍" class="headerlink" title="二、编译器介绍"></a>二、编译器介绍</h1><h2 id="2-1-程序运行方式"><a href="#2-1-程序运行方式" class="headerlink" title="2.1 程序运行方式"></a>2.1 程序运行方式</h2><p>现代程序主要有两种编译模式：静态编译和动态解释。推荐一篇文章<a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000008739157">《Angular 2 JIT vs AOT》</a>介绍得非常详细。<br /></p>
<h3 id="静态编译"><a href="#静态编译" class="headerlink" title="静态编译"></a>静态编译</h3><p>简称 <strong>AOT</strong>（Ahead-Of-Time）即 <strong>提前编译</strong> ，静态编译的程序会在执行前，会使用指定编译器，将全部代码编译成机器码。<br /><img src="http://images.pingan8787.com/TinyCompiler/111.png"><br />（图片来自：<a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000008739157">https://segmentfault.com/a/1190000008739157</a>）<br /><br><br />在 Angular 的 AOT 编译模式开发流程如下：</p>
<ul>
<li>使用 TypeScript 开发 Angular 应用</li>
<li>运行 ngc 编译应用程序<ul>
<li>使用 Angular Compiler 编译模板，一般输出 TypeScript 代码</li>
<li>运行 tsc 编译 TypeScript 代码</li>
</ul>
</li>
<li>使用 Webpack 或 Gulp 等其他工具构建项目，如代码压缩、合并等</li>
<li>部署应用</li>
</ul>
<h3 id="动态解释"><a href="#动态解释" class="headerlink" title="动态解释"></a>动态解释</h3><p>简称 <strong>JIT</strong>（Just-In-Time）即 <strong>即时编译</strong> ，动态解释的程序会使用指定解释器，一边编译一边执行程序。<br /><img src="http://images.pingan8787.com/TinyCompiler/112.png">（图片来自：<a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000008739157" title="https://segmentfault.com/a/1190000008739157">https://segmentfault.com/a/1190000008739157</a>）<br /><br><br />在 Angular 的 JIT 编译模式开发流程如下：</p>
<ul>
<li>使用 TypeScript 开发 Angular 应用</li>
<li>运行 tsc 编译 TypeScript 代码</li>
<li>使用 Webpack 或 Gulp 等其他工具构建项目，如代码压缩、合并等</li>
<li>部署应用</li>
</ul>
<h3 id="AOT-vs-JIT"><a href="#AOT-vs-JIT" class="headerlink" title="AOT vs JIT"></a>AOT vs JIT</h3><p><strong>AOT 编译流程：</strong><img src="http://images.pingan8787.com/TinyCompiler/113.png">（图片来自：<a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000008739157">https://segmentfault.com/a/1190000008739157</a>）</p>
<p><strong>JIT 编译流程：</strong><img src="http://images.pingan8787.com/TinyCompiler/114.png">（图片来自：<a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000008739157">https://segmentfault.com/a/1190000008739157</a>）</p>
<table>
<thead>
<tr>
<th align="center">特性</th>
<th align="center">AOT</th>
<th align="center">JIT</th>
</tr>
</thead>
<tbody><tr>
<td align="center">编译平台</td>
<td align="center">(Server) 服务器</td>
<td align="center">(Browser) 浏览器</td>
</tr>
<tr>
<td align="center">编译时机</td>
<td align="center">Build (构建阶段)</td>
<td align="center">Runtime (运行时)</td>
</tr>
<tr>
<td align="center">包大小</td>
<td align="center">较小</td>
<td align="center">较大</td>
</tr>
<tr>
<td align="center">执行性能</td>
<td align="center">更好</td>
<td align="center">-</td>
</tr>
<tr>
<td align="center">启动时间</td>
<td align="center">更短</td>
<td align="center">-</td>
</tr>
</tbody></table>
<p>除此之外 AOT 还有以下优点：</p>
<ul>
<li>在客户端我们不需要导入体积庞大的 angular 编译器，这样可以减少我们 JS 脚本库的大小</li>
<li>使用 AOT 编译后的应用，不再包含任何 HTML 片段，取而代之的是编译生成的 TypeScript 代码，这样的话 TypeScript 编译器就能提前发现错误。总而言之，采用 AOT 编译模式，我们的模板是类型安全的。</li>
</ul>
<h2 id="2-2-现代编译器工作流程"><a href="#2-2-现代编译器工作流程" class="headerlink" title="2.2 现代编译器工作流程"></a>2.2 现代编译器工作流程</h2><p>摘抄维基百科中对 <a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E7%B7%A8%E8%AD%AF%E5%99%A8?wprov=srpw1_0" title="编译器">编译器</a>工作流程介绍：</p>
<blockquote>
<p>一个现代编译器的主要工作流程如下：<br>源代码（source code）→ 预处理器（preprocessor）→ 编译器（compiler）→ 汇编程序（assembler）→ 目标代码（object code）→ 链接器（linker）→ 可执行文件（executables），最后打包好的文件就可以给电脑去判读运行了。</p>
</blockquote>
<p><img src="http://images.pingan8787.com/TinyCompiler/115.png"></p>
<p>这里更强调了编译器的作用：<strong>将原始程序作为输入，翻译产生目标语言的等价程序</strong>。</p>
<p><img src="http://images.pingan8787.com/TinyCompiler/%E7%BC%96%E8%AF%91%E5%99%A8%E4%B8%89%E4%B8%AA%E6%A0%B8%E5%BF%83%E9%98%B6%E6%AE%B5.png" alt="编译器三个核心阶段.png"></p>
<p>目前绝大多数现代编译器工作流程基本类似，包括三个核心阶段：</p>
<ol>
<li><strong>解析（_Parsing_）</strong> ：通过词法分析和语法分析，将原始代码字符串解析成<strong>抽象语法树（Abstract Syntax Tree）</strong>；</li>
<li><strong>转换（_Transformation_）</strong>：对抽象语法树进行转换处理操作；</li>
<li><strong>生成代码（_Code Generation_）</strong>：将转换之后的 AST 对象生成目标语言代码字符串。</li>
</ol>
<h1 id="三、编译器实现"><a href="#三、编译器实现" class="headerlink" title="三、编译器实现"></a>三、编译器实现</h1><p>本文将通过 <strong><a target="_blank" rel="noopener" href="https://the-super-tiny-compiler.glitch.me/" title="The Super Tiny Compiler">The Super Tiny Compiler</a></strong> 源码解读，学习如何实现一个轻量编译器，最终<strong>实现将下面原始代码字符串（Lisp 风格的函数调用）编译成 JavaScript 可执行的代码</strong>。<br /></p>
<table>
<thead>
<tr>
<th align="left"></th>
<th align="left">Lisp 风格（编译前）</th>
<th align="left">JavaScript 风格（编译后）</th>
</tr>
</thead>
<tbody><tr>
<td align="left">2 + 2</td>
<td align="left">(add 2 2)</td>
<td align="left">add(2, 2)</td>
</tr>
<tr>
<td align="left">4 - 2</td>
<td align="left">(subtract 4 2)</td>
<td align="left">subtract(4, 2)</td>
</tr>
<tr>
<td align="left">2 + (4 - 2)</td>
<td align="left">(add 2 (subtract 4 2))</td>
<td align="left">add(2, subtract(4, 2))</td>
</tr>
</tbody></table>
<p><br />话说 <a target="_blank" rel="noopener" href="https://the-super-tiny-compiler.glitch.me/">The Super Tiny Compiler</a> 号称<strong>可能是有史以来最小的编译器</strong>，并且其作者 James Kyle 也是 Babel 活跃维护者之一。<br /><img src="https://st-gdx.dancf.com/gaodingx/46/design/20191206-135932-505a.gif"><br><br />让我们开始吧~<br /></p>
<h2 id="3-1-The-Super-Tiny-Compiler-工作流程"><a href="#3-1-The-Super-Tiny-Compiler-工作流程" class="headerlink" title="3.1 The Super Tiny Compiler 工作流程"></a>3.1 The Super Tiny Compiler 工作流程</h2><p>现在对照前面编译器的三个核心阶段，了解下 <a target="_blank" rel="noopener" href="https://the-super-tiny-compiler.glitch.me/">The Super Tiny Compiler</a>  编译器核心工作流程：<br /><img src="http://images.pingan8787.com/TinyCompiler/TheSuperTinyCompiler%E7%BC%96%E8%AF%91%E5%99%A8%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B.png" alt="The Super Tiny Compiler编译器工作流程.png"><br /></p>
<p><strong>图中详细流程如下：</strong></p>
<ol>
<li>执行<strong>入口函数</strong>，输入<strong>原始代码字符串</strong>作为参数；</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 原始代码字符串</span></span><br><span class="line">(add <span class="number">2</span> (subtract <span class="number">4</span> <span class="number">2</span>))</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>进入<strong>解析阶段（Parsing）</strong>，原始代码字符串通过<strong>词法分析器（Tokenizer）</strong>转换为<strong>词法单元数组，</strong>然后再通过 <strong>语法分析器（Parser）</strong>将<strong>词法单元数组</strong>转换为<strong>抽象语法树（Abstract Syntax Tree 简称 AST）</strong>，并返回；</li>
</ol>
<p><img src="http://images.pingan8787.com/TinyCompiler/%E8%A7%A3%E6%9E%90%E9%98%B6%E6%AE%B5-%E8%AF%8D%E6%B3%95%E5%88%86%E6%9E%90.png" alt="解析阶段 - 词法分析.png"><br /><br><img src="http://images.pingan8787.com/TinyCompiler/%E8%A7%A3%E6%9E%90%E9%98%B6%E6%AE%B5-%E8%AF%AD%E6%B3%95%E5%88%86%E6%9E%90.png" alt="解析阶段 - 语法分析.png"><br /></p>
<ol start="3">
<li>进入<strong>转换阶段（Transformation）</strong>，将上一步生成的 <strong>AST 对象</strong> 导入<strong>转换器（Transformer）</strong>，通过<strong>转换器</strong>中的<strong>遍历器（Traverser）</strong>，将代码转换为我们所需的<strong>新的 AST 对象</strong>；</li>
</ol>
<p><img src="http://images.pingan8787.com/TinyCompiler/%E8%BD%AC%E6%8D%A2%E9%98%B6%E6%AE%B5.png" alt="转换阶段.png"><br /></p>
<ol start="4">
<li>进入<strong>代码生成阶段（Code Generation）</strong>，将上一步返回的<strong>新 AST 对象</strong>通过<strong>代码生成器（CodeGenerator）</strong>，转换成 <strong>JavaScript Code</strong>；</li>
</ol>
<p><img src="http://images.pingan8787.com/TinyCompiler/%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90%E9%98%B6%E6%AE%B5.png" alt="代码生成阶段.png"><br /></p>
<ol start="5">
<li><strong>代码编译结束</strong>，返回 <strong>JavaScript Code</strong>。</li>
</ol>
<p><img src="https://st-gdx.dancf.com/gaodingx/0/uxms/design/20200320-163503-12b5.gif"><br /><br><br />上述流程看完后可能一脸懵逼，不过没事，请保持头脑清醒，先有个整个流程的印象，接下来我们开始阅读代码：<br /></p>
<h2 id="3-2-入口方法"><a href="#3-2-入口方法" class="headerlink" title="3.2 入口方法"></a>3.2 入口方法</h2><p>首先定义一个入口方法 <code>compiler</code> ，接收原始代码字符串作为参数，返回最终 JavaScript Code：<br /></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 编译器入口方法 参数：原始代码字符串 input</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">compiler</span>(<span class="params">input</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> tokens = tokenizer(input);</span><br><span class="line">  <span class="keyword">let</span> ast    = parser(tokens);</span><br><span class="line">  <span class="keyword">let</span> newAst = transformer(ast);</span><br><span class="line">  <span class="keyword">let</span> output = codeGenerator(newAst);</span><br><span class="line">  <span class="keyword">return</span> output;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-3-解析阶段"><a href="#3-3-解析阶段" class="headerlink" title="3.3 解析阶段"></a>3.3 解析阶段</h2><p>在解析阶段中，我们定义<strong>词法分析器方法</strong> <code>tokenizer</code>  和<strong>语法分析器方法</strong> <code>parser</code> 然后分别实现：<br /></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 词法分析器 参数：原始代码字符串 input</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">tokenizer</span>(<span class="params">input</span>) </span>&#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 语法分析器 参数：词法单元数组tokens</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">parser</span>(<span class="params">tokens</span>) </span>&#123;&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="词法分析器"><a href="#词法分析器" class="headerlink" title="词法分析器"></a>词法分析器</h3><p><strong>词法分析器方法</strong> <code>tokenizer</code> 的主要任务：遍历整个原始代码字符串，将原始代码字符串转换为<strong>词法单元数组（tokens）</strong>，并返回。<br />在遍历过程中，匹配每种字符并处理成<strong>词法单元</strong>压入<strong>词法单元数组</strong>，如当匹配到左括号（ <code>(</code> ）时，将往<strong>词法单元数组（tokens）</strong>压入一个<strong>词法单元对象</strong>（<code>&#123;type: &#39;paren&#39;, value:&#39;(&#39;&#125;</code>）。<br /><img src="http://images.pingan8787.com/TinyCompiler/%E8%AF%8D%E6%B3%95%E5%88%86%E6%9E%90%E5%99%A8%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B.png" alt="词法分析器工作流程.png"><br /></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 词法分析器 参数：原始代码字符串 input</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">tokenizer</span>(<span class="params">input</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> current = <span class="number">0</span>;  <span class="comment">// 当前解析的字符索引，作为游标</span></span><br><span class="line">  <span class="keyword">let</span> tokens = [];  <span class="comment">// 初始化词法单元数组</span></span><br><span class="line">  <span class="comment">// 循环遍历原始代码字符串，读取词法单元数组</span></span><br><span class="line">  <span class="keyword">while</span> (current &lt; input.length) &#123;</span><br><span class="line">    <span class="keyword">let</span> char = input[current];</span><br><span class="line">    <span class="comment">// 匹配左括号，匹配成功则压入对象 &#123;type: &#x27;paren&#x27;, value:&#x27;(&#x27;&#125;</span></span><br><span class="line">    <span class="keyword">if</span> (char === <span class="string">&#x27;(&#x27;</span>) &#123;</span><br><span class="line">      tokens.push(&#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;paren&#x27;</span>,</span><br><span class="line">        <span class="attr">value</span>: <span class="string">&#x27;(&#x27;</span></span><br><span class="line">      &#125;);</span><br><span class="line">      current++;</span><br><span class="line">      <span class="keyword">continue</span>; <span class="comment">// 自增current，完成本次循环，进入下一个循环</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 匹配右括号，匹配成功则压入对象 &#123;type: &#x27;paren&#x27;, value:&#x27;)&#x27;&#125;</span></span><br><span class="line">    <span class="keyword">if</span> (char === <span class="string">&#x27;)&#x27;</span>) &#123;</span><br><span class="line">      tokens.push(&#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;paren&#x27;</span>,</span><br><span class="line">        <span class="attr">value</span>: <span class="string">&#x27;)&#x27;</span></span><br><span class="line">      &#125;);</span><br><span class="line">      current++;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 匹配空白字符，匹配成功则跳过</span></span><br><span class="line">    <span class="comment">// 使用 \s 匹配，包括空格、制表符、换页符、换行符、垂直制表符等</span></span><br><span class="line">    <span class="keyword">let</span> WHITESPACE = <span class="regexp">/\s/</span>;</span><br><span class="line">    <span class="keyword">if</span> (WHITESPACE.test(char)) &#123;</span><br><span class="line">      current++;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 匹配数字字符，使用 [0-9]：匹配</span></span><br><span class="line">    <span class="comment">// 匹配成功则压入&#123;type: &#x27;number&#x27;, value: value&#125;</span></span><br><span class="line">    <span class="comment">// 如 (add 123 456) 中 123 和 456 为两个数值词法单元</span></span><br><span class="line">    <span class="keyword">let</span> NUMBERS = <span class="regexp">/[0-9]/</span>;</span><br><span class="line">    <span class="keyword">if</span> (NUMBERS.test(char)) &#123;</span><br><span class="line">      <span class="keyword">let</span> value = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">      <span class="comment">// 匹配连续数字，作为数值</span></span><br><span class="line">      <span class="keyword">while</span> (NUMBERS.test(char)) &#123;</span><br><span class="line">        value += char;</span><br><span class="line">        char = input[++current];</span><br><span class="line">      &#125;</span><br><span class="line">      tokens.push(&#123; <span class="attr">type</span>: <span class="string">&#x27;number&#x27;</span>, value &#125;);</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 匹配形双引号包围的字符串</span></span><br><span class="line">    <span class="comment">// 匹配成功则压入 &#123; type: &#x27;string&#x27;, value: value &#125;</span></span><br><span class="line">    <span class="comment">// 如 (concat &quot;foo&quot; &quot;bar&quot;) 中 &quot;foo&quot; 和 &quot;bar&quot; 为两个字符串词法单元</span></span><br><span class="line">    <span class="keyword">if</span> (char === <span class="string">&#x27;&quot;&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">let</span> value = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">      char = input[++current]; <span class="comment">// 跳过左双引号</span></span><br><span class="line">      <span class="comment">// 获取两个双引号之间所有字符</span></span><br><span class="line">      <span class="keyword">while</span> (char !== <span class="string">&#x27;&quot;&#x27;</span>) &#123;</span><br><span class="line">        value += char;</span><br><span class="line">        char = input[++current];</span><br><span class="line">      &#125;</span><br><span class="line">      char = input[++current];<span class="comment">// 跳过右双引号</span></span><br><span class="line">      tokens.push(&#123; <span class="attr">type</span>: <span class="string">&#x27;string&#x27;</span>, value &#125;);</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 匹配函数名，要求只含大小写字母，使用 [a-z] 匹配 i 模式</span></span><br><span class="line">    <span class="comment">// 匹配成功则压入 &#123; type: &#x27;name&#x27;, value: value &#125;</span></span><br><span class="line">    <span class="comment">// 如 (add 2 4) 中 add 为一个名称词法单元</span></span><br><span class="line">    <span class="keyword">let</span> LETTERS = <span class="regexp">/[a-z]/i</span>;</span><br><span class="line">    <span class="keyword">if</span> (LETTERS.test(char)) &#123;</span><br><span class="line">      <span class="keyword">let</span> value = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">      <span class="comment">// 获取连续字符</span></span><br><span class="line">      <span class="keyword">while</span> (LETTERS.test(char)) &#123;</span><br><span class="line">        value += char;</span><br><span class="line">        char = input[++current];</span><br><span class="line">      &#125;</span><br><span class="line">      tokens.push(&#123; <span class="attr">type</span>: <span class="string">&#x27;name&#x27;</span>, value &#125;);</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 当遇到无法识别的字符，抛出错误提示，并退出</span></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">&#x27;I dont know what this character is: &#x27;</span> + char);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 词法分析器的最后返回词法单元数组</span></span><br><span class="line">  <span class="keyword">return</span> tokens;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="语法分析器"><a href="#语法分析器" class="headerlink" title="语法分析器"></a>语法分析器</h3><p><strong>语法分析器方法</strong> <code>parser</code> 的主要任务：将<strong>词法分析器</strong>返回的<strong>词法单元数组</strong>，转换为能够描述语法成分及其关系的中间形式（<strong>抽象语法树 AST</strong>）。<br /><img src="http://images.pingan8787.com/TinyCompiler/%E8%AF%AD%E6%B3%95%E5%88%86%E6%9E%90%E5%99%A8%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B.png" alt="语法分析器工作流程.png"><br /></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 语法分析器 参数：词法单元数组tokens</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">parser</span>(<span class="params">tokens</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> current = <span class="number">0</span>; <span class="comment">// 设置当前解析的词法单元的索引，作为游标</span></span><br><span class="line">  <span class="comment">// 递归遍历（因为函数调用允许嵌套），将词法单元转成 LISP 的 AST 节点</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">walk</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 获取当前索引下的词法单元 token</span></span><br><span class="line">    <span class="keyword">let</span> token = tokens[current]; </span><br><span class="line"></span><br><span class="line">    <span class="comment">// 数值类型词法单元</span></span><br><span class="line">    <span class="keyword">if</span> (token.type === <span class="string">&#x27;number&#x27;</span>) &#123;</span><br><span class="line">      current++; <span class="comment">// 自增当前 current 值</span></span><br><span class="line">      <span class="comment">// 生成一个 AST节点 &#x27;NumberLiteral&#x27;，表示数值字面量</span></span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;NumberLiteral&#x27;</span>,</span><br><span class="line">        <span class="attr">value</span>: token.value,</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 字符串类型词法单元</span></span><br><span class="line">    <span class="keyword">if</span> (token.type === <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">      current++;</span><br><span class="line">      <span class="comment">// 生成一个 AST节点 &#x27;StringLiteral&#x27;，表示字符串字面量</span></span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;StringLiteral&#x27;</span>,</span><br><span class="line">        <span class="attr">value</span>: token.value,</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 函数类型词法单元</span></span><br><span class="line">    <span class="keyword">if</span> (token.type === <span class="string">&#x27;paren&#x27;</span> &amp;&amp; token.value === <span class="string">&#x27;(&#x27;</span>) &#123;</span><br><span class="line">      <span class="comment">// 跳过左括号，获取下一个词法单元作为函数名</span></span><br><span class="line">      token = tokens[++current];</span><br><span class="line"></span><br><span class="line">      <span class="keyword">let</span> node = &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;CallExpression&#x27;</span>,</span><br><span class="line">        <span class="attr">name</span>: token.value,</span><br><span class="line">        <span class="attr">params</span>: []</span><br><span class="line">      &#125;;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 再次自增 current 变量，获取参数词法单元</span></span><br><span class="line">      token = tokens[++current];</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 遍历每个词法单元，获取函数参数，直到出现右括号&quot;）&quot;</span></span><br><span class="line">      <span class="keyword">while</span> ((token.type !== <span class="string">&#x27;paren&#x27;</span>) || (token.type === <span class="string">&#x27;paren&#x27;</span> &amp;&amp; token.value !== <span class="string">&#x27;)&#x27;</span>)) &#123;</span><br><span class="line">        node.params.push(walk());</span><br><span class="line">        token = tokens[current];</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      current++; <span class="comment">// 跳过右括号</span></span><br><span class="line">      <span class="keyword">return</span> node;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 无法识别的字符，抛出错误提示</span></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">TypeError</span>(token.type);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 初始化 AST 根节点</span></span><br><span class="line">  <span class="keyword">let</span> ast = &#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="string">&#x27;Program&#x27;</span>,</span><br><span class="line">    <span class="attr">body</span>: [],</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 循环填充 ast.body</span></span><br><span class="line">  <span class="keyword">while</span> (current &lt; tokens.length) &#123;</span><br><span class="line">    ast.body.push(walk());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 最后返回ast</span></span><br><span class="line">  <span class="keyword">return</span> ast;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="3-4-转换阶段"><a href="#3-4-转换阶段" class="headerlink" title="3.4 转换阶段"></a>3.4 转换阶段</h2><p>在转换阶段中，定义了转换器 <code>transformer</code> 函数，使用词法分析器返回的 LISP 的 AST 对象作为参数，将 AST 对象转换成一个新的 AST 对象。<br /><br><br />为了方便代码组织，我们定义一个遍历器 <code>traverser</code> 方法，用来处理每一个节点的操作。<br /></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 遍历器 参数：ast 和 visitor</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">traverser</span>(<span class="params">ast, visitor</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 定义方法 traverseArray </span></span><br><span class="line">  <span class="comment">// 用于遍历 AST节点数组，对数组中每个元素调用 traverseNode 方法。</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">traverseArray</span>(<span class="params">array, parent</span>) </span>&#123;</span><br><span class="line">    array.forEach(<span class="function"><span class="params">child</span> =&gt;</span> &#123;</span><br><span class="line">      traverseNode(child, parent);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 定义方法 traverseNode</span></span><br><span class="line">  <span class="comment">// 用于处理每个 AST 节点，接受一个 node 和它的父节点 parent 作为参数</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">traverseNode</span>(<span class="params">node, parent</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 获取 visitor 上对应方法的对象</span></span><br><span class="line">    <span class="keyword">let</span> methods = visitor[node.type];</span><br><span class="line">    <span class="comment">// 获取 visitor 的 enter 方法，处理操作当前 node</span></span><br><span class="line">    <span class="keyword">if</span> (methods &amp;&amp; methods.enter) &#123;</span><br><span class="line">      methods.enter(node, parent);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (node.type) &#123;</span><br><span class="line">      <span class="comment">// 根节点</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;Program&#x27;</span>:</span><br><span class="line">        traverseArray(node.body, node);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="comment">// 函数调用</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;CallExpression&#x27;</span>:</span><br><span class="line">        traverseArray(node.params, node);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="comment">// 数值和字符串，忽略</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;NumberLiteral&#x27;</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;StringLiteral&#x27;</span>:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 当遇到无法识别的字符，抛出错误提示，并退出</span></span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">TypeError</span>(node.type);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (methods &amp;&amp; methods.exit) &#123;</span><br><span class="line">      methods.exit(node, parent);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 首次执行，开始遍历</span></span><br><span class="line">  traverseNode(ast, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在看<strong>遍历器</strong> <code>traverser</code> 方法时，建议结合下面介绍的<strong>转换器</strong> <code>transformer</code> 方法阅读：<br /></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 转化器，参数：ast</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">transformer</span>(<span class="params">ast</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 创建 newAST，与之前 AST 类似，Program：作为新 AST 的根节点</span></span><br><span class="line">  <span class="keyword">let</span> newAst = &#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="string">&#x27;Program&#x27;</span>,</span><br><span class="line">    <span class="attr">body</span>: [],</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 通过 _context 维护新旧 AST，注意 _context 是一个引用，从旧的 AST 到新的 AST。</span></span><br><span class="line">  ast._context = newAst.body;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 通过遍历器遍历 处理旧的 AST</span></span><br><span class="line">  traverser(ast, &#123;</span><br><span class="line">    <span class="comment">// 数值，直接原样插入新AST，类型名称 NumberLiteral</span></span><br><span class="line">    <span class="attr">NumberLiteral</span>: &#123;</span><br><span class="line">      <span class="function"><span class="title">enter</span>(<span class="params">node, parent</span>)</span> &#123;</span><br><span class="line">        parent._context.push(&#123;</span><br><span class="line">          <span class="attr">type</span>: <span class="string">&#x27;NumberLiteral&#x27;</span>,</span><br><span class="line">          <span class="attr">value</span>: node.value,</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 字符串，直接原样插入新AST，类型名称 StringLiteral</span></span><br><span class="line">    <span class="attr">StringLiteral</span>: &#123;</span><br><span class="line">      <span class="function"><span class="title">enter</span>(<span class="params">node, parent</span>)</span> &#123;</span><br><span class="line">        parent._context.push(&#123;</span><br><span class="line">          <span class="attr">type</span>: <span class="string">&#x27;StringLiteral&#x27;</span>,</span><br><span class="line">          <span class="attr">value</span>: node.value,</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 函数调用</span></span><br><span class="line">    <span class="attr">CallExpression</span>: &#123;</span><br><span class="line">      <span class="function"><span class="title">enter</span>(<span class="params">node, parent</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 创建不同的AST节点</span></span><br><span class="line">        <span class="keyword">let</span> expression = &#123;</span><br><span class="line">          <span class="attr">type</span>: <span class="string">&#x27;CallExpression&#x27;</span>,</span><br><span class="line">          <span class="attr">callee</span>: &#123;</span><br><span class="line">            <span class="attr">type</span>: <span class="string">&#x27;Identifier&#x27;</span>,</span><br><span class="line">            <span class="attr">name</span>: node.name,</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">arguments</span>: [],</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 函数调用有子类，建立节点对应关系，供子节点使用</span></span><br><span class="line">        node._context = expression.arguments;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 顶层函数调用算是语句，包装成特殊的AST节点</span></span><br><span class="line">        <span class="keyword">if</span> (parent.type !== <span class="string">&#x27;CallExpression&#x27;</span>) &#123;</span><br><span class="line"></span><br><span class="line">          expression = &#123;</span><br><span class="line">            <span class="attr">type</span>: <span class="string">&#x27;ExpressionStatement&#x27;</span>,</span><br><span class="line">            <span class="attr">expression</span>: expression,</span><br><span class="line">          &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        parent._context.push(expression);</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">return</span> newAst;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重要一点，这里通过 <code>_context</code> 引用来<strong>维护新旧 AST 对象</strong>，管理方便，避免污染旧 AST 对象。<br /></p>
<h2 id="3-5-代码生成"><a href="#3-5-代码生成" class="headerlink" title="3.5 代码生成"></a>3.5 代码生成</h2><p>接下来到了最后一步，我们定义<strong>代码生成器</strong> <code>codeGenerator</code> 方法，通过递归，将新的 AST 对象代码转换成 JavaScript 可执行代码字符串。<br /></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 代码生成器 参数：新 AST 对象</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">codeGenerator</span>(<span class="params">node</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (node.type) &#123;</span><br><span class="line">    <span class="comment">// 遍历 body 属性中的节点，且递归调用 codeGenerator，按行输出结果</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;Program&#x27;</span>:</span><br><span class="line">      <span class="keyword">return</span> node.body.map(codeGenerator)</span><br><span class="line">        .join(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 表达式，处理表达式内容，并用分号结尾</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;ExpressionStatement&#x27;</span>:</span><br><span class="line">      <span class="keyword">return</span> (</span><br><span class="line">        codeGenerator(node.expression) +</span><br><span class="line">        <span class="string">&#x27;;&#x27;</span></span><br><span class="line">      );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 函数调用，添加左右括号，参数用逗号隔开</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;CallExpression&#x27;</span>:</span><br><span class="line">      <span class="keyword">return</span> (</span><br><span class="line">        codeGenerator(node.callee) +</span><br><span class="line">        <span class="string">&#x27;(&#x27;</span> +</span><br><span class="line">        node.arguments.map(codeGenerator)</span><br><span class="line">          .join(<span class="string">&#x27;, &#x27;</span>) +</span><br><span class="line">        <span class="string">&#x27;)&#x27;</span></span><br><span class="line">      );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 标识符，返回其 name</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;Identifier&#x27;</span>:</span><br><span class="line">      <span class="keyword">return</span> node.name;</span><br><span class="line">    <span class="comment">// 数值，返回其 value</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;NumberLiteral&#x27;</span>:</span><br><span class="line">      <span class="keyword">return</span> node.value;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 字符串，用双引号包裹再输出</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;StringLiteral&#x27;</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&#x27;&quot;&#x27;</span> + node.value + <span class="string">&#x27;&quot;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当遇到无法识别的字符，抛出错误提示，并退出</span></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">TypeError</span>(node.type);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-6-编译器测试"><a href="#3-6-编译器测试" class="headerlink" title="3.6 编译器测试"></a>3.6 编译器测试</h2><p>截止上一步，我们完成简易编译器的代码开发。接下来通过前面原始需求的代码，测试编译器效果如何：<br /></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> add = <span class="function">(<span class="params">a, b</span>) =&gt;</span> a + b;</span><br><span class="line"><span class="keyword">const</span> subtract = <span class="function">(<span class="params">a, b</span>) =&gt;</span> a - b;</span><br><span class="line"><span class="keyword">const</span> source = <span class="string">&quot;(add 2 (subtract 4 2))&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> target = compiler(source); <span class="comment">// &quot;add(2, (subtract(4, 2));&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> result = <span class="built_in">eval</span>(target); <span class="comment">// Ok result is 4</span></span><br></pre></td></tr></table></figure>

<h2 id="3-7-工作流程小结"><a href="#3-7-工作流程小结" class="headerlink" title="3.7 工作流程小结"></a>3.7 工作流程小结</h2><p>总结 <a target="_blank" rel="noopener" href="https://the-super-tiny-compiler.glitch.me/">The Super Tiny Compiler</a> 编译器整个工作流程：<br /><strong>1、input =&gt; tokenizer =&gt; tokens</strong><br /><strong>2、tokens =&gt; parser =&gt; ast</strong><br /><strong>3、ast =&gt; transformer =&gt; newAst</strong><br /><strong>4、newAst =&gt; generator =&gt; output</strong><br /></p>
<p>其实多数编译器的工作流程都大致相同：<br><img src="http://images.pingan8787.com/TinyCompiler/TheSuperTinyCompiler%E7%BC%96%E8%AF%91%E5%99%A8%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B%EF%BC%88%E6%96%B9%E6%B3%95%E5%AE%9E%E7%8E%B0%EF%BC%89.png" alt="The Super Tiny Compiler编译器工作流程（方法实现）.png"></p>
<h1 id="四、手写-Webpack-编译器"><a href="#四、手写-Webpack-编译器" class="headerlink" title="四、手写 Webpack 编译器"></a>四、手写 Webpack 编译器</h1><p>根据之前介绍的 <a target="_blank" rel="noopener" href="https://the-super-tiny-compiler.glitch.me/">The Super Tiny Compiler</a>编译器核心工作流程，再来手写 Webpack 的编译器，会让你有种众享丝滑的感觉~<br /><img src="https://st-gdx.dancf.com/gaodingx/0/design/20191030-163349-cca6.gif"></p>
<p><br />话说，有些面试官喜欢问这个呢。当然，手写一遍能让我们更了解 Webpack 的构建流程，这个章节我们简要介绍一下。</p>
<h2 id="4-1-Webpack-构建流程分析"><a href="#4-1-Webpack-构建流程分析" class="headerlink" title="4.1 Webpack 构建流程分析"></a>4.1 Webpack 构建流程分析</h2><p>从启动构建到输出结果一系列过程：</p>
<ol>
<li><strong>初始化参数</strong></li>
</ol>
<p>解析 Webpack 配置参数，合并 Shell 传入和 <code>webpack.config.js</code> 文件配置的参数，形成最后的配置结果。<br /></p>
<ol start="2">
<li><strong>开始编译</strong></li>
</ol>
<p>上一步得到的参数初始化 <code>compiler</code> 对象，注册所有配置的插件，插件监听 Webpack 构建生命周期的事件节点，做出相应的反应，执行对象的 <code>run</code> 方法开始执行编译。<br /></p>
<ol start="3">
<li><strong>确定入口</strong></li>
</ol>
<p>从配置的 <code>entry</code> 入口，开始解析文件构建 AST 语法树，找出依赖，递归下去。<br /></p>
<ol start="4">
<li><strong>编译模块</strong></li>
</ol>
<p>递归中根据<strong>文件类型</strong>和 <strong>loader 配置</strong>，调用所有配置的 loader 对文件进行转换，再找出该模块依赖的模块，再递归本步骤直到所有入口依赖的文件都经过了本步骤的处理。<br /></p>
<ol start="5">
<li><strong>完成模块编译并输出</strong></li>
</ol>
<p>递归完事后，得到每个文件结果，包含每个模块以及他们之间的依赖关系，根据 <code>entry</code> 配置生成代码块 <code>chunk</code> 。<br /></p>
<ol start="6">
<li><strong>输出完成</strong></li>
</ol>
<p>输出所有的 <code>chunk</code> 到文件系统。<br /><br><br />注意：在构建生命周期中有一系列插件在做合适的时机做合适事情，比如 <code>UglifyPlugin</code> 会在 loader 转换递归完对结果使用 <code>UglifyJs</code> 压缩<strong>覆盖之前的结果</strong>。<br /><img src="http://images.pingan8787.com/TinyCompiler/Webpack%E6%9E%84%E5%BB%BA%E6%B5%81%E7%A8%8B1.png" alt="Webpack构建流程.png"></p>
<h2 id="4-2-代码实现"><a href="#4-2-代码实现" class="headerlink" title="4.2 代码实现"></a>4.2 代码实现</h2><p>手写 Webpack 需要实现以下三个核心方法：</p>
<ul>
<li><code>createAssets</code> : 收集和处理文件的代码；</li>
<li><code>createGraph</code> ：根据入口文件，返回所有文件依赖图；</li>
<li><code>bundle</code> : 根据依赖图整个代码并输出；</li>
</ul>
<h3 id="1-createAssets"><a href="#1-createAssets" class="headerlink" title="1. createAssets"></a>1. createAssets</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createAssets</span>(<span class="params">filename</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">const</span> content = fs.readFileSync(filename, <span class="string">&quot;utf-8&quot;</span>); <span class="comment">// 根据文件名读取文件内容</span></span><br><span class="line">  </span><br><span class="line">  	<span class="comment">// 将读取到的代码内容，转换为 AST</span></span><br><span class="line">    <span class="keyword">const</span> ast = parser.parse(content, &#123;</span><br><span class="line">        <span class="attr">sourceType</span>: <span class="string">&quot;module&quot;</span> <span class="comment">// 指定源码类型</span></span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">const</span> dependencies = []; <span class="comment">// 用于收集文件依赖的路径</span></span><br><span class="line"></span><br><span class="line">  	<span class="comment">// 通过 traverse 提供的操作 AST 的方法，获取每个节点的依赖路径</span></span><br><span class="line">    traverse(ast, &#123;</span><br><span class="line">        <span class="attr">ImportDeclaration</span>: <span class="function">(<span class="params">&#123;node&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">            dependencies.push(node.source.value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">  	<span class="comment">// 通过 AST 将 ES6 代码转换成 ES5 代码</span></span><br><span class="line">    <span class="keyword">const</span> &#123; code &#125; = babel.transformFromAstSync(ast, <span class="literal">null</span>, &#123;</span><br><span class="line">        <span class="attr">presets</span>: [<span class="string">&quot;@babel/preset-env&quot;</span>]</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> id = moduleId++;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        id,</span><br><span class="line">        filename,</span><br><span class="line">        code,</span><br><span class="line">        dependencies</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-createGraph"><a href="#2-createGraph" class="headerlink" title="2. createGraph"></a>2. createGraph</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createGraph</span>(<span class="params">entry</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> mainAsset = createAssets(entry); <span class="comment">// 获取入口文件下的内容</span></span><br><span class="line">    <span class="keyword">const</span> queue = [mainAsset];</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">const</span> asset <span class="keyword">of</span> queue)&#123;</span><br><span class="line">        <span class="keyword">const</span> dirname = path.dirname(asset.filename);</span><br><span class="line">        asset.mapping = &#123;&#125;;</span><br><span class="line">        asset.dependencies.forEach(<span class="function"><span class="params">relativePath</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> absolutePath = path.join(dirname, relativePath); <span class="comment">// 转换文件路径为绝对路径</span></span><br><span class="line">            <span class="keyword">const</span> child = createAssets(absolutePath);</span><br><span class="line">            asset.mapping[relativePath] = child.id;</span><br><span class="line">            queue.push(child); <span class="comment">// 递归去遍历所有子节点的文件</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> queue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-bunlde"><a href="#3-bunlde" class="headerlink" title="3. bunlde"></a>3. bunlde</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">bundle</span>(<span class="params">graph</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> modules = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    graph.forEach(<span class="function"><span class="params">item</span> =&gt;</span> &#123;</span><br><span class="line">        modules += <span class="string">`</span></span><br><span class="line"><span class="string">            <span class="subst">$&#123;item.id&#125;</span>: [</span></span><br><span class="line"><span class="string">                function (require, module, exports)&#123;</span></span><br><span class="line"><span class="string">                    <span class="subst">$&#123;item.code&#125;</span></span></span><br><span class="line"><span class="string">                &#125;,</span></span><br><span class="line"><span class="string">                <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(item.mapping)&#125;</span></span></span><br><span class="line"><span class="string">            ],</span></span><br><span class="line"><span class="string">        `</span></span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`</span></span><br><span class="line"><span class="string">        (function(modules)&#123;</span></span><br><span class="line"><span class="string">            function require(id)&#123;</span></span><br><span class="line"><span class="string">                const [fn, mapping] = modules[id];</span></span><br><span class="line"><span class="string">                function localRequire(relativePath)&#123;</span></span><br><span class="line"><span class="string">                    return require(mapping[relativePath]);</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                const module = &#123;</span></span><br><span class="line"><span class="string">                    exports: &#123;&#125;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                fn(localRequire, module, module.exports);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                return module.exports;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">            require(0);</span></span><br><span class="line"><span class="string">        &#125;)(&#123;<span class="subst">$&#123;modules&#125;</span>&#125;)</span></span><br><span class="line"><span class="string">    `</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h1 id="五、总结"><a href="#五、总结" class="headerlink" title="五、总结"></a>五、总结</h1><p>本文从编译器概念和基本工作流程开始介绍，然后通过 <a target="_blank" rel="noopener" href="https://the-super-tiny-compiler.glitch.me/">The Super Tiny Compiler</a> 译器源码，详细介绍核心工作流程实现，包括<strong>词法分析器</strong>、<strong>语法分析器</strong>、<strong>遍历器</strong>和<strong>转换器</strong>的基本实现，最后通过<strong>代码生成器</strong>，将各个阶段代码结合起来，实现了这个号称<strong>可能是有史以来最小的编译器。</strong><br />本文也简要介绍了<strong>手写 Webpack 的实现</strong>，需要读者自行完善和深入哟！<br>是不是觉得很神奇~<br /><br><img src="https://st0.dancf.com/csc/346/templets/20191106-155044-c33a.gif"><br /><br>当然通过本文学习，也仅仅是编译器相关知识的边山一脚，要学的知识还有非常多，不过好的开头，更能促进我们学习动力。加油！<br /><br><br />最后，文中介绍到的代码，我存放在 Github 上：</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://github.com/pingan8787/Leo-JavaScript/blob/master/Cute-Frontend/learningSourceCode/%5Blearning%5Dthe-super-tiny-compiler.js" title="[learning]the-super-tiny-compiler.js">[learning]the-super-tiny-compiler.js</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/pingan8787/Leo-JavaScript/blob/master/Cute-Frontend/learningSourceCode/%5Bwriting%5Dwebpack-compiler.js" title="[writing]webpack-compiler.js">[writing]webpack-compiler.js</a></li>
</ol>
<h1 id="六、参考资料"><a href="#六、参考资料" class="headerlink" title="六、参考资料"></a>六、参考资料</h1><ol>
<li><a target="_blank" rel="noopener" href="https://the-super-tiny-compiler.glitch.me/" title="《The Super Tiny Compiler》">《The Super Tiny Compiler》</a></li>
<li><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000016402699" title="《有史以来最小的编译器源码解析》">《有史以来最小的编译器源码解析》</a></li>
<li><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000008739157" title="《Angular 2 JIT vs AOT》">《Angular 2 JIT vs AOT》</a></li>
</ol>
<h1 id="关于我"><a href="#关于我" class="headerlink" title="关于我"></a>关于我</h1><table>
<thead>
<tr>
<th>Author</th>
<th>王平安</th>
</tr>
</thead>
<tbody><tr>
<td>E-mail</td>
<td><a href="mailto:&#x70;&#105;&#110;&#103;&#x61;&#110;&#56;&#x37;&#56;&#x37;&#x40;&#113;&#x71;&#46;&#x63;&#111;&#x6d;">&#x70;&#105;&#110;&#103;&#x61;&#110;&#56;&#x37;&#56;&#x37;&#x40;&#113;&#x71;&#46;&#x63;&#111;&#x6d;</a></td>
</tr>
<tr>
<td>博  客</td>
<td><a target="_blank" rel="noopener" href="http://www.pingan8787.com/">www.pingan8787.com</a></td>
</tr>
<tr>
<td>微  信</td>
<td>pingan8787</td>
</tr>
<tr>
<td>每日文章推荐</td>
<td><a target="_blank" rel="noopener" href="https://github.com/pingan8787/Leo_Reading/issues">https://github.com/pingan8787/Leo_Reading/issues</a></td>
</tr>
<tr>
<td>ES小册</td>
<td>js.pingan8787.com</td>
</tr>
</tbody></table>
<p><img src="https://user-gold-cdn.xitu.io/2020/2/22/1706bb1ea5f680ae?w=885&h=445&f=png&s=80093">  </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/03/30/201-%E3%80%90%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86%E3%80%91200%E8%A1%8CJS%E4%BB%A3%E7%A0%81%E5%B8%A6%E4%BD%A0%E5%AE%9E%E7%8E%B0%E5%BE%AE%E5%9E%8B%E7%BC%96%E8%AF%91%E5%99%A8%EF%BC%88%E4%BA%BA%E4%BA%BA%E9%83%BD%E8%83%BD%E5%AD%A6%E4%BC%9A%EF%BC%89/" data-id="ckts3ejym00mx4d9kbv2j3lrr" data-title="201-【编译原理】200行JS代码带你实现微型编译器（人人都能学会）" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/" rel="tag">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/" rel="tag">前端开发</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%8E%9F%E5%88%9B/" rel="tag">原创</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/" rel="tag">编译原理</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-200-【数据结构】8种常见数据结构" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/03/24/200-%E3%80%90%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E3%80%918%E7%A7%8D%E5%B8%B8%E8%A7%81%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" class="article-date">
  <time class="dt-published" datetime="2020-03-24T13:27:48.000Z" itemprop="datePublished">2020-03-24</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/03/24/200-%E3%80%90%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E3%80%918%E7%A7%8D%E5%B8%B8%E8%A7%81%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/">200-【数据结构】8种常见数据结构</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>来源 | <a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000020011987">https://segmentfault.com/a/1190000020011987</a></p>
<p>做前端的同学不少都是自学成才或者半路出家，计算机基础的知识比较薄弱，尤其是数据结构和算法这块，所以今天整理了一下常见的数据结构和对应的Javascript的实现，希望能帮助大家完善这方面的知识体系。<br><a name="item-1"></a></p>
<h1 id="1-Stack（栈）"><a href="#1-Stack（栈）" class="headerlink" title="1. Stack（栈）"></a>1. Stack（栈）</h1><p><img src="https://cdn.nlark.com/yuque/0/2020/png/186051/1585055459424-fad002ec-8fbf-4b40-9f68-6f25b665be04.png#align=left&display=inline&height=281&originHeight=281&originWidth=391&size=0&status=done&style=none&width=391"><br />Stack的特点是后进先出（last in first out）。生活中常见的Stack的例子比如一摞书，你最后放上去的那本你之后会最先拿走；又比如浏览器的访问历史，当点击返回按钮，最后访问的网站最先从历史记录中弹出。<br />Stack一般具备以下方法：</p>
<ol>
<li><code>push</code>：将一个元素推入栈顶</li>
<li><code>pop</code>：移除栈顶元素，并返回被移除的元素</li>
<li><code>peek</code>：返回栈顶元素</li>
<li><code>length</code>：返回栈中元素的个数</li>
</ol>
<p>Javascript的Array天生具备了Stack的特性，但我们也可以从头实现一个 Stack类：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Stack</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">this</span>.count = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">this</span>.storage = &#123;&#125;;</span><br><span class="line">  <span class="built_in">this</span>.push = <span class="function"><span class="keyword">function</span> (<span class="params">value</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">this</span>.storage[<span class="built_in">this</span>.count] = value;</span><br><span class="line">    <span class="built_in">this</span>.count++;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">this</span>.pop = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.count === <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">undefined</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">this</span>.count--;</span><br><span class="line">    <span class="keyword">var</span> result = <span class="built_in">this</span>.storage[<span class="built_in">this</span>.count];</span><br><span class="line">    <span class="keyword">delete</span> <span class="built_in">this</span>.storage[<span class="built_in">this</span>.count];</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">this</span>.peek = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.storage[<span class="built_in">this</span>.count - <span class="number">1</span>];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">this</span>.size = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.count;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a name="item-2"></a></p>
<h1 id="2-Queue（队列）"><a href="#2-Queue（队列）" class="headerlink" title="2. Queue（队列）"></a>2. Queue（队列）</h1><p><img src="https://cdn.nlark.com/yuque/0/2020/png/186051/1585055459380-2dcc1113-6e64-4073-a85b-ea203380dad7.png#align=left&display=inline&height=196&originHeight=196&originWidth=300&size=0&status=done&style=none&width=300"><br />Queue和Stack有一些类似，不同的是Stack是先进后出，而Queue是先进先出。Queue在生活中的例子比如排队上公交，排在第一个的总是最先上车；又比如打印机的打印队列，排在前面的最先打印。<br />Queue一般具有以下常见方法：</p>
<ol>
<li><code>enqueue</code>：入列，向队列尾部增加一个元素</li>
<li><code>dequeue</code>：出列，移除队列头部的一个元素并返回被移除的元素</li>
<li><code>front</code>：获取队列的第一个元素</li>
<li><code>isEmpty</code>：判断队列是否为空</li>
<li><code>size</code>：获取队列中元素的个数</li>
</ol>
<p>Javascript中的Array已经具备了Queue的一些特性，所以我们可以借助Array实现一个Queue类型：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Queue</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> collection = [];</span><br><span class="line">  <span class="built_in">this</span>.print = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(collection);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">this</span>.enqueue = <span class="function"><span class="keyword">function</span> (<span class="params">element</span>) </span>&#123;</span><br><span class="line">    collection.push(element);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">this</span>.dequeue = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> collection.shift();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">this</span>.front = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> collection[<span class="number">0</span>];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">this</span>.isEmpty = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> collection.length === <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">this</span>.size = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> collection.length;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a name="item-2-1"></a></p>
<h2 id="Priority-Queue（优先队列）"><a href="#Priority-Queue（优先队列）" class="headerlink" title="Priority Queue（优先队列）"></a>Priority Queue（优先队列）</h2><p>Queue还有个升级版本，给每个元素赋予优先级，优先级高的元素入列时将排到低优先级元素之前。区别主要是<code>enqueue</code>方法的实现：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">PriorityQueue</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="built_in">this</span>.enqueue = <span class="function"><span class="keyword">function</span> (<span class="params">element</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.isEmpty()) &#123;</span><br><span class="line">      collection.push(element);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">var</span> added = <span class="literal">false</span>;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; collection.length; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (element[<span class="number">1</span>] &lt; collection[i][<span class="number">1</span>]) &#123;</span><br><span class="line">          collection.splice(i, <span class="number">0</span>, element);</span><br><span class="line">          added = <span class="literal">true</span>;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (!added) &#123;</span><br><span class="line">        collection.push(element);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>测试一下：</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> pQ = <span class="keyword">new</span> PriorityQueue();</span><br><span class="line">pQ.enqueue([<span class="string">&#x27;gannicus&#x27;</span>, <span class="number">3</span>]);</span><br><span class="line">pQ.enqueue([<span class="string">&#x27;spartacus&#x27;</span>, <span class="number">1</span>]);</span><br><span class="line">pQ.enqueue([<span class="string">&#x27;crixus&#x27;</span>, <span class="number">2</span>]);</span><br><span class="line">pQ.enqueue([<span class="string">&#x27;oenomaus&#x27;</span>, <span class="number">4</span>]);</span><br><span class="line">pQ.print();</span><br></pre></td></tr></table></figure>
<p><strong>结果：</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  [ <span class="string">&#x27;spartacus&#x27;</span>, <span class="number">1</span> ],</span><br><span class="line">  [ <span class="string">&#x27;crixus&#x27;</span>, <span class="number">2</span> ],</span><br><span class="line">  [ <span class="string">&#x27;gannicus&#x27;</span>, <span class="number">3</span> ],</span><br><span class="line">  [ <span class="string">&#x27;oenomaus&#x27;</span>, <span class="number">4</span> ]</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p><a name="item-3"></a></p>
<h1 id="3-Linked-List（链表）"><a href="#3-Linked-List（链表）" class="headerlink" title="3. Linked List（链表）"></a>3. Linked List（链表）</h1><p><img src="https://cdn.nlark.com/yuque/0/2020/png/186051/1585055459373-fd6b544e-135b-43c9-9785-b33be8806d46.png#align=left&display=inline&height=151&originHeight=151&originWidth=335&size=0&status=done&style=none&width=335"><br />顾名思义，链表是一种链式数据结构，链上的每个节点包含两种信息：节点本身的数据和指向下一个节点的指针。链表和传统的数组都是线性的数据结构，存储的都是一个序列的数据，但也有很多区别，如下表：</p>
<table>
<thead>
<tr>
<th>比较维度</th>
<th>数组</th>
<th>链表</th>
</tr>
</thead>
<tbody><tr>
<td>内存分配</td>
<td>静态内存分配，编译时分配且连续</td>
<td>动态内存分配，运行时分配且不连续</td>
</tr>
<tr>
<td>元素获取</td>
<td>通过Index获取，速度较快</td>
<td>通过遍历顺序访问，速度较慢</td>
</tr>
<tr>
<td>添加删除元素</td>
<td>因为内存位置连续且固定，速度较慢</td>
<td>因为内存分配灵活，只有一个开销步骤，速度更快</td>
</tr>
<tr>
<td>空间结构</td>
<td>可以是一维或者多维数组</td>
<td>可以是单向、双向或者循环链表</td>
</tr>
</tbody></table>
<p>一个单向链表通常具有以下方法：</p>
<ol>
<li><code>size</code>：返回链表中节点的个数</li>
<li><code>head</code>：返回链表中的头部元素</li>
<li><code>add</code>：向链表尾部增加一个节点</li>
<li><code>remove</code>：删除某个节点</li>
<li><code>indexOf</code>：返回某个节点的index</li>
<li><code>elementAt</code>：返回某个index处的节点</li>
<li><code>addAt</code>：在某个index处插入一个节点</li>
<li><code>removeAt</code>：删除某个index处的节点</li>
</ol>
<p><strong>单向链表的Javascript实现：</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 链表中的节点 </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Node</span>(<span class="params">element</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 节点中的数据</span></span><br><span class="line">  <span class="built_in">this</span>.element = element;</span><br><span class="line">  <span class="comment">// 指向下一个节点的指针</span></span><br><span class="line">  <span class="built_in">this</span>.next = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">LinkedList</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> length = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">var</span> head = <span class="literal">null</span>;</span><br><span class="line">  <span class="built_in">this</span>.size = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> length;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">this</span>.head = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> head;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">this</span>.add = <span class="function"><span class="keyword">function</span> (<span class="params">element</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> node = <span class="keyword">new</span> Node(element);</span><br><span class="line">    <span class="keyword">if</span> (head == <span class="literal">null</span>) &#123;</span><br><span class="line">      head = node;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">var</span> currentNode = head;</span><br><span class="line">      <span class="keyword">while</span> (currentNode.next) &#123;</span><br><span class="line">        currentNode = currentNode.next;</span><br><span class="line">      &#125;</span><br><span class="line">      currentNode.next = node;</span><br><span class="line">    &#125;</span><br><span class="line">    length++;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">this</span>.remove = <span class="function"><span class="keyword">function</span> (<span class="params">element</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> currentNode = head;</span><br><span class="line">    <span class="keyword">var</span> previousNode;</span><br><span class="line">    <span class="keyword">if</span> (currentNode.element === element) &#123;</span><br><span class="line">      head = currentNode.next;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">while</span> (currentNode.element !== element) &#123;</span><br><span class="line">        previousNode = currentNode;</span><br><span class="line">        currentNode = currentNode.next;</span><br><span class="line">      &#125;</span><br><span class="line">      previousNode.next = currentNode.next;</span><br><span class="line">    &#125;</span><br><span class="line">    length--;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">this</span>.isEmpty = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> length === <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">this</span>.indexOf = <span class="function"><span class="keyword">function</span> (<span class="params">element</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> currentNode = head;</span><br><span class="line">    <span class="keyword">var</span> index = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (currentNode) &#123;</span><br><span class="line">      index++;</span><br><span class="line">      <span class="keyword">if</span> (currentNode.element === element) &#123;</span><br><span class="line">        <span class="keyword">return</span> index;</span><br><span class="line">      &#125;</span><br><span class="line">      currentNode = currentNode.next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">this</span>.elementAt = <span class="function"><span class="keyword">function</span> (<span class="params">index</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> currentNode = head;</span><br><span class="line">    <span class="keyword">var</span> count = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (count &lt; index) &#123;</span><br><span class="line">      count++;</span><br><span class="line">      currentNode = currentNode.next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> currentNode.element;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">this</span>.addAt = <span class="function"><span class="keyword">function</span> (<span class="params">index, element</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> node = <span class="keyword">new</span> Node(element);</span><br><span class="line">    <span class="keyword">var</span> currentNode = head;</span><br><span class="line">    <span class="keyword">var</span> previousNode;</span><br><span class="line">    <span class="keyword">var</span> currentIndex = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (index &gt; length) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (index === <span class="number">0</span>) &#123;</span><br><span class="line">      node.next = currentNode;</span><br><span class="line">      head = node;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">while</span> (currentIndex &lt; index) &#123;</span><br><span class="line">        currentIndex++;</span><br><span class="line">        previousNode = currentNode;</span><br><span class="line">        currentNode = currentNode.next;</span><br><span class="line">      &#125;</span><br><span class="line">      node.next = currentNode;</span><br><span class="line">      previousNode.next = node;</span><br><span class="line">    &#125;</span><br><span class="line">    length++;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">this</span>.removeAt = <span class="function"><span class="keyword">function</span> (<span class="params">index</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> currentNode = head;</span><br><span class="line">    <span class="keyword">var</span> previousNode;</span><br><span class="line">    <span class="keyword">var</span> currentIndex = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (index &lt; <span class="number">0</span> || index &gt;= length) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (index === <span class="number">0</span>) &#123;</span><br><span class="line">      head = currentIndex.next;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">while</span> (currentIndex &lt; index) &#123;</span><br><span class="line">        currentIndex++;</span><br><span class="line">        previousNode = currentNode;</span><br><span class="line">        currentNode = currentNode.next;</span><br><span class="line">      &#125;</span><br><span class="line">      previousNode.next = currentNode.next;</span><br><span class="line">    &#125;</span><br><span class="line">    length--;</span><br><span class="line">    <span class="keyword">return</span> currentNode.element;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a name="item-4"></a></p>
<h1 id="4-Set（集合）"><a href="#4-Set（集合）" class="headerlink" title="4. Set（集合）"></a>4. Set（集合）</h1><p><img src="https://cdn.nlark.com/yuque/0/2020/png/186051/1585055459561-531a1b4c-96d9-428a-8dd6-8cf87eb4509e.png#align=left&display=inline&height=163&originHeight=163&originWidth=397&size=0&status=done&style=none&width=397"><br />集合是数学中的一个基本概念，表示具有某种特性的对象汇总成的集体。在ES6中也引入了集合类型Set，Set和Array有一定程度的相似，不同的是Set中不允许出现重复的元素而且是无序的。<br />一个典型的Set应该具有以下方法：</p>
<ol>
<li><code>values</code>：返回集合中的所有元素</li>
<li><code>size</code>：返回集合中元素的个数</li>
<li><code>has</code>：判断集合中是否存在某个元素</li>
<li><code>add</code>：向集合中添加元素</li>
<li><code>remove</code>：从集合中移除某个元素</li>
<li><code>union</code>：返回两个集合的并集</li>
<li><code>intersection</code>：返回两个集合的交集</li>
<li><code>difference</code>：返回两个集合的差集</li>
<li><code>subset</code>：判断一个集合是否为另一个集合的子集</li>
</ol>
<p>使用Javascript可以将Set进行如下实现，为了区别于ES6中的Set命名为MySet：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">MySet</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> collection = [];</span><br><span class="line">  <span class="built_in">this</span>.has = <span class="function"><span class="keyword">function</span> (<span class="params">element</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (collection.indexOf(element) !== -<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">this</span>.values = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> collection;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">this</span>.size = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> collection.length;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">this</span>.add = <span class="function"><span class="keyword">function</span> (<span class="params">element</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">this</span>.has(element)) &#123;</span><br><span class="line">      collection.push(element);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">this</span>.remove = <span class="function"><span class="keyword">function</span> (<span class="params">element</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.has(element)) &#123;</span><br><span class="line">      index = collection.indexOf(element);</span><br><span class="line">      collection.splice(index, <span class="number">1</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">this</span>.union = <span class="function"><span class="keyword">function</span> (<span class="params">otherSet</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> unionSet = <span class="keyword">new</span> MySet();</span><br><span class="line">    <span class="keyword">var</span> firstSet = <span class="built_in">this</span>.values();</span><br><span class="line">    <span class="keyword">var</span> secondSet = otherSet.values();</span><br><span class="line">    firstSet.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">      unionSet.add(e);</span><br><span class="line">    &#125;);</span><br><span class="line">    secondSet.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">      unionSet.add(e);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> unionSet;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">this</span>.intersection = <span class="function"><span class="keyword">function</span> (<span class="params">otherSet</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> intersectionSet = <span class="keyword">new</span> MySet();</span><br><span class="line">    <span class="keyword">var</span> firstSet = <span class="built_in">this</span>.values();</span><br><span class="line">    firstSet.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (otherSet.has(e)) &#123;</span><br><span class="line">        intersectionSet.add(e);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> intersectionSet;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">this</span>.difference = <span class="function"><span class="keyword">function</span> (<span class="params">otherSet</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> differenceSet = <span class="keyword">new</span> MySet();</span><br><span class="line">    <span class="keyword">var</span> firstSet = <span class="built_in">this</span>.values();</span><br><span class="line">    firstSet.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (!otherSet.has(e)) &#123;</span><br><span class="line">        differenceSet.add(e);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> differenceSet;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">this</span>.subset = <span class="function"><span class="keyword">function</span> (<span class="params">otherSet</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> firstSet = <span class="built_in">this</span>.values();</span><br><span class="line">    <span class="keyword">return</span> firstSet.every(<span class="function"><span class="keyword">function</span> (<span class="params">value</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> otherSet.has(value);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a name="item-5"></a></p>
<h1 id="5-Hash-Table（哈希表-散列表）"><a href="#5-Hash-Table（哈希表-散列表）" class="headerlink" title="5. Hash Table（哈希表/散列表）"></a>5. Hash Table（哈希表/散列表）</h1><p><img src="https://cdn.nlark.com/yuque/0/2020/png/186051/1585055459382-b498aa21-cbcc-4ccb-b4cf-9b7827743a47.png#align=left&display=inline&height=230&originHeight=230&originWidth=315&size=0&status=done&style=none&width=315"><br />Hash Table是一种用于存储键值对（key value pair）的数据结构，因为Hash Table根据key查询value的速度很快，所以它常用于实现Map、Dictinary、Object等数据结构。如上图所示，Hash Table内部使用一个hash函数将传入的键转换成一串数字，而这串数字将作为键值对实际的key，通过这个key查询对应的value非常快，时间复杂度将达到O(1)。Hash函数要求相同输入对应的输出必须相等，而不同输入对应的输出必须不等，相当于对每对数据打上唯一的指纹。<br />一个Hash Table通常具有下列方法：</p>
<ol>
<li><code>add</code>：增加一组键值对</li>
<li><code>remove</code>：删除一组键值对</li>
<li><code>lookup</code>：查找一个键对应的值</li>
</ol>
<p><strong>一个简易版本的Hash Table的Javascript实现：</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hash</span>(<span class="params">string, max</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> hash = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; string.length; i++) &#123;</span><br><span class="line">    hash += string.charCodeAt(i);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> hash % max;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">HashTable</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> storage = [];</span><br><span class="line">  <span class="keyword">const</span> storageLimit = <span class="number">4</span>;</span><br><span class="line">  <span class="built_in">this</span>.add = <span class="function"><span class="keyword">function</span> (<span class="params">key, value</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> index = hash(key, storageLimit);</span><br><span class="line">    <span class="keyword">if</span> (storage[index] === <span class="literal">undefined</span>) &#123;</span><br><span class="line">      storage[index] = [</span><br><span class="line">        [key, value]</span><br><span class="line">      ];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">var</span> inserted = <span class="literal">false</span>;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; storage[index].length; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (storage[index][i][<span class="number">0</span>] === key) &#123;</span><br><span class="line">          storage[index][i][<span class="number">1</span>] = value;</span><br><span class="line">          inserted = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (inserted === <span class="literal">false</span>) &#123;</span><br><span class="line">        storage[index].push([key, value]);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">this</span>.remove = <span class="function"><span class="keyword">function</span> (<span class="params">key</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> index = hash(key, storageLimit);</span><br><span class="line">    <span class="keyword">if</span> (storage[index].length === <span class="number">1</span> &amp;&amp; storage[index][<span class="number">0</span>][<span class="number">0</span>] === key) &#123;</span><br><span class="line">      <span class="keyword">delete</span> storage[index];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; storage[index]; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (storage[index][i][<span class="number">0</span>] === key) &#123;</span><br><span class="line">          <span class="keyword">delete</span> storage[index][i];</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">this</span>.lookup = <span class="function"><span class="keyword">function</span> (<span class="params">key</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> index = hash(key, storageLimit);</span><br><span class="line">    <span class="keyword">if</span> (storage[index] === <span class="literal">undefined</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">undefined</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; storage[index].length; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (storage[index][i][<span class="number">0</span>] === key) &#123;</span><br><span class="line">          <span class="keyword">return</span> storage[index][i][<span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a name="item-6"></a></p>
<h1 id="6-Tree（树）"><a href="#6-Tree（树）" class="headerlink" title="6. Tree（树）"></a>6. Tree（树）</h1><p><img src="https://cdn.nlark.com/yuque/0/2020/png/186051/1585055459390-c69c0792-773f-45ac-bbb7-4656f1f516af.png#align=left&display=inline&height=424&originHeight=424&originWidth=708&size=0&status=done&style=none&width=708"><br />顾名思义，Tree的数据结构和自然界中的树极其相似，有根、树枝、叶子，如上图所示。Tree是一种多层数据结构，与Array、Stack、Queue相比是一种非线性的数据结构，在进行插入和搜索操作时很高效。在描述一个Tree时经常会用到下列概念：</p>
<ol>
<li>Root（根）：代表树的根节点，根节点没有父节点</li>
<li>Parent Node（父节点）：一个节点的直接上级节点，只有一个</li>
<li>Child Node（子节点）：一个节点的直接下级节点，可能有多个</li>
<li>Siblings（兄弟节点）：具有相同父节点的节点</li>
<li>Leaf（叶节点）：没有子节点的节点</li>
<li>Edge（边）：两个节点之间的连接线</li>
<li>Path（路径）：从源节点到目标节点的连续边</li>
<li>Height of Node（节点的高度）：表示节点与叶节点之间的最长路径上边的个数</li>
<li>Height of Tree（树的高度）：即根节点的高度</li>
<li>Depth of Node（节点的深度）：表示从根节点到该节点的边的个数</li>
<li>Degree of Node（节点的度）：表示子节点的个数</li>
</ol>
<p>我们以二叉查找树为例，展示树在Javascript中的实现。在二叉查找树中，即每个节点最多只有两个子节点，而左侧子节点小于当前节点，而右侧子节点大于当前节点，如图所示：<br /><img src="https://cdn.nlark.com/yuque/0/2020/png/186051/1585055459516-ce2e5d9a-f57e-4ef0-b30f-5b35ada54166.png#align=left&display=inline&height=333&originHeight=333&originWidth=562&size=0&status=done&style=none&width=562"><br />一个二叉查找树应该具有以下常用方法：</p>
<ol>
<li><code>add</code>：向树中插入一个节点</li>
<li><code>findMin</code>：查找树中最小的节点</li>
<li><code>findMax</code>：查找树中最大的节点</li>
<li><code>find</code>：查找树中的某个节点</li>
<li><code>isPresent</code>：判断某个节点在树中是否存在</li>
<li><code>remove</code>：移除树中的某个节点</li>
</ol>
<p>以下是二叉查找树的Javascript实现：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Node</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">data, left = <span class="literal">null</span>, right = <span class="literal">null</span></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.data = data;</span><br><span class="line">    <span class="built_in">this</span>.left = left;</span><br><span class="line">    <span class="built_in">this</span>.right = right;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BST</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.root = <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">add</span>(<span class="params">data</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> node = <span class="built_in">this</span>.root;</span><br><span class="line">    <span class="keyword">if</span> (node === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="built_in">this</span>.root = <span class="keyword">new</span> Node(data);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> searchTree = <span class="function"><span class="keyword">function</span> (<span class="params">node</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (data &lt; node.data) &#123;</span><br><span class="line">          <span class="keyword">if</span> (node.left === <span class="literal">null</span>) &#123;</span><br><span class="line">            node.left = <span class="keyword">new</span> Node(data);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (node.left !== <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> searchTree(node.left);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (data &gt; node.data) &#123;</span><br><span class="line">          <span class="keyword">if</span> (node.right === <span class="literal">null</span>) &#123;</span><br><span class="line">            node.right = <span class="keyword">new</span> Node(data);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (node.right !== <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> searchTree(node.right);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;;</span><br><span class="line">      <span class="keyword">return</span> searchTree(node);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">findMin</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> current = <span class="built_in">this</span>.root;</span><br><span class="line">    <span class="keyword">while</span> (current.left !== <span class="literal">null</span>) &#123;</span><br><span class="line">      current = current.left;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> current.data;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">findMax</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> current = <span class="built_in">this</span>.root;</span><br><span class="line">    <span class="keyword">while</span> (current.right !== <span class="literal">null</span>) &#123;</span><br><span class="line">      current = current.right;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> current.data;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">find</span>(<span class="params">data</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> current = <span class="built_in">this</span>.root;</span><br><span class="line">    <span class="keyword">while</span> (current.data !== data) &#123;</span><br><span class="line">      <span class="keyword">if</span> (data &lt; current.data) &#123;</span><br><span class="line">        current = current.left</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        current = current.right;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (current === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> current;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">isPresent</span>(<span class="params">data</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> current = <span class="built_in">this</span>.root;</span><br><span class="line">    <span class="keyword">while</span> (current) &#123;</span><br><span class="line">      <span class="keyword">if</span> (data === current.data) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (data &lt; current.data) &#123;</span><br><span class="line">        current = current.left;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        current = current.right;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">remove</span>(<span class="params">data</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> removeNode = <span class="function"><span class="keyword">function</span> (<span class="params">node, data</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (node == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (data == node.data) &#123;</span><br><span class="line">        <span class="comment">// node没有子节点</span></span><br><span class="line">        <span class="keyword">if</span> (node.left == <span class="literal">null</span> &amp;&amp; node.right == <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// node没有左侧子节点</span></span><br><span class="line">        <span class="keyword">if</span> (node.left == <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> node.right;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// node没有右侧子节点</span></span><br><span class="line">        <span class="keyword">if</span> (node.right == <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> node.left;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// node有两个子节点</span></span><br><span class="line">        <span class="keyword">var</span> tempNode = node.right;</span><br><span class="line">        <span class="keyword">while</span> (tempNode.left !== <span class="literal">null</span>) &#123;</span><br><span class="line">          tempNode = tempNode.left;</span><br><span class="line">        &#125;</span><br><span class="line">        node.data = tempNode.data;</span><br><span class="line">        node.right = removeNode(node.right, tempNode.data);</span><br><span class="line">        <span class="keyword">return</span> node;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (data &lt; node.data) &#123;</span><br><span class="line">        node.left = removeNode(node.left, data);</span><br><span class="line">        <span class="keyword">return</span> node;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        node.right = removeNode(node.right, data);</span><br><span class="line">        <span class="keyword">return</span> node;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">this</span>.root = removeNode(<span class="built_in">this</span>.root, data);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>测试一下：</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> bst = <span class="keyword">new</span> BST();</span><br><span class="line">bst.add(<span class="number">4</span>);</span><br><span class="line">bst.add(<span class="number">2</span>);</span><br><span class="line">bst.add(<span class="number">6</span>);</span><br><span class="line">bst.add(<span class="number">1</span>);</span><br><span class="line">bst.add(<span class="number">3</span>);</span><br><span class="line">bst.add(<span class="number">5</span>);</span><br><span class="line">bst.add(<span class="number">7</span>);</span><br><span class="line">bst.remove(<span class="number">4</span>);</span><br><span class="line"><span class="built_in">console</span>.log(bst.findMin());</span><br><span class="line"><span class="built_in">console</span>.log(bst.findMax());</span><br><span class="line">bst.remove(<span class="number">7</span>);</span><br><span class="line"><span class="built_in">console</span>.log(bst.findMax());</span><br><span class="line"><span class="built_in">console</span>.log(bst.isPresent(<span class="number">4</span>));</span><br></pre></td></tr></table></figure>
<p><strong>打印结果：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1</span><br><span class="line">7</span><br><span class="line">6</span><br><span class="line">false</span><br></pre></td></tr></table></figure>
<p><a name="item-7"></a></p>
<h1 id="7-Trie（字典树，读音同try）"><a href="#7-Trie（字典树，读音同try）" class="headerlink" title="7. Trie（字典树，读音同try）"></a>7. Trie（字典树，读音同try）</h1><p><img src="https://cdn.nlark.com/yuque/0/2020/png/186051/1585055459493-dcf8b11b-5b4a-45f6-b5ce-df254b1390b4.png#align=left&display=inline&height=632&originHeight=632&originWidth=797&size=0&status=done&style=none&width=797"><br />Trie也可以叫做Prefix Tree（前缀树），也是一种搜索树。Trie分步骤存储数据，树中的每个节点代表一个步骤，trie常用于存储单词以便快速查找，比如实现单词的自动完成功能。 Trie中的每个节点都包含一个单词的字母，跟着树的分支可以可以拼写出一个完整的单词，每个节点还包含一个布尔值表示该节点是否是单词的最后一个字母。<br />Trie一般有以下方法：</p>
<ol>
<li><code>add</code>：向字典树中增加一个单词</li>
<li><code>isWord</code>：判断字典树中是否包含某个单词</li>
<li><code>print</code>：返回字典树中的所有单词<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Trie的节点</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Node</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">this</span>.keys = <span class="keyword">new</span> <span class="built_in">Map</span>();</span><br><span class="line">  <span class="built_in">this</span>.end = <span class="literal">false</span>;</span><br><span class="line">  <span class="built_in">this</span>.setEnd = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">this</span>.end = <span class="literal">true</span>;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="built_in">this</span>.isEnd = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.end;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Trie</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">this</span>.root = <span class="keyword">new</span> Node();</span><br><span class="line">  <span class="built_in">this</span>.add = <span class="function"><span class="keyword">function</span> (<span class="params">input, node = <span class="built_in">this</span>.root</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (input.length === <span class="number">0</span>) &#123;</span><br><span class="line">      node.setEnd();</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!node.keys.has(input[<span class="number">0</span>])) &#123;</span><br><span class="line">      node.keys.set(input[<span class="number">0</span>], <span class="keyword">new</span> Node());</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">this</span>.add(input.substr(<span class="number">1</span>), node.keys.get(input[<span class="number">0</span>]));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">this</span>.add(input.substr(<span class="number">1</span>), node.keys.get(input[<span class="number">0</span>]));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">this</span>.isWord = <span class="function"><span class="keyword">function</span> (<span class="params">word</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> node = <span class="built_in">this</span>.root;</span><br><span class="line">    <span class="keyword">while</span> (word.length &gt; <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!node.keys.has(word[<span class="number">0</span>])) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        node = node.keys.get(word[<span class="number">0</span>]);</span><br><span class="line">        word = word.substr(<span class="number">1</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (node.keys.has(word) &amp;&amp; node.keys.get(word).isEnd()) ? <span class="literal">true</span> : <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">this</span>.print = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> words = <span class="keyword">new</span> <span class="built_in">Array</span>();</span><br><span class="line">    <span class="keyword">let</span> search = <span class="function"><span class="keyword">function</span> (<span class="params">node = <span class="built_in">this</span>.root, string</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (node.keys.size != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> letter <span class="keyword">of</span> node.keys.keys()) &#123;</span><br><span class="line">          search(node.keys.get(letter), string.concat(letter));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (node.isEnd()) &#123;</span><br><span class="line">          words.push(string);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        string.length &gt; <span class="number">0</span> ? words.push(string) : <span class="literal">undefined</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    search(<span class="built_in">this</span>.root, <span class="keyword">new</span> <span class="built_in">String</span>());</span><br><span class="line">    <span class="keyword">return</span> words.length &gt; <span class="number">0</span> ? words : <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<a name="item-8"></a><h1 id="8-Graph（图）"><a href="#8-Graph（图）" class="headerlink" title="8. Graph（图）"></a>8. Graph（图）</h1><img src="https://cdn.nlark.com/yuque/0/2020/png/186051/1585055459558-bd99813e-d9ce-412e-b569-f6f1316ff97f.png#align=left&display=inline&height=367&originHeight=367&originWidth=800&size=0&status=done&style=none&width=800"><br />Graph是节点（或顶点）以及它们之间的连接（或边）的集合。Graph也可以称为Network（网络）。根据节点之间的连接是否有方向又可以分为Directed Graph（有向图）和Undrected Graph（无向图）。Graph在实际生活中有很多用途，比如：导航软件计算最佳路径，社交软件进行好友推荐等等。<br />Graph通常有两种表达方式：<br /><strong>Adjaceny List（邻接列表）</strong>：<br /><img src="https://cdn.nlark.com/yuque/0/2020/jpeg/186051/1585055459444-1e95771f-b986-496c-a08c-4db76bdb3820.jpeg#align=left&display=inline&height=220&originHeight=220&originWidth=600&size=0&status=done&style=none&width=600"><br />邻接列表可以表示为左侧是节点的列表，右侧列出它所连接的所有其他节点。<br />和 <strong>Adjacency Matrix（邻接矩阵）</strong>：<br /><img src="https://cdn.nlark.com/yuque/0/2020/png/186051/1585055459540-fd0e2de2-1221-4479-a9d7-fdeb0709e0ea.png#align=left&display=inline&height=211&originHeight=211&originWidth=555&size=0&status=done&style=none&width=555"><br />邻接矩阵用矩阵来表示节点之间的连接关系，每行或者每列表示一个节点，行和列的交叉处的数字表示节点之间的关系：0表示没用连接，1表示有连接，大于1表示不同的权重。<br />访问Graph中的节点需要使用遍历算法，遍历算法又分为广度优先和深度优先，主要用于确定目标节点和根节点之间的距离，<br />在Javascript中，Graph可以用一个矩阵（二维数组）表示，广度优先搜索算法可以实现如下：<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">bfs</span>(<span class="params">graph, root</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> nodesLen = &#123;&#125;;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; graph.length; i++) &#123;</span><br><span class="line">    nodesLen[i] = <span class="literal">Infinity</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  nodesLen[root] = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">var</span> queue = [root];</span><br><span class="line">  <span class="keyword">var</span> current;</span><br><span class="line">  <span class="keyword">while</span> (queue.length != <span class="number">0</span>) &#123;</span><br><span class="line">    current = queue.shift();</span><br><span class="line">    <span class="keyword">var</span> curConnected = graph[current];</span><br><span class="line">    <span class="keyword">var</span> neighborIdx = [];</span><br><span class="line">    <span class="keyword">var</span> idx = curConnected.indexOf(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">while</span> (idx != -<span class="number">1</span>) &#123;</span><br><span class="line">      neighborIdx.push(idx);</span><br><span class="line">      idx = curConnected.indexOf(<span class="number">1</span>, idx + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; neighborIdx.length; j++) &#123;</span><br><span class="line">      <span class="keyword">if</span> (nodesLen[neighborIdx[j]] == <span class="literal">Infinity</span>) &#123;</span><br><span class="line">        nodesLen[neighborIdx[j]] = nodesLen[current] + <span class="number">1</span>;</span><br><span class="line">        queue.push(neighborIdx[j]);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> nodesLen;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<p><strong>测试一下：</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> graph = [</span><br><span class="line">  [<span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>],</span><br><span class="line">  [<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">  [<span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">  [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>],</span><br><span class="line">  [<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line">];</span><br><span class="line"><span class="built_in">console</span>.log(bfs(graph, <span class="number">1</span>));</span><br></pre></td></tr></table></figure>
<p><strong>打印：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  0: 2,</span><br><span class="line">  1: 0,</span><br><span class="line">  2: 1,</span><br><span class="line">  3: 3,</span><br><span class="line">  4: Infinity</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>本文旨在向广大前端同学普及常见的数据结构，本人对这一领域也只是初窥门径，说的有差池的地方欢迎指出。也希望大家能打牢基础，在这条路上走的更高更远！</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/03/24/200-%E3%80%90%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E3%80%918%E7%A7%8D%E5%B8%B8%E8%A7%81%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" data-id="ckts3ejyl00mv4d9k7gm01j36" data-title="200-【数据结构】8种常见数据结构" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/" rel="tag">前端开发</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" rel="tag">数据结构</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-199-【Webpack】彻底搞懂并实现webpack热更新原理" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/03/11/199-%E3%80%90Webpack%E3%80%91%E5%BD%BB%E5%BA%95%E6%90%9E%E6%87%82%E5%B9%B6%E5%AE%9E%E7%8E%B0webpack%E7%83%AD%E6%9B%B4%E6%96%B0%E5%8E%9F%E7%90%86/" class="article-date">
  <time class="dt-published" datetime="2020-03-11T15:20:35.000Z" itemprop="datePublished">2020-03-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/03/11/199-%E3%80%90Webpack%E3%80%91%E5%BD%BB%E5%BA%95%E6%90%9E%E6%87%82%E5%B9%B6%E5%AE%9E%E7%8E%B0webpack%E7%83%AD%E6%9B%B4%E6%96%B0%E5%8E%9F%E7%90%86/">199-【Webpack】彻底搞懂并实现webpack热更新原理</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>原文地址：<a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000020310371">https://segmentfault.com/a/1190000020310371</a></p>
<ul>
<li><p><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000020310371#HMR%E6%98%AF%E4%BB%80%E4%B9%88">HMR是什么</a></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000020310371#%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF">使用场景</a></li>
</ul>
</li>
<li><p><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000020310371#%E9%85%8D%E7%BD%AE%E4%BD%BF%E7%94%A8HMR">配置使用HMR</a></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000020310371#%E9%85%8D%E7%BD%AEwebpack">配置webpack</a></li>
<li><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000020310371#%E8%A7%A3%E6%9E%90webpack%E6%89%93%E5%8C%85%E5%90%8E%E7%9A%84%E6%96%87%E4%BB%B6%E5%86%85%E5%AE%B9">解析webpack打包后的文件内容</a></li>
<li><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000020310371#%E9%85%8D%E7%BD%AEHMR">配置HMR</a></li>
</ul>
</li>
<li><p><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000020310371#HMR%E5%8E%9F%E7%90%86">HMR原理</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000020310371#debug%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%BA%90%E7%A0%81">debug服务端源码</a></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000020310371#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E7%AE%80%E6%98%93%E5%AE%9E%E7%8E%B0">服务端简易实现</a></li>
<li><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000020310371#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E8%B0%83%E8%AF%95%E9%98%B6%E6%AE%B5">服务端调试阶段</a></li>
</ul>
</li>
<li><p><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000020310371#debug%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%BA%90%E7%A0%81">debug客户端源码</a></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000020310371#%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%AE%80%E6%98%93%E5%AE%9E%E7%8E%B0">客户端简易实现</a></li>
<li><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000020310371#%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%B0%83%E8%AF%95%E9%98%B6%E6%AE%B5">客户端调试阶段</a></li>
</ul>
</li>
<li><p><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000020310371#%E9%97%AE%E9%A2%98">问题</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000020310371#%E6%80%BB%E7%BB%93">总结</a><br><a name="item-2"></a></p>
<h2 id="HMR是什么"><a href="#HMR是什么" class="headerlink" title="HMR是什么"></a>HMR是什么</h2><p><code>HMR</code>即<code>Hot Module Replacement</code>是指当你对代码修改并保存后，<code>webpack</code>将会对代码进行重新打包，并将改动的模块发送到浏览器端，浏览器用新的模块替换掉旧的模块，去实现局部更新页面而非整体刷新页面。接下来将从使用到实现一版简易功能带领大家深入浅出<code>HMR</code>。<br />文章首发于<a target="_blank" rel="noopener" href="https://github.com/careteenL/webpack-hmr">@careteen/webpack-hmr</a>，转载请注明来源即可。<br><a name="item-2-1"></a></p>
<h3 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h3><p><img src="https://cdn.nlark.com/yuque/0/2020/jpeg/186051/1583939666973-5b57ede4-45d0-4e23-b722-ad85fcc78f1a.jpeg#align=left&display=inline&height=548&originHeight=548&originWidth=800&size=0&status=done&style=none&width=800"><br />如上图所示，一个注册页面包含<code>用户名</code>、<code>密码</code>、<code>邮箱</code>三个必填输入框，以及一个<code>提交</code>按钮，当你在调试<code>邮箱</code>模块改动了代码时，没做任何处理情况下是会刷新整个页面，频繁的改动代码会浪费你大量时间去重新填写内容。预期是保留<code>用户名</code>、<code>密码</code>的输入内容，而只替换<code>邮箱</code>这一模块。这一诉求就需要借助<code>webpack-dev-server</code>的热模块更新功能。<br />相对于<code>live reload</code>整体刷新页面的方案，<code>HMR</code>的优点在于可以保存应用的状态，提高开发效率。<br><a name="item-3"></a></p>
<h2 id="配置使用HMR"><a href="#配置使用HMR" class="headerlink" title="配置使用HMR"></a>配置使用HMR</h2><p><a name="item-3-2"></a></p>
<h3 id="配置webpack"><a href="#配置webpack" class="headerlink" title="配置webpack"></a>配置webpack</h3><p>首先借助<code>webpack</code>搭建项目</p>
</li>
<li><p>初识化项目并导入依赖</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir webpack-hmr &amp;&amp; <span class="built_in">cd</span> webpack-hmr</span><br><span class="line">npm i -y</span><br><span class="line">npm i -S webpack webpack-cli webpack-dev-server html-webpack-plugin</span><br></pre></td></tr></table></figure></li>
<li><p>配置文件<code>webpack.config.js</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> webpack = <span class="built_in">require</span>(<span class="string">&#x27;webpack&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> htmlWebpackPlugin = <span class="built_in">require</span>(<span class="string">&#x27;html-webpack-plugin&#x27;</span>)</span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="attr">mode</span>: <span class="string">&#x27;development&#x27;</span>, <span class="comment">// 开发模式不压缩代码，方便调试</span></span><br><span class="line">  <span class="attr">entry</span>: <span class="string">&#x27;./src/index.js&#x27;</span>, <span class="comment">// 入口文件</span></span><br><span class="line">  <span class="attr">output</span>: &#123;</span><br><span class="line">    <span class="attr">path</span>: path.join(__dirname, <span class="string">&#x27;dist&#x27;</span>),</span><br><span class="line">    <span class="attr">filename</span>: <span class="string">&#x27;main.js&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">devServer</span>: &#123;</span><br><span class="line">    <span class="attr">contentBase</span>: path.join(__dirname, <span class="string">&#x27;dist&#x27;</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">plugins</span>: [</span><br><span class="line">    <span class="keyword">new</span> htmlWebpackPlugin(&#123;</span><br><span class="line">      <span class="attr">template</span>: <span class="string">&#x27;./src/index.html&#x27;</span>,</span><br><span class="line">      <span class="attr">filename</span>: <span class="string">&#x27;index.html&#x27;</span></span><br><span class="line">    &#125;)</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>新建<code>src/index.html</code>模板文件</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;ie=edge&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>Webpack Hot Module Replacement<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;root&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><p>新建<code>src/index.js</code>入口文件编写简单逻辑</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> root = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;root&#x27;</span>)</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  root.innerHTML = <span class="built_in">require</span>(<span class="string">&#x27;./content.js&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line">render()</span><br></pre></td></tr></table></figure></li>
<li><p>新建依赖文件<code>src/content.js</code>导出字符供index渲染页面</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ret = <span class="string">&#x27;Hello Webpack Hot Module Replacement&#x27;</span></span><br><span class="line"><span class="built_in">module</span>.exports = ret</span><br><span class="line"><span class="comment">// export default ret</span></span><br></pre></td></tr></table></figure></li>
<li><p>配置<code>package.json</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;scripts&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;dev&quot;</span>: <span class="string">&quot;webpack-dev-server&quot;</span>,</span><br><span class="line">    <span class="string">&quot;build&quot;</span>: <span class="string">&quot;webpack&quot;</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></li>
<li><p>然后<code>npm run dev</code>即可启动项目</p>
</li>
<li><p>通过<code>npm run build</code>打包生成静态资源到<code>dist</code>目录</p>
</li>
</ul>
<p>接下来先分析下<code>dist</code>目录中的文件<br><a name="item-3-3"></a></p>
<h3 id="解析webpack打包后的文件内容"><a href="#解析webpack打包后的文件内容" class="headerlink" title="解析webpack打包后的文件内容"></a>解析webpack打包后的文件内容</h3><ul>
<li>webpack自己实现的一套commonjs规范讲解</li>
<li>区分commonjs和esmodule</li>
</ul>
<p>dist目录结构</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── index.html</span><br><span class="line">└── main.js</span><br></pre></td></tr></table></figure>
<p><a name="AsJuz"></a></p>
<h4 id="其中index-html内容如下"><a href="#其中index-html内容如下" class="headerlink" title="其中index.html内容如下"></a>其中<code>index.html</code>内容如下</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- ... --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;root&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span> <span class="attr">src</span>=<span class="string">&quot;main.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- ... --&gt;</span></span><br></pre></td></tr></table></figure>
<p>使用<code>html-webpack-plugin</code>插件将入口文件及其依赖通过<code>script</code>标签引入<br><a name="Tf06E"></a></p>
<h4 id="先对main-js内容去掉注释和无关内容进行分析"><a href="#先对main-js内容去掉注释和无关内容进行分析" class="headerlink" title="先对main.js内容去掉注释和无关内容进行分析"></a>先对<code>main.js</code>内容去掉注释和无关内容进行分析</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params">modules</span>) </span>&#123; <span class="comment">// webpackBootstrap</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;)</span><br><span class="line">(&#123;</span><br><span class="line">  <span class="string">&quot;./src/content.js&quot;</span>:</span><br><span class="line">    (<span class="function"><span class="keyword">function</span> (<span class="params"><span class="built_in">module</span>, <span class="built_in">exports</span></span>) </span>&#123;</span><br><span class="line">      <span class="built_in">eval</span>(<span class="string">&quot;var ret = &#x27;Hello Webpack Hot Module Replacement&#x27;\n\nmodule.exports = ret\n// export default ret\n\n&quot;</span>);</span><br><span class="line">    &#125;),</span><br><span class="line">  <span class="string">&quot;./src/index.js&quot;</span>: (<span class="function"><span class="keyword">function</span> (<span class="params"><span class="built_in">module</span>, <span class="built_in">exports</span>, __webpack_require__</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">eval</span>(<span class="string">&quot;var root = document.getElementById(&#x27;root&#x27;)\nfunction render () &#123;\n  root.innerHTML = __webpack_require__(/*! ./content.js */ \&quot;./src/content.js\&quot;)\n&#125;\nrender()\n\n\n&quot;</span>);</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>可见webpack打包后会产出一个自执行函数，其参数为一个对象</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;./src/content.js&quot;</span>: (<span class="function"><span class="keyword">function</span> (<span class="params"><span class="built_in">module</span>, <span class="built_in">exports</span></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">eval</span>(<span class="string">&quot;...&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>键为入口文件或依赖文件相对于根目录的相对路径，值则是一个函数，其中使用<code>eval</code>执行文件的内容字符。</p>
<ul>
<li><p>再进入自执行函数体内，可见webpack自己实现了一套<code>commonjs</code>规范</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params">modules</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 模块缓存</span></span><br><span class="line">  <span class="keyword">var</span> installedModules = &#123;&#125;;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__webpack_require__</span>(<span class="params">moduleId</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 判断是否有缓存</span></span><br><span class="line">    <span class="keyword">if</span> (installedModules[moduleId]) &#123;</span><br><span class="line">      <span class="keyword">return</span> installedModules[moduleId].exports;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 没有缓存则创建一个模块对象并将其放入缓存</span></span><br><span class="line">    <span class="keyword">var</span> <span class="built_in">module</span> = installedModules[moduleId] = &#123;</span><br><span class="line">      <span class="attr">i</span>: moduleId,</span><br><span class="line">      <span class="attr">l</span>: <span class="literal">false</span>, <span class="comment">// 是否已加载</span></span><br><span class="line">      <span class="attr">exports</span>: &#123;&#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 执行模块函数</span></span><br><span class="line">    modules[moduleId].call(<span class="built_in">module</span>.exports, <span class="built_in">module</span>, <span class="built_in">module</span>.exports, __webpack_require__);</span><br><span class="line">    <span class="comment">// 将状态置为已加载</span></span><br><span class="line">    <span class="built_in">module</span>.l = <span class="literal">true</span>;</span><br><span class="line">    <span class="comment">// 返回模块对象</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">module</span>.exports;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// 加载入口文件</span></span><br><span class="line">  <span class="keyword">return</span> __webpack_require__(__webpack_require__.s = <span class="string">&quot;./src/index.js&quot;</span>);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>如果对上面&gt; <code>commonjs</code>规范感兴趣可以前往我的另一篇文章&gt; <a target="_blank" rel="noopener" href="https://github.com/careteenL/blog/blob/master/src/20181201-node/module.md">手摸手带你实现commonjs规范</a><br>给出上面代码主要是先对webpack的产出文件混个眼熟，不要惧怕。其实任何一个不管多复杂的事物都是由更小更简单的东西组成，剖开它认识它爱上它。<br><a name="item-3-4"></a></p>
<h3 id="配置HMR"><a href="#配置HMR" class="headerlink" title="配置HMR"></a>配置HMR</h3><p>接下来配置并感受一下热更新带来的便捷开发<br /><code>webpack.config.js</code>配置</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line">  <span class="attr">devServer</span>: &#123;</span><br><span class="line">    <span class="attr">hot</span>: <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br></pre></td></tr></table></figure>
<p><code>./src/index.js</code>配置</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">module</span>.hot) &#123;</span><br><span class="line">  <span class="built_in">module</span>.hot.accept([<span class="string">&#x27;./content.js&#x27;</span>], <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    render()</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当更改<code>./content.js</code>的内容并保存时，可以看到页面没有刷新，但是内容已经被替换了。<br />这对提高开发效率意义重大。接下来将一层层剖开它，认识它的实现原理。<br><a name="item-4"></a></p>
<h2 id="HMR原理"><a href="#HMR原理" class="headerlink" title="HMR原理"></a>HMR原理</h2><p><img src="https://cdn.nlark.com/yuque/0/2020/jpeg/186051/1583939666081-f8da2fc1-bc9b-494d-9376-0c5a4c129876.jpeg#align=left&display=inline&height=1430&originHeight=1430&originWidth=2088&size=0&status=done&style=none&width=2088"><br />如上图所示，右侧<code>Server</code>端使用<code>webpack-dev-server</code>去启动本地服务，内部实现主要使用了<code>webpack</code>、<code>express</code>、<code>websocket</code>。</p>
</li>
<li><p>使用<code>express</code>启动本地服务，当浏览器访问资源时对此做响应。</p>
</li>
<li><p>服务端和客户端使用<code>websocket</code>实现长连接</p>
</li>
<li><p><code>webpack</code>监听源文件的变化，即当开发者保存文件时触发<code>webpack</code>的重新编译。</p>
<ul>
<li>每次编译都会生成<code>hash值</code>、<code>已改动模块的json文件</code>、<code>已改动模块代码的js文件</code></li>
<li>编译完成后通过<code>socket</code>向客户端推送当前编译的<code>hash戳</code></li>
</ul>
</li>
<li><p>客户端的<code>websocket</code>监听到有文件改动推送过来的<code>hash戳</code>，会和上一次对比</p>
<ul>
<li>一致则走缓存</li>
<li>不一致则通过<code>ajax</code>和<code>jsonp</code>向服务端获取最新资源</li>
</ul>
</li>
<li><p>使用<code>内存文件系统</code>去替换有修改的内容实现局部刷新</p>
</li>
</ul>
<p>上图先只看个大概，下面将从服务端和客户端两个方面进行详细分析<br><a name="item-5"></a></p>
<h2 id="debug服务端源码"><a href="#debug服务端源码" class="headerlink" title="debug服务端源码"></a>debug服务端源码</h2><p><img src="https://cdn.nlark.com/yuque/0/2020/jpeg/186051/1583939666100-67768253-890b-4e3f-abd3-8b313b9dcd75.jpeg#align=left&display=inline&height=1430&originHeight=1430&originWidth=2088&size=0&status=done&style=none&width=2088"><br /><strong>现在也只需要关注上图的右侧服务端部分，左侧可以暂时忽略。下面步骤主要是debug服务端源码分析其详细思路，也给出了代码所处的具体位置，感兴趣的可以先行定位到下面的代码处设置断点，然后观察数据的变化情况。也可以先跳过阅读此步骤。</strong></p>
<ol>
<li><p>启动<code>webpack-dev-server</code>服务器，源代码地址<a target="_blank" rel="noopener" href="https://github.com/webpack/webpack-dev-server/blob/v3.7.2/bin/webpack-dev-server.js#L173">@webpack-dev-server/webpack-dev-server.js#L173</a></p>
</li>
<li><p>创建webpack实例，源代码地址<a target="_blank" rel="noopener" href="https://github.com/webpack/webpack-dev-server/blob/v3.7.2/bin/webpack-dev-server.js#L89">@webpack-dev-server/webpack-dev-server.js#L89</a></p>
</li>
<li><p>创建Server服务器，源代码地址<a target="_blank" rel="noopener" href="https://github.com/webpack/webpack-dev-server/blob/v3.7.2/bin/webpack-dev-server.js#L107">@webpack-dev-server/webpack-dev-server.js#L107</a></p>
</li>
<li><p>添加webpack的done事件回调，源代码地址<a target="_blank" rel="noopener" href="https://github.com/webpack/webpack-dev-server/blob/v3.7.2/lib/Server.js#L122">@webpack-dev-server/Server.js#L122</a></p>
</li>
<li><p>编译完成向客户端发送消息，源代码地址<a target="_blank" rel="noopener" href="https://github.com/webpack/webpack-dev-server/blob/v3.7.2/lib/Server.js#L184">@webpack-dev-server/Server.js#L184</a></p>
</li>
<li><p>创建express应用app，源代码地址<a target="_blank" rel="noopener" href="https://github.com/webpack/webpack-dev-server/blob/v3.7.2/lib/Server.js#L123">@webpack-dev-server/Server.js#L123</a></p>
</li>
<li><p>设置文件系统为内存文件系统，源代码地址<a target="_blank" rel="noopener" href="https://github.com/webpack/webpack-dev-middleware/blob/v3.7.0/lib/fs.js#L115">@webpack-dev-middleware/fs.js#L115</a></p>
</li>
<li><p>添加webpack-dev-middleware中间件，源代码地址<a target="_blank" rel="noopener" href="https://github.com/webpack/webpack-dev-server/blob/v3.7.2/lib/Server.js#L125">@webpack-dev-server/Server.js#L125</a></p>
</li>
<li><p>中间件负责返回生成的文件，源代码地址<a target="_blank" rel="noopener" href="https://github.com/webpack/webpack-dev-middleware/blob/v3.7.0/lib/middleware.js#L20">@webpack-dev-middleware/middleware.js#L20</a></p>
</li>
<li><p>启动webpack编译，源代码地址<a target="_blank" rel="noopener" href="https://github.com/webpack/webpack-dev-middleware/blob/v3.7.0/index.js#L51">@webpack-dev-middleware/index.js#L51</a></p>
</li>
<li><p>创建http服务器并启动服务，源代码地址<a target="_blank" rel="noopener" href="https://github.com/webpack/webpack-dev-server/blob/v3.7.2/lib/Server.js#L135">@webpack-dev-server/Server.js#L135</a></p>
</li>
<li><p>使用sockjs在浏览器端和服务端之间建立一个 websocket 长连接，源代码地址<a target="_blank" rel="noopener" href="https://github.com/webpack/webpack-dev-server/blob/v3.7.2/lib/Server.js#L745">@webpack-dev-server/Server.js#L745</a></p>
</li>
<li><p>创建socket服务器，源代码地址<a target="_blank" rel="noopener" href="https://github.com/webpack/webpack-dev-server/blob/v3.7.2/lib/servers/SockJSServer.js#L34">@webpack-dev-server/SockJSServer.js#L34</a><br><a name="item-5-5"></a></p>
<h3 id="服务端简易实现"><a href="#服务端简易实现" class="headerlink" title="服务端简易实现"></a>服务端简易实现</h3><p>上面是我通过debug得出dev-server运行流程比较核心的几个点，下面将其<a target="_blank" rel="noopener" href="https://github.com/careteenL/webpack-hmr/blob/master/dev-server.js">抽象整合到一个文件中</a>。<br><a name="2zgyu"></a></p>
<h4 id="启动webpack-dev-server服务器"><a href="#启动webpack-dev-server服务器" class="headerlink" title="启动webpack-dev-server服务器"></a>启动webpack-dev-server服务器</h4><p>先导入所有依赖</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>) <span class="comment">// 解析文件路径</span></span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>) <span class="comment">// 启动本地服务</span></span><br><span class="line"><span class="keyword">const</span> mime = <span class="built_in">require</span>(<span class="string">&#x27;mime&#x27;</span>) <span class="comment">// 获取文件类型 实现一个静态服务器</span></span><br><span class="line"><span class="keyword">const</span> webpack = <span class="built_in">require</span>(<span class="string">&#x27;webpack&#x27;</span>) <span class="comment">// 读取配置文件进行打包</span></span><br><span class="line"><span class="keyword">const</span> MemoryFileSystem = <span class="built_in">require</span>(<span class="string">&#x27;memory-fs&#x27;</span>) <span class="comment">// 使用内存文件系统更快，文件生成在内存中而非真实文件</span></span><br><span class="line"><span class="keyword">const</span> config = <span class="built_in">require</span>(<span class="string">&#x27;./webpack.config&#x27;</span>) <span class="comment">// 获取webpack配置文件</span></span><br></pre></td></tr></table></figure>
<p><a name="juOkB"></a></p>
<h4 id="创建webpack实例"><a href="#创建webpack实例" class="headerlink" title="创建webpack实例"></a>创建webpack实例</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> compiler = webpack(config)</span><br></pre></td></tr></table></figure>
<p>compiler代表整个webpack编译任务，全局只有一个<br><a name="zSNHn"></a></p>
<h4 id="创建Server服务器"><a href="#创建Server服务器" class="headerlink" title="创建Server服务器"></a>创建Server服务器</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Server</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">compiler</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.compiler = compiler</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">listen</span>(<span class="params">port</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.server.listen(port, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`服务器已经在<span class="subst">$&#123;port&#125;</span>端口上启动了`</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> server = <span class="keyword">new</span> Server(compiler)</span><br><span class="line">server.listen(<span class="number">8000</span>)</span><br></pre></td></tr></table></figure>
<p>在后面是通过express来当启动服务的<br><a name="1u6aE"></a></p>
<h4 id="添加webpack的done事件回调"><a href="#添加webpack的done事件回调" class="headerlink" title="添加webpack的done事件回调"></a>添加webpack的done事件回调</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">constructor</span>(<span class="params">compiler</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> sockets = []</span><br><span class="line">    <span class="keyword">let</span> lasthash</span><br><span class="line">    compiler.hooks.done.tap(<span class="string">&#x27;webpack-dev-server&#x27;</span>, <span class="function">(<span class="params">stats</span>) =&gt;</span> &#123;</span><br><span class="line">      lasthash = stats.hash</span><br><span class="line">      <span class="comment">// 每当新一个编译完成后都会向客户端发送消息</span></span><br><span class="line">      sockets.forEach(<span class="function"><span class="params">socket</span> =&gt;</span> &#123;</span><br><span class="line">        socket.emit(<span class="string">&#x27;hash&#x27;</span>, stats.hash) <span class="comment">// 先向客户端发送最新的hash值</span></span><br><span class="line">        socket.emit(<span class="string">&#x27;ok&#x27;</span>) <span class="comment">// 再向客户端发送一个ok</span></span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p><code>webpack</code>编译后提供提供了一系列钩子函数，以供插件能访问到它的各个生命周期节点，并对其打包内容做修改。<code>compiler.hooks.done</code>则是插件能修改其内容的最后一个节点。<br />编译完成通过<code>socket</code>向客户端发送消息，推送每次编译产生的<code>hash</code>。另外如果是热更新的话，还会产出二个补丁文件，里面描述了从上一次结果到这一次结果都有哪些chunk和模块发生了变化。<br />使用<code>let sockets = []</code>数组去存放当打开了多个Tab时每个Tab的<code>socket实例</code>。<br><a name="xz9K1"></a></p>
<h4 id="创建express应用app"><a href="#创建express应用app" class="headerlink" title="创建express应用app"></a>创建express应用app</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> app = <span class="keyword">new</span> express()</span><br></pre></td></tr></table></figure>
<p><a name="szEAX"></a></p>
<h4 id="设置文件系统为内存文件系统"><a href="#设置文件系统为内存文件系统" class="headerlink" title="设置文件系统为内存文件系统"></a>设置文件系统为内存文件系统</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> fs = <span class="keyword">new</span> MemoryFileSystem()</span><br></pre></td></tr></table></figure>
<p>使用<code>MemoryFileSystem</code>将<code>compiler</code>的产出文件打包到内存中。<br><a name="bUYUN"></a></p>
<h4 id="添加webpack-dev-middleware中间件"><a href="#添加webpack-dev-middleware中间件" class="headerlink" title="添加webpack-dev-middleware中间件"></a>添加webpack-dev-middleware中间件</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">middleware</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (req.url === <span class="string">&#x27;/favicon.ico&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> res.sendStatus(<span class="number">404</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// /index.html   dist/index.html</span></span><br><span class="line">    <span class="keyword">let</span> filename = path.join(config.output.path, req.url.slice(<span class="number">1</span>))</span><br><span class="line">    <span class="keyword">let</span> stat = fs.statSync(filename)</span><br><span class="line">    <span class="keyword">if</span> (stat.isFile()) &#123; <span class="comment">// 判断是否存在这个文件,如果在的话直接把这个读出来发给浏览器</span></span><br><span class="line">      <span class="keyword">let</span> content = fs.readFileSync(filename)</span><br><span class="line">      <span class="keyword">let</span> contentType = mime.getType(filename)</span><br><span class="line">      res.setHeader(<span class="string">&#x27;Content-Type&#x27;</span>, contentType)</span><br><span class="line">      res.statusCode = res.statusCode || <span class="number">200</span></span><br><span class="line">      res.send(content)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> res.sendStatus(<span class="number">404</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  app.use(middleware)</span><br></pre></td></tr></table></figure>
<p>使用expres启动了本地开发服务后，使用中间件去为其构造一个静态服务器，并使用了内存文件系统，使读取文件后存放到内存中，提高读写效率，最终返回生成的文件。<br><a name="Vjj1z"></a></p>
<h4 id="启动webpack编译"><a href="#启动webpack编译" class="headerlink" title="启动webpack编译"></a>启动webpack编译</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">compiler.watch(&#123;&#125;, <span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;又一次编译任务成功完成了&#x27;</span>)</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure>
<p>以监控的模式启动一次webpack编译，当编译成功之后执行回调<br><a name="CLwCf"></a></p>
<h4 id="创建http服务器并启动服务"><a href="#创建http服务器并启动服务" class="headerlink" title="创建http服务器并启动服务"></a>创建http服务器并启动服务</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">constructor</span>(<span class="params">compiler</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="built_in">this</span>.server = <span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>).createServer(app)</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">listen</span>(<span class="params">port</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.server.listen(port, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`服务器已经在<span class="subst">$&#123;port&#125;</span>端口上启动了`</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p><a name="2ghPp"></a></p>
<h4 id="使用sockjs在浏览器端和服务端之间建立一个-websocket-长连接"><a href="#使用sockjs在浏览器端和服务端之间建立一个-websocket-长连接" class="headerlink" title="使用sockjs在浏览器端和服务端之间建立一个 websocket 长连接"></a>使用sockjs在浏览器端和服务端之间建立一个 websocket 长连接</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">constructor</span>(<span class="params">compiler</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="built_in">this</span>.server = <span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>).createServer(app)</span><br><span class="line">    <span class="keyword">let</span> io = <span class="built_in">require</span>(<span class="string">&#x27;socket.io&#x27;</span>)(<span class="built_in">this</span>.server)</span><br><span class="line">    io.on(<span class="string">&#x27;connection&#x27;</span>, <span class="function">(<span class="params">socket</span>) =&gt;</span> &#123;</span><br><span class="line">      sockets.push(socket)</span><br><span class="line">      socket.emit(<span class="string">&#x27;hash&#x27;</span>, lastHash)</span><br><span class="line">      socket.emit(<span class="string">&#x27;ok&#x27;</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>启动一个 websocket服务器，然后等待连接来到，连接到来之后存进sockets池<br />当有文件改动，webpack重新编译时，向客户端推送<code>hash</code>和<code>ok</code>两个事件<br><a name="item-5-6"></a></p>
<h3 id="服务端调试阶段"><a href="#服务端调试阶段" class="headerlink" title="服务端调试阶段"></a>服务端调试阶段</h3><p>感兴趣的可以根据上面<a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000020310371#debug%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%BA%90%E7%A0%81">debug服务端源码</a>所带的源码位置，并在浏览器的调试模式下设置断点查看每个阶段的值。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node dev-server.js</span><br></pre></td></tr></table></figure>
<p>使用我们自己编译的<code>dev-server.js</code>启动服务，可看到页面可以正常展示，但还没有实现热更新。<br />下面将调式客户端的源代码分析其实现流程。<br><a name="item-6"></a></p>
<h2 id="debug客户端源码"><a href="#debug客户端源码" class="headerlink" title="debug客户端源码"></a>debug客户端源码</h2><p><img src="https://cdn.nlark.com/yuque/0/2020/jpeg/186051/1583939666119-c372f841-c5ce-41ac-835c-ec0dbaa8031c.jpeg#align=left&display=inline&height=1430&originHeight=1430&originWidth=2088&size=0&status=done&style=none&width=2088"><br /><strong>现在也只需要关注上图的左侧客户端部分，右侧可以暂时忽略。下面步骤主要是debug客户端源码分析其详细思路，也给出了代码所处的具体位置，感兴趣的可以先行定位到下面的代码处设置断点，然后观察数据的变化情况。也可以先跳过阅读此步骤。</strong><br />debug客户端源码分析其详细思路</p>
</li>
<li><p>webpack-dev-server/client端会监听到此hash消息，源代码地址<a target="_blank" rel="noopener" href="https://github.com/webpack/webpack-dev-server/blob/v3.7.2/client-src/default/index.js#L54">@webpack-dev-server/index.js#L54</a></p>
</li>
<li><p>客户端收到ok的消息后会执行reloadApp方法进行更新，源代码地址<a target="_blank" rel="noopener" href="https://github.com/webpack/webpack-dev-server/blob/v3.7.2/client-src/default/index.js#L101">index.js#L101</a></p>
</li>
<li><p>在reloadApp中会进行判断，是否支持热更新，如果支持的话发射webpackHotUpdate事件，如果不支持则直接刷新浏览器，源代码地址<a target="_blank" rel="noopener" href="https://github.com/webpack/webpack-dev-server/blob/v3.7.2/client-src/default/utils/reloadApp.js#L7">reloadApp.js#L7</a></p>
</li>
<li><p>在webpack/hot/dev-server.js会监听webpackHotUpdate事件，源代码地址<a target="_blank" rel="noopener" href="https://github.com/webpack/webpack/blob/v4.39.1/hot/dev-server.js#L55">dev-server.js#L55</a></p>
</li>
<li><p>在check方法里会调用module.hot.check方法，源代码地址<a target="_blank" rel="noopener" href="https://github.com/webpack/webpack/blob/v4.39.1/hot/dev-server.js#L13">dev-server.js#L13</a></p>
</li>
<li><p>HotModuleReplacement.runtime请求Manifest，源代码地址<a target="_blank" rel="noopener" href="https://github.com/webpack/webpack/blob/v4.39.1/lib/HotModuleReplacement.runtime.js#L180">HotModuleReplacement.runtime.js#L180</a></p>
</li>
<li><p>它通过调用 JsonpMainTemplate.runtime的hotDownloadManifest方法，源代码地址<a target="_blank" rel="noopener" href="https://github.com/webpack/webpack/blob/v4.39.1/lib/web/JsonpMainTemplate.runtime.js#L23">JsonpMainTemplate.runtime.js#L23</a></p>
</li>
<li><p>调用JsonpMainTemplate.runtime的hotDownloadUpdateChunk方法通过JSONP请求获取到最新的模块代码，源代码地址<a target="_blank" rel="noopener" href="https://github.com/webpack/webpack/blob/v4.39.1/lib/web/JsonpMainTemplate.runtime.js#L14">JsonpMainTemplate.runtime.js#L14</a></p>
</li>
<li><p>补丁JS取回来后会调用JsonpMainTemplate.runtime.js的webpackHotUpdate方法，源代码地址<a target="_blank" rel="noopener" href="https://github.com/webpack/webpack/blob/v4.39.1/lib/web/JsonpMainTemplate.runtime.js#L8">JsonpMainTemplate.runtime.js#L8</a></p>
</li>
<li><p>然后会调用HotModuleReplacement.runtime.js的hotAddUpdateChunk方法动态更新模块代码，源代码地址<a target="_blank" rel="noopener" href="https://github.com/webpack/webpack/blob/v4.39.1/lib/HotModuleReplacement.runtime.js#L222">HotModuleReplacement.runtime.js#L222</a></p>
</li>
<li><p>然后调用hotApply方法进行热更新，源代码地址<a target="_blank" rel="noopener" href="https://github.com/webpack/webpack/blob/v4.39.1/lib/HotModuleReplacement.runtime.js#L257">HotModuleReplacement.runtime.js#L257</a>、<a target="_blank" rel="noopener" href="https://github.com/webpack/webpack/blob/v4.39.1/lib/HotModuleReplacement.runtime.js#L278">HotModuleReplacement.runtime.js#L278</a><br><a name="item-6-7"></a></p>
<h3 id="客户端简易实现"><a href="#客户端简易实现" class="headerlink" title="客户端简易实现"></a>客户端简易实现</h3><p>上面是我通过debug得出dev-server运行流程比较核心的几个点，下面将其<a target="_blank" rel="noopener" href="https://github.com/careteenL/webpack-hmr/blob/master/src/client.js">抽象整合成一个文件</a>。<br><a name="NUr0h"></a></p>
<h4 id="webpack-dev-server-client端会监听到此hash消息"><a href="#webpack-dev-server-client端会监听到此hash消息" class="headerlink" title="webpack-dev-server/client端会监听到此hash消息"></a>webpack-dev-server/client端会监听到此hash消息</h4><p>在开发客户端功能之前，需要在<code>src/index.html</code>中引入<code>socket.io</code></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;/socket.io/socket.io.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>下面连接socket并接受消息</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> socket = io(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">socket.on(<span class="string">&#x27;connect&#x27;</span>, onConnected)</span><br><span class="line"><span class="keyword">const</span> onConnected = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;客户端连接成功&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> hotCurrentHash <span class="comment">// lastHash 上一次 hash值 </span></span><br><span class="line"><span class="keyword">let</span> currentHash <span class="comment">// 这一次的hash值</span></span><br><span class="line">socket.on(<span class="string">&#x27;hash&#x27;</span>, <span class="function">(<span class="params">hash</span>) =&gt;</span> &#123;</span><br><span class="line">  currentHash = hash</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>将服务端webpack每次编译所产生<code>hash</code>进行缓存<br><a name="uvtiH"></a></p>
<h4 id="客户端收到ok的消息后会执行reloadApp方法进行更新"><a href="#客户端收到ok的消息后会执行reloadApp方法进行更新" class="headerlink" title="客户端收到ok的消息后会执行reloadApp方法进行更新"></a>客户端收到ok的消息后会执行reloadApp方法进行更新</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">socket.on(<span class="string">&#x27;ok&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  reloadApp(<span class="literal">true</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><a name="ZbSqA"></a></p>
<h4 id="reloadApp中判断是否支持热更新"><a href="#reloadApp中判断是否支持热更新" class="headerlink" title="reloadApp中判断是否支持热更新"></a>reloadApp中判断是否支持热更新</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 当收到ok事件后，会重新刷新app</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reloadApp</span>(<span class="params">hot</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (hot) &#123; <span class="comment">// 如果hot为true 走热更新的逻辑</span></span><br><span class="line">    hotEmitter.emit(<span class="string">&#x27;webpackHotUpdate&#x27;</span>)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123; <span class="comment">// 如果不支持热更新，则直接重新加载</span></span><br><span class="line">    <span class="built_in">window</span>.location.reload()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在reloadApp中会进行判断，是否支持热更新，如果支持的话发射webpackHotUpdate事件，如果不支持则直接刷新浏览器。<br><a name="KZYCi"></a></p>
<h4 id="在webpack-hot-dev-server-js会监听webpackHotUpdate事件"><a href="#在webpack-hot-dev-server-js会监听webpackHotUpdate事件" class="headerlink" title="在webpack/hot/dev-server.js会监听webpackHotUpdate事件"></a>在webpack/hot/dev-server.js会监听webpackHotUpdate事件</h4><p>首先需要一个发布订阅去绑定事件并在合适的时机触发。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Emitter</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.listeners = &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">on</span>(<span class="params">type, listener</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.listeners[type] = listener</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">emit</span>(<span class="params">type</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.listeners[type] &amp;&amp; <span class="built_in">this</span>.listeners[type]()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> hotEmitter = <span class="keyword">new</span> Emitter()</span><br><span class="line">hotEmitter.on(<span class="string">&#x27;webpackHotUpdate&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!hotCurrentHash || hotCurrentHash == currentHash) &#123;</span><br><span class="line">    <span class="keyword">return</span> hotCurrentHash = currentHash</span><br><span class="line">  &#125;</span><br><span class="line">  hotCheck()</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>会判断是否为第一次进入页面和代码是否有更新。<br>上面的发布订阅较为简单，且只支持先发布后订阅功能。对于一些较为复杂的场景可能需要先订阅后发布，此时可以移步&gt; <a target="_blank" rel="noopener" href="https://github.com/careteenL/event-emitter">@careteen/event-emitter</a>。其实现原理也挺简单，需要维护一个离线事件栈存放还没发布就订阅的事件，等到订阅时可以取出所有事件执行。<br><a name="IOT6r"></a></p>
<h4 id="在check方法里会调用module-hot-check方法"><a href="#在check方法里会调用module-hot-check方法" class="headerlink" title="在check方法里会调用module.hot.check方法"></a>在check方法里会调用module.hot.check方法</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hotCheck</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  hotDownloadManifest().then(<span class="function"><span class="params">update</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> chunkIds = <span class="built_in">Object</span>.keys(update.c)</span><br><span class="line">    chunkIds.forEach(<span class="function"><span class="params">chunkId</span> =&gt;</span> &#123;</span><br><span class="line">      hotDownloadUpdateChunk(chunkId)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面也提到过webpack每次编译都会产生<code>hash值</code>、<code>已改动模块的json文件</code>、<code>已改动模块代码的js文件</code>，<br />此时先使用<code>ajax</code>请求<code>Manifest</code>即服务器这一次编译相对于上一次编译改变了哪些module和chunk。<br />然后再通过<code>jsonp</code>获取这些已改动的module和chunk的代码。<br><a name="vjb3D"></a></p>
<h4 id="调用hotDownloadManifest方法"><a href="#调用hotDownloadManifest方法" class="headerlink" title="调用hotDownloadManifest方法"></a>调用hotDownloadManifest方法</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hotDownloadManifest</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">resolve</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> request = <span class="keyword">new</span> XMLHttpRequest()</span><br><span class="line">    <span class="comment">//hot-update.json文件里存放着从上一次编译到这一次编译 取到差异</span></span><br><span class="line">    <span class="keyword">let</span> requestPath = <span class="string">&#x27;/&#x27;</span> + hotCurrentHash + <span class="string">&quot;.hot-update.json&quot;</span></span><br><span class="line">    request.open(<span class="string">&#x27;GET&#x27;</span>, requestPath, <span class="literal">true</span>)</span><br><span class="line">    request.onreadystatechange = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (request.readyState === <span class="number">4</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> update = <span class="built_in">JSON</span>.parse(request.responseText)</span><br><span class="line">        resolve(update)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    request.send()</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a name="ndg3N"></a></p>
<h4 id="调用hotDownloadUpdateChunk方法通过JSONP请求获取到最新的模块代码"><a href="#调用hotDownloadUpdateChunk方法通过JSONP请求获取到最新的模块代码" class="headerlink" title="调用hotDownloadUpdateChunk方法通过JSONP请求获取到最新的模块代码"></a>调用hotDownloadUpdateChunk方法通过JSONP请求获取到最新的模块代码</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hotDownloadUpdateChunk</span>(<span class="params">chunkId</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> script = <span class="built_in">document</span>.createElement(<span class="string">&#x27;script&#x27;</span>)</span><br><span class="line">  script.charset = <span class="string">&#x27;utf-8&#x27;</span></span><br><span class="line">  <span class="comment">// /main.xxxx.hot-update.js</span></span><br><span class="line">  script.src = <span class="string">&#x27;/&#x27;</span> + chunkId + <span class="string">&quot;.&quot;</span> + hotCurrentHash + <span class="string">&quot;.hot-update.js&quot;</span></span><br><span class="line">  <span class="built_in">document</span>.head.appendChild(script)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里解释下为什么使用<code>JSONP</code>获取而不直接利用<code>socket</code>获取最新代码？主要是因为<code>JSONP</code>获取的代码可以直接执行。<br><a name="ztLF2"></a></p>
<h4 id="调用webpackHotUpdate方法"><a href="#调用webpackHotUpdate方法" class="headerlink" title="调用webpackHotUpdate方法"></a>调用webpackHotUpdate方法</h4><p>当客户端把最新的代码拉到浏览之后</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.webpackHotUpdate = <span class="function"><span class="keyword">function</span> (<span class="params">chunkId, moreModules</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 循环新拉来的模块</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> moduleId <span class="keyword">in</span> moreModules) &#123;</span><br><span class="line">    <span class="comment">// 从模块缓存中取到老的模块定义</span></span><br><span class="line">    <span class="keyword">let</span> oldModule = __webpack_require__.c[moduleId]</span><br><span class="line">    <span class="comment">// parents哪些模块引用这个模块 children这个模块引用了哪些模块</span></span><br><span class="line">    <span class="comment">// parents=[&#x27;./src/index.js&#x27;]</span></span><br><span class="line">    <span class="keyword">let</span> &#123;</span><br><span class="line">      parents,</span><br><span class="line">      children</span><br><span class="line">    &#125; = oldModule</span><br><span class="line">    <span class="comment">// 更新缓存为最新代码 缓存进行更新</span></span><br><span class="line">    <span class="keyword">let</span> <span class="built_in">module</span> = __webpack_require__.c[moduleId] = &#123;</span><br><span class="line">      <span class="attr">i</span>: moduleId,</span><br><span class="line">      <span class="attr">l</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">exports</span>: &#123;&#125;,</span><br><span class="line">      parents,</span><br><span class="line">      children,</span><br><span class="line">      <span class="attr">hot</span>: <span class="built_in">window</span>.hotCreateModule(moduleId)</span><br><span class="line">    &#125;</span><br><span class="line">    moreModules[moduleId].call(<span class="built_in">module</span>.exports, <span class="built_in">module</span>, <span class="built_in">module</span>.exports, __webpack_require__)</span><br><span class="line">    <span class="built_in">module</span>.l = <span class="literal">true</span> <span class="comment">// 状态变为加载就是给module.exports 赋值了</span></span><br><span class="line">    parents.forEach(<span class="function"><span class="params">parent</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// parents=[&#x27;./src/index.js&#x27;]</span></span><br><span class="line">      <span class="keyword">let</span> parentModule = __webpack_require__.c[parent]</span><br><span class="line">      <span class="comment">// _acceptedDependencies=&#123;&#x27;./src/title.js&#x27;,render&#125;</span></span><br><span class="line">      parentModule &amp;&amp; parentModule.hot &amp;&amp; parentModule.hot._acceptedDependencies[moduleId] &amp;&amp; parentModule.hot._acceptedDependencies[moduleId]()</span><br><span class="line">    &#125;)</span><br><span class="line">    hotCurrentHash = currentHash</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a name="nMRoh"></a></p>
<h4 id="hotCreateModule的实现"><a href="#hotCreateModule的实现" class="headerlink" title="hotCreateModule的实现"></a>hotCreateModule的实现</h4><p>实现我们可以在业务代码中定义需要热更新的模块以及回调函数，将其存放在<code>hot._acceptedDependencies</code>中。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.hotCreateModule = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> hot = &#123;</span><br><span class="line">    <span class="attr">_acceptedDependencies</span>: &#123;&#125;,</span><br><span class="line">    <span class="function"><span class="title">dispose</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="comment">// 销毁老的元素</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">accept</span>: <span class="function"><span class="keyword">function</span> (<span class="params">deps, callback</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; deps.length; i++) &#123;</span><br><span class="line">        <span class="comment">// hot._acceptedDependencies=&#123;&#x27;./title&#x27;: render&#125;</span></span><br><span class="line">        hot._acceptedDependencies[deps[i]] = callback</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> hot</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后在<code>webpackHotUpdate</code>中进行调用</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">parents.forEach(<span class="function"><span class="params">parent</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// parents=[&#x27;./src/index.js&#x27;]</span></span><br><span class="line">      <span class="keyword">let</span> parentModule = __webpack_require__.c[parent]</span><br><span class="line">      <span class="comment">// _acceptedDependencies=&#123;&#x27;./src/title.js&#x27;,render&#125;</span></span><br><span class="line">      parentModule &amp;&amp; parentModule.hot &amp;&amp; parentModule.hot._acceptedDependencies[moduleId] &amp;&amp; parentModule.hot._acceptedDependencies[moduleId]()</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>
<p>最后调用hotApply方法进行热更新<br><a name="item-6-8"></a></p>
<h3 id="客户端调试阶段"><a href="#客户端调试阶段" class="headerlink" title="客户端调试阶段"></a>客户端调试阶段</h3><p>经过上述实现了一个基本版的HMR，可更改代码保存的同时查看浏览器并非整体刷新，而是局部更新代码进而更新视图。在涉及到大量表单的需求时大大提高了开发效率。<br><a name="item-7"></a></p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2></li>
</ol>
<ul>
<li><p>如何实现commonjs规范？<br>感兴趣的可前往&gt; <a target="_blank" rel="noopener" href="https://github.com/careteenL/blog/blob/master/src/20181201-node/module.md">debug CommonJs规范</a>了解其实现原理。</p>
</li>
<li><p>webpack实现流程以及各个生命周期的作用是什么？<br>webpack主要借助了&gt; <code>tapable</code>这个库所提供的一系列同步/异步钩子函数贯穿整个生命周期。&gt; <img src="https://cdn.nlark.com/yuque/0/2020/jpeg/186051/1583939666129-b464ba02-d967-42db-a140-2b8321df9985.jpeg#align=left&display=inline&height=4244&originHeight=4244&originWidth=4436&size=0&status=done&style=none&width=4436">基于此我实现了一版简易的&gt; <a target="_blank" rel="noopener" href="https://github.com/careteenL/webpack">webpack</a>，源码100+行，食用时伴着注释很容易消化，感兴趣的可前往看个思路。</p>
</li>
<li><p>发布订阅的使用和实现，并且如何实现一个可先订阅后发布的机制？<br>上面也提到需要使用到发布订阅模式，且只支持先发布后订阅功能。对于一些较为复杂的场景可能需要先订阅后发布，此时可以移步&gt; <a target="_blank" rel="noopener" href="https://github.com/careteenL/event-emitter">@careteen/event-emitter</a>。其实现原理也挺简单，需要维护一个离线事件栈存放还没发布就订阅的事件，等到订阅时可以取出所有事件执行。</p>
</li>
<li><p>为什么使用JSONP而不用socke通信获取更新过的代码？<br>因为通过socket通信获取的是一串字符串需要再做处理。而通过&gt; <code>JSONP</code>获取的代码可以直接执行。<br><a name="item-7-9"></a></p>
<h3 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h3></li>
<li><p>珠峰架构课</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://webpack.docschina.org/api/hot-module-replacement/#src/components/Sidebar/Sidebar.jsx">模块热替换 - webpack官网</a></p>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/03/11/199-%E3%80%90Webpack%E3%80%91%E5%BD%BB%E5%BA%95%E6%90%9E%E6%87%82%E5%B9%B6%E5%AE%9E%E7%8E%B0webpack%E7%83%AD%E6%9B%B4%E6%96%B0%E5%8E%9F%E7%90%86/" data-id="ckts3ejyk00mt4d9kalne8c9k" data-title="199-【Webpack】彻底搞懂并实现webpack热更新原理" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Webpack/" rel="tag">Webpack</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/" rel="tag">前端开发</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%8E%9F%E5%88%9B/" rel="tag">原创</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-198-【Webpack】Webpack插件开发如此简单！" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/02/24/198-%E3%80%90Webpack%E3%80%91Webpack%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91%E5%A6%82%E6%AD%A4%E7%AE%80%E5%8D%95%EF%BC%81/" class="article-date">
  <time class="dt-published" datetime="2020-02-23T23:42:27.000Z" itemprop="datePublished">2020-02-24</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/02/24/198-%E3%80%90Webpack%E3%80%91Webpack%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91%E5%A6%82%E6%AD%A4%E7%AE%80%E5%8D%95%EF%BC%81/">198-【Webpack】Webpack插件开发如此简单！</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <blockquote>
<p>本文使用的<a target="_blank" rel="noopener" href="https://github.com/pingan8787/Webpack-Quickly-Starter"><strong>Webpack-Quickly-Starter</strong></a>快速搭建 Webpack4 本地学习环境。<br>建议多阅读 Webpack 文档《<a target="_blank" rel="noopener" href="https://webpack.js.org/contribute/writing-a-plugin/"><strong>Writing a Plugin</strong></a>》章节，学习开发简单插件。</p>
</blockquote>
<p>本文将带你一起开发你的第一个 Webpack 插件，从 Webpack 配置工程师，迈向 Webpack 开发工程师！<br />做自己的轮子，让别人用去吧。</p>
<p>完整代码存放在：<a target="_blank" rel="noopener" href="https://github.com/pingan8787/script-timestamp-webpack-plugin">https://github.com/pingan8787/script-timestamp-webpack-plugin</a></p>
<p><img src="https://user-gold-cdn.xitu.io/2020/2/24/1707463e4ec11bce?w=800&h=400&f=png&s=30184"></p>
<h2 id="一、背景介绍"><a href="#一、背景介绍" class="headerlink" title="一、背景介绍"></a>一、背景介绍</h2><p>本文灵感源自业务中的经验总结，<strong>不怕神一样的产品，只怕一根筋的开发</strong>。</p>
<p>在项目打包遇到问题：“当项目托管到 CDN 平台，希望实现项目中的 index.js 不被缓存”。因为我们需要修改 <code>index.js</code> 中的内容，不想用户被缓存。</p>
<p>思考一阵，有这么几种思路：</p>
<ol>
<li>在 CDN 平台中过滤该文件的缓存设置；</li>
<li>查找 DOM 元素，修改该 <code>script</code> 标签的 <code>src</code> 值，并添加时时间戳；</li>
<li>打包时动态创建 <code>script</code> 标签引入文件，并添加时时间戳。</li>
</ol>
<p>（聪明的你还有其他方法，欢迎讨论）</p>
<p>思路分析：</p>
<ol>
<li>显然修改 CDN 设置的话，治标不治本；</li>
<li>在模版文件中，添加 <code>script</code> 标签，执行获取 Webpack 自动添加的 <code>script</code> 标签并为其 <code>src</code> 值添加时间戳。但事实是还没等你修改完， js 文件已经加载完毕，所以放弃</li>
<li>需要在 <code>index.html</code> 生成之前，修改 js 文件的路径，并添加时间戳。</li>
</ol>
<p>于是我准备使用第三种方式，在 <code>index.html</code> 生成之前完成下面修改：<br /><img src="https://user-gold-cdn.xitu.io/2020/2/24/170745f867efcd61?w=951&h=328&f=png&s=86717" alt="image.png"></p>
<p>问题简单，实际还是想试试开发 Webpack Plugin。</p>
<h2 id="二、基础知识"><a href="#二、基础知识" class="headerlink" title="二、基础知识"></a>二、基础知识</h2><p>Webpack 使用阶段式的构建回调，开发者可以引入它们自己的行为到 Webpack 构建流程中。<br />在开发之前，需要了解以下 Webpack 相关概念：</p>
<h3 id="2-1-Webpack-插件组成"><a href="#2-1-Webpack-插件组成" class="headerlink" title="2.1 Webpack 插件组成"></a>2.1 Webpack 插件组成</h3><p>在自定义插件之前，我们需要了解，一个 Webpack 插件由哪些构成，下面摘抄文档：</p>
<ul>
<li>一个具名 JavaScript 函数；</li>
<li>在它的原型上定义 apply 方法；</li>
<li>指定一个触及到 Webpack 本身的<a target="_blank" rel="noopener" href="https://webpack.docschina.org/api/compiler-hooks/">事件钩子</a>；</li>
<li>操作 Webpack 内部的实例特定数据；</li>
<li>在实现功能后调用 Webpack 提供的 callback。 </li>
</ul>
<h3 id="2-2-Webpack-插件基本架构"><a href="#2-2-Webpack-插件基本架构" class="headerlink" title="2.2 Webpack 插件基本架构"></a>2.2 Webpack 插件基本架构</h3><p>插件由一个构造函数实例化出来。构造函数定义 <code>apply</code> 方法，在安装插件时，<code>apply</code> 方法会被 Webpack <code>compiler</code> 调用一次。<code>apply</code> 方法可以接收一个 Webpack <code>compiler </code>对象的引用，从而可以在回调函数中访问到 <code>compiler</code> 对象。</p>
<p>官方文档提供一个简单的插件结构：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HelloWorldPlugin</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">apply</span>(<span class="params">compiler</span>)</span> &#123;</span><br><span class="line">    compiler.hooks.done.tap(<span class="string">&#x27;Hello World Plugin&#x27;</span>, <span class="function">(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">      stats <span class="comment">/* 在 hook 被触及时，会将 stats 作为参数传入。 */</span></span></span></span><br><span class="line"><span class="params"><span class="function">    </span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&#x27;Hello World!&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">module</span>.exports = HelloWorldPlugin;</span><br></pre></td></tr></table></figure>

<p>使用插件：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.config.js</span></span><br><span class="line"><span class="keyword">var</span> HelloWorldPlugin = <span class="built_in">require</span>(<span class="string">&#x27;hello-world&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="comment">// ... 这里是其他配置 ...</span></span><br><span class="line">  <span class="attr">plugins</span>: [<span class="keyword">new</span> HelloWorldPlugin(&#123; <span class="attr">options</span>: <span class="literal">true</span> &#125;)]</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-HtmlWebpackPlugin-介绍"><a href="#2-3-HtmlWebpackPlugin-介绍" class="headerlink" title="2.3 HtmlWebpackPlugin 介绍"></a>2.3 HtmlWebpackPlugin 介绍</h3><blockquote>
<p>HtmlWebpackPlugin 简化了 HTML 文件的创建，以便为你的 Webpack 包提供服务。这对于在文件名中包含每次会随着编译而发生变化哈希的 webpack bundle 尤其有用。</p>
</blockquote>
<p>插件的基本作用概括：<strong>生成 HTML 文件</strong>。</p>
<p><code>html-webapck-plugin</code> 插件<strong>两个主要作用：</strong></p>
<ul>
<li>为 HTML 文件引入外部资源（如 <code>script</code> / <code>link</code> ）动态添加每次编译后的 hash，防止引用文件的缓存问题；</li>
<li>动态创建 HTML 入口文件，如单页应用的 <code>index.html </code>文件。</li>
</ul>
<p><code>html-webapck-plugin</code> 插件<strong>原理介绍：</strong></p>
<ul>
<li>读取 Webpack 中 <code>entry</code> 配置的相关入口 <code>chunk</code> 和 <code>extract-text-webpack-plugin</code> 插件抽取的 CSS 样式；</li>
<li>将样式插入到插件提供的 <code>template</code> 或 <code>templateContent</code> 配置指定的模版文件中；</li>
<li>插入方式是：通过 <code>link</code> 标签引入样式，通过 <code>script</code> 标签引入脚本文件；</li>
</ul>
<h2 id="三、开发流程"><a href="#三、开发流程" class="headerlink" title="三、开发流程"></a>三、开发流程</h2><p>本文开发的 <strong>自动添加时间戳引用脚本文件（SetScriptTimestampPlugin）</strong> 插件实现的原理：通过 <strong>HtmlWebpackPlugin</strong> 生成 HTML 文件前，将模版文件<strong>预留位置替换成脚本</strong>，脚本中执行自动添加时间戳来引用脚本文件。</p>
<h3 id="3-1-插件运行机制"><a href="#3-1-插件运行机制" class="headerlink" title="3.1 插件运行机制"></a>3.1 插件运行机制</h3><p><img src="https://user-gold-cdn.xitu.io/2020/2/24/170745f8681eb3b6?w=2244&h=1604&f=png&s=269681" alt="SetScriptTimestampPlugin 运行机制.png"></p>
<h3 id="3-2-初始化插件文件"><a href="#3-2-初始化插件文件" class="headerlink" title="3.2 初始化插件文件"></a>3.2 初始化插件文件</h3><p>新建 <code>SetScriptTimestampPlugin.js</code>  文件，并参考官方文档中插件的基本结构，初始化插件代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SetScriptTimestampPlugin.js</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SetScriptTimestampPlugin</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">apply</span>(<span class="params">compiler</span>)</span> &#123;</span><br><span class="line">    compiler.hooks.done.tap(<span class="string">&#x27;SetScriptTimestampPlugin&#x27;</span>,</span><br><span class="line">     <span class="function">(<span class="params">compilation, callback</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&#x27;SetScriptTimestampPlugin!&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">module</span>.exports = SetScriptTimestampPlugin;</span><br></pre></td></tr></table></figure>

<p><code>apply</code> 方法为插件原型方法，接收 <code>compiler</code> 作为参数。</p>
<h3 id="3-3-选择插件触发时机"><a href="#3-3-选择插件触发时机" class="headerlink" title="3.3 选择插件触发时机"></a>3.3 选择插件触发时机</h3><p>选择插件触发时机，其实是选择插件触发的 compiler 钩子（即何时触发插件）。<br />Webpack 提供钩子有很多，这里简单介绍几个，完整具体可参考文档《<a target="_blank" rel="noopener" href="https://webpack.js.org/api/compiler-hooks/">Compiler Hooks</a>》：</p>
<ul>
<li><code>entryOption</code> : 在 webpack 选项中的 <code>entry</code> 配置项 处理过之后，执行插件。</li>
<li><code>afterPlugins</code> : 设置完初始插件之后，执行插件。</li>
<li><code>compilation</code> : 编译创建之后，生成文件之前，执行插件。。</li>
<li><code>emit</code> : 生成资源到 <code>output</code> 目录之前。</li>
<li><code>done</code> : 编译完成。</li>
</ul>
<p>我们插件应该是要在 HTML 输出之前，动态添加 <code>script</code> 标签，所以我们选择钩入 <code>compilation</code> 阶段，代码修改：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// SetScriptTimestampPlugin.js</span><br><span class="line"></span><br><span class="line">class SetScriptTimestampPlugin &#123;</span><br><span class="line">  apply(compiler) &#123;</span><br><span class="line"><span class="deletion">-   compiler.hooks.done.tap(&#x27;SetScriptTimestampPlugin&#x27;,</span></span><br><span class="line"><span class="addition">+   compiler.hooks.compilation.tap(&#x27;SetScriptTimestampPlugin&#x27;, </span></span><br><span class="line">      (compilation, callback) =&gt; &#123;</span><br><span class="line">      console.log(&#x27;SetScriptTimestampPlugin!&#x27;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">module.exports = SetScriptTimestampPlugin;</span><br></pre></td></tr></table></figure>

<p>在 <code>compiler.hooks</code> 下指定<strong>事件钩子函数</strong>，便会触发钩子时，执行回调函数。<br />Webpack 提供三种触发钩子的方法：</p>
<ul>
<li><code>tap</code> ：以<strong>同步方式</strong>触发钩子；</li>
<li><code>tapAsync</code> ：以<strong>异步方式</strong>触发钩子；</li>
<li><code>tapPromise</code> ：以<strong>异步方式</strong>触发钩子，返回 Promise；</li>
</ul>
<p>这三种方式能选择的钩子方法也不同，由于 <code>compilation</code> 是 <code>SyncHook</code> 同步钩子，所以采用 <code>tap</code> 触发方式。<br /><code>tap</code> 方法接收两个参数：插件名称和回调函数。</p>
<h3 id="3-4-添加插件替换入口"><a href="#3-4-添加插件替换入口" class="headerlink" title="3.4 添加插件替换入口"></a>3.4 添加插件替换入口</h3><p>我们原理上是将模版文件中，指定替换入口，再替换成需要执行的脚本。</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/2/24/170745f8680672ef?w=947&h=340&f=png&s=83858" alt="image.png"></p>
<p>所以我们在模版文件 <code>template.html</code> 中添加 <code>&lt;!--SetScriptTimestampPlugin inset script--&gt;</code> 作为标识替换入口：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Webpack 插件开发入门<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  	<span class="comment">&lt;!-- other code --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--SetScriptTimestampPlugin inset script--&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="3-5-编写插件逻辑"><a href="#3-5-编写插件逻辑" class="headerlink" title="3.5 编写插件逻辑"></a>3.5 编写插件逻辑</h3><p>到这一步，才开始编写插件的逻辑。<br />从上一步中，我们知道在 <code>tap</code> 第二个参数是个回调函数，并且这个回调函数有两个参数： <code>compilation</code> 和 <code>callback</code> 。</p>
<p><code>compilation</code> 继承于<code>compiler</code>，包含 <code>compiler</code> 所有内容（也有 Webpack 的 <code>options</code>），而且也有 <code>plugin</code> 函数接入任务点。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SetScriptTimestampPlugin.js</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SetScriptTimestampPlugin</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">apply</span>(<span class="params">compiler</span>)</span> &#123;</span><br><span class="line">    compiler.hooks.compilation.tap(<span class="string">&#x27;SetScriptTimestampPlugin&#x27;</span>, </span><br><span class="line">      <span class="function">(<span class="params">compilation, callback</span>) =&gt;</span> &#123;</span><br><span class="line">      	<span class="comment">// 插件逻辑 调用compilation提供的plugin方法</span></span><br><span class="line">        compilation.plugin(</span><br><span class="line">          <span class="string">&quot;html-webpack-plugin-before-html-processing&quot;</span>,</span><br><span class="line">          <span class="function"><span class="keyword">function</span>(<span class="params">htmlPluginData, callback</span>) </span>&#123;</span><br><span class="line">            <span class="comment">// 读取并修改 script 上 src 列表</span></span><br><span class="line">            <span class="keyword">let</span> jsScr = htmlPluginData.assets.js[<span class="number">0</span>];</span><br><span class="line">            htmlPluginData.assets.js = [];</span><br><span class="line">            <span class="keyword">let</span> result = <span class="string">`</span></span><br><span class="line"><span class="string">                &lt;script&gt;</span></span><br><span class="line"><span class="string">                    let scriptDOM = document.createElement(&quot;script&quot;);</span></span><br><span class="line"><span class="string">                    let jsScr = &quot;./<span class="subst">$&#123;jsScr&#125;</span>&quot;;</span></span><br><span class="line"><span class="string">                    scriptDOM.src = jsScr + &quot;?&quot; + new Date().getTime();</span></span><br><span class="line"><span class="string">                    document.body.appendChild(scriptDOM)</span></span><br><span class="line"><span class="string">                &lt;/script&gt;</span></span><br><span class="line"><span class="string">            `</span>;</span><br><span class="line">            <span class="keyword">let</span> resultHTML = htmlPluginData.html.replace(</span><br><span class="line">              <span class="string">&quot;&lt;!--SetScriptTimestampPlugin inset script--&gt;&quot;</span>, result</span><br><span class="line">            );</span><br><span class="line">            <span class="comment">// 返回修改后的结果</span></span><br><span class="line">            htmlPluginData.html = resultHTML;</span><br><span class="line">          &#125;</span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">module</span>.exports = SetScriptTimestampPlugin;</span><br></pre></td></tr></table></figure>

<p>在上面插件逻辑中，具体做了这些事：</p>
<ol>
<li><strong>执行 <strong><code>compilation.plugin</code></strong>  方法，并传入两个参数：插件事件和回调方法。</strong></li>
</ol>
<p>所谓“插件事件”即插件所提供的一些事件，用于监听插件状态，这里列举几个 <code>html-webpack-plugin</code> 提供的事件（完整可查看《<a target="_blank" rel="noopener" href="https://www.npmjs.com/package/html-webpack-plugin">html-webpack-plugin</a>》）：<br />Async:</p>
<ul>
<li><code>html-webpack-plugin-before-html-generation</code></li>
<li><code>html-webpack-plugin-before-html-processing</code></li>
<li><code>html-webpack-plugin-alter-asset-tags</code></li>
</ul>
<p>Sync:</p>
<ul>
<li><code>html-webpack-plugin-alter-chunks</code></li>
</ul>
<ol start="2">
<li><strong>获取脚本文件名称列表并清空。</strong></li>
</ol>
<p>在回调方法中，通过 <code>htmlPluginData.assets.js</code> 获取需要通过 <code>script</code> 引入的脚本文件名称列表，拷贝一份，并清空原有列表。</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/2/24/170745f86a2d7bbe?w=334&h=93&f=png&s=27216" alt="image.png"></p>
<ol start="3">
<li><strong>编写替换逻辑。</strong></li>
</ol>
<p>替换逻辑即：动态创建一个 <code>script</code> 标签，将其 <code>src</code> 值设置为上一步读取到的脚本文件名，并在后面拼接 <strong>时间戳</strong> 作为参数。</p>
<ol start="4">
<li><strong>插入替换逻辑。</strong></li>
</ol>
<p>通过 <code>htmlPluginData.html</code> 可以获取到模版文件的字符串输出，我们只需要将模版字符串中替换入口 <code>&lt;!--SetScriptTimestampPlugin inset script--&gt;</code> 替换成我们上一步编写的替换逻辑即可。</p>
<ol start="5">
<li><strong>返回HTML文件。</strong></li>
</ol>
<p>最后将修改后的 HTML 字符串，赋值给原来的 <code>htmlPluginData.html</code> 达到修改效果。</p>
<h3 id="3-5-使用插件"><a href="#3-5-使用插件" class="headerlink" title="3.5 使用插件"></a>3.5 使用插件</h3><p>自定义插件使用方式，与其他插件一致，在 <code>plugins</code> 数组中实例化：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.config.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> SetScriptTimestampPlugin = <span class="built_in">require</span>(<span class="string">&quot;./SetScriptTimestampPlugin.js&quot;</span>);</span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">	<span class="comment">// ... 省略其他配置</span></span><br><span class="line">  <span class="attr">plugins</span>: [</span><br><span class="line">  	<span class="comment">// ... 省略其他插件</span></span><br><span class="line">    <span class="keyword">new</span> SetScriptTimestampPlugin()  </span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>到这一步，我们已经实现需求“当项目托管到 CDN 平台，希望实现项目中的 index.js 不被缓存”。<br /><img src="https://user-gold-cdn.xitu.io/2020/2/24/170745f86a7fdfd0?w=467&h=291&f=png&s=44616" alt="image.png"></p>
<h2 id="四、案例拓展"><a href="#四、案例拓展" class="headerlink" title="四、案例拓展"></a>四、案例拓展</h2><p>这里以之前 <strong>SetScriptTimestampPlugin</strong> 插件为例子，继续拓展。</p>
<h3 id="4-1-读取插件配置参数"><a href="#4-1-读取插件配置参数" class="headerlink" title="4.1 读取插件配置参数"></a>4.1 读取插件配置参数</h3><p>每个插件本质是一个类，跟一个类实例化相同，可以在实例化时传入配置参数，在构造函数中操作：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SetScriptTimestampPlugin.js</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SetScriptTimestampPlugin</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">options</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.options = options;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">apply</span>(<span class="params">compiler</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">this</span>.options.filename); <span class="comment">// &quot;index.js&quot;</span></span><br><span class="line">    <span class="comment">// ... 省略其他代码</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">module</span>.exports = SetScriptTimestampPlugin;</span><br></pre></td></tr></table></figure>

<p>使用时：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.config.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> SetScriptTimestampPlugin = <span class="built_in">require</span>(<span class="string">&quot;./SetScriptTimestampPlugin.js&quot;</span>);</span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">	<span class="comment">// ... 省略其他配置</span></span><br><span class="line">  <span class="attr">plugins</span>: [</span><br><span class="line">  	<span class="comment">// ... 省略其他插件</span></span><br><span class="line">    <span class="keyword">new</span> SetScriptTimestampPlugin(&#123;</span><br><span class="line">    	<span class="attr">filename</span>: <span class="string">&quot;index.js&quot;</span></span><br><span class="line">    &#125;)  </span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-2-添加多脚本文件的时间戳"><a href="#4-2-添加多脚本文件的时间戳" class="headerlink" title="4.2 添加多脚本文件的时间戳"></a>4.2 添加多脚本文件的时间戳</h3><p>如果我们此时需要同时修改多个脚本文件的时间戳，也只需要将参数类型和执行脚本做下调整。<br />具体修改脚本，这里不具体展开，篇幅有限，可以自行思考实现咯~<br />这里展示使用插件时的参数：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.config.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> SetScriptTimestampPlugin = <span class="built_in">require</span>(<span class="string">&quot;./SetScriptTimestampPlugin.js&quot;</span>);</span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">	<span class="comment">// ... 省略其他配置</span></span><br><span class="line">  <span class="attr">plugins</span>: [</span><br><span class="line">  	<span class="comment">// ... 省略其他插件</span></span><br><span class="line">    <span class="keyword">new</span> SetScriptTimestampPlugin(&#123;</span><br><span class="line">    	<span class="attr">filename</span>: [<span class="string">&quot;index.js&quot;</span>, <span class="string">&quot;boundle.js&quot;</span>, <span class="string">&quot;pingan.js&quot;</span>]</span><br><span class="line">    &#125;)  </span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>生成结果：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;./index.js?1582425467655&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;./boundle.js?1582425467655&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;./pingan.js?1582425467655&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="五、总结"><a href="#五、总结" class="headerlink" title="五、总结"></a>五、总结</h2><p>本文通用自定义 Webpack 插件来实现日常一些比较棘手的需求。主要为大家介绍了 Webpack 插件的基本组成和简单架构，也介绍了 HtmlWebpackPlugin 插件。并通过这些基础知识，完成了一个 HTML 文本替换插件，最后通过两个场景来拓展插件使用范围。</p>
<p>最后，关于 Webpack 插件开发，还有更多知识可以学习，建议多看看官方文档《<a target="_blank" rel="noopener" href="https://webpack.js.org/contribute/writing-a-plugin/">Writing a Plugin</a>》进行学习。</p>
<p>本文纯属个人经验总结，如有异议，欢迎指点。</p>
<h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><ol>
<li>《<a target="_blank" rel="noopener" href="https://webpack.js.org/contribute/writing-a-plugin/">Writing a Plugin</a>》</li>
<li>《<a target="_blank" rel="noopener" href="https://webpack.js.org/plugins/html-webpack-plugin/">HtmlWebpackPlugin - Webpack</a>》</li>
<li>《<a target="_blank" rel="noopener" href="https://www.cnblogs.com/mjian/p/9250095.html">扩展 HtmlwebpackPlugin 插入自定义的脚本</a>》</li>
</ol>
<h2 id="关于我"><a href="#关于我" class="headerlink" title="关于我"></a>关于我</h2><table>
<thead>
<tr>
<th>Author</th>
<th>王平安</th>
</tr>
</thead>
<tbody><tr>
<td>E-mail</td>
<td><a href="mailto:&#112;&#105;&#110;&#103;&#97;&#110;&#56;&#55;&#x38;&#x37;&#64;&#x71;&#113;&#x2e;&#x63;&#111;&#x6d;">&#112;&#105;&#110;&#103;&#97;&#110;&#56;&#55;&#x38;&#x37;&#64;&#x71;&#113;&#x2e;&#x63;&#111;&#x6d;</a></td>
</tr>
<tr>
<td>博  客</td>
<td><a target="_blank" rel="noopener" href="http://www.pingan8787.com/">www.pingan8787.com</a></td>
</tr>
<tr>
<td>微  信</td>
<td>pingan8787</td>
</tr>
<tr>
<td>每日文章推荐</td>
<td><a target="_blank" rel="noopener" href="https://github.com/pingan8787/Leo_Reading/issues">https://github.com/pingan8787/Leo_Reading/issues</a></td>
</tr>
<tr>
<td>ES小册</td>
<td>js.pingan8787.com</td>
</tr>
</tbody></table>
<h2 id="微信公众号"><a href="#微信公众号" class="headerlink" title="微信公众号"></a>微信公众号</h2><p><img src="https://user-gold-cdn.xitu.io/2020/2/22/1706bb1ea5f680ae?w=885&h=445&f=png&s=80093" alt="bg">  </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/02/24/198-%E3%80%90Webpack%E3%80%91Webpack%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91%E5%A6%82%E6%AD%A4%E7%AE%80%E5%8D%95%EF%BC%81/" data-id="ckts3eju2005j4d9k346s7az9" data-title="198-【Webpack】Webpack插件开发如此简单！" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Webpack/" rel="tag">Webpack</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/" rel="tag">前端开发</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%8E%9F%E5%88%9B/" rel="tag">原创</a></li></ul>

    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/2/">&laquo; Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/23/">23</a><a class="extend next" rel="next" href="/page/4/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Angular/" rel="tag">Angular</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CSS/" rel="tag">CSS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CSS%E5%8A%A8%E7%94%BB/" rel="tag">CSS动画</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Chrome/" rel="tag">Chrome</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ES6-ES7-ES8/" rel="tag">ES6/ES7/ES8</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Eslint/" rel="tag">Eslint</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Express/" rel="tag">Express</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GraphQL/" rel="tag">GraphQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/H5/" rel="tag">H5</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTML/" rel="tag">HTML</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTTP/" rel="tag">HTTP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTTP%E5%8D%8F%E8%AE%AE/" rel="tag">HTTP协议</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hybrid/" rel="tag">Hybrid</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JavaScript/" rel="tag">JavaScript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NPM/" rel="tag">NPM</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nodejs/" rel="tag">Nodejs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Numpy/" rel="tag">Numpy</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Python/" rel="tag">Python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/React/" rel="tag">React</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Tensorflow/" rel="tag">Tensorflow</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TyeScript/" rel="tag">TyeScript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TypeScript/" rel="tag">TypeScript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vuejs/" rel="tag">Vuejs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WebSocket/" rel="tag">WebSocket</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Webpack/" rel="tag">Webpack</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/demo/" rel="tag">demo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/" rel="tag">中间件</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD/" rel="tag">人工智能</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%85%A8%E6%A0%88%E5%BC%80%E5%8F%91/" rel="tag">全栈开发</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/" rel="tag">前端开发</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%89%8D%E7%AB%AF%E6%8E%A2%E7%B4%A2/" rel="tag">前端探索</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%89%8D%E7%AB%AF%E7%9F%A5%E4%B9%8E%E7%B3%BB%E5%88%97/" rel="tag">前端知乎系列</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8E%9F%E5%88%9B/" rel="tag">原创</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B8%B8%E7%94%A8%E6%8A%80%E6%9C%AF/" rel="tag">常用技术</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BE%AE%E5%89%8D%E7%AB%AF/" rel="tag">微前端</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%80%BB%E7%BB%93/" rel="tag">总结</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" rel="tag">数据结构</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/" rel="tag">机器学习</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9E%84%E5%BB%BA%E5%B7%A5%E5%85%B7/" rel="tag">构建工具</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/" rel="tag">正则表达式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%BA%90%E7%A0%81/" rel="tag">源码</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%BA%90%E7%A0%81%E7%B2%BE%E8%AF%BB/" rel="tag">源码精读</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%83%AD%E9%97%A8/" rel="tag">热门</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%94%9F%E6%B4%BB%E6%9D%82%E8%AE%B0/" rel="tag">生活杂记</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%AE%97%E6%B3%95/" rel="tag">算法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/" rel="tag">编译原理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BD%91%E7%BB%9C%E8%AF%B7%E6%B1%82/" rel="tag">网络请求</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" rel="tag">设计模式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" rel="tag">读书笔记</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%87%8D%E6%B8%A9%E5%9F%BA%E7%A1%80/" rel="tag">重温基础</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9D%A2%E8%AF%95%E9%A2%98/" rel="tag">面试题</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Angular/" style="font-size: 11.88px;">Angular</a> <a href="/tags/CSS/" style="font-size: 18.13px;">CSS</a> <a href="/tags/CSS%E5%8A%A8%E7%94%BB/" style="font-size: 12.5px;">CSS动画</a> <a href="/tags/Chrome/" style="font-size: 10px;">Chrome</a> <a href="/tags/ES6-ES7-ES8/" style="font-size: 10.63px;">ES6/ES7/ES8</a> <a href="/tags/Eslint/" style="font-size: 10px;">Eslint</a> <a href="/tags/Express/" style="font-size: 10px;">Express</a> <a href="/tags/GraphQL/" style="font-size: 10px;">GraphQL</a> <a href="/tags/H5/" style="font-size: 10px;">H5</a> <a href="/tags/HTML/" style="font-size: 10px;">HTML</a> <a href="/tags/HTTP/" style="font-size: 11.88px;">HTTP</a> <a href="/tags/HTTP%E5%8D%8F%E8%AE%AE/" style="font-size: 11.25px;">HTTP协议</a> <a href="/tags/Hybrid/" style="font-size: 10.63px;">Hybrid</a> <a href="/tags/JavaScript/" style="font-size: 19.38px;">JavaScript</a> <a href="/tags/NPM/" style="font-size: 10px;">NPM</a> <a href="/tags/Nodejs/" style="font-size: 11.25px;">Nodejs</a> <a href="/tags/Numpy/" style="font-size: 10.63px;">Numpy</a> <a href="/tags/Python/" style="font-size: 17.5px;">Python</a> <a href="/tags/React/" style="font-size: 12.5px;">React</a> <a href="/tags/Tensorflow/" style="font-size: 10.63px;">Tensorflow</a> <a href="/tags/TyeScript/" style="font-size: 10px;">TyeScript</a> <a href="/tags/TypeScript/" style="font-size: 11.25px;">TypeScript</a> <a href="/tags/Vuejs/" style="font-size: 14.38px;">Vuejs</a> <a href="/tags/WebSocket/" style="font-size: 10px;">WebSocket</a> <a href="/tags/Webpack/" style="font-size: 15.63px;">Webpack</a> <a href="/tags/demo/" style="font-size: 10.63px;">demo</a> <a href="/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/" style="font-size: 10px;">中间件</a> <a href="/tags/%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD/" style="font-size: 16.25px;">人工智能</a> <a href="/tags/%E5%85%A8%E6%A0%88%E5%BC%80%E5%8F%91/" style="font-size: 11.25px;">全栈开发</a> <a href="/tags/%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/" style="font-size: 20px;">前端开发</a> <a href="/tags/%E5%89%8D%E7%AB%AF%E6%8E%A2%E7%B4%A2/" style="font-size: 11.25px;">前端探索</a> <a href="/tags/%E5%89%8D%E7%AB%AF%E7%9F%A5%E4%B9%8E%E7%B3%BB%E5%88%97/" style="font-size: 10.63px;">前端知乎系列</a> <a href="/tags/%E5%8E%9F%E5%88%9B/" style="font-size: 18.75px;">原创</a> <a href="/tags/%E5%B8%B8%E7%94%A8%E6%8A%80%E6%9C%AF/" style="font-size: 10.63px;">常用技术</a> <a href="/tags/%E5%BE%AE%E5%89%8D%E7%AB%AF/" style="font-size: 10px;">微前端</a> <a href="/tags/%E6%80%BB%E7%BB%93/" style="font-size: 13.75px;">总结</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" style="font-size: 10px;">数据结构</a> <a href="/tags/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/" style="font-size: 15px;">机器学习</a> <a href="/tags/%E6%9E%84%E5%BB%BA%E5%B7%A5%E5%85%B7/" style="font-size: 10.63px;">构建工具</a> <a href="/tags/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/" style="font-size: 10.63px;">正则表达式</a> <a href="/tags/%E6%BA%90%E7%A0%81/" style="font-size: 10px;">源码</a> <a href="/tags/%E6%BA%90%E7%A0%81%E7%B2%BE%E8%AF%BB/" style="font-size: 10px;">源码精读</a> <a href="/tags/%E7%83%AD%E9%97%A8/" style="font-size: 10px;">热门</a> <a href="/tags/%E7%94%9F%E6%B4%BB%E6%9D%82%E8%AE%B0/" style="font-size: 10px;">生活杂记</a> <a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 13.13px;">算法</a> <a href="/tags/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/" style="font-size: 10px;">编译原理</a> <a href="/tags/%E7%BD%91%E7%BB%9C%E8%AF%B7%E6%B1%82/" style="font-size: 10px;">网络请求</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 15px;">设计模式</a> <a href="/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" style="font-size: 14.38px;">读书笔记</a> <a href="/tags/%E9%87%8D%E6%B8%A9%E5%9F%BA%E7%A1%80/" style="font-size: 16.88px;">重温基础</a> <a href="/tags/%E9%9D%A2%E8%AF%95%E9%A2%98/" style="font-size: 10px;">面试题</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">July 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">May 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">December 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">October 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/07/28/227-%E3%80%90%E6%80%BB%E7%BB%93%E3%80%91%E5%A6%82%E4%BD%95%E4%BC%98%E9%9B%85%E7%9A%84%E5%9C%A8%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E4%BD%BF%E7%94%A8SVG%E5%AD%97%E4%BD%93%E5%9B%BE%E6%A0%87/">227-【总结】如何优雅的在微信小程序使用SVG字体图标</a>
          </li>
        
          <li>
            <a href="/2021/07/28/226-%E3%80%90HTTP%E3%80%91%E5%A6%82%E4%BD%95%E4%BC%98%E9%9B%85%E7%9A%84%E7%AE%A1%E7%90%86HTTP%E8%AF%B7%E6%B1%82%E5%92%8C%E5%93%8D%E5%BA%94%E6%8B%A6%E6%88%AA%E5%99%A8%EF%BC%9F/">226-【HTTP】如何优雅的管理HTTP请求和响应拦截器？</a>
          </li>
        
          <li>
            <a href="/2021/07/28/225-%E3%80%90Vue%E3%80%91%E4%BB%8E%E6%89%8B%E5%86%99Vue3%E7%9A%84Reactivity%E5%BC%80%E5%A7%8B%E6%B7%B1%E5%85%A5Vue3%E6%BA%90%E7%A0%81/">225-【Vue】从手写Vue3的Reactivity开始深入Vue3源码</a>
          </li>
        
          <li>
            <a href="/2021/05/30/224-%E3%80%90Chrome%E3%80%915%E4%B8%AAChrome%E8%B0%83%E8%AF%95%E6%B7%B7%E5%90%88%E5%BA%94%E7%94%A8%E7%9A%84%E6%8A%80%E5%B7%A7/">224-【Chrome】5个Chrome调试混合应用的技巧</a>
          </li>
        
          <li>
            <a href="/2021/03/19/223-%E3%80%90%E5%89%8D%E7%AB%AF%E6%8E%A2%E7%B4%A2%E3%80%91%E6%8E%A2%E7%B4%A2Snabbdom%E6%A8%A1%E5%9D%97%E7%B3%BB%E7%BB%9F%E5%8E%9F%E7%90%86/">223-【前端探索】探索Snabbdom模块系统原理</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2021 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>