<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-227-【总结】如何优雅的在微信小程序使用SVG字体图标" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/07/28/227-%E3%80%90%E6%80%BB%E7%BB%93%E3%80%91%E5%A6%82%E4%BD%95%E4%BC%98%E9%9B%85%E7%9A%84%E5%9C%A8%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E4%BD%BF%E7%94%A8SVG%E5%AD%97%E4%BD%93%E5%9B%BE%E6%A0%87/" class="article-date">
  <time class="dt-published" datetime="2021-07-28T14:12:08.000Z" itemprop="datePublished">2021-07-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/07/28/227-%E3%80%90%E6%80%BB%E7%BB%93%E3%80%91%E5%A6%82%E4%BD%95%E4%BC%98%E9%9B%85%E7%9A%84%E5%9C%A8%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E4%BD%BF%E7%94%A8SVG%E5%AD%97%E4%BD%93%E5%9B%BE%E6%A0%87/">227-【总结】如何优雅的在微信小程序使用SVG字体图标</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <blockquote>
<p>本文思路来自实际项目的重构总结，欢迎纠正和交流。如果对你有帮助，还请点赞👍收藏支持一下啦。</p>
</blockquote>
<p>最近在重构一个项目，主要是做 H5 端和小程序端，这次打算开始多做总结啦，之前已经总结一篇<a target="_blank" rel="noopener" href="https://juejin.cn/post/6986455896708612110">《如何优雅的管理 HTTP 请求和响应拦截器？》</a> 。</p>
<p>如果大家还有其他方案，欢迎一起探讨哈~ 喜欢本文的朋友给个赞👍鼓励一下哈~</p>
<h2 id="一、需求思考和方案设计"><a href="#一、需求思考和方案设计" class="headerlink" title="一、需求思考和方案设计"></a>一、需求思考和方案设计</h2><p>本文介绍的项目是使用 <a target="_blank" rel="noopener" href="https://taro-docs.jd.com/taro/docs/README">Taro</a>框架进行多端开发，目前主要适配 H5 端和微信小程序端。项目使用的字体图标库内部维护，目前托管在 <a target="_blank" rel="noopener" href="https://www.iconfont.cn/">iconfont</a> 上。</p>
<h3 id="1-问题分析"><a href="#1-问题分析" class="headerlink" title="1. 问题分析"></a>1. 问题分析</h3><p>最近在重构的项目比较古老（其实也就去年的），项目中使用到的图标早已更新 N 个迭代了，已经由<strong>单色图标</strong>更新到<strong>多色图标</strong>！<br><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/16cfaf7b06054a389ca1d4112c62c78c~tplv-k3u1fbpfcp-zoom-1.image"><br>很明显好看多了。</p>
<p>这里先按照 <a target="_blank" rel="noopener" href="https://www.iconfont.cn/help/detail?spm=a313x.7781069.1998910419.d8cf4382a&helptype=code">iconfont 的规则</a>看看单色图标和多色图标使用上的区别：</p>
<h4 id="单色图标的使用"><a href="#单色图标的使用" class="headerlink" title="单色图标的使用"></a>单色图标的使用</h4><p>单色图标使用起来比较简单（以 font-class 引用为例），只需要 2 个步骤：</p>
<ul>
<li><p>第一步：拷贝项目下面生成的fontclass代码：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">//at<span class="selector-class">.alicdn</span><span class="selector-class">.com</span>/t/font_8d5l8fzk5b87iudi<span class="selector-class">.css</span></span><br></pre></td></tr></table></figure></li>
<li><p>第二步：挑选相应图标并获取类名，应用于页面：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;iconfont icon-xxx&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="多色图标的使用"><a href="#多色图标的使用" class="headerlink" title="多色图标的使用"></a>多色图标的使用</h4><p>多色图标使用起来也很简单（以 symbol 引用为例），只需要 3 个步骤：</p>
<ul>
<li><p>第一步：拷贝项目下面生成的symbol代码：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">//at.alicdn.com/t/font_8d5l8fzk5b87iudi.js</span><br></pre></td></tr></table></figure></li>
<li><p>第二步：加入通用css代码（引入一次就行）：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span>&gt;</span><span class="css"></span></span><br><span class="line"><span class="css">    <span class="selector-class">.icon</span> &#123;</span></span><br><span class="line"><span class="css">       <span class="attribute">width</span>: <span class="number">1em</span>; <span class="attribute">height</span>: <span class="number">1em</span>;</span></span><br><span class="line"><span class="css">       <span class="attribute">vertical-align</span>: -<span class="number">0.15em</span>;</span></span><br><span class="line"><span class="css">       fill: currentColor;</span></span><br><span class="line"><span class="css">       <span class="attribute">overflow</span>: hidden;</span></span><br><span class="line"><span class="css">    &#125;</span></span><br><span class="line"><span class="css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><p>第三步：挑选相应图标并获取类名，应用于页面：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">class</span>=<span class="string">&quot;icon&quot;</span> <span class="attr">aria-hidden</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">use</span> <span class="attr">xlink:href</span>=<span class="string">&quot;#icon-xxx&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">use</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>这两种图标在使用上都非常方便，那大家是不是会好奇，我们写本文的目的？</p>
<p>原因是，<strong>微信小程序上不支持 SVG 字体图标！😔 而多色图标，是需要借助 SVG 标签来实现。</strong></p>
<p>于是我在<a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/component/image.html">小程序文档</a>找了好久，也只看到了 <code>&lt;Image&gt;</code> 组件能够使用 SVG，介绍如下：</p>
<blockquote>
<p>image图片。支持 JPG、PNG、SVG、WEBP、GIF 等格式，2.3.0 起支持云文件ID。</p>
</blockquote>
<p>其属性 <code>src</code> 的值为图片资源地址，这就意味着，不能使用 SVG 字体图标了。因此我们需要想想变通的办法。</p>
<p>（这里不讨论将 iconfont 上图标下载为图片来引用的情况）</p>
<h3 id="2-方案设计"><a href="#2-方案设计" class="headerlink" title="2. 方案设计"></a>2. 方案设计</h3><p>既然我们了解了单色图标和多色图标的使用方式：</p>
<ul>
<li>单色图标：任意标签（如 <code>div</code> 标签） + 对应字体图标 class 名称</li>
<li>多色图标：使用 <code>svg</code> 标签 + <code>use</code> 标签设置 <code>xlink:href</code> 属性</li>
</ul>
<p>首先马上想到的是，能不能集合两者使用方式，实现任意标签通过 class 名称来使用多色图标？</p>
<p>答案是可以的，只需要对图标文件进行格式转换，即 <strong>将多色字体图标转换为能通过class名称来引用的字体图标文件</strong> 。</p>
<p>那接下来只要看看如何实现格式转换即可。</p>
<h2 id="二、重构后的效果"><a href="#二、重构后的效果" class="headerlink" title="二、重构后的效果"></a>二、重构后的效果</h2><p>这边我以其中一个页面进行重构，最后将单色图标全都换成新的多色 SVG 字体图标，效果如下：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c102f716f07a4c489bac801c9ed71ebe~tplv-k3u1fbpfcp-zoom-1.image"></p>
<h2 id="三、方案一：手动转换图标文件"><a href="#三、方案一：手动转换图标文件" class="headerlink" title="三、方案一：手动转换图标文件"></a>三、方案一：手动转换图标文件</h2><p>目前我尝试了两套方案，并且都顺利实现效果，这边先分享一下这两种方案，然后再补充说明我选择哪个方案和原因：</p>
<p>该方案实现的是手动将字体图标库文件转换成能通过 class 名称来引用的图标库。<br>使用到的工具有：</p>
<ol>
<li>icomoon：<a target="_blank" rel="noopener" href="https://icomoon.io/">https://icomoon.io/</a> 用来打包图标。</li>
<li>transfonter： <a target="_blank" rel="noopener" href="https://transfonter.org/">https://transfonter.org/</a> 用来生成 base64 格式的图标。</li>
</ol>
<p>接下来开始试试：</p>
<h3 id="步骤一：通过-iconfont-下载需要的-SVG-格式的图标"><a href="#步骤一：通过-iconfont-下载需要的-SVG-格式的图标" class="headerlink" title="步骤一：通过 iconfont 下载需要的 SVG 格式的图标"></a>步骤一：通过 iconfont 下载需要的 SVG 格式的图标</h3><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d2f2ed0981774d3082f29812b7226cc8~tplv-k3u1fbpfcp-zoom-1.image"></p>
<p>这边多下载了几个，都是 svg 格式的文件，如下图：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/61210334a3d148f4ac06c3b24c071663~tplv-k3u1fbpfcp-zoom-1.image"></p>
<h3 id="步骤二：打包字体图标"><a href="#步骤二：打包字体图标" class="headerlink" title="步骤二：打包字体图标"></a>步骤二：打包字体图标</h3><p>这一步是将零散个多个 SVG 多色图标打包成一个字体图标文件，这一步需要使用 <a target="_blank" rel="noopener" href="https://icomoon.io/">https://icomoon.io/</a>：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0758d7a86d8046d99e0d3293c3ac44ba~tplv-k3u1fbpfcp-zoom-1.image"></p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2e710ef82d7b445b8503eeddd3616a4d~tplv-k3u1fbpfcp-zoom-1.image"></p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ac14cf323a0a4c30896528abd519e04a~tplv-k3u1fbpfcp-zoom-1.image"></p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/49d1b72417614cb4847b42d8a51c8b83~tplv-k3u1fbpfcp-zoom-1.image"></p>
<h3 id="步骤三：字体图标进行-Base64-编码"><a href="#步骤三：字体图标进行-Base64-编码" class="headerlink" title="步骤三：字体图标进行 Base64 编码"></a>步骤三：字体图标进行 Base64 编码</h3><p>接下来就需要将打好的字体图标进行 base64 压缩，这边使用<a target="_blank" rel="noopener" href="https://transfonter.org/">https://transfonter.org/</a>来操作。</p>
<p>第一步选择前面打好的包里面的 <code>.ttf</code> 文件：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/52c375c7a20a4dcdb45b9b9b6aa76fe7~tplv-k3u1fbpfcp-zoom-1.image"></p>
<p>设置参数，并导出文件：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b074d244eafd4efbb33ec0a339c7e41a~tplv-k3u1fbpfcp-zoom-1.image"></p>
<h3 id="步骤四：合并字体图标"><a href="#步骤四：合并字体图标" class="headerlink" title="步骤四：合并字体图标"></a>步骤四：合并字体图标</h3><p>经过前面几个步骤，我们现在已经有 2 个包：</p>
<ul>
<li>第一个包：icomoon 生成的包</li>
</ul>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2d8be45c189442f8bfa18d33c9325b0b~tplv-k3u1fbpfcp-zoom-1.image"></p>
<ul>
<li>第二个包：transfonter 生成的包</li>
</ul>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5f8f7d9414aa4e43b8ad21dd44747c64~tplv-k3u1fbpfcp-zoom-1.image"></p>
<p>接下来我们开始将两个包合并：<br>将第一个包 style.css 文件除 <code>@font-face</code> 的内容复制到第二个包 stylesheet.css 文件后面。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/47f9996d991a4a7bb8af9a7fd84e8a23~tplv-k3u1fbpfcp-zoom-1.image"></p>
<p>这样就获得一份新的字体图标文件，其实也可以拷贝到一份新的 css 文件中。</p>
<h3 id="使用字体图标"><a href="#使用字体图标" class="headerlink" title="使用字体图标"></a>使用字体图标</h3><p>我们将前面修改后的文件改名为 <code>icon.scss</code> 并引入到项目：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// app<span class="selector-class">.scss</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@import</span> <span class="string">&quot;./style/icon.scss&quot;</span>;</span><br></pre></td></tr></table></figure>
<p>代码中使用图标：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;View className=<span class="string">&quot;icon-exe-knowledge-ppt&quot;</span>&gt;</span><br><span class="line">  <span class="xml"><span class="tag">&lt;<span class="name">View</span> <span class="attr">className</span>=<span class="string">&#x27;path1&#x27;</span>&gt;</span><span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line">  <span class="xml"><span class="tag">&lt;<span class="name">View</span> <span class="attr">className</span>=<span class="string">&#x27;path2&#x27;</span>&gt;</span><span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line">  <span class="xml"><span class="tag">&lt;<span class="name">View</span> <span class="attr">className</span>=<span class="string">&#x27;path3&#x27;</span>&gt;</span><span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line">  <span class="xml"><span class="tag">&lt;<span class="name">View</span> <span class="attr">className</span>=<span class="string">&#x27;path4&#x27;</span>&gt;</span><span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line">  <span class="xml"><span class="tag">&lt;<span class="name">View</span> <span class="attr">className</span>=<span class="string">&#x27;path5&#x27;</span>&gt;</span><span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line">  <span class="xml"><span class="tag">&lt;<span class="name">View</span> <span class="attr">className</span>=<span class="string">&#x27;path6&#x27;</span>&gt;</span><span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line">&lt;/View&gt;</span><br></pre></td></tr></table></figure>
<p>最后效果如下：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c48ca101e0d8458c970eaceb562c641c~tplv-k3u1fbpfcp-zoom-1.image"></p>
<h3 id="踩坑记录"><a href="#踩坑记录" class="headerlink" title="踩坑记录"></a>踩坑记录</h3><p>在使用方案一的时候，踩了好几个坑，这边挑两个来说：</p>
<ul>
<li>使用时，需要手动添加几个 <code>&lt;View classname=&quot;path*&quot;&gt;&lt;/View&gt;</code> 元素</li>
</ul>
<p>刚开始使用，图标一直没有出来，后面观察字体图标，它是在容器元素下很多个 <code>path1</code> 、 <code>path2</code> 等元素的伪类中去渲染图标内容：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/35107552afc042f388757059de967143~tplv-k3u1fbpfcp-zoom-1.image"></p>
<p>所以使用时需要手动添加一下。</p>
<ul>
<li>默认图标会是一个大的块级元素，导致图标显示有问题</li>
</ul>
<p>这是因为手动加的 class 为 <code>path*</code> 的 <code>View</code> 标签本身是块级元素，所以这里只要简单加个 <code>display: flex</code> 即可。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4f6cf5d1753b4221af6614ce964683cc~tplv-k3u1fbpfcp-zoom-1.image"></p>
<p>并且其字体大小，也是可以使用 <code>font-size</code> 来设置：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">display</span>: flex;</span><br><span class="line"><span class="attribute">font-size</span>: <span class="number">100px</span>;</span><br></pre></td></tr></table></figure>

<h3 id="抽取组件"><a href="#抽取组件" class="headerlink" title="抽取组件"></a>抽取组件</h3><p>考虑到复用性，我将这些抽成一个 <code>exe-svg-icon</code> 组件：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Taro <span class="keyword">from</span> <span class="string">&#x27;@tarojs/taro&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; View, Text &#125; <span class="keyword">from</span> <span class="string">&#x27;@tarojs/components&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> classNames <span class="keyword">from</span> <span class="string">&#x27;classnames&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">EXESvgIcon</span>(<span class="params">params</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; icon = <span class="string">&#x27;exe-none&#x27;</span> &#125; = params;</span><br><span class="line">  <span class="keyword">const</span> containerStyle = &#123;</span><br><span class="line">    <span class="attr">display</span>: <span class="string">&#x27;inline-block&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="xml"><span class="tag">&lt;<span class="name">View</span> <span class="attr">className</span>=<span class="string">&#123;classNames(</span>&#x27;<span class="attr">svg</span>&#x27;, <span class="attr">icon</span>)&#125; <span class="attr">style</span>=<span class="string">&#123;containerStyle&#125;</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">View</span> <span class="attr">className</span>=<span class="string">&#x27;path1&#x27;</span> <span class="attr">style</span>=<span class="string">&#123;containerStyle&#125;</span>&gt;</span><span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">View</span> <span class="attr">className</span>=<span class="string">&#x27;path2&#x27;</span> <span class="attr">style</span>=<span class="string">&#123;containerStyle&#125;</span>&gt;</span><span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">View</span> <span class="attr">className</span>=<span class="string">&#x27;path3&#x27;</span> <span class="attr">style</span>=<span class="string">&#123;containerStyle&#125;</span>&gt;</span><span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line"><span class="xml">      &#123;/* 一般图标 3 层，这边多预留几层，防止不够用 */&#125;</span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">View</span> <span class="attr">className</span>=<span class="string">&#x27;path4&#x27;</span> <span class="attr">style</span>=<span class="string">&#123;containerStyle&#125;</span>&gt;</span><span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">View</span> <span class="attr">className</span>=<span class="string">&#x27;path5&#x27;</span> <span class="attr">style</span>=<span class="string">&#123;containerStyle&#125;</span>&gt;</span><span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">View</span> <span class="attr">className</span>=<span class="string">&#x27;path6&#x27;</span> <span class="attr">style</span>=<span class="string">&#123;containerStyle&#125;</span>&gt;</span><span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">View</span> <span class="attr">className</span>=<span class="string">&#x27;path7&#x27;</span> <span class="attr">style</span>=<span class="string">&#123;containerStyle&#125;</span>&gt;</span><span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">View</span> <span class="attr">className</span>=<span class="string">&#x27;path8&#x27;</span> <span class="attr">style</span>=<span class="string">&#123;containerStyle&#125;</span>&gt;</span><span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">View</span> <span class="attr">className</span>=<span class="string">&#x27;path9&#x27;</span> <span class="attr">style</span>=<span class="string">&#123;containerStyle&#125;</span>&gt;</span><span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> EXESvgIcon;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>到这边，方案一实现完成。</p>
<h2 id="四、方案二：借助第三方库实现"><a href="#四、方案二：借助第三方库实现" class="headerlink" title="四、方案二：借助第三方库实现"></a>四、方案二：借助第三方库实现</h2><p>由于第一个方案使用起来比较繁琐，于是我又再研究其他简单点的方案。</p>
<p>直到我看到 <a target="_blank" rel="noopener" href="https://gitee.com/mirrors/Taro-Iconfont">taro-iconfont-cli</a> 这个库。</p>
<blockquote>
<p>在Taro框架中使用iconfont图标，不依赖字体，支持多色彩。</p>
</blockquote>
<p>目前支持平台包括：</p>
<ul>
<li>微信小程序</li>
<li>支付宝小程序</li>
<li>百度小程序</li>
<li>头条小程序</li>
<li>QQ小程序</li>
<li>H5</li>
</ul>
<p>有以下特性：</p>
<ul>
<li>一键生成标准组件，多端支持</li>
<li>使用方便，import即可</li>
<li>支持多色彩</li>
<li>支持自定义颜色</li>
<li>支持 ES6 和 TypeScript 两种模式</li>
</ul>
<p>按照文档描述，只需要 3 个步骤，那么试试看：</p>
<h3 id="步骤一：安装-taro-iconfont-cli"><a href="#步骤一：安装-taro-iconfont-cli" class="headerlink" title="步骤一：安装 taro-iconfont-cli"></a>步骤一：安装 taro-iconfont-cli</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Yarn</span></span><br><span class="line">yarn add taro-iconfont-cli --dev</span><br><span class="line"></span><br><span class="line"><span class="comment"># Npm</span></span><br><span class="line">npm install taro-iconfont-cli --save-dev</span><br></pre></td></tr></table></figure>
<p>需要注意的是，如果使用的是 Taro 2.x，请安装 **<code>**taro-iconfont-cli@2.1.0**</code>**，并阅读旧版的<a target="_blank" rel="noopener" href="https://github.com/iconfont-cli/taro-iconfont-cli/blob/v2.1.0/README.md">README.md</a>。</p>
<h3 id="步骤二：生成配置文件"><a href="#步骤二：生成配置文件" class="headerlink" title="步骤二：生成配置文件"></a>步骤二：生成配置文件</h3><p>通过命令生成 iconfont.json 配置文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">npx iconfont-init</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可传入配置输出路径</span></span><br><span class="line"><span class="comment"># npx iconfont-init --output iconfont.json</span></span><br></pre></td></tr></table></figure>
<p>此时项目根目录会生成一个<code>iconfont.json</code>的文件，内容如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;symbol_url&quot;</span>: <span class="string">&quot;请参考README.md，复制 http://iconfont.cn 官网提供的JS链接&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;save_dir&quot;</span>: <span class="string">&quot;./src/components/iconfont&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;use_typescript&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;platforms&quot;</span>: <span class="string">&quot;*&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;use_rpx&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">&quot;trim_icon_prefix&quot;</span>: <span class="string">&quot;icon&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;default_icon_size&quot;</span>: <span class="number">18</span>,</span><br><span class="line">  <span class="attr">&quot;design_width&quot;</span>: <span class="number">750</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>symbol_url</code> 值需要在 iconfont 中复制</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/246e746ed45d42afa5ae93a9b9cfe15b~tplv-k3u1fbpfcp-zoom-1.image"></p>
<h3 id="步骤三：生成-Taro-标准组件"><a href="#步骤三：生成-Taro-标准组件" class="headerlink" title="步骤三：生成 Taro 标准组件"></a>步骤三：生成 Taro 标准组件</h3><p>通过命令，生成 Taro 标准组件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">npx iconfont-taro</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可传入配置文件路径</span></span><br><span class="line"><span class="comment"># npx iconfont-taro --config iconfont.json</span></span><br></pre></td></tr></table></figure>
<p>通过控制台，我们可以看到 taro-iconfont-cli 为每个图标单独生成一个 Taro 组件：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2ba58b7294c240f58a83b26f3d5bd1b6~tplv-k3u1fbpfcp-zoom-1.image"></p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/80ff739befa843469c5af0d0beeabec1~tplv-k3u1fbpfcp-zoom-1.image"></p>
<h3 id="使用字体图标-1"><a href="#使用字体图标-1" class="headerlink" title="使用字体图标"></a>使用字体图标</h3><p>按照文档使用方法，使用的时候，只需要引入 <code>IconFont</code> 组件，通过 <code>name</code> 名称来选择对应图标即可：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 省略其他代码</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> IconFont <span class="keyword">from</span> <span class="string">&#x27;@components/Iconfont/index&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">IconFont</span> <span class="attr">name</span>=<span class="string">&quot;exe-knowledge-ppt&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">IconFont</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>按照文档提示，还有更多使用方法：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 原色彩</span></span><br><span class="line">&lt;IconFont name=<span class="string">&quot;alipay&quot;</span> /&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 单色：红色</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">IconFont</span> <span class="attr">name</span>=<span class="string">&quot;alipay&quot;</span> <span class="attr">color</span>=<span class="string">&quot;red&quot;</span> /&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 多色：红色+橘色</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">IconFont</span> <span class="attr">name</span>=<span class="string">&quot;alipay&quot;</span> <span class="attr">color</span>=<span class="string">&#123;[</span>&#x27;<span class="attr">red</span>&#x27;, &#x27;<span class="attr">orange</span>&#x27;]&#125; <span class="attr">size</span>=<span class="string">&#123;300&#125;</span> /&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 不同格式的颜色写法</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">IconFont</span> <span class="attr">name</span>=<span class="string">&quot;alipay&quot;</span> <span class="attr">color</span>=<span class="string">&#123;[</span>&#x27;#<span class="attr">333</span>&#x27;, &#x27;<span class="attr">rgb</span>(<span class="attr">50</span>, <span class="attr">124</span>, <span class="attr">39</span>)&#x27;]&#125; /&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 与文字对齐</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">View</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">display:</span> &#x27;<span class="attr">flex</span>&#x27;, <span class="attr">alignItems:</span> &#x27;<span class="attr">center</span>&#x27; &#125;&#125;&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;<span class="name">Text</span>&gt;</span>Hello<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;<span class="name">IconFont</span> <span class="attr">name</span>=<span class="string">&quot;alipay&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<h3 id="踩坑记录-1"><a href="#踩坑记录-1" class="headerlink" title="踩坑记录"></a>踩坑记录</h3><ol>
<li>字体大小设置问题</li>
</ol>
<p>由于通过这种方式导出的图标，是个单独组件，使用时如果需要设置图标大小，需要通过设置其 <code>width</code>和<code>height</code>属性进行设置。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e2a1543852b9471faf58996659570723~tplv-k3u1fbpfcp-zoom-1.image"></p>
<p>通过 <code>font-size</code>属性无法设置字体图标的大小。</p>
<h2 id="五、方案对比和选择"><a href="#五、方案对比和选择" class="headerlink" title="五、方案对比和选择"></a>五、方案对比和选择</h2><p>这次只尝试了这两种方案，都能顺利完成需求。如果大家有其他方案，欢迎一起评论区讨论~</p>
<p>接下来<strong>以生成下面相同 20 个多色图标为标准，分析这两种方案：</strong></p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3f78d0a522394926a71c0243988ca945~tplv-k3u1fbpfcp-zoom-1.image"></p>
<p>先看看对比结果：</p>
<table>
<thead>
<tr>
<th></th>
<th><strong>手动转换图标文件</strong></th>
<th><strong>借助 taro-iconfont-cli 库实现</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>生成难易程度</strong></td>
<td>复杂</td>
<td>简单</td>
</tr>
<tr>
<td><strong>使用难易程度</strong></td>
<td>简单</td>
<td>简单</td>
</tr>
<tr>
<td><strong>资源占用程度</strong></td>
<td>27kb</td>
<td>420kb（项目未打包前）</td>
</tr>
</tbody></table>
<p>分析每个项目：</p>
<h3 id="1-对比生成难易程度"><a href="#1-对比生成难易程度" class="headerlink" title="1. 对比生成难易程度"></a>1. 对比生成难易程度</h3><ul>
<li>「手动转换图标文件」需要每次将图标单独下载，再进行打包，当图标数量较多，其工作量就较大。</li>
<li>「taro-iconfont-cli」只需设置字体图标库地址，自动下载并生成组件，较为方便。</li>
</ul>
<h3 id="2-对比使用难易程度"><a href="#2-对比使用难易程度" class="headerlink" title="2. 对比使用难易程度"></a>2. 对比使用难易程度</h3><p>两者使用起来都比较简单：</p>
<ul>
<li><p>「手动转换图标文件」为元素添加 class 名称即可。</p>
</li>
<li><p>「taro-iconfont-cli」为元素添加 name 属性。</p>
<h3 id="3-对比资源占用情况"><a href="#3-对比资源占用情况" class="headerlink" title="3. 对比资源占用情况"></a>3. 对比资源占用情况</h3><p>资源占用差异就很大了，分析下原因：</p>
</li>
<li><p>「手动转换图标文件」是将图标重新打包，最后生成的都是 base64 编码的内容，相对较小。</p>
</li>
<li><p>「taro-iconfont-cli」是为每个图标生成一个组件，单独一个文件，还有附加各个平台的文件，因此较大。</p>
<h3 id="4-选择方案"><a href="#4-选择方案" class="headerlink" title="4. 选择方案"></a>4. 选择方案</h3><p>考虑到目前项目所使用的字体图标比较少（20 个以内），后续开发人员上手难度问题，我最终使用「taro-iconfont-cli」这套方案。<br>虽然这个方案生成的组件资源占用会稍大，但是目前使用图标较少，并且可以通过打包工具、CDN 等常用优化方式进行优化。</p>
</li>
</ul>
<h2 id="六、本文总结"><a href="#六、本文总结" class="headerlink" title="六、本文总结"></a>六、本文总结</h2><p>本文通过一次简单的项目重构，总结项目中小程序使用 SVG 多色图标的方案，目的是为了实现在小程序中能够正常使用 SVG 多色图标，并且也为内容越来越多独立站点的项目积累经验，毕竟各个项目具有相关性。</p>
<p>最后，「taro-iconfont-cli」方案目前已经在内部 npm 仓库维护，采用版本控制，方便不同项目使用时减少冲突。</p>
<p>当然，本文是基于我的经验总结，欢迎大家有更好的方案，一起讨论学习~~</p>
<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/Originally_M/article/details/106473475">微信小程序中使用svg字体图标教程 ——图解三步，很清晰</a> </li>
<li><a target="_blank" rel="noopener" href="https://gitee.com/mirrors/Taro-Iconfont">Taro-Iconfont</a> </li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/07/28/227-%E3%80%90%E6%80%BB%E7%BB%93%E3%80%91%E5%A6%82%E4%BD%95%E4%BC%98%E9%9B%85%E7%9A%84%E5%9C%A8%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E4%BD%BF%E7%94%A8SVG%E5%AD%97%E4%BD%93%E5%9B%BE%E6%A0%87/" data-id="ckts3ejue006k4d9k3vwjfvkj" data-title="227-【总结】如何优雅的在微信小程序使用SVG字体图标" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%80%BB%E7%BB%93/" rel="tag">总结</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-226-【HTTP】如何优雅的管理HTTP请求和响应拦截器？" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/07/28/226-%E3%80%90HTTP%E3%80%91%E5%A6%82%E4%BD%95%E4%BC%98%E9%9B%85%E7%9A%84%E7%AE%A1%E7%90%86HTTP%E8%AF%B7%E6%B1%82%E5%92%8C%E5%93%8D%E5%BA%94%E6%8B%A6%E6%88%AA%E5%99%A8%EF%BC%9F/" class="article-date">
  <time class="dt-published" datetime="2021-07-28T14:11:08.000Z" itemprop="datePublished">2021-07-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/07/28/226-%E3%80%90HTTP%E3%80%91%E5%A6%82%E4%BD%95%E4%BC%98%E9%9B%85%E7%9A%84%E7%AE%A1%E7%90%86HTTP%E8%AF%B7%E6%B1%82%E5%92%8C%E5%93%8D%E5%BA%94%E6%8B%A6%E6%88%AA%E5%99%A8%EF%BC%9F/">226-【HTTP】如何优雅的管理HTTP请求和响应拦截器？</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <blockquote>
<p>本文思路来自实际项目的重构总结，欢迎纠正和交流。如果对你有帮助，还请点赞👍收藏支持一下啦。</p>
</blockquote>
<p>最近重构一个老项目，发现其中处理请求的拦截器写得相当乱，于是我将整个项目的请求处理层重构了，目前已经在项目中正常运行。</p>
<p>本文会和大家分享我的重构思路和后续优化的思考，为方便与大家分享，我用 Vue3 实现一个简单 demo，思路是一致的，有兴趣的朋友可以<a target="_blank" rel="noopener" href="https://github.com/pingan8787/Leo-JavaScript/blob/master/Cute-Summary/useful-request-demo/index.html">在我 Github 查看</a>，本文会以这个 Vue 实现的 demo 为例介绍。</p>
<p>本文我会主要和大家分享以下几点：</p>
<ol>
<li>问题分析和方案设计；</li>
<li>重构后效果；</li>
<li>开发过程；</li>
<li>后期优化点；</li>
</ol>
<p>如果你还不清楚什么是 HTTP 请求和响应拦截器，那么可以先看看<a target="_blank" rel="noopener" href="https://juejin.cn/post/6885471967714115597">《77.9K Star 的 Axios 项目有哪些值得借鉴的地方》</a> 。</p>
<h2 id="一、需求思考和方案设计"><a href="#一、需求思考和方案设计" class="headerlink" title="一、需求思考和方案设计"></a>一、需求思考和方案设计</h2><h3 id="1-问题分析"><a href="#1-问题分析" class="headerlink" title="1. 问题分析"></a>1. 问题分析</h3><p>目前旧项目经过多位同事参与开发，拦截器存在以下问题：</p>
<ul>
<li>代码比较混乱，可读性差；</li>
<li>每个拦截器职责混乱，存在相互依赖；</li>
<li>逻辑上存在问题；</li>
<li>团队内部不同项目无法复用；</li>
</ul>
<h3 id="2-方案设计"><a href="#2-方案设计" class="headerlink" title="2. 方案设计"></a>2. 方案设计</h3><p>分析上面问题后，我初步的方案如下：<br>参考<strong>插件化架构设计</strong>，<strong>独立每个拦截器</strong>，将每个拦截器抽离成单独文件维护，做到<strong>职责单一</strong>，然后通过<strong>拦截器调度器</strong>进行调度和注册。</p>
<p>其拦截器调度过程如下图：<br><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9ce1a9b0a66249048f323ed9b4b89478~tplv-k3u1fbpfcp-zoom-1.image" alt="拦截器调度过程"></p>
<h2 id="二、重构后效果"><a href="#二、重构后效果" class="headerlink" title="二、重构后效果"></a>二、重构后效果</h2><p>代码其实比较简单，这里先看下最后实现效果：</p>
<h3 id="1-目录分层更加清晰"><a href="#1-目录分层更加清晰" class="headerlink" title="1. 目录分层更加清晰"></a>1. 目录分层更加清晰</h3><p>重构后请求处理层的目录分层更加清晰，大致如下：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/93071e340443455baa6465c74b738cdc~tplv-k3u1fbpfcp-zoom-1.image" alt="目录分层"></p>
<h3 id="2-拦截器开发更加方便"><a href="#2-拦截器开发更加方便" class="headerlink" title="2. 拦截器开发更加方便"></a>2. 拦截器开发更加方便</h3><p>在后续业务拓展新的拦截器，仅需 3 个步骤既可以完成拦截器的开发和使用，拦截器调度器会<strong>自动调用所有拦截器</strong>：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/300d5d2b343f47d9822f38308b501ba3~tplv-k3u1fbpfcp-zoom-1.image" alt="拦截器开发更加方便"></p>
<h3 id="3-每个拦截器职责更加单一，可插拔"><a href="#3-每个拦截器职责更加单一，可插拔" class="headerlink" title="3. 每个拦截器职责更加单一，可插拔"></a>3. 每个拦截器职责更加单一，可插拔</h3><p>将每个拦截器抽成一个文件去实现，让每个拦截器<strong>职责分离且单一</strong>，当不需要使用某个拦截器时，随时可以替换，灵活插拔。</p>
<h2 id="三、开发过程"><a href="#三、开发过程" class="headerlink" title="三、开发过程"></a>三、开发过程</h2><p>这里以我单独抽出来的<a target="_blank" rel="noopener" href="https://github.com/pingan8787/Leo-JavaScript/blob/master/Cute-Summary/useful-request-demo/index.html">这个 demo 项目</a>为例来介绍。</p>
<h3 id="1-初始化目录结构"><a href="#1-初始化目录结构" class="headerlink" title="1. 初始化目录结构"></a>1. 初始化目录结构</h3><p>按照前面设计的方案，首先需要在项目中创建一下目录结构：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- request</span><br><span class="line">	- index.js      // 拦截器调度器</span><br><span class="line">  - interceptors  </span><br><span class="line">    - request     // 用来存放每个请求拦截器</span><br><span class="line">    	- index.js  // 管理所有请求拦截器，并做排序</span><br><span class="line">    - response    // 用来存放每个响应拦截器</span><br><span class="line">    	- index.js  // 管理所有响应拦截器，并做排序</span><br></pre></td></tr></table></figure>


<h3 id="2-定义拦截器调度器"><a href="#2-定义拦截器调度器" class="headerlink" title="2. 定义拦截器调度器"></a>2. 定义拦截器调度器</h3><p>因为项目采用 <a target="_blank" rel="noopener" href="https://github.com/axios/axios">axios 请求库</a>，所以我们需要先知道 axios 拦截器的使用方法，这里简单看下 <a target="_blank" rel="noopener" href="https://github.com/axios/axios#interceptors">axios 文档上如何使用拦截器</a>的：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 添加请求拦截器</span></span><br><span class="line">axios.interceptors.request.use(<span class="function"><span class="keyword">function</span> (<span class="params">config</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 业务 逻辑</span></span><br><span class="line">    <span class="keyword">return</span> config;</span><br><span class="line">  &#125;, <span class="function"><span class="keyword">function</span> (<span class="params">error</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 业务 逻辑</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Promise</span>.reject(error);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加响应拦截器</span></span><br><span class="line">axios.interceptors.response.use(<span class="function"><span class="keyword">function</span> (<span class="params">response</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 业务 逻辑</span></span><br><span class="line">    <span class="keyword">return</span> response;</span><br><span class="line">  &#125;, <span class="function"><span class="keyword">function</span> (<span class="params">error</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 业务逻辑</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Promise</span>.reject(error);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<p>从上面代码，我们可以知道，使用拦截器的时候，只需调用 <code>axios.interceptors</code> 对象上对应方法即可，因此我们可以将这块逻辑抽取出来：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/request/interceptors/index.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; log &#125; <span class="keyword">from</span> <span class="string">&#x27;../log&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> request <span class="keyword">from</span> <span class="string">&#x27;./request/index&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> response <span class="keyword">from</span> <span class="string">&#x27;./response/index&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> runInterceptors = <span class="function"><span class="params">instance</span> =&gt;</span> &#123;</span><br><span class="line">    log(<span class="string">&#x27;[runInterceptors]&#x27;</span>, instance);</span><br><span class="line">  	<span class="keyword">if</span>(!instance) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置请求拦截器</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> request) &#123;</span><br><span class="line">        instance.interceptors.request</span><br><span class="line">            .use(<span class="function"><span class="params">config</span> =&gt;</span> request[key](config));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置响应拦截器</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> response) &#123;</span><br><span class="line">        instance.interceptors.response</span><br><span class="line">            .use(<span class="function"><span class="params">result</span> =&gt;</span> response[key](result));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> instance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这就是我们的<strong>核心拦截器调度器</strong>，目前实现导入所有请求拦截器和响应拦截器后，通过 <code>for</code> 循环，注册所有拦截器，最后将整个 axios 实例返回出去。</p>
<h3 id="3-定义简单的请求拦截器和响应拦截器"><a href="#3-定义简单的请求拦截器和响应拦截器" class="headerlink" title="3. 定义简单的请求拦截器和响应拦截器"></a>3. 定义简单的请求拦截器和响应拦截器</h3><p>这里我们做简单演示，创建以下两个拦截器：</p>
<ol>
<li>请求拦截器：<strong>setLoading</strong>，作用是在发起请求前，显示一个全局 Toast 框，提示“加载中…”文案。</li>
<li>响应拦截器：<strong>setLoading</strong>，作用是在请求响应后，关闭页面中的 Toast 框。</li>
</ol>
<p>为了统一开发规范，我们约定插件开发规范如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  拦截器名称：xxx</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">const</span> interceptorName = <span class="function"><span class="params">options</span> =&gt;</span> &#123;</span><br><span class="line">  log(<span class="string">&quot;[interceptor.request]interceptorName:&quot;</span>, options);</span><br><span class="line">	<span class="comment">// 拦截器业务</span></span><br><span class="line">  <span class="keyword">return</span> options;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> interceptorName;</span><br></pre></td></tr></table></figure>

<p>首先创建文件 <code>src/request/interceptors/request/</code> 目录下创建 <code>setLoading.js</code>  文件，按照上面约定的插件开发规范，我们完成下面插件开发：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/request/interceptors/request/setLoading.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; Toast &#125; <span class="keyword">from</span> <span class="string">&#x27;vant&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; log &#125; <span class="keyword">from</span> <span class="string">&quot;../../log&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  拦截器名称：全局设置请求的 loading 动画</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">const</span> setLoading = <span class="function"><span class="params">options</span> =&gt;</span> &#123;</span><br><span class="line">  log(<span class="string">&quot;[interceptor.request]setLoading:&quot;</span>, options);</span><br><span class="line"></span><br><span class="line">  Toast.loading(&#123;</span><br><span class="line">    <span class="attr">duration</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">message</span>: <span class="string">&#x27;加载中...&#x27;</span>,</span><br><span class="line">    <span class="attr">forbidClick</span>: <span class="literal">true</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">return</span> options;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> setLoading;</span><br></pre></td></tr></table></figure>

<p>然后在导出该请求拦截器，并且导出的是个<strong>数组</strong>，方便拦截器调度器进行统一注册：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/request/interceptors/request/index.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> setLoading <span class="keyword">from</span> <span class="string">&#x27;./setLoading&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> [</span><br><span class="line">    setLoading</span><br><span class="line">];</span><br></pre></td></tr></table></figure>

<p>按照相同方式，我们开发响应拦截器：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/request/interceptors/response/setLoading.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; Toast &#125; <span class="keyword">from</span> <span class="string">&#x27;vant&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; log &#125; <span class="keyword">from</span> <span class="string">&quot;../../log&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  拦截器名称：关闭全局请求的 loading 动画</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">const</span> setLoading = <span class="function"><span class="params">result</span> =&gt;</span> &#123;</span><br><span class="line">  log(<span class="string">&quot;[interceptor.response]setLoading:&quot;</span>, result);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// example: 请求返回成功时，关闭所有 toast 框</span></span><br><span class="line">  <span class="keyword">if</span>(result &amp;&amp; result.success)&#123;</span><br><span class="line">    Toast.clear();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> setLoading;</span><br></pre></td></tr></table></figure>

<p>导出响应拦截器：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/request/interceptors/response/index.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> setLoading <span class="keyword">from</span> <span class="string">&#x27;./setLoading&#x27;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> [</span><br><span class="line">    setLoading</span><br><span class="line">];</span><br></pre></td></tr></table></figure>

<h3 id="4-全局设置-axios-拦截器"><a href="#4-全局设置-axios-拦截器" class="headerlink" title="4. 全局设置 axios 拦截器"></a>4. 全局设置 axios 拦截器</h3><p>按照前面相同步骤，我又多写了几个拦截器：<br>请求拦截器：</p>
<ul>
<li>setSecurityInformation.js：为请求的 url 添加安全参数；</li>
<li>setSignature.js：为请求的请求头添加加签信息；</li>
<li>setToken.js： 为请求的请求头添加 token 信息；</li>
</ul>
<p>响应拦截器：</p>
<ul>
<li>setError.js：处理响应结果的出错情况，如关闭所有 toast 框；</li>
<li>setInvalid.js：处理响应结果的登录失效情况，如跳转到登录页；</li>
<li>setResult.js：处理响应结果的数据嵌套太深的问题，将 <code>result.data.data.data</code> 这类返回结果处理成 <code>result.data</code> 格式；</li>
</ul>
<p>至于是如何实现的，大家有兴趣可以<a target="_blank" rel="noopener" href="https://github.com/pingan8787/Leo-JavaScript/blob/master/Cute-Summary/useful-request-demo/index.html">在我 Github 查看</a>。</p>
<p>然后我们可以将 axios 进行二次封装，导出 <code>request</code> 对象供业务使用：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/request/index.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">&#x27;axios&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; runInterceptors &#125; <span class="keyword">from</span> <span class="string">&#x27;./interceptors/index&#x27;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> requestConfig = &#123; <span class="attr">timeout</span>: <span class="number">10000</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> request = axios.create(requestConfig);</span><br><span class="line">request = runInterceptors(request);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> request;</span><br></pre></td></tr></table></figure>

<p>到这边就完成。</p>
<p>在业务中需要发起请求，可以这么使用：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;&lt;button @click=&quot;send&quot;&gt;发起请求&lt;/button&gt;&lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup&gt;</span><br><span class="line">import request from &#x27;./../request/index.js&#x27;;</span><br><span class="line"></span><br><span class="line">const send = async () =&gt; &#123;</span><br><span class="line">  const result = await request(&#123;</span><br><span class="line">    url: &#x27;https://httpbin.org/headers&#x27;,</span><br><span class="line">    method: &#x27;get&#x27;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h3 id="5-测试一下"><a href="#5-测试一下" class="headerlink" title="5. 测试一下"></a>5. 测试一下</h3><p>开发到这边就差不多，我们发送个请求，可以看到所有拦截器执行过程如下：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9d35ad954a504d1f9245c9d3fbeee597~tplv-k3u1fbpfcp-zoom-1.image" alt="日志输出"></p>
<p>看看请求头信息：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8308f8e7297f480a88f70716351853b4~tplv-k3u1fbpfcp-zoom-1.image" alt="请求头"></p>
<p>可以看到我们开发的请求拦截器已经生效。</p>
<h2 id="四、Taro-中使用"><a href="#四、Taro-中使用" class="headerlink" title="四、Taro 中使用"></a>四、Taro 中使用</h2><p>由于 <a target="_blank" rel="noopener" href="https://taro-docs.jd.com/">Taro</a> 中已经提供了 <a target="_blank" rel="noopener" href="https://taro-docs.jd.com/taro/docs/2.x/apis/network/request/request">Taro.request</a> 方法作为请求方法，我们可以不需要使用 axios 发请求。</p>
<p>基于上面代码进行改造，也很简单，只需要更改 2 个地方：</p>
<h3 id="1-修改封装请求的方法"><a href="#1-修改封装请求的方法" class="headerlink" title="1. 修改封装请求的方法"></a>1. 修改封装请求的方法</h3><p>主要是更换 axios 为 Taro.request 方法，并使用 addInterceptor  方法导入拦截器：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/request/index.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> Taro <span class="keyword">from</span> <span class="string">&quot;@tarojs/taro&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; runInterceptors &#125; <span class="keyword">from</span> <span class="string">&#x27;./interceptors/index&#x27;</span>;</span><br><span class="line"></span><br><span class="line">Taro.addInterceptor(runInterceptors);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> request = Taro.request;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> requestTask = Taro.RequestTask; <span class="comment">// 看需求，是否需要</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> addInterceptor = Taro.addInterceptor; <span class="comment">// 看需求，是否需要</span></span><br></pre></td></tr></table></figure>

<h3 id="2-修改拦截器调度器"><a href="#2-修改拦截器调度器" class="headerlink" title="2. 修改拦截器调度器"></a>2. 修改拦截器调度器</h3><p>由于 axios 和 <code>Taro.request</code> 添加拦截器的方法不同，所以也需要进行更换：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> request <span class="keyword">from</span> <span class="string">&#x27;./interceptors/request&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> response <span class="keyword">from</span> <span class="string">&#x27;./interceptors/response&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> interceptor = &#123;</span><br><span class="line">    request,</span><br><span class="line">    response</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getInterceptor = <span class="function">(<span class="params">chain = &#123;&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 设置请求拦截器</span></span><br><span class="line">  <span class="keyword">let</span> requestParams = chain.requestParams;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> request) &#123;</span><br><span class="line">    requestParams = request[key](requestParams);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 设置响应拦截器</span></span><br><span class="line">  <span class="keyword">let</span> responseObject = chain.proceed(requestParams);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> response) &#123;</span><br><span class="line">    responseObject = responseObject.then(<span class="function"><span class="params">res</span> =&gt;</span> response[key](res));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> responseObject;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>具体 API 可以看 <a target="_blank" rel="noopener" href="https://taro-docs.jd.com/taro/docs/2.x/apis/network/request/request">Taro.request</a> 文档，这里不过多介绍。</p>
<h2 id="五、项目总结和思考"><a href="#五、项目总结和思考" class="headerlink" title="五、项目总结和思考"></a>五、项目总结和思考</h2><p>这次重构主要是按照已有业务进行重构，因此即使是重构后的请求层，仍然还有很多可以优化的点，目前我想到有这些，也算是我的一个 TODO LIST 了：</p>
<h3 id="1-将请求层独立成库"><a href="#1-将请求层独立成库" class="headerlink" title="1. 将请求层独立成库"></a>1. 将请求层独立成库</h3><p>由于公司现在独立站点的项目较多，考虑到项目的统一开发规范，可以考虑将该请求层独立为私有库进行维护。<br>目前思路：</p>
<ul>
<li>参考插件化架构设计，通过 <a target="_blank" rel="noopener" href="https://github.com/lerna/lerna/">lerna</a> 做管理所有拦截器；</li>
<li>升级 TypeScript，方便管理和开发；</li>
<li>进行工程化改造，加入构建工具、单元测试、UMD等等；</li>
<li>使用文档和开发文档完善。</li>
</ul>
<h3 id="2-支持可更换请求库"><a href="#2-支持可更换请求库" class="headerlink" title="2.  支持可更换请求库"></a>2.  支持可更换请求库</h3><p>单独抽这一点来讲，是因为目前我们前端团队使用的请求库较多，比较分散，所以考虑到通用性，需要增加支持可更换请求库方法。<br>目前思路：</p>
<ul>
<li>在已有请求层再抽象一层<strong>请求库适配层</strong>，定义统一接口；</li>
<li>内置几种常见请求库的适配。</li>
</ul>
<h3 id="3-开发拦截器脚手架"><a href="#3-开发拦截器脚手架" class="headerlink" title="3. 开发拦截器脚手架"></a>3. 开发拦截器脚手架</h3><p>这个的目的其实很简单，让团队内其他人直接使用脚手架工具，按照内置脚手架模版，快速创建一个拦截器，进行后续开发，很大程度统一拦截器的开发规范。<br>目前思路：</p>
<ul>
<li>内置两套拦截器模版：请求拦截器和响应拦截器；</li>
<li>脚手架开发比较简单，参数（如语言）根据业务需要再确定。</li>
</ul>
<h3 id="4-增强拦截器调度"><a href="#4-增强拦截器调度" class="headerlink" title="4. 增强拦截器调度"></a>4. 增强拦截器调度</h3><p>目前实现的这个功能还比较简单，还是得考虑增强拦截器调度。<br>目前思路：</p>
<ul>
<li>处理拦截器失败的情况；</li>
<li>处理拦截器调度顺序的问题；</li>
<li>拦截器同步执行、异步执行、并发执行、循环执行等等情况；</li>
<li>可插拔的拦截器调度；</li>
<li>考虑参考 Tapable 插件机制；</li>
</ul>
<h2 id="六、本文总结"><a href="#六、本文总结" class="headerlink" title="六、本文总结"></a>六、本文总结</h2><p>本文通过一次简单的项目重构总结出一个请求层拦截器调度方案，目的是为了实现所有<strong>拦截器职责单一</strong>、方便维护，并<strong>统一维护</strong>和<strong>自动调度</strong>，大大降低实际业务的拦截器开发上手难度。</p>
<p>后续我仍有很多需要优化的地方，作为自己的一个 TODO LIST，如果是做成完全通用，则定位可能更偏向于拦截器调度容器，只提供一些通用拦截器，其余还是由开发者定义，库负责调度，但常用的请求库一般都已经做好，所以这样做的价值有待权衡。</p>
<p>当然，目前还是优先作为团队内部私有库进行开发和使用，因为基本上团队内部使用的业务都差不多，只是项目不同。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/07/28/226-%E3%80%90HTTP%E3%80%91%E5%A6%82%E4%BD%95%E4%BC%98%E9%9B%85%E7%9A%84%E7%AE%A1%E7%90%86HTTP%E8%AF%B7%E6%B1%82%E5%92%8C%E5%93%8D%E5%BA%94%E6%8B%A6%E6%88%AA%E5%99%A8%EF%BC%9F/" data-id="ckts3ejud006i4d9kdxjq97jq" data-title="226-【HTTP】如何优雅的管理HTTP请求和响应拦截器？" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/HTTP/" rel="tag">HTTP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%80%BB%E7%BB%93/" rel="tag">总结</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-225-【Vue】从手写Vue3的Reactivity开始深入Vue3源码" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/07/28/225-%E3%80%90Vue%E3%80%91%E4%BB%8E%E6%89%8B%E5%86%99Vue3%E7%9A%84Reactivity%E5%BC%80%E5%A7%8B%E6%B7%B1%E5%85%A5Vue3%E6%BA%90%E7%A0%81/" class="article-date">
  <time class="dt-published" datetime="2021-07-28T14:09:07.000Z" itemprop="datePublished">2021-07-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/07/28/225-%E3%80%90Vue%E3%80%91%E4%BB%8E%E6%89%8B%E5%86%99Vue3%E7%9A%84Reactivity%E5%BC%80%E5%A7%8B%E6%B7%B1%E5%85%A5Vue3%E6%BA%90%E7%A0%81/">225-【Vue】从手写Vue3的Reactivity开始深入Vue3源码</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>Vue 3 中的响应式原理可谓是非常之重要，通过学习 Vue3 的响应式原理，不仅能让我们学习到 Vue.js 的一些设计模式和思想，还能<strong>帮助我们提高项目开发效率和代码调试能力</strong>。  </p>
<p>在这之前，我也写了一篇<a target="_blank" rel="noopener" href="https://juejin.cn/post/6916276304258007053">《探索 Vue.js 响应式原理》</a> ，主要介绍 Vue 2 响应式的原理，这篇补上 Vue 3 的。  </p>
<p>于是最近在 Vue Mastery 上重新学习 <a target="_blank" rel="noopener" href="https://www.vuemastery.com/courses/vue-3-reactivity/vue3-reactivity">Vue3 Reactivity</a> 的知识，这次收获更大。本文将带大家从头开始学习如何实现简单版 Vue 3 响应式，帮助大家了解其核心，后面阅读 Vue 3 响应式相关的源码能够更加得心应手。</p>
<h2 id="一、Vue-3-响应式使用"><a href="#一、Vue-3-响应式使用" class="headerlink" title="一、Vue 3 响应式使用"></a>一、Vue 3 响应式使用</h2><h3 id="1-Vue-3-中的使用"><a href="#1-Vue-3-中的使用" class="headerlink" title="1. Vue 3 中的使用"></a>1. Vue 3 中的使用</h3><p>当我们在学习 Vue 3 的时候，可以通过一个简单示例，看看什么是 Vue 3 中的响应式：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- HTML 内容 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span>Price: &#123;&#123;price&#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span>Total: &#123;&#123;price * quantity&#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span>getTotal: &#123;&#123;getTotal&#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> app = Vue.createApp(&#123; <span class="comment">// ① 创建 APP 实例</span></span><br><span class="line">    <span class="function"><span class="title">data</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="attr">price</span>: <span class="number">10</span>,</span><br><span class="line">            <span class="attr">quantity</span>: <span class="number">2</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">computed</span>: &#123;</span><br><span class="line">        <span class="function"><span class="title">getTotal</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.price * <span class="built_in">this</span>.quantity * <span class="number">1.1</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line">app.mount(<span class="string">&#x27;#app&#x27;</span>)  <span class="comment">// ② 挂载 APP 实例</span></span><br></pre></td></tr></table></figure>

<p>通过创建 APP 实例和挂载 APP 实例即可，这时可以看到页面中分别显示对应数值：<br><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bccaca7ec584466c90ca06f3e960048a~tplv-k3u1fbpfcp-zoom-1.image" alt="image.png"></p>
<p>当我们修改 <code>price</code> 或 <code>quantity</code> 值的时候，页面上引用它们的地方，内容也能正常展示变化后的结果。这时，我们会好奇为何数据发生变化后，相关的数据也会跟着变化，那么我们接着往下看。</p>
<h3 id="2-实现单个值的响应式"><a href="#2-实现单个值的响应式" class="headerlink" title="2. 实现单个值的响应式"></a>2. 实现单个值的响应式</h3><p>在普通 JS 代码执行中，并不会有响应式变化，比如在控制台执行下面代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> price = <span class="number">10</span>, quantity = <span class="number">2</span>;</span><br><span class="line"><span class="keyword">const</span> total = price * quantity;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">`total: <span class="subst">$&#123;total&#125;</span>`</span>); <span class="comment">// total: 20</span></span><br><span class="line">price = <span class="number">20</span>;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">`total: <span class="subst">$&#123;total&#125;</span>`</span>); <span class="comment">// total: 20</span></span><br></pre></td></tr></table></figure>

<p>从这可以看出，在修改 <code>price</code> 变量的值后， <code>total</code> 的值并没有发生改变。</p>
<p>那么如何修改上面代码，让 <code>total</code> 能够自动更新呢？我们其实可以将修改 <code>total</code> 值的方法保存起来，等到与 <code>total</code> 值相关的变量（如 <code>price</code> 或 <code>quantity</code> 变量的值）发生变化时，触发该方法，更新 <code>total</code> 即可。我们可以这么实现：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> price = <span class="number">10</span>, quantity = <span class="number">2</span>, total = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">const</span> dep = <span class="keyword">new</span> <span class="built_in">Set</span>(); <span class="comment">// ① </span></span><br><span class="line"><span class="keyword">const</span> effect = <span class="function">() =&gt;</span> &#123; total = price * quantity &#125;;</span><br><span class="line"><span class="keyword">const</span> track = <span class="function">() =&gt;</span> &#123; dep.add(effect) &#125;;  <span class="comment">// ②</span></span><br><span class="line"><span class="keyword">const</span> trigger = <span class="function">() =&gt;</span> &#123; dep.forEach( <span class="function"><span class="params">effect</span> =&gt;</span> effect() )&#125;;  <span class="comment">// ③</span></span><br><span class="line"></span><br><span class="line">track();</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">`total: <span class="subst">$&#123;total&#125;</span>`</span>); <span class="comment">// total: 0</span></span><br><span class="line">trigger();</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">`total: <span class="subst">$&#123;total&#125;</span>`</span>); <span class="comment">// total: 20</span></span><br><span class="line">price = <span class="number">20</span>;</span><br><span class="line">trigger();</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">`total: <span class="subst">$&#123;total&#125;</span>`</span>); <span class="comment">// total: 40</span></span><br></pre></td></tr></table></figure>

<p>上面代码通过 3 个步骤，实现对 <code>total</code> 数据进行响应式变化：</p>
<p>① 初始化一个 <code>Set</code> 类型的 <code>dep</code> 变量，用来存放需要执行的副作用（ <code>effect</code> 函数），这边是修改 <code>total</code> 值的方法；</p>
<p>② 创建 <code>track()</code> 函数，用来将需要执行的副作用保存到 <code>dep</code> 变量中（也称收集副作用）；</p>
<p>③ 创建 <code>trigger()</code> 函数，用来执行 <code>dep</code> 变量中的所有副作用；</p>
<p>在每次修改 <code>price</code> 或 <code>quantity</code> 后，调用 <code>trigger()</code> 函数执行所有副作用后， <code>total</code> 值将自动更新为最新值。<br><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/90d37128631145589deecfa28f81b1bf~tplv-k3u1fbpfcp-zoom-1.image" alt="image.png"></p>
<p>（图片来源：Vue Mastery）</p>
<h3 id="3-实现单个对象的响应式"><a href="#3-实现单个对象的响应式" class="headerlink" title="3. 实现单个对象的响应式"></a>3. 实现单个对象的响应式</h3><p>通常，<strong>我们的对象具有多个属性，并且每个属性都需要自己的 <code>dep</code>。我们如何存储这些？比如：</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> product = &#123; <span class="attr">price</span>: <span class="number">10</span>, <span class="attr">quantity</span>: <span class="number">2</span> &#125;;</span><br></pre></td></tr></table></figure>

<p>从前面介绍我们知道，我们将所有副作用保存在一个 <code>Set</code> 集合中，而该集合不会有重复项，这里我们引入一个 <code>Map</code> 类型集合（即 <code>depsMap</code> ），其 <code>key</code> 为对象的属性（如： <code>price</code> 属性）， <code>value</code> 为前面保存副作用的 <code>Set</code> 集合（如： <code>dep</code> 对象），大致结构如下图：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/31ec8d68de9b40ecb703476123b079f6~tplv-k3u1fbpfcp-zoom-1.image" alt="image.png"><br>（图片来源：Vue Mastery）</p>
<p>实现代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> product = &#123; <span class="attr">price</span>: <span class="number">10</span>, <span class="attr">quantity</span>: <span class="number">2</span> &#125;, total = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">const</span> depsMap = <span class="keyword">new</span> <span class="built_in">Map</span>(); <span class="comment">// ① </span></span><br><span class="line"><span class="keyword">const</span> effect = <span class="function">() =&gt;</span> &#123; total = product.price * product.quantity &#125;;</span><br><span class="line"><span class="keyword">const</span> track = <span class="function"><span class="params">key</span> =&gt;</span> &#123;     <span class="comment">// ②</span></span><br><span class="line">	<span class="keyword">let</span> dep = depsMap.get(key);</span><br><span class="line">  <span class="keyword">if</span>(!dep) &#123;</span><br><span class="line">		depsMap.set(key, (dep = <span class="keyword">new</span> <span class="built_in">Set</span>()));</span><br><span class="line">  &#125;</span><br><span class="line">	dep.add(effect);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> trigger = <span class="function"><span class="params">key</span> =&gt;</span> &#123;  <span class="comment">// ③</span></span><br><span class="line">	<span class="keyword">let</span> dep = depsMap.get(key);</span><br><span class="line">  <span class="keyword">if</span>(dep) &#123;</span><br><span class="line">		dep.forEach( <span class="function"><span class="params">effect</span> =&gt;</span> effect() );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">track(<span class="string">&#x27;price&#x27;</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">`total: <span class="subst">$&#123;total&#125;</span>`</span>); <span class="comment">// total: 0</span></span><br><span class="line">effect();</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">`total: <span class="subst">$&#123;total&#125;</span>`</span>); <span class="comment">// total: 20</span></span><br><span class="line">product.price = <span class="number">20</span>;</span><br><span class="line">trigger(<span class="string">&#x27;price&#x27;</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">`total: <span class="subst">$&#123;total&#125;</span>`</span>); <span class="comment">// total: 40</span></span><br></pre></td></tr></table></figure>

<p>上面代码通过 3 个步骤，实现对 <code>total</code> 数据进行响应式变化：</p>
<p>① 初始化一个 <code>Map</code> 类型的 <code>depsMap</code> 变量，用来保存每个需要响应式变化的对象属性（<code>key</code> 为对象的属性， <code>value</code> 为前面 <code>Set</code> 集合）；</p>
<p>② 创建 <code>track()</code> 函数，用来将需要执行的副作用保存到 <code>depsMap</code> 变量中对应的对象属性下（也称收集副作用）；</p>
<p>③ 创建 <code>trigger()</code> 函数，用来执行 <code>dep</code> 变量中指定对象属性的所有副作用；</p>
<p>这样就实现监听对象的响应式变化，在 <code>product</code> 对象中的属性值发生变化， <code>total</code> 值也会跟着更新。</p>
<h3 id="4-实现多个对象的响应式"><a href="#4-实现多个对象的响应式" class="headerlink" title="4. 实现多个对象的响应式"></a>4. 实现多个对象的响应式</h3><p>如果我们有多个响应式数据，比如同时需要观察对象 <code>a</code> 和对象 <code>b</code>  的数据，那么又要如何跟踪每个响应变化的对象？</p>
<p>这里我们引入一个 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/WeakMap">WeakMap 类型</a>的对象，将需要观察的对象作为 <code>key</code> ，值为前面用来保存对象属性的 Map 变量。代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> product = &#123; <span class="attr">price</span>: <span class="number">10</span>, <span class="attr">quantity</span>: <span class="number">2</span> &#125;, total = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">const</span> targetMap = <span class="keyword">new</span> <span class="built_in">WeakMap</span>();     <span class="comment">// ① 初始化 targetMap，保存观察对象</span></span><br><span class="line"><span class="keyword">const</span> effect = <span class="function">() =&gt;</span> &#123; total = product.price * product.quantity &#125;;</span><br><span class="line"><span class="keyword">const</span> track = <span class="function">(<span class="params">target, key</span>) =&gt;</span> &#123;     <span class="comment">// ② 收集依赖</span></span><br><span class="line">  <span class="keyword">let</span> depsMap = targetMap.get(target);</span><br><span class="line">  <span class="keyword">if</span>(!depsMap)&#123;</span><br><span class="line">  	targetMap.set(target, (depsMap = <span class="keyword">new</span> <span class="built_in">Map</span>()));</span><br><span class="line">  &#125;</span><br><span class="line">	<span class="keyword">let</span> dep = depsMap.get(key);</span><br><span class="line">  <span class="keyword">if</span>(!dep) &#123;</span><br><span class="line">		depsMap.set(key, (dep = <span class="keyword">new</span> <span class="built_in">Set</span>()));</span><br><span class="line">  &#125;</span><br><span class="line">	dep.add(effect);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> trigger = <span class="function">(<span class="params">target, key</span>) =&gt;</span> &#123;  <span class="comment">// ③ 执行指定对象的指定属性的所有副作用</span></span><br><span class="line">  <span class="keyword">const</span> depsMap = targetMap.get(target);</span><br><span class="line">  <span class="keyword">if</span>(!depsMap) <span class="keyword">return</span>;</span><br><span class="line">	<span class="keyword">let</span> dep = depsMap.get(key);</span><br><span class="line">  <span class="keyword">if</span>(dep) &#123;</span><br><span class="line">		dep.forEach( <span class="function"><span class="params">effect</span> =&gt;</span> effect() );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">track(product, <span class="string">&#x27;price&#x27;</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">`total: <span class="subst">$&#123;total&#125;</span>`</span>); <span class="comment">// total: 0</span></span><br><span class="line">effect();</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">`total: <span class="subst">$&#123;total&#125;</span>`</span>); <span class="comment">// total: 20</span></span><br><span class="line">product.price = <span class="number">20</span>;</span><br><span class="line">trigger(product, <span class="string">&#x27;price&#x27;</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">`total: <span class="subst">$&#123;total&#125;</span>`</span>); <span class="comment">// total: 40</span></span><br></pre></td></tr></table></figure>

<p>上面代码通过 3 个步骤，实现对 <code>total</code> 数据进行响应式变化：</p>
<p>① 初始化一个 <code>WeakMap</code> 类型的 <code>targetMap</code> 变量，用来要观察每个响应式对象；</p>
<p>② 创建 <code>track()</code> 函数，用来将需要执行的副作用保存到指定对象（ <code>target</code> ）的依赖中（也称收集副作用）；</p>
<p>③ 创建 <code>trigger()</code> 函数，用来执行指定对象（ <code>target</code> ）中指定属性（ <code>key</code> ）的所有副作用；</p>
<p>这样就实现监听对象的响应式变化，在 <code>product</code> 对象中的属性值发生变化， <code>total</code> 值也会跟着更新。</p>
<p>大致流程如下图：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f9cb8a729dac453da8ed344a494e49d6~tplv-k3u1fbpfcp-zoom-1.image" alt="image.png"><br>（图片来源：Vue Mastery）</p>
<h2 id="二、Proxy-和-Reflect"><a href="#二、Proxy-和-Reflect" class="headerlink" title="二、Proxy 和 Reflect"></a>二、Proxy 和 Reflect</h2><p>在上一节内容中，介绍了如何在数据发生变化后，自动更新数据，但存在的问题是，每次需要手动通过触发 <code>track()</code> 函数搜集依赖，通过 <code>trigger()</code> 函数执行所有副作用，达到数据更新目的。</p>
<p>这一节将来解决这个问题，实现这两个函数自动调用。</p>
<h3 id="1-如何实现自动操作"><a href="#1-如何实现自动操作" class="headerlink" title="1. 如何实现自动操作"></a>1. 如何实现自动操作</h3><p>这里我们引入 JS 对象访问器的概念，解决办法如下：</p>
<ul>
<li>在读取（GET 操作）数据时，自动执行 <code>track()</code> 函数自动收集依赖；</li>
<li>在修改（SET 操作）数据时，自动执行 <code>trigger()</code> 函数执行所有副作用；</li>
</ul>
<p>那么如何拦截 GET 和 SET 操作？接下来看看 Vue2 和 Vue3 是如何实现的：</p>
<ul>
<li>在 Vue2 中，使用 ES5 的 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/defineProperty"><code>Object.defineProperty()</code></a> 函数实现；</li>
<li>在 Vue3 中，使用 ES6 的 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy"><code>Proxy</code></a> 和 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Reflect"><code>Reflect</code></a> API 实现；</li>
</ul>
<p>需要注意的是：Vue3 使用的 <code>Proxy</code> 和 <code>Reflect</code> API 并不支持 IE。</p>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/defineProperty"><code>Object.defineProperty()</code></a> 函数这边就不多做介绍，可以阅读文档，下文将主要介绍 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy"><code>Proxy</code></a> 和 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Reflect"><code>Reflect</code></a> API。</p>
<h3 id="2-如何使用-Reflect"><a href="#2-如何使用-Reflect" class="headerlink" title="2. 如何使用 Reflect"></a>2. 如何使用 Reflect</h3><p>通常我们有三种方法读取一个对象的属性：</p>
<ol>
<li>使用 <code>.</code> 操作符：<code>leo.name</code> ；</li>
<li>使用 <code>[]</code> ： <code>leo[&#39;name&#39;]</code> ；</li>
<li>使用 <code>Reflect</code> API： <code>Reflect.get(leo, &#39;name&#39;)</code> 。</li>
</ol>
<p>这三种方式输出结果相同。</p>
<h3 id="3-如何使用-Proxy"><a href="#3-如何使用-Proxy" class="headerlink" title="3. 如何使用 Proxy"></a>3. 如何使用 Proxy</h3><p>Proxy 对象用于创建一个对象的代理，从而实现基本操作的拦截和自定义（如属性查找、赋值、枚举、函数调用等）。语法如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> p = <span class="keyword">new</span> <span class="built_in">Proxy</span>(target, handler)</span><br></pre></td></tr></table></figure>

<p>参数如下：</p>
<ul>
<li>target : 要使用 Proxy 包装的目标对象（可以是任何类型的对象，包括原生数组，函数，甚至另一个代理）。</li>
<li>handler : 一个通常以函数作为属性的对象，各属性中的函数分别定义了在执行各种操作时代理 <code>p</code> 的行为。</li>
</ul>
<p>我们通过官方文档，体验一下 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy">Proxy API</a>：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> product = &#123; <span class="attr">price</span>: <span class="number">10</span>, <span class="attr">quantity</span>: <span class="number">2</span> &#125;;</span><br><span class="line"><span class="keyword">let</span> proxiedProduct = <span class="keyword">new</span> <span class="built_in">Proxy</span>(product, &#123;</span><br><span class="line">	<span class="function"><span class="title">get</span>(<span class="params">target, key</span>)</span>&#123;</span><br><span class="line">  	<span class="built_in">console</span>.log(<span class="string">&#x27;正在读取的数据：&#x27;</span>,key);</span><br><span class="line">    <span class="keyword">return</span> target[key];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="built_in">console</span>.log(proxiedProduct.price); </span><br><span class="line"><span class="comment">// 正在读取的数据： price</span></span><br><span class="line"><span class="comment">// 10</span></span><br></pre></td></tr></table></figure>

<p>这样就保证我们每次在读取 <code>proxiedProduct.price</code> 都会执行到其中代理的 get 处理函数。其过程如下：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0328f8dc4b8d491293556c5d6b66ffa2~tplv-k3u1fbpfcp-zoom-1.image" alt="image.png"><br>（图片来源：Vue Mastery）</p>
<p>然后结合 Reflect 使用，只需修改 get 函数：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">get</span>(<span class="params">target, key, receiver</span>)</span>&#123;</span><br><span class="line"> 	<span class="built_in">console</span>.log(<span class="string">&#x27;正在读取的数据：&#x27;</span>,key);</span><br><span class="line">   <span class="keyword">return</span> <span class="built_in">Reflect</span>.get(target, key, receiver);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>输出结果还是一样。</p>
<p>接下来增加 set 函数，来拦截对象的修改操作：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> product = &#123; <span class="attr">price</span>: <span class="number">10</span>, <span class="attr">quantity</span>: <span class="number">2</span> &#125;;</span><br><span class="line"><span class="keyword">let</span> proxiedProduct = <span class="keyword">new</span> <span class="built_in">Proxy</span>(product, &#123;</span><br><span class="line">	<span class="function"><span class="title">get</span>(<span class="params">target, key, receiver</span>)</span>&#123;</span><br><span class="line">  	<span class="built_in">console</span>.log(<span class="string">&#x27;正在读取的数据：&#x27;</span>,key);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Reflect</span>.get(target, key, receiver);</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="function"><span class="title">set</span>(<span class="params">target, key, value, receiver</span>)</span>&#123;</span><br><span class="line">  	<span class="built_in">console</span>.log(<span class="string">&#x27;正在修改的数据：&#x27;</span>, key, <span class="string">&#x27;,值为：&#x27;</span>, value);</span><br><span class="line">  	<span class="keyword">return</span> <span class="built_in">Reflect</span>.set(target, key, value, receiver);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line">proxiedProduct.price = <span class="number">20</span>;</span><br><span class="line"><span class="built_in">console</span>.log(proxiedProduct.price); </span><br><span class="line"><span class="comment">// 正在修改的数据： price ,值为： 20</span></span><br><span class="line"><span class="comment">// 正在读取的数据： price</span></span><br><span class="line"><span class="comment">// 20</span></span><br></pre></td></tr></table></figure>

<p>这样便完成 get 和 set 函数来拦截对象的读取和修改的操作。为了方便对比 Vue 3 源码，我们将上面代码抽象一层，使它看起来更像 Vue3 源码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reactive</span>(<span class="params">target</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">const</span> handler = &#123;  <span class="comment">// ① 封装统一处理函数对象</span></span><br><span class="line">  	<span class="function"><span class="title">get</span>(<span class="params">target, key, receiver</span>)</span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&#x27;正在读取的数据：&#x27;</span>,key);</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">Reflect</span>.get(target, key, receiver);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">set</span>(<span class="params">target, key, value, receiver</span>)</span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&#x27;正在修改的数据：&#x27;</span>, key, <span class="string">&#x27;,值为：&#x27;</span>, value);</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">Reflect</span>.set(target, key, value, receiver);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Proxy</span>(target, handler); <span class="comment">// ② 统一调用 Proxy API</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> product = reactive(&#123;<span class="attr">price</span>: <span class="number">10</span>, <span class="attr">quantity</span>: <span class="number">2</span>&#125;); <span class="comment">// ③ 将对象转换为响应式对象</span></span><br><span class="line">product.price = <span class="number">20</span>;</span><br><span class="line"><span class="built_in">console</span>.log(product.price); </span><br><span class="line"><span class="comment">// 正在修改的数据： price ,值为： 20</span></span><br><span class="line"><span class="comment">// 正在读取的数据： price</span></span><br><span class="line"><span class="comment">// 20</span></span><br></pre></td></tr></table></figure>

<p>这样输出结果仍然不变。</p>
<h3 id="4-修改-track-和-trigger-函数"><a href="#4-修改-track-和-trigger-函数" class="headerlink" title="4. 修改 track 和 trigger 函数"></a>4. 修改 track 和 trigger 函数</h3><p>通过上面代码，我们已经实现一个简单 <code>reactive()</code> 函数，用来<strong>将普通对象转换为响应式对象</strong>。但是还缺少自动执行 <code>track()</code> 函数和 <code>trigger()</code> 函数，接下来修改上面代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> targetMap = <span class="keyword">new</span> <span class="built_in">WeakMap</span>();</span><br><span class="line"><span class="keyword">let</span> total = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">const</span> effect = <span class="function">() =&gt;</span> &#123; total = product.price * product.quantity &#125;;</span><br><span class="line"><span class="keyword">const</span> track = <span class="function">(<span class="params">target, key</span>) =&gt;</span> &#123; </span><br><span class="line">  <span class="keyword">let</span> depsMap = targetMap.get(target);</span><br><span class="line">  <span class="keyword">if</span>(!depsMap)&#123;</span><br><span class="line">  	targetMap.set(target, (depsMap = <span class="keyword">new</span> <span class="built_in">Map</span>()));</span><br><span class="line">  &#125;</span><br><span class="line">	<span class="keyword">let</span> dep = depsMap.get(key);</span><br><span class="line">  <span class="keyword">if</span>(!dep) &#123;</span><br><span class="line">		depsMap.set(key, (dep = <span class="keyword">new</span> <span class="built_in">Set</span>()));</span><br><span class="line">  &#125;</span><br><span class="line">	dep.add(effect);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> trigger = <span class="function">(<span class="params">target, key</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> depsMap = targetMap.get(target);</span><br><span class="line">  <span class="keyword">if</span>(!depsMap) <span class="keyword">return</span>;</span><br><span class="line">	<span class="keyword">let</span> dep = depsMap.get(key);</span><br><span class="line">  <span class="keyword">if</span>(dep) &#123;</span><br><span class="line">		dep.forEach( <span class="function"><span class="params">effect</span> =&gt;</span> effect() );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> reactive = <span class="function">(<span class="params">target</span>) =&gt;</span> &#123;</span><br><span class="line">	<span class="keyword">const</span> handler = &#123;</span><br><span class="line">  	<span class="function"><span class="title">get</span>(<span class="params">target, key, receiver</span>)</span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&#x27;正在读取的数据：&#x27;</span>,key);</span><br><span class="line">      <span class="keyword">const</span> result = <span class="built_in">Reflect</span>.get(target, key, receiver);</span><br><span class="line">      track(target, key);  <span class="comment">// 自动调用 track 方法收集依赖</span></span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">set</span>(<span class="params">target, key, value, receiver</span>)</span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&#x27;正在修改的数据：&#x27;</span>, key, <span class="string">&#x27;,值为：&#x27;</span>, value);</span><br><span class="line">      <span class="keyword">const</span> oldValue = target[key];</span><br><span class="line">      <span class="keyword">const</span> result = <span class="built_in">Reflect</span>.set(target, key, value, receiver);</span><br><span class="line">      <span class="keyword">if</span>(oldValue != result)&#123;</span><br><span class="line">         trigger(target, key);  <span class="comment">// 自动调用 trigger 方法执行依赖</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Proxy</span>(target, handler);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> product = reactive(&#123;<span class="attr">price</span>: <span class="number">10</span>, <span class="attr">quantity</span>: <span class="number">2</span>&#125;); </span><br><span class="line">effect();</span><br><span class="line"><span class="built_in">console</span>.log(total); </span><br><span class="line">product.price = <span class="number">20</span>;</span><br><span class="line"><span class="built_in">console</span>.log(total); </span><br><span class="line"><span class="comment">// 正在读取的数据： price</span></span><br><span class="line"><span class="comment">// 正在读取的数据： quantity</span></span><br><span class="line"><span class="comment">// 20</span></span><br><span class="line"><span class="comment">// 正在修改的数据： price ,值为： 20</span></span><br><span class="line"><span class="comment">// 正在读取的数据： price</span></span><br><span class="line"><span class="comment">// 正在读取的数据： quantity</span></span><br><span class="line"><span class="comment">// 40</span></span><br></pre></td></tr></table></figure>

<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/561822c28c634f2690d901b5cd00aa5c~tplv-k3u1fbpfcp-zoom-1.image" alt="image.png"><br>（图片来源：Vue Mastery）</p>
<h2 id="三、activeEffect-和-ref"><a href="#三、activeEffect-和-ref" class="headerlink" title="三、activeEffect 和 ref"></a>三、activeEffect 和 ref</h2><p>在上一节代码中，还存在一个问题： <code>track</code> 函数中的依赖（ <code>effect</code> 函数）是外部定义的，当依赖发生变化， <code>track</code> 函数收集依赖时都要手动修改其依赖的方法名。</p>
<p>比如现在的依赖为 <code>foo</code> 函数，就要修改 <code>track</code> 函数的逻辑，可能是这样：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> foo = <span class="function">() =&gt;</span> &#123; <span class="comment">/**/</span> &#125;;</span><br><span class="line"><span class="keyword">const</span> track = <span class="function">(<span class="params">target, key</span>) =&gt;</span> &#123;     <span class="comment">// ②</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">	dep.add(foo);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么如何解决这个问题呢？</p>
<h3 id="1-引入-activeEffect-变量"><a href="#1-引入-activeEffect-变量" class="headerlink" title="1. 引入 activeEffect 变量"></a>1. 引入 activeEffect 变量</h3><p>接下来引入 <code>activeEffect</code> 变量，来保存当前运行的 effect 函数。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> activeEffect = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">const</span> effect = <span class="function"><span class="params">eff</span> =&gt;</span> &#123;</span><br><span class="line">	activeEffect = eff; <span class="comment">// 1. 将 eff 函数赋值给 activeEffect</span></span><br><span class="line">  activeEffect();     <span class="comment">// 2. 执行 activeEffect</span></span><br><span class="line">  activeEffect = <span class="literal">null</span>;<span class="comment">// 3. 重置 activeEffect</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后在 <code>track</code> 函数中将 <code>activeEffect</code> 变量作为依赖：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> track = <span class="function">(<span class="params">target, key</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (activeEffect) &#123;  <span class="comment">// 1. 判断当前是否有 activeEffect</span></span><br><span class="line">        <span class="keyword">let</span> depsMap = targetMap.get(target);</span><br><span class="line">        <span class="keyword">if</span> (!depsMap) &#123;</span><br><span class="line">            targetMap.set(target, (depsMap = <span class="keyword">new</span> <span class="built_in">Map</span>()));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> dep = depsMap.get(key);</span><br><span class="line">        <span class="keyword">if</span> (!dep) &#123;</span><br><span class="line">            depsMap.set(key, (dep = <span class="keyword">new</span> <span class="built_in">Set</span>()));</span><br><span class="line">        &#125;</span><br><span class="line">        dep.add(activeEffect);  <span class="comment">// 2. 添加 activeEffect 依赖</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用方式修改为：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">effect(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    total = product.price * product.quantity</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>这样就可以解决手动修改依赖的问题，这也是 Vue3 解决该问题的方法。完善一下测试代码后，如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> targetMap = <span class="keyword">new</span> <span class="built_in">WeakMap</span>();</span><br><span class="line"><span class="keyword">let</span> activeEffect = <span class="literal">null</span>; <span class="comment">// 引入 activeEffect 变量</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> effect = <span class="function"><span class="params">eff</span> =&gt;</span> &#123;</span><br><span class="line">	activeEffect = eff; <span class="comment">// 1. 将副作用赋值给 activeEffect</span></span><br><span class="line">  activeEffect();     <span class="comment">// 2. 执行 activeEffect</span></span><br><span class="line">  activeEffect = <span class="literal">null</span>;<span class="comment">// 3. 重置 activeEffect</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> track = <span class="function">(<span class="params">target, key</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (activeEffect) &#123;  <span class="comment">// 1. 判断当前是否有 activeEffect</span></span><br><span class="line">        <span class="keyword">let</span> depsMap = targetMap.get(target);</span><br><span class="line">        <span class="keyword">if</span> (!depsMap) &#123;</span><br><span class="line">            targetMap.set(target, (depsMap = <span class="keyword">new</span> <span class="built_in">Map</span>()));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> dep = depsMap.get(key);</span><br><span class="line">        <span class="keyword">if</span> (!dep) &#123;</span><br><span class="line">            depsMap.set(key, (dep = <span class="keyword">new</span> <span class="built_in">Set</span>()));</span><br><span class="line">        &#125;</span><br><span class="line">        dep.add(activeEffect);  <span class="comment">// 2. 添加 activeEffect 依赖</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> trigger = <span class="function">(<span class="params">target, key</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> depsMap = targetMap.get(target);</span><br><span class="line">    <span class="keyword">if</span> (!depsMap) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">let</span> dep = depsMap.get(key);</span><br><span class="line">    <span class="keyword">if</span> (dep) &#123;</span><br><span class="line">        dep.forEach(<span class="function"><span class="params">effect</span> =&gt;</span> effect());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> reactive = <span class="function">(<span class="params">target</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> handler = &#123;</span><br><span class="line">        <span class="function"><span class="title">get</span>(<span class="params">target, key, receiver</span>)</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> result = <span class="built_in">Reflect</span>.get(target, key, receiver);</span><br><span class="line">            track(target, key);</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="function"><span class="title">set</span>(<span class="params">target, key, value, receiver</span>)</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> oldValue = target[key];</span><br><span class="line">            <span class="keyword">const</span> result = <span class="built_in">Reflect</span>.set(target, key, value, receiver);</span><br><span class="line">            <span class="keyword">if</span> (oldValue != result) &#123;</span><br><span class="line">                trigger(target, key);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Proxy</span>(target, handler);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> product = reactive(&#123; <span class="attr">price</span>: <span class="number">10</span>, <span class="attr">quantity</span>: <span class="number">2</span> &#125;);</span><br><span class="line"><span class="keyword">let</span> total = <span class="number">0</span>, salePrice = <span class="number">0</span>;</span><br><span class="line"><span class="comment">// 修改 effect 使用方式，将副作用作为参数传给 effect 方法</span></span><br><span class="line">effect(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    total = product.price * product.quantity</span><br><span class="line">&#125;);</span><br><span class="line">effect(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    salePrice = product.price * <span class="number">0.9</span></span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">console</span>.log(total, salePrice);  <span class="comment">// 20 9</span></span><br><span class="line">product.quantity = <span class="number">5</span>;</span><br><span class="line"><span class="built_in">console</span>.log(total, salePrice);  <span class="comment">// 50 9</span></span><br><span class="line">product.price = <span class="number">20</span>;</span><br><span class="line"><span class="built_in">console</span>.log(total, salePrice);  <span class="comment">// 100 18</span></span><br></pre></td></tr></table></figure>

<p>思考一下，如果把第一个 <code>effect</code> 函数中 <code>product.price</code> 换成 <code>salePrice</code> 会如何：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">effect(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    total = salePrice * product.quantity</span><br><span class="line">&#125;);</span><br><span class="line">effect(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    salePrice = product.price * <span class="number">0.9</span></span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">console</span>.log(total, salePrice);  <span class="comment">// 0 9</span></span><br><span class="line">product.quantity = <span class="number">5</span>;</span><br><span class="line"><span class="built_in">console</span>.log(total, salePrice);  <span class="comment">// 45 9</span></span><br><span class="line">product.price = <span class="number">20</span>;</span><br><span class="line"><span class="built_in">console</span>.log(total, salePrice);  <span class="comment">// 45 18</span></span><br></pre></td></tr></table></figure>

<p>得到的结果完全不同，因为 <code>salePrice</code> 并不是响应式变化，而是需要调用第二个 <code>effect</code> 函数才会变化，也就是 <code>product.price</code> 变量值发生变化。</p>
<blockquote>
<p>代码地址：<br><a target="_blank" rel="noopener" href="https://github.com/Code-Pop/vue-3-reactivity/blob/master/05-activeEffect.js">https://github.com/Code-Pop/vue-3-reactivity/blob/master/05-activeEffect.js</a></p>
</blockquote>
<h3 id="2-引入-ref-方法"><a href="#2-引入-ref-方法" class="headerlink" title="2. 引入 ref 方法"></a>2. 引入 ref 方法</h3><p>熟悉  Vue3 Composition API 的朋友可能会想到 Ref，它接收一个值，并返回一个响应式可变的<a target="_blank" rel="noopener" href="https://v3.cn.vuejs.org/api/refs-api.html"> Ref 对象</a>，其值可以通过 <code>value</code> 属性获取。</p>
<blockquote>
<p>ref：接受一个内部值并返回一个响应式且可变的 ref 对象。ref 对象具有指向内部值的单个 property .value。</p>
</blockquote>
<p>官网的使用示例如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> count = ref(<span class="number">0</span>)</span><br><span class="line"><span class="built_in">console</span>.log(count.value) <span class="comment">// 0</span></span><br><span class="line"></span><br><span class="line">count.value++</span><br><span class="line"><span class="built_in">console</span>.log(count.value) <span class="comment">// 1</span></span><br></pre></td></tr></table></figure>
<p>我们有 2 种方法实现 ref 函数：</p>
<ol>
<li><strong>使用 <code>rective</code> 函数</strong></li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ref = <span class="function"><span class="params">intialValue</span> =&gt;</span> reactive(&#123;<span class="attr">value</span>: intialValue&#125;);</span><br></pre></td></tr></table></figure>

<p>这样是可以的，虽然 Vue3 不是这么实现。</p>
<ol start="2">
<li><strong>使用对象的属性访问器（计算属性）</strong></li>
</ol>
<p>属性方式去包括：<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Functions/get">getter</a> 和 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Functions/set">setter</a>。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ref = <span class="function"><span class="params">raw</span> =&gt;</span> &#123;</span><br><span class="line">	<span class="keyword">const</span> r = &#123;</span><br><span class="line">  	<span class="keyword">get</span> <span class="title">value</span>()&#123;</span><br><span class="line">    	track(r, <span class="string">&#x27;value&#x27;</span>);</span><br><span class="line">      <span class="keyword">return</span> raw;</span><br><span class="line">    &#125;,</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">set</span> <span class="title">value</span>(<span class="params">newVal</span>)&#123;</span><br><span class="line">    	raw = newVal;</span><br><span class="line">      trigger(r, <span class="string">&#x27;value&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">	<span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用方式如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> product = reactive(&#123; <span class="attr">price</span>: <span class="number">10</span>, <span class="attr">quantity</span>: <span class="number">2</span> &#125;);</span><br><span class="line"><span class="keyword">let</span> total = <span class="number">0</span>, salePrice = ref(<span class="number">0</span>);</span><br><span class="line">effect(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    salePrice.value = product.price * <span class="number">0.9</span></span><br><span class="line">&#125;);</span><br><span class="line">effect(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    total = salePrice.value * product.quantity</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">console</span>.log(total, salePrice.value); <span class="comment">// 18 9</span></span><br><span class="line">product.quantity = <span class="number">5</span>;</span><br><span class="line"><span class="built_in">console</span>.log(total, salePrice.value); <span class="comment">// 45 9</span></span><br><span class="line">product.price = <span class="number">20</span>;</span><br><span class="line"><span class="built_in">console</span>.log(total, salePrice.value); <span class="comment">// 90 18</span></span><br></pre></td></tr></table></figure>

<p>在 Vue3 中 ref 实现的核心也是如此。</p>
<blockquote>
<p>代码地址：<br><a target="_blank" rel="noopener" href="https://github.com/Code-Pop/vue-3-reactivity/blob/master/06-ref.js">https://github.com/Code-Pop/vue-3-reactivity/blob/master/06-ref.js</a></p>
</blockquote>
<h2 id="四、实现简易-Computed-方法"><a href="#四、实现简易-Computed-方法" class="headerlink" title="四、实现简易 Computed 方法"></a>四、实现简易 Computed 方法</h2><p>用过 Vue 的同学可能会好奇，上面的 <code>salePrice</code> 和 <code>total</code> 变量为什么不使用 <code>computed</code> 方法呢？</p>
<p>没错，这个可以的，接下来一起实现个简单的 <code>computed</code> 方法。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> computed = <span class="function"><span class="params">getter</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> result = ref();</span><br><span class="line">    effect(<span class="function">() =&gt;</span> result.value = getter());</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> product = reactive(&#123; <span class="attr">price</span>: <span class="number">10</span>, <span class="attr">quantity</span>: <span class="number">2</span> &#125;);</span><br><span class="line"><span class="keyword">let</span> salePrice = computed(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> product.price * <span class="number">0.9</span>;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">let</span> total = computed(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> salePrice.value * product.quantity;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(total.value, salePrice.value);</span><br><span class="line">product.quantity = <span class="number">5</span>;</span><br><span class="line"><span class="built_in">console</span>.log(total.value, salePrice.value);</span><br><span class="line">product.price = <span class="number">20</span>;</span><br><span class="line"><span class="built_in">console</span>.log(total.value, salePrice.value);</span><br></pre></td></tr></table></figure>

<p>这里我们将一个函数作为参数传入 <code>computed</code> 方法，<code>computed</code> 方法内通过 <code>ref</code> 方法构建一个 ref 对象，然后通过 <code>effct</code> 方法，将 <code>getter</code> 方法返回值作为 <code>computed</code> 方法的返回值。</p>
<p>这样我们实现了个简单的 <code>computed</code> 方法，执行效果和前面一样。</p>
<h2 id="五、源码学习建议"><a href="#五、源码学习建议" class="headerlink" title="五、源码学习建议"></a>五、源码学习建议</h2><h3 id="1-构建-reactivity-cjs-js"><a href="#1-构建-reactivity-cjs-js" class="headerlink" title="1. 构建 reactivity.cjs.js"></a>1. 构建 reactivity.cjs.js</h3><p>这一节介绍如何去从<a target="_blank" rel="noopener" href="https://github.com/vuejs/vue-next"> Vue 3 仓库</a>打包一个 Reactivity 包来学习和使用。</p>
<p>准备流程如下：</p>
<ol>
<li>从<a target="_blank" rel="noopener" href="https://github.com/vuejs/vue-next"> Vue 3 仓库</a>下载最新 Vue3 源码；</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/vuejs/vue-next.git</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>安装依赖：</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn install</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>构建 Reactivity 代码：</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn build reactivity</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>复制 reactivity.cjs.js 到你的学习 demo 目录：</li>
</ol>
<p>上一步构建完的内容，会保存在 <code>packages/reactivity/dist</code>目录下，我们只要在自己的学习 demo 中引入该目录的  reactivity.cjs.js  文件即可。</p>
<ol start="5">
<li>学习 demo 中引入：</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; reactive, computed, effect &#125; = <span class="built_in">require</span>(<span class="string">&quot;./reactivity.cjs.js&quot;</span>);</span><br></pre></td></tr></table></figure>

<h3 id="2-Vue3-Reactivity-文件目录"><a href="#2-Vue3-Reactivity-文件目录" class="headerlink" title="2. Vue3 Reactivity 文件目录"></a>2. Vue3 Reactivity 文件目录</h3><p>在源码的 <code>packages/reactivity/src</code>目录下，有以下几个主要文件：</p>
<ol>
<li>effect.ts：用来定义 <code>effect</code> / <code>track</code> / <code>trigger</code> ；</li>
<li>baseHandlers.ts：定义 Proxy 处理器（ get 和 set）；</li>
<li>reactive.ts：定义 <code>reactive</code> 方法并创建 ES6 Proxy；</li>
<li>ref.ts：定义 reactive 的 ref 使用的对象访问器；</li>
<li>computed.ts：定义计算属性的方法；</li>
</ol>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a25ba2643d094083aa1541c9ea0f6a77~tplv-k3u1fbpfcp-zoom-1.image" alt="image.png"><br>（图片来源：Vue Mastery）</p>
<h2 id="六、总结"><a href="#六、总结" class="headerlink" title="六、总结"></a>六、总结</h2><p>本文带大家从头开始学习如何实现简单版 Vue 3 响应式，实现了 Vue3 Reactivity 中的核心方法（ <code>effect</code> / <code>track</code> / <code>trigger</code> / <code>computed</code> /<code>ref</code> 等方法），帮助大家了解其核心，<strong>提高项目开发效率和代码调试能力</strong>。</p>
<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.vuemastery.com/courses/vue-3-reactivity/vue3-reactivity">Vue Mastery</a></li>
</ul>
<h2 id="往期推荐"><a href="#往期推荐" class="headerlink" title="往期推荐"></a>往期推荐</h2><ol>
<li><a target="_blank" rel="noopener" href="https://juejin.cn/post/6897911576053940231">探索 React 合成事件</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.cn/post/6916276304258007053">探索 Vue.js 响应式原理</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.cn/post/6941009454376681479">探索 Snabbdom 模块系统原理</a></li>
</ol>
<p>我是王平安，如果我的文章对你有帮助，请点个 赞👍🏻 支持我一下</p>
<p>我的公众号：前端自习课，每日清晨，享受一篇前端优秀文章。欢迎大家加入我的前端群，一起分享和交流技术，vx: <code>pingan8787</code>。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/07/28/225-%E3%80%90Vue%E3%80%91%E4%BB%8E%E6%89%8B%E5%86%99Vue3%E7%9A%84Reactivity%E5%BC%80%E5%A7%8B%E6%B7%B1%E5%85%A5Vue3%E6%BA%90%E7%A0%81/" data-id="ckts3ejz500np4d9k5x8pflj6" data-title="225-【Vue】从手写Vue3的Reactivity开始深入Vue3源码" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Vuejs/" rel="tag">Vuejs</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%BA%90%E7%A0%81/" rel="tag">源码</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-224-【Chrome】5个Chrome调试混合应用的技巧" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/05/30/224-%E3%80%90Chrome%E3%80%915%E4%B8%AAChrome%E8%B0%83%E8%AF%95%E6%B7%B7%E5%90%88%E5%BA%94%E7%94%A8%E7%9A%84%E6%8A%80%E5%B7%A7/" class="article-date">
  <time class="dt-published" datetime="2021-05-30T08:01:30.000Z" itemprop="datePublished">2021-05-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/05/30/224-%E3%80%90Chrome%E3%80%915%E4%B8%AAChrome%E8%B0%83%E8%AF%95%E6%B7%B7%E5%90%88%E5%BA%94%E7%94%A8%E7%9A%84%E6%8A%80%E5%B7%A7/">224-【Chrome】5个Chrome调试混合应用的技巧</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>对前端开发人员来说，Chrome 真是一个必备的开发工具，大到页面展示，小到 BUG 调试/HTTP 抓包等，本文我将和大家分享自己做混合应用开发过程中经常用到的几个调试技巧。</p>
<h2 id="一、调试安卓应用"><a href="#一、调试安卓应用" class="headerlink" title="一、调试安卓应用"></a>一、调试安卓应用</h2><p>在进行混合应用开发过程中，经常需要在安卓应用中调试 H5 项目的代码，这里我们就需要了解安卓应用如何在 Chrome 上进行调试。<br>接下来简单介绍一下，希望大家还是能实际进行调试看看：</p>
<h3 id="1-准备工作"><a href="#1-准备工作" class="headerlink" title="1. 准备工作"></a>1. 准备工作</h3><p>需要准备有以下几个事项：</p>
<ol>
<li>安卓包必须为可调试包，如果不可以调试，可以找原生的同事提供；</li>
<li>安卓手机通过数据线连接电脑，然后开启“开发者模式”，并启用“USB 调试”选项。</li>
</ol>
<h3 id="2-Chrome-启动调试页面"><a href="#2-Chrome-启动调试页面" class="headerlink" title="2. Chrome 启动调试页面"></a>2. Chrome 启动调试页面</h3><p>在 Chrome 浏览器访问“<code>chrome://inspect/#devices</code>”，然后在 WebView 列表中选择你要调试的页面，点击“ <code>Inspect</code> ”选项，跟调试 PC 网页一样，使用 Chrome 控制台进行调试。<br><img src="http://images.pingan8787.com/Chrome/tips1/1%E8%B0%83%E8%AF%95%E5%AE%89%E5%8D%93%E5%BA%94%E7%94%A8.png" alt="1调试安卓应用.png"></p>
<p>然后就可以正常进行调试了，操作和平常 Chrome 上面调试页面是一样的。<br><img src="http://images.pingan8787.com/Chrome/tips1/1%E8%B0%83%E8%AF%95%E5%AE%89%E5%8D%93%E5%BA%94%E7%94%A82.png" alt="1调试安卓应用2.png"></p>
<h3 id="3-注意"><a href="#3-注意" class="headerlink" title="3. 注意"></a>3. 注意</h3><p>如果访问 “<code>chrome://inspect/#devices</code>” 页面会一直提示 404，可以在翻墙情况下，先在 Chrome 访问 <code>[https://chrome-devtools-frontend.appspot.com](https://chrome-devtools-frontend.appspot.com)</code>，然后重新访问“<code>chrome://inspect/#devices</code>”即可。</p>
<h2 id="二、筛选特定条件的请求"><a href="#二、筛选特定条件的请求" class="headerlink" title="二、筛选特定条件的请求"></a>二、筛选特定条件的请求</h2><p>在 Network 面板中，我们可以在 Filter 输入框中，通过各种筛选条件，来查看满足条件的请求。</p>
<ol>
<li>使用场景：</li>
</ol>
<p>如只需要查看失败或者符合指定 URL 的请求。</p>
<ol start="2">
<li>使用方式：</li>
</ol>
<p>在 Network 面板在 Filter 输入框中，输入各种筛选条件，支持的筛选条件包括：文本、正则表达式、过滤器和资源类型。<br>这里主要介绍“过滤器”，包括：<br><img src="http://images.pingan8787.com/Chrome/tips1/2%E7%AD%9B%E9%80%89%E7%89%B9%E5%AE%9A%E6%9D%A1%E4%BB%B6%E7%9A%84%E8%AF%B7%E6%B1%82.png" alt="2筛选特定条件的请求.png"><br>这里输入“-”目的是为了让大家能看到 Chrome 提供哪些高级选项，在使用的时候是不需要输入“-”。<br>如果输入“-.js -.css”则可以过滤掉“.js”和“.css”类型的文件。</p>
<p>关于过滤器更多用法，可以阅读<a target="_blank" rel="noopener" href="https://www.freecodecamp.org/news/chrome-devtools-network-tab-tricks/">《Chrome DevTools: How to Filter Network Requests》</a></p>
<p><img src="http://images.pingan8787.com/Chrome/tips1/2%E7%AD%9B%E9%80%89%E7%89%B9%E5%AE%9A%E6%9D%A1%E4%BB%B6%E7%9A%84%E8%AF%B7%E6%B1%82.gif" alt="2筛选特定条件的请求.gif"></p>
<h2 id="三、快速断点报错信息"><a href="#三、快速断点报错信息" class="headerlink" title="三、快速断点报错信息"></a>三、快速断点报错信息</h2><p>在 Sources 面板中，我们可以开启异常自动断点的开关，当我们代码抛出异常，会自动在抛出异常的地方断点，能帮助我们快速定位到错误信息，并提供完整的错误信息的方法调用栈。<br><img src="http://images.pingan8787.com/Chrome/tips1/3%E9%80%9F%E6%96%AD%E7%82%B9%E6%8A%A5%E9%94%99%E4%BF%A1%E6%81%AF.png" alt="3速断点报错信息.png"></p>
<ol>
<li>使用场景：</li>
</ol>
<p>需要调试抛出异常的情况。</p>
<ol start="2">
<li>使用方式：</li>
</ol>
<p>在 Sources 面板中，开启异常自动断点的开关。<br><img src="http://images.pingan8787.com/Chrome/tips1/3%E5%BF%AB%E9%80%9F%E6%96%AD%E7%82%B9%E6%8A%A5%E9%94%99%E4%BF%A1%E6%81%AF.gif" alt="3快速断点报错信息.gif"></p>
<h2 id="四、断点时修改代码"><a href="#四、断点时修改代码" class="headerlink" title="四、断点时修改代码"></a>四、断点时修改代码</h2><p>在 Sources 面板中，我们可以在需要断点的行数右击，选择“Add conditional breakpoint”，然后在输入框中输入表达式（如赋值操作等），后面代码将使用该结果。<br><img src="http://images.pingan8787.com/Chrome/tips1/4%E6%96%AD%E7%82%B9%E6%97%B6%E4%BF%AE%E6%94%B9%E4%BB%A3%E7%A0%811.png" alt="4断点时修改代码1.png"><br><img src="http://images.pingan8787.com/Chrome/tips1/4%E6%96%AD%E7%82%B9%E6%97%B6%E4%BF%AE%E6%94%B9%E4%BB%A3%E7%A0%812.png" alt="4断点时修改代码2.png"></p>
<ol>
<li>使用场景：</li>
</ol>
<p>需要在调试时，方便手动修改数据来完成后续调试的时候。</p>
<ol start="2">
<li>使用方式：</li>
</ol>
<p>在 Sources 面板中，在需要断点的行数右击，选择“Add conditional breakpoint”。<br><img src="http://images.pingan8787.com/Chrome/tips1/4%E6%96%AD%E7%82%B9%E6%97%B6%E4%BF%AE%E6%94%B9%E4%BB%A3%E7%A0%81.gif" alt="4断点时修改代码.gif"></p>
<h2 id="五、自定义断点（事件、请求等）"><a href="#五、自定义断点（事件、请求等）" class="headerlink" title="五、自定义断点（事件、请求等）"></a>五、自定义断点（事件、请求等）</h2><p>当我们需要进行自定义断点的时候，比如需要拦截 DOM 事件、网络请求等，就可以在 Source 面板，通过 XHR/fetch Breakpoints 和 Event Listener Breakpoints 来启用对应断点。<br><img src="http://images.pingan8787.com/Chrome/tips1/5%E8%87%AA%E5%AE%9A%E4%B9%89%E6%96%AD%E7%82%B9.png" alt="5自定义断点.png"></p>
<ol>
<li>使用场景：</li>
</ol>
<p>需要在调试时，需要增加自定义断点时（如需要拦截 DOM 事件、网络请求等）。</p>
<ol start="2">
<li>使用方式：</li>
</ol>
<p>在 Sources 面板中，通过 XHR/fetch Breakpoints 和 Event Listener Breakpoints 来启用对应断点。<br><img src="http://images.pingan8787.com/Chrome/tips1/5%E8%87%AA%E5%AE%9A%E4%B9%89%E6%96%AD%E7%82%B9.gif" alt="5自定义断点.gif"></p>
<h2 id="六、学习资料"><a href="#六、学习资料" class="headerlink" title="六、学习资料"></a>六、学习资料</h2><ol>
<li><a target="_blank" rel="noopener" href="https://umaar.com/">Chrome tips community</a></li>
<li><a target="_blank" rel="noopener" href="https://www.css88.com/doc/chrome-devtools/">Chrome 开发者工具中文文档</a></li>
</ol>
<p><img src="https://www.pingan8787.com/images/share.gif" alt="https://www.pingan8787.com/images/share.gifs"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/05/30/224-%E3%80%90Chrome%E3%80%915%E4%B8%AAChrome%E8%B0%83%E8%AF%95%E6%B7%B7%E5%90%88%E5%BA%94%E7%94%A8%E7%9A%84%E6%8A%80%E5%B7%A7/" data-id="ckts3ejud006f4d9kbj0c9myr" data-title="224-【Chrome】5个Chrome调试混合应用的技巧" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Chrome/" rel="tag">Chrome</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/" rel="tag">前端开发</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-223-【前端探索】探索Snabbdom模块系统原理" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/03/19/223-%E3%80%90%E5%89%8D%E7%AB%AF%E6%8E%A2%E7%B4%A2%E3%80%91%E6%8E%A2%E7%B4%A2Snabbdom%E6%A8%A1%E5%9D%97%E7%B3%BB%E7%BB%9F%E5%8E%9F%E7%90%86/" class="article-date">
  <time class="dt-published" datetime="2021-03-19T06:54:46.000Z" itemprop="datePublished">2021-03-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/03/19/223-%E3%80%90%E5%89%8D%E7%AB%AF%E6%8E%A2%E7%B4%A2%E3%80%91%E6%8E%A2%E7%B4%A2Snabbdom%E6%A8%A1%E5%9D%97%E7%B3%BB%E7%BB%9F%E5%8E%9F%E7%90%86/">223-【前端探索】探索Snabbdom模块系统原理</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p><img src="https://images.pingan8787.com/Vue/Snabbdom/cover.png" alt="snabbdom-cover"></p>
<p>近几年随着 React、Vue 等前端框架不断兴起，Virtual DOM 概念也越来越火，被用到越来越多的框架、库中。Virtual DOM 是基于真实 DOM 的一层抽象，用简单的 JS 对象描述真实 DOM。本文要介绍的 <a target="_blank" rel="noopener" href="https://github.com/snabbdom/snabbdom">Snabbdom</a> 就是 Virtual DOM 的一种简单实现，并且 Vue 的 Virtual DOM 也参考了 Snabbdom 实现方式。</p>
<p>对于想要深入学习 Vue Virtual DOM 的朋友，建议先学习 Snabbdom，对理解 Vue 会很有帮助，并且其核心代码 200 多行。</p>
<p><strong>本文挑选 Snabbdom 模块系统作为主要核心点介绍，其他内容可以查阅官方文档</strong><a target="_blank" rel="noopener" href="https://github.com/snabbdom/snabbdom">《Snabbdom》</a>。</p>
<p><img src="https://images.pingan8787.com/Vue/Snabbdom/snabbdom-cover.png" alt="snabbdom-cover"></p>
<h2 id="一、Snabbdom-是什么"><a href="#一、Snabbdom-是什么" class="headerlink" title="一、Snabbdom 是什么"></a>一、Snabbdom 是什么</h2><p>Snabbdom 是一个专注于简单性、模块化、强大特性和性能的虚拟 DOM 库。其中有几个核心特性：</p>
<ol>
<li>核心代码 200 行，并且提供丰富的测试用例；</li>
<li><strong>拥有强大模块系统，并且支持模块拓展和灵活组合；</strong></li>
<li>在每个 VNode 和全局模块上，都有丰富的钩子，可以在 Diff 和 Patch 阶段使用。</li>
</ol>
<p>接下来从一个简单示例来体验一下 Snabbdom。</p>
<h3 id="1-快速上手"><a href="#1-快速上手" class="headerlink" title="1. 快速上手"></a>1. 快速上手</h3><p>安装 Snabbdom： </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install snabbdom -D</span><br></pre></td></tr></table></figure>
<p>接着新建 index.html，设置入口元素：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>然后新建 demo1.js 文件，并使用 Snabbdom 提供的函数：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// demo1.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; h &#125; <span class="keyword">from</span> <span class="string">&#x27;snabbdom/src/package/h&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; init &#125; <span class="keyword">from</span> <span class="string">&#x27;snabbdom/src/package/init&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> patch = init([])</span><br><span class="line"><span class="keyword">let</span> vnode = h(<span class="string">&#x27;div#app&#x27;</span>, <span class="string">&#x27;Hello Leo&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;app&#x27;</span>)</span><br><span class="line">patch(app, vnode)</span><br></pre></td></tr></table></figure>
<p>这样就实现一个简单示例，在浏览器打开 index.html，页面将显示 “Hello Leo” 文本。<br><img src="https://images.pingan8787.com/Vue/Snabbdom/img-1.png" alt="img-1.png"></p>
<p>接下来，我会以 <a target="_blank" rel="noopener" href="https://github.com/zyycode/snabbdom-demo">snabbdom-demo</a> 项目作为学习示例，从简单示例到模块系统使用的示例，深入学习和分析 Snabbdom 源码，重点分析 Snabbdom 模块系统。</p>
<h2 id="二、Snabbdom-demo-分析"><a href="#二、Snabbdom-demo-分析" class="headerlink" title="二、Snabbdom-demo 分析"></a>二、Snabbdom-demo 分析</h2><p><a target="_blank" rel="noopener" href="https://github.com/zyycode/snabbdom-demo">Snabbdom-demo</a> 项目中的三个演示代码，为我们展示如何从简单到深入 Snabbdom。<br>首先克隆仓库并安装：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> https://github.com/zyycode/snabbdom-demo.git</span><br><span class="line">$ npm install</span><br></pre></td></tr></table></figure>
<p>虽然本项目没有 README.md 文件，但项目目录比较直观，我们可以轻松的从 src 目录找到这三个示例代码的文件：</p>
<ul>
<li>01-basicusage.js</li>
<li>02-basicusage.js</li>
<li><strong>03-modules.js  -&gt; 本文核心介绍</strong></li>
</ul>
<p>接着在 index.html 中引入想要学习的代码文件，默认 <code>&lt;script src=&quot;./src/01-basicusage.js&quot;&gt;&lt;/script&gt;</code>  ，通过 package.json 可知启动命令并启动项目：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm run dev</span><br></pre></td></tr></table></figure>


<h3 id="1-简单示例分析"><a href="#1-简单示例分析" class="headerlink" title="1. 简单示例分析"></a>1. 简单示例分析</h3><p><strong>当我们要研究一个库或框架等比较复杂的项目，可以通过官方提供的简单示例代码进行分析</strong>，我们这里选择该项目中最简单的 01-basicusage.js 代码进行分析，其代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/01-basicusage.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; h &#125; <span class="keyword">from</span> <span class="string">&#x27;snabbdom/src/package/h&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; init &#125; <span class="keyword">from</span> <span class="string">&#x27;snabbdom/src/package/init&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> patch = init([])</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> vnode = h(<span class="string">&#x27;div#container.cls&#x27;</span>, <span class="string">&#x27;Hello World&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;app&#x27;</span>) <span class="comment">// 入口元素</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> oldVNode = patch(app, vnode)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 假设时刻</span></span><br><span class="line">vnode = h(<span class="string">&#x27;div&#x27;</span>, <span class="string">&#x27;Hello Snabbdom&#x27;</span>)</span><br><span class="line">patch(oldVNode, vnode)</span><br></pre></td></tr></table></figure>
<p>运行项目以后，可以看到页面展示了“Hello Snabbdom”文本，这里你会觉得奇怪，<strong>前面的 “Hello World” 文本去哪了</strong>？</p>
<p><img src="https://images.pingan8787.com/Vue/Snabbdom/img-2.png" alt="img-2.png"></p>
<p>原因很简单，我们把 demo 中的下面两行代码注释后，页面便显示文本是 “Hello World”：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vnode = h(<span class="string">&#x27;div&#x27;</span>, <span class="string">&#x27;Hello Snabbdom&#x27;</span>)</span><br><span class="line">patch(oldVNode, vnode)</span><br></pre></td></tr></table></figure>
<p>这里我们可以猜测 <code>patch()</code> 函数可以将 VNode 渲染到页面。更进一步可以理解为，这边第一个执行 <code>patch()</code> 函数为<strong>首次渲染</strong>，第二次执行 <code>patch()</code> 函数为<strong>更新操作</strong>。</p>
<p><img src="https://images.pingan8787.com/Vue/Snabbdom/img-3.png" alt="img-3.png"></p>
<h3 id="2-VNode-介绍"><a href="#2-VNode-介绍" class="headerlink" title="2. VNode 介绍"></a>2. VNode 介绍</h3><p>这里可能会有小伙伴疑惑，示例中的 VNode 是什么？这里简单解释下：</p>
<blockquote>
<p>VNode，该对象用于描述节点的信息，它的全称是虚拟节点（virtual node）。与 “虚拟节点” 相关联的另一个概念是 “虚拟 DOM”，它是我们对由 Vue 组件树建立起来的整个 VNode 树的称呼。“虚拟 DOM” 由 VNode 组成的。<br>—— 全栈修仙之路 《Vue 3.0 进阶之 VNode 探秘》</p>
</blockquote>
<p>其实 VNode 就是一个 JS 对象，在 Snabbdom 中是这么定义 VNode 的类型：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> VNode &#123;</span><br><span class="line">  <span class="attr">sel</span>: <span class="built_in">string</span> | <span class="literal">undefined</span>; <span class="comment">// selector的缩写</span></span><br><span class="line">  data: VNodeData | <span class="literal">undefined</span>; <span class="comment">// 下面VNodeData接口的内容</span></span><br><span class="line">  children: <span class="built_in">Array</span>&lt;VNode | <span class="built_in">string</span>&gt; | <span class="literal">undefined</span>; <span class="comment">// 子节点</span></span><br><span class="line">  elm: Node | <span class="literal">undefined</span>; <span class="comment">// element的缩写，存储了真实的HTMLElement</span></span><br><span class="line">  text: <span class="built_in">string</span> | <span class="literal">undefined</span>; <span class="comment">// 如果是文本节点，则存储text</span></span><br><span class="line">  key: Key | <span class="literal">undefined</span>; <span class="comment">// 节点的key，在做列表时很有用</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> VNodeData &#123;</span><br><span class="line">  props?: Props</span><br><span class="line">  attrs?: Attrs</span><br><span class="line">  <span class="class"><span class="keyword">class</span>?: <span class="title">Classes</span></span></span><br><span class="line"><span class="class">  <span class="title">style</span>?: <span class="title">VNodeStyle</span></span></span><br><span class="line"><span class="class">  <span class="title">dataset</span>?: <span class="title">Dataset</span></span></span><br><span class="line"><span class="class">  <span class="title">on</span>?: <span class="title">On</span></span></span><br><span class="line"><span class="class">  <span class="title">hero</span>?: <span class="title">Hero</span></span></span><br><span class="line"><span class="class">  <span class="title">attachData</span>?: <span class="title">AttachData</span></span></span><br><span class="line"><span class="class">  <span class="title">hook</span>?: <span class="title">Hooks</span></span></span><br><span class="line"><span class="class">  <span class="title">key</span>?: <span class="title">Key</span></span></span><br><span class="line"><span class="class">  <span class="title">ns</span>?: <span class="title">string</span> // <span class="title">for</span> <span class="title">SVGs</span></span></span><br><span class="line"><span class="class">  <span class="title">fn</span>?: () </span>=&gt; VNode <span class="comment">// for thunks</span></span><br><span class="line">  args?: <span class="built_in">any</span>[] <span class="comment">// for thunks</span></span><br><span class="line">  [key: <span class="built_in">string</span>]: <span class="built_in">any</span> <span class="comment">// for any other 3rd party module</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 VNode 对象中含描述节点选择器 <code>sel</code> 字段、节点数据 <code>data</code> 字段、节点所包含的子节点 <code>children</code> 字段等。</p>
<p>在这个 demo 中，我们似乎并没有看到模块系统相关的代码，没事，因为这是最简单的示例，下一节会详细介绍。</p>
<blockquote>
<p>我们在学习一个函数时，可以重点了解该函数的“入参”和“出参”，大致就能判断该函数的作用。</p>
</blockquote>
<p>从这个 demo 主要执行过程可以看出，主要用到有三个函数： <code>init()</code> / <code>patch()</code> / <code>h()</code> ，它们到底做什么用的呢？我们分析一下 Snabbdom 源码中这三个函数的入参和出参情况：</p>
<h3 id="3-init-函数分析"><a href="#3-init-函数分析" class="headerlink" title="3. init() 函数分析"></a>3. init() 函数分析</h3><p><code>init()</code> 函数被定义在 <code>package/init.ts</code> 文件中：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// node_modules/snabbdom/src/package/init.ts</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">init</span> (<span class="params">modules: <span class="built_in">Array</span>&lt;Partial&lt;Module&gt;&gt;, domApi?: DOMAPI</span>) </span>&#123;</span><br><span class="line">	<span class="comment">// 省略其他代码</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其参数类型如下：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">init</span>(<span class="params">modules: <span class="built_in">Array</span>&lt;Partial&lt;Module&gt;&gt;, domApi?: DOMAPI</span>): (<span class="params">oldVnode: VNode | Element, vnode: VNode</span>) =&gt; <span class="title">VNode</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">export</span> <span class="title">type</span> <span class="title">Module</span> = <span class="title">Partial</span>&lt;</span>&#123;</span><br><span class="line">  <span class="attr">pre</span>: PreHook</span><br><span class="line">  <span class="attr">create</span>: CreateHook</span><br><span class="line">  <span class="attr">update</span>: UpdateHook</span><br><span class="line">  <span class="attr">destroy</span>: DestroyHook</span><br><span class="line">  <span class="attr">remove</span>: RemoveHook</span><br><span class="line">  <span class="attr">post</span>: PostHook</span><br><span class="line">&#125;&gt;</span><br><span class="line">  </span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> DOMAPI &#123;</span><br><span class="line">  <span class="attr">createElement</span>: <span class="function">(<span class="params">tagName: <span class="built_in">any</span></span>) =&gt;</span> HTMLElement</span><br><span class="line">  <span class="attr">createElementNS</span>: <span class="function">(<span class="params">namespaceURI: <span class="built_in">string</span>, qualifiedName: <span class="built_in">string</span></span>) =&gt;</span> Element</span><br><span class="line">  <span class="attr">createTextNode</span>: <span class="function">(<span class="params">text: <span class="built_in">string</span></span>) =&gt;</span> Text</span><br><span class="line">  <span class="attr">createComment</span>: <span class="function">(<span class="params">text: <span class="built_in">string</span></span>) =&gt;</span> Comment</span><br><span class="line">  <span class="attr">insertBefore</span>: <span class="function">(<span class="params">parentNode: Node, newNode: Node, referenceNode: Node | <span class="literal">null</span></span>) =&gt;</span> <span class="built_in">void</span></span><br><span class="line">  <span class="attr">removeChild</span>: <span class="function">(<span class="params">node: Node, child: Node</span>) =&gt;</span> <span class="built_in">void</span></span><br><span class="line">  <span class="attr">appendChild</span>: <span class="function">(<span class="params">node: Node, child: Node</span>) =&gt;</span> <span class="built_in">void</span></span><br><span class="line">  <span class="attr">parentNode</span>: <span class="function">(<span class="params">node: Node</span>) =&gt;</span> Node | <span class="literal">null</span></span><br><span class="line">  <span class="attr">nextSibling</span>: <span class="function">(<span class="params">node: Node</span>) =&gt;</span> Node | <span class="literal">null</span></span><br><span class="line">  <span class="attr">tagName</span>: <span class="function">(<span class="params">elm: Element</span>) =&gt;</span> <span class="built_in">string</span></span><br><span class="line">  <span class="attr">setTextContent</span>: <span class="function">(<span class="params">node: Node, text: <span class="built_in">string</span> | <span class="literal">null</span></span>) =&gt;</span> <span class="built_in">void</span></span><br><span class="line">  <span class="attr">getTextContent</span>: <span class="function">(<span class="params">node: Node</span>) =&gt;</span> <span class="built_in">string</span> | <span class="literal">null</span></span><br><span class="line">  <span class="attr">isElement</span>: <span class="function">(<span class="params">node: Node</span>) =&gt;</span> node is Element</span><br><span class="line">  <span class="attr">isText</span>: <span class="function">(<span class="params">node: Node</span>) =&gt;</span> node is Text</span><br><span class="line">  <span class="attr">isComment</span>: <span class="function">(<span class="params">node: Node</span>) =&gt;</span> node is Comment</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p><code>init()</code> 函数接收一个模块数组 <code>modules</code> 和可选的 <code>domApi</code> 对象作为参数，返回一个函数，即 <code>patch()</code> 函数。<br><code>domApi</code> 对象的接口包含了很多 DOM 操作的方法。<br>这里的 <code>modules</code> 参数本文将重点介绍。</p>
<h3 id="4-patch-函数分析"><a href="#4-patch-函数分析" class="headerlink" title="4. patch() 函数分析"></a>4. patch() 函数分析</h3><p><code>init()</code> 函数返回了一个 <code>patch()</code> 函数，其类型为：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// node_modules/snabbdom/src/package/init.ts</span></span><br><span class="line"></span><br><span class="line">patch(oldVnode: VNode | Element, <span class="attr">vnode</span>: VNode) =&gt; VNode</span><br></pre></td></tr></table></figure>
<p><code>patch()</code> 函数接收两个 VNode 对象作为参数，并返回一个新 VNode。</p>
<h3 id="5-h-函数分析"><a href="#5-h-函数分析" class="headerlink" title="5. h() 函数分析"></a>5. h() 函数分析</h3><p><code>h()</code> 函数被定义在 <code>package/h.ts</code> 文件中：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// node_modules/snabbdom/src/package/h.ts</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">h</span>(<span class="params">sel: <span class="built_in">string</span></span>): <span class="title">VNode</span></span></span><br><span class="line"><span class="function"><span class="title">export</span> <span class="function"><span class="keyword">function</span> <span class="title">h</span>(<span class="params">sel: <span class="built_in">string</span>, data: VNodeData | <span class="literal">null</span></span>): <span class="title">VNode</span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="title">export</span> <span class="function"><span class="keyword">function</span> <span class="title">h</span>(<span class="params">sel: <span class="built_in">string</span>, children: VNodeChildren</span>): <span class="title">VNode</span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="title">export</span> <span class="function"><span class="keyword">function</span> <span class="title">h</span>(<span class="params">sel: <span class="built_in">string</span>, data: VNodeData | <span class="literal">null</span>, children: VNodeChildren</span>): <span class="title">VNode</span></span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="title">export</span> <span class="function"><span class="keyword">function</span> <span class="title">h</span> (<span class="params">sel: <span class="built_in">any</span>, b?: <span class="built_in">any</span>, c?: <span class="built_in">any</span></span>): <span class="title">VNode</span></span>&#123;</span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function">	// 省略其他代码</span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function">&#125;</span></span></span></span></span><br></pre></td></tr></table></figure>
<p><code>h()</code> 函数接收多种参数，其中必须有一个 <code>sel</code> 参数，<strong>作用是将节点内容挂载到该容器中</strong>，并返回一个新 VNode。</p>
<h3 id="6-小结"><a href="#6-小结" class="headerlink" title="6. 小结"></a>6. 小结</h3><p>通过前面介绍，我们在回过头看看这个 demo 的代码，大致调用流程如下：</p>
<p><img src="https://images.pingan8787.com/Vue/Snabbdom/img-4.png" alt="img-4.png"></p>
<h2 id="三、深入-Snabbdom-模块系统"><a href="#三、深入-Snabbdom-模块系统" class="headerlink" title="三、深入 Snabbdom 模块系统"></a>三、深入 Snabbdom 模块系统</h2><p>学习完前面这些基础知识后，我们已经知道 Snabbdom 使用方式，并且知道其中三个核心方法入参出参情况和大致作用，接下来开始看本文核心 Snabbdom 模块系统。</p>
<h3 id="1-Modules-介绍"><a href="#1-Modules-介绍" class="headerlink" title="1. Modules 介绍"></a>1. Modules 介绍</h3><p>Snabbdom 模块系统是 Snabbdom 提供的一套<strong>可拓展</strong>、<strong>可灵活组合</strong>的模块系统，用来为 Snabbdom 提供操作 VNode 时的各种模块支持，如我们组建需要处理 style 则引入对应的 styleModule，需要处理事件，则引入 eventListenersModule 既可，这样就达到灵活组合，可以支持按需引入的效果。</p>
<p>Snabbdom 模块系统的特点可以概括为：支持按需引入、独立管理、职责单一、方便组合复用、可维护性强。</p>
<p>当然 Snabbdom 模块系统还有其他内置模块：</p>
<table>
<thead>
<tr>
<th align="center">模块名称</th>
<th align="center">模块功能</th>
<th align="center">示例代码</th>
</tr>
</thead>
<tbody><tr>
<td align="center">attributesModule</td>
<td align="center">为 DOM 元素设置属性，在属性添加和更新时使用 <code>setAttribute</code> 方法。</td>
<td align="center"><code>h(&#39;a&#39;, &#123; attrs: &#123; href: &#39;/foo&#39; &#125; &#125;, &#39;Go to Foo&#39;)</code></td>
</tr>
<tr>
<td align="center">classModule</td>
<td align="center">用来动态设置和切换 DOM 元素上的 class 名称。</td>
<td align="center"><code>h(&#39;a&#39;, &#123; class: &#123; active: true, selected: false &#125; &#125;, &#39;Toggle&#39;)</code></td>
</tr>
<tr>
<td align="center">datasetModule</td>
<td align="center">为 DOM 元素设置自定义数据属性（<code>data- *</code>）。然后可以使用 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/HTMLElement/dataset">HTMLElement.dataset</a> 属性访问它们。</td>
<td align="center"><code>h(&#39;button&#39;, &#123; dataset: &#123; action: &#39;reset&#39; &#125; &#125;, &#39;Reset&#39;)</code></td>
</tr>
<tr>
<td align="center">eventListenersModule</td>
<td align="center">为 DOM 元素绑定事件监听器。</td>
<td align="center"><code>h(&#39;div&#39;, &#123; on: &#123; click: clickHandler &#125; &#125;)</code></td>
</tr>
<tr>
<td align="center">propsModule</td>
<td align="center">为 DOM 元素设置属性，如果同时使用 attributesModule，则会被 attributesModule 覆盖。</td>
<td align="center"><code>h(&#39;a&#39;, &#123; props: &#123; href: &#39;/foo&#39; &#125; &#125;, &#39;Go to Foo&#39;)</code></td>
</tr>
<tr>
<td align="center">styleModule</td>
<td align="center">为 DOM 元素设置 CSS 属性。</td>
<td align="center"><code>h(&#39;span&#39;, &#123;style: &#123; color: &#39;#c0ffee&#39;&#125;&#125;, &#39;Say my name&#39;)</code></td>
</tr>
</tbody></table>
<h3 id="2-Hooks-介绍"><a href="#2-Hooks-介绍" class="headerlink" title="2. Hooks 介绍"></a>2. Hooks 介绍</h3><p>Hooks 也称钩子，是 DOM 节点生命周期的一种方法。Snabbdom 提供丰富的钩子选择。模块既使用钩子来扩展 Snabbdom，也在普通代码中使用钩子，用来在 DOM 节点生命周期中执行任意代码。</p>
<p>这里大致介绍一下所有的 Hooks：</p>
<table>
<thead>
<tr>
<th align="center">钩子名称</th>
<th align="center">触发时机</th>
<th align="center">回调参数</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><code>pre</code></td>
<td align="center">patch 阶段开始。</td>
<td align="center">none</td>
</tr>
<tr>
<td align="center"><code>init</code></td>
<td align="center">已添加一个 VNode。</td>
<td align="center"><code>vnode</code></td>
</tr>
<tr>
<td align="center"><code>create</code></td>
<td align="center">基于 VNode 创建了一个 DOM 元素。</td>
<td align="center"><code>emptyVnode, vnode</code></td>
</tr>
<tr>
<td align="center"><code>insert</code></td>
<td align="center">一个元素已添加到 DOM 元素中。</td>
<td align="center"><code>vnode</code></td>
</tr>
<tr>
<td align="center"><code>prepatch</code></td>
<td align="center">一个元素即将进入 patch 阶段。</td>
<td align="center"><code>oldVnode, vnode</code></td>
</tr>
<tr>
<td align="center"><code>update</code></td>
<td align="center">一个元素开始更新。</td>
<td align="center"><code>oldVnode, vnode</code></td>
</tr>
<tr>
<td align="center"><code>postpatch</code></td>
<td align="center">一个元素完成 patch 阶段。</td>
<td align="center"><code>oldVnode, vnode</code></td>
</tr>
<tr>
<td align="center"><code>destroy</code></td>
<td align="center">一个元素直接或间接被删除。</td>
<td align="center"><code>vnode</code></td>
</tr>
<tr>
<td align="center"><code>remove</code></td>
<td align="center">一个元素直接从 DOM 元素中删除。</td>
<td align="center"><code>vnode, removeCallback</code></td>
</tr>
<tr>
<td align="center"><code>post</code></td>
<td align="center">patch 阶段结束。</td>
<td align="center">none</td>
</tr>
</tbody></table>
<p>模块中可以使用这些钩子：<code>pre</code>, <code>create</code>, <code>update</code>, <code>destroy</code>, <code>remove</code>, <code>post</code>。<br>单个元素可以使用这些钩子：<code>init</code>, <code>create</code>, <code>insert</code>, <code>prepatch</code>, <code>update</code>, <code>postpatch</code>, <code>destroy</code>, <code>remove</code>。</p>
<p>Snabbdom 是这么定义钩子的：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// snabbdom/src/package/hooks.ts</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> PreHook = <span class="function">() =&gt;</span> <span class="built_in">any</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> InitHook = <span class="function">(<span class="params">vNode: VNode</span>) =&gt;</span> <span class="built_in">any</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> CreateHook = <span class="function">(<span class="params">emptyVNode: VNode, vNode: VNode</span>) =&gt;</span> <span class="built_in">any</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> InsertHook = <span class="function">(<span class="params">vNode: VNode</span>) =&gt;</span> <span class="built_in">any</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> PrePatchHook = <span class="function">(<span class="params">oldVNode: VNode, vNode: VNode</span>) =&gt;</span> <span class="built_in">any</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> UpdateHook = <span class="function">(<span class="params">oldVNode: VNode, vNode: VNode</span>) =&gt;</span> <span class="built_in">any</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> PostPatchHook = <span class="function">(<span class="params">oldVNode: VNode, vNode: VNode</span>) =&gt;</span> <span class="built_in">any</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> DestroyHook = <span class="function">(<span class="params">vNode: VNode</span>) =&gt;</span> <span class="built_in">any</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> RemoveHook = <span class="function">(<span class="params">vNode: VNode, removeCallback: () =&gt; <span class="built_in">void</span></span>) =&gt;</span> <span class="built_in">any</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> PostHook = <span class="function">() =&gt;</span> <span class="built_in">any</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> Hooks &#123;</span><br><span class="line">  pre?: PreHook</span><br><span class="line">  init?: InitHook</span><br><span class="line">  create?: CreateHook</span><br><span class="line">  insert?: InsertHook</span><br><span class="line">  prepatch?: PrePatchHook</span><br><span class="line">  update?: UpdateHook</span><br><span class="line">  postpatch?: PostPatchHook</span><br><span class="line">  destroy?: DestroyHook</span><br><span class="line">  remove?: RemoveHook</span><br><span class="line">  post?: PostHook</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>接下来我们通过 03-modules.js 文件的示例代码，我们需要<strong>样式处理</strong>和<strong>事件操作，</strong>因此引入这两个模块，并进行<strong>灵活组合</strong>：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/03-modules.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; h &#125; <span class="keyword">from</span> <span class="string">&#x27;snabbdom/src/package/h&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; init &#125; <span class="keyword">from</span> <span class="string">&#x27;snabbdom/src/package/init&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. 导入模块</span></span><br><span class="line"><span class="keyword">import</span> &#123; styleModule &#125; <span class="keyword">from</span> <span class="string">&#x27;snabbdom/src/package/modules/style&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; eventListenersModule &#125; <span class="keyword">from</span> <span class="string">&#x27;snabbdom/src/package/modules/eventlisteners&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 注册模块</span></span><br><span class="line"><span class="keyword">const</span> patch = init([ styleModule, eventListenersModule ])</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 使用 h() 函数的第二个参数传入模块需要的数据（对象）</span></span><br><span class="line"><span class="keyword">let</span> vnode = h(<span class="string">&#x27;div&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">style</span>: &#123; <span class="attr">backgroundColor</span>: <span class="string">&#x27;#4fc08d&#x27;</span>, <span class="attr">color</span>: <span class="string">&#x27;#35495d&#x27;</span> &#125;,</span><br><span class="line">  <span class="attr">on</span>: &#123; <span class="attr">click</span>: eventHandler &#125;</span><br><span class="line">&#125;, [</span><br><span class="line">  h(<span class="string">&#x27;h1&#x27;</span>, <span class="string">&#x27;Hello Snabbdom&#x27;</span>),</span><br><span class="line">  h(<span class="string">&#x27;p&#x27;</span>, <span class="string">&#x27;This is p tag&#x27;</span>)</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">eventHandler</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;clicked.&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;app&#x27;</span>)</span><br><span class="line">patch(app, vnode)</span><br></pre></td></tr></table></figure>
<p>上面代码中，引入了 styleModule 和 eventListenersModule 两个模块，并且作为参数组合，传入 <code>init()</code> 函数中。<br>此时我们可以看到页面上显示的内容已经有包含样式，并且点击事件也能正常输出日志 <code>&#39;clicked.&#39;</code> ：</p>
<p><img src="https://images.pingan8787.com/Vue/Snabbdom/img-5.png" alt="img-5.png"></p>
<p>这里我们看下 styleModule 模块源码，把代码精简一下：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// snabbdom/src/package/modules/style.ts</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateStyle</span> (<span class="params">oldVnode: VNode, vnode: VNode</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">	<span class="comment">// 省略其他代码</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">forceReflow</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 省略其他代码</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">applyDestroyStyle</span> (<span class="params">vnode: VNode</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 省略其他代码</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">applyRemoveStyle</span> (<span class="params">vnode: VNode, rm: () =&gt; <span class="built_in">void</span></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 省略其他代码</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> styleModule: Module = &#123;</span><br><span class="line">  <span class="attr">pre</span>: forceReflow,</span><br><span class="line">  <span class="attr">create</span>: updateStyle,</span><br><span class="line">  <span class="attr">update</span>: updateStyle,</span><br><span class="line">  <span class="attr">destroy</span>: applyDestroyStyle,</span><br><span class="line">  <span class="attr">remove</span>: applyRemoveStyle</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在看看  eventListenersModule 模块源码：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// snabbdom/src/package/modules/eventlisteners.ts</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateEventListeners</span> (<span class="params">oldVnode: VNode, vnode?: VNode</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">	<span class="comment">// 省略其他代码</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> eventListenersModule: Module = &#123;</span><br><span class="line">  <span class="attr">create</span>: updateEventListeners,</span><br><span class="line">  <span class="attr">update</span>: updateEventListeners,</span><br><span class="line">  <span class="attr">destroy</span>: updateEventListeners</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>明显可以看出，两个模块返回的都是个对象，并且每个属性为一种钩子，如 <code>pre/create</code> 等，值为对应的处理函数，每个处理函数有统一的入参。</p>
<p>继续看下 styleModule 中，样式是如何绑定上去的。这里分析它的 <code>updateStyle</code> 方法，因为元素创建（create 钩子）和元素更新（update 钩子）阶段都是通过这个方法处理：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// snabbdom/src/package/modules/style.ts</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateStyle</span> (<span class="params">oldVnode: VNode, vnode: VNode</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> cur: <span class="built_in">any</span></span><br><span class="line">  <span class="keyword">var</span> name: <span class="built_in">string</span></span><br><span class="line">  <span class="keyword">var</span> elm = vnode.elm</span><br><span class="line">  <span class="keyword">var</span> oldStyle = (oldVnode.data <span class="keyword">as</span> VNodeData).style</span><br><span class="line">  <span class="keyword">var</span> style = (vnode.data <span class="keyword">as</span> VNodeData).style</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!oldStyle &amp;&amp; !style) <span class="keyword">return</span></span><br><span class="line">  <span class="keyword">if</span> (oldStyle === style) <span class="keyword">return</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 1. 设置新旧 style 默认值</span></span><br><span class="line">  oldStyle = oldStyle || &#123;&#125;</span><br><span class="line">  style = style || &#123;&#125;</span><br><span class="line">  <span class="keyword">var</span> oldHasDel = <span class="string">&#x27;delayed&#x27;</span> <span class="keyword">in</span> oldStyle</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2. 比较新旧 style</span></span><br><span class="line">  <span class="keyword">for</span> (name <span class="keyword">in</span> oldStyle) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!style[name]) &#123;</span><br><span class="line">      <span class="keyword">if</span> (name[<span class="number">0</span>] === <span class="string">&#x27;-&#x27;</span> &amp;&amp; name[<span class="number">1</span>] === <span class="string">&#x27;-&#x27;</span>) &#123;</span><br><span class="line">        (elm <span class="keyword">as</span> <span class="built_in">any</span>).style.removeProperty(name)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        (elm <span class="keyword">as</span> <span class="built_in">any</span>).style[name] = <span class="string">&#x27;&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> (name <span class="keyword">in</span> style) &#123;</span><br><span class="line">    cur = style[name]</span><br><span class="line">    <span class="keyword">if</span> (name === <span class="string">&#x27;delayed&#x27;</span> &amp;&amp; style.delayed) &#123;</span><br><span class="line">      <span class="comment">// 省略部分代码</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (name !== <span class="string">&#x27;remove&#x27;</span> &amp;&amp; cur !== oldStyle[name]) &#123;</span><br><span class="line">      <span class="keyword">if</span> (name[<span class="number">0</span>] === <span class="string">&#x27;-&#x27;</span> &amp;&amp; name[<span class="number">1</span>] === <span class="string">&#x27;-&#x27;</span>) &#123;</span><br><span class="line">        (elm <span class="keyword">as</span> <span class="built_in">any</span>).style.setProperty(name, cur)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 3. 设置新 style 到元素</span></span><br><span class="line">        (elm <span class="keyword">as</span> <span class="built_in">any</span>).style[name] = cur</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="3-init-分析"><a href="#3-init-分析" class="headerlink" title="3. init() 分析"></a>3. init() 分析</h3><p>接着我们看下 <code>init()</code> 函数内部如何处理这些 Module。</p>
<p>首先在 init.ts 文件中，可以看到声明了默认支持的 Hooks 钩子列表：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// snabbdom/src/package/init.ts</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> hooks: <span class="built_in">Array</span>&lt;keyof Module&gt; = [<span class="string">&#x27;create&#x27;</span>, <span class="string">&#x27;update&#x27;</span>, <span class="string">&#x27;remove&#x27;</span>, <span class="string">&#x27;destroy&#x27;</span>, <span class="string">&#x27;pre&#x27;</span>, <span class="string">&#x27;post&#x27;</span>]</span><br></pre></td></tr></table></figure>


<p>接着看 <code>hooks</code> 是如何使用的：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// snabbdom/src/package/init.ts</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">init</span> (<span class="params">modules: <span class="built_in">Array</span>&lt;Partial&lt;Module&gt;&gt;, domApi?: DOMAPI</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> i: <span class="built_in">number</span></span><br><span class="line">  <span class="keyword">let</span> j: <span class="built_in">number</span></span><br><span class="line">  <span class="keyword">const</span> cbs: ModuleHooks = &#123;  <span class="comment">// 创建 cbs 对象，用于收集 module 中的 hook</span></span><br><span class="line">    <span class="attr">create</span>: [],</span><br><span class="line">    <span class="attr">update</span>: [],</span><br><span class="line">    <span class="attr">remove</span>: [],</span><br><span class="line">    <span class="attr">destroy</span>: [],</span><br><span class="line">    <span class="attr">pre</span>: [],</span><br><span class="line">    <span class="attr">post</span>: []</span><br><span class="line">  &#125;</span><br><span class="line">	<span class="comment">// 收集 module 中的 hook，并保存在 cbs 中</span></span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; hooks.length; ++i) &#123;</span><br><span class="line">    cbs[hooks[i]] = []</span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; modules.length; ++j) &#123;</span><br><span class="line">      <span class="keyword">const</span> hook = modules[j][hooks[i]]</span><br><span class="line">      <span class="keyword">if</span> (hook !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">        (cbs[hooks[i]] <span class="keyword">as</span> <span class="built_in">any</span>[]).push(hook)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">	<span class="comment">// 省略其他代码，稍后介绍</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面代码中，创建 <code>hooks</code> 变量用来声明默认支持的 Hooks 钩子，在 <code>init()</code> 函数中，创建 <code>cbs</code> 对象，通过两层循环，保存每个 module 中的 hook 函数到 <code>cbs</code> 对象的指定钩子中。</p>
<p>通过断点可以看到这是 demo 中，<code>cbs</code> 对象是下面这个样子：</p>
<p><img src="https://images.pingan8787.com/Vue/Snabbdom/img-6.png" alt="img-6.png"></p>
<p>这里 <code>cbs</code> 对象收集了每个 module 中的 Hooks 处理函数，保存到对应 Hooks 数组中。比如这里的 <code>create</code> 钩子中保存了 <code>updateStyle</code> 函数和 <code>updateEventListeners</code> 函数。</p>
<p><img src="https://images.pingan8787.com/Vue/Snabbdom/img-7.png" alt="img-7.png"></p>
<p>到这里， <code>init()</code> 函数已经保存好所有 module 的 Hooks 处理函数，接下来就要看看 <code>init()</code> 函数返回的 <code>patch()</code> 函数，这里面将用到前面保存好的 <code>cbs</code> 对象。</p>
<h3 id="4-patch-分析"><a href="#4-patch-分析" class="headerlink" title="4. patch() 分析"></a>4. patch() 分析</h3><p><code>init()</code> 函数中最终返回一个 <code>patch()</code> 函数，这边形成一个闭包，闭包里面可以使用到 <code>init()</code> 函数作用域定义的变量和方法，因此在 <code>patch()</code> 函数中能使用 <code>cbs</code> 对象。</p>
<p><code>patch()</code> 函数会在不同时机点（可以参照前面的 Hooks 介绍），遍历 <code>cbs</code> 对象中不同 Hooks 处理函数列表。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// snabbdom/src/package/init.ts</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">init</span> (<span class="params">modules: <span class="built_in">Array</span>&lt;Partial&lt;Module&gt;&gt;, domApi?: DOMAPI</span>) </span>&#123;</span><br><span class="line">	<span class="comment">// 省略其他代码</span></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">patch</span> (<span class="params">oldVnode: VNode | Element, vnode: VNode</span>): <span class="title">VNode</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> i: <span class="built_in">number</span>, <span class="attr">elm</span>: Node, <span class="attr">parent</span>: Node</span><br><span class="line">    <span class="keyword">const</span> insertedVnodeQueue: VNodeQueue = []</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; cbs.pre.length; ++i) cbs.pre[i]()  <span class="comment">// [Hooks]遍历 pre Hooks 处理函数列表</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!isVnode(oldVnode)) &#123;</span><br><span class="line">      oldVnode = emptyNodeAt(oldVnode) <span class="comment">// 当 oldVnode 参数不是 VNode 则创建一个空的 VNode</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sameVnode(oldVnode, vnode)) &#123;  <span class="comment">// 当两个 VNode 为同一个 VNode，则进行比较和更新</span></span><br><span class="line">      patchVnode(oldVnode, vnode, insertedVnodeQueue)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      createElm(vnode, insertedVnodeQueue) <span class="comment">// 当两个 VNode 不同，则创建新元素</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (parent !== <span class="literal">null</span>) &#123;  <span class="comment">// 当该 oldVnode 有父节点，则插入该节点，然后移除原来节点</span></span><br><span class="line">        api.insertBefore(parent, vnode.elm!, api.nextSibling(elm))</span><br><span class="line">        removeVnodes(parent, [oldVnode], <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; cbs.post.length; ++i) cbs.post[i]()  <span class="comment">// [Hooks]遍历 post Hooks 处理函数列表</span></span><br><span class="line">    <span class="keyword">return</span> vnode</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>patchVnode()</code> 函数定义如下：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">patchVnode</span> (<span class="params">oldVnode: VNode, vnode: VNode, insertedVnodeQueue: VNodeQueue</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 省略其他代码</span></span><br><span class="line">  <span class="keyword">if</span> (vnode.data !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; cbs.update.length; ++i) cbs.update[i](oldVnode, vnode)  <span class="comment">// [Hooks]遍历 update Hooks 处理函数列表</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>createVnode()</code> 函数定义如下：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createElm</span> (<span class="params">vnode: VNode, insertedVnodeQueue: VNodeQueue</span>): <span class="title">Node</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 省略其他代码</span></span><br><span class="line">  <span class="keyword">const</span> sel = vnode.sel</span><br><span class="line">  <span class="keyword">if</span> (sel === <span class="string">&#x27;!&#x27;</span>) &#123;</span><br><span class="line">    <span class="comment">// 省略其他代码</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sel !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; cbs.create.length; ++i) cbs.create[i](emptyNode, vnode)  <span class="comment">// [Hooks]遍历 create Hooks 处理函数列表</span></span><br><span class="line">    <span class="keyword">const</span> hook = vnode.data!.hook</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> vnode.elm</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>removeNodes()</code> 函数定义如下：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">removeVnodes</span> (<span class="params">parentElm: Node,vnodes: VNode[],startIdx: <span class="built_in">number</span>,endIdx: <span class="built_in">number</span></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 省略其他代码</span></span><br><span class="line">  <span class="keyword">for</span> (; startIdx &lt;= endIdx; ++startIdx) &#123;</span><br><span class="line">    <span class="keyword">const</span> ch = vnodes[startIdx]</span><br><span class="line">    <span class="keyword">if</span> (ch != <span class="literal">null</span>) &#123;</span><br><span class="line">      rm = createRmCb(ch.elm!, listeners)</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; cbs.remove.length; ++i) cbs.remove[i](ch, rm) <span class="comment">// [Hooks]遍历 remove Hooks 处理函数列表</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这部分代码跳转较多，总结一下这个过程，如下图：</p>
<p><img src="https://images.pingan8787.com/Vue/Snabbdom/img-8.png" alt="img-8.png"></p>
<h2 id="四、自定义-Snabbdom-模块"><a href="#四、自定义-Snabbdom-模块" class="headerlink" title="四、自定义 Snabbdom 模块"></a>四、自定义 Snabbdom 模块</h2><p>前面我们介绍了 Snabbdom 模块系统是如何收集 Hooks 并保存下来，然后在不同时机点执行不同的 Hooks。</p>
<p>在 Snabbdom 中，所有模块独立在 <code>src/package/modules</code> 下，使用的时候可以灵活组合，也方便做解耦和跨平台，并且所有 Module 返回的对象中每个 Hooks 类型如下：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// snabbdom/src/package/init.ts</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> Module = Partial&lt;&#123;</span><br><span class="line">  <span class="attr">pre</span>: PreHook</span><br><span class="line">  <span class="attr">create</span>: CreateHook</span><br><span class="line">  <span class="attr">update</span>: UpdateHook</span><br><span class="line">  <span class="attr">destroy</span>: DestroyHook</span><br><span class="line">  <span class="attr">remove</span>: RemoveHook</span><br><span class="line">  <span class="attr">post</span>: PostHook</span><br><span class="line">&#125;&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">// snabbdom/src/package/hooks.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> PreHook = <span class="function">() =&gt;</span> <span class="built_in">any</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> CreateHook = <span class="function">(<span class="params">emptyVNode: VNode, vNode: VNode</span>) =&gt;</span> <span class="built_in">any</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> UpdateHook = <span class="function">(<span class="params">oldVNode: VNode, vNode: VNode</span>) =&gt;</span> <span class="built_in">any</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> DestroyHook = <span class="function">(<span class="params">vNode: VNode</span>) =&gt;</span> <span class="built_in">any</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> RemoveHook = <span class="function">(<span class="params">vNode: VNode, removeCallback: () =&gt; <span class="built_in">void</span></span>) =&gt;</span> <span class="built_in">any</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> PostHook = <span class="function">() =&gt;</span> <span class="built_in">any</span></span><br></pre></td></tr></table></figure>
<p>因此，<strong>如果开发者需要自定义模块，只需实现不同 Hooks 并导出即可。</strong></p>
<p>接下来我们实现一个简单的模块 <strong>replaceTagModule</strong>，用来<strong>将节点文本自动过滤掉 HTML 标签</strong>。</p>
<h3 id="1-初始化代码"><a href="#1-初始化代码" class="headerlink" title="1. 初始化代码"></a>1. 初始化代码</h3><p>考虑到方便调试，我们直接在 <code>node_modules/snabbdom/src/package/modules/</code> 目录中新建 replaceTag.ts 文件，然后写个最简单的 demo 框架：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; VNode, VNodeData &#125; <span class="keyword">from</span> <span class="string">&#x27;../vnode&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; Module &#125; <span class="keyword">from</span> <span class="string">&#x27;./module&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> replaceTagPre = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;run replaceTagPre!&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> updateReplaceTag = (oldVnode: VNode, <span class="attr">vnode</span>: VNode): <span class="function"><span class="params">void</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;run updateReplaceTag!&quot;</span>, oldVnode, vnode)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> removeReplaceTag = (vnode: VNode): <span class="function"><span class="params">void</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;run removeReplaceTag!&quot;</span>, vnode)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> replaceTagModule: Module = &#123;</span><br><span class="line">    <span class="attr">pre</span>: replaceTagPre,</span><br><span class="line">    <span class="attr">create</span>: updateReplaceTag,</span><br><span class="line">    <span class="attr">update</span>: updateReplaceTag,</span><br><span class="line">    <span class="attr">remove</span>: removeReplaceTag</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来引入到 03-modules.js 代码中，并简化下代码：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; h &#125; <span class="keyword">from</span> <span class="string">&#x27;snabbdom/src/package/h&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; init &#125; <span class="keyword">from</span> <span class="string">&#x27;snabbdom/src/package/init&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. 导入模块</span></span><br><span class="line"><span class="keyword">import</span> &#123; styleModule &#125; <span class="keyword">from</span> <span class="string">&#x27;snabbdom/src/package/modules/style&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; eventListenersModule &#125; <span class="keyword">from</span> <span class="string">&#x27;snabbdom/src/package/modules/eventlisteners&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; replaceTagModule &#125; <span class="keyword">from</span> <span class="string">&#x27;snabbdom/src/package/modules/replaceTag&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 注册模块</span></span><br><span class="line"><span class="keyword">const</span> patch = init([</span><br><span class="line">  styleModule,</span><br><span class="line">  eventListenersModule,</span><br><span class="line">  replaceTagModule</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 使用 h() 函数的第二个参数传入模块需要的数据（对象）</span></span><br><span class="line"><span class="keyword">let</span> vnode = h(<span class="string">&#x27;div&#x27;</span>, <span class="string">&#x27;&lt;h1&gt;Hello Leo&lt;/h1&gt;&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;app&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> oldVNode = patch(app, vnode)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> newVNode = h(<span class="string">&#x27;div&#x27;</span>, <span class="string">&#x27;&lt;div&gt;Hello Leo&lt;/div&gt;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">patch(oldVNode, newVNode)</span><br></pre></td></tr></table></figure>
<p>刷新浏览器，就可以看到 replaceTagModule 的每个钩子都被正常执行：</p>
<p><img src="https://images.pingan8787.com/Vue/Snabbdom/img-9.png" alt="img-9.png"></p>
<h3 id="2-实现-updateReplaceTag-函数"><a href="#2-实现-updateReplaceTag-函数" class="headerlink" title="2. 实现 updateReplaceTag() 函数"></a>2. 实现 updateReplaceTag() 函数</h3><p>我们删除掉多余代码，接下来实现 <code>updateReplaceTag()</code> 函数，当 vnode 创建和更新时，都会调用该方法。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; VNode, VNodeData &#125; <span class="keyword">from</span> <span class="string">&#x27;../vnode&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; Module &#125; <span class="keyword">from</span> <span class="string">&#x27;./module&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> regFunction = <span class="function"><span class="params">str</span> =&gt;</span> str &amp;&amp; str.replace(<span class="regexp">/\&lt;|\&gt;|\//g</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> updateReplaceTag = (oldVnode: VNode, <span class="attr">vnode</span>: VNode): <span class="function"><span class="params">void</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> oldVnodeReplace = regFunction(oldVnode.text);</span><br><span class="line">    <span class="keyword">const</span> vnodeReplace = regFunction(vnode.text);</span><br><span class="line">    <span class="keyword">if</span>(oldVnodeReplace === vnodeReplace) <span class="keyword">return</span>;</span><br><span class="line">    vnode.text = vnodeReplace;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> replaceTagModule: Module = &#123;</span><br><span class="line">    <span class="attr">create</span>: updateReplaceTag,</span><br><span class="line">    <span class="attr">update</span>: updateReplaceTag,</span><br><span class="line">&#125;</span><br><span class="line">  </span><br></pre></td></tr></table></figure>
<p>在 <code>updateReplaceTag()</code> 函数中，比较新旧 vnode 的文本内容是否一致，如果一致则直接返回，否则将新的 vnode 的替换后的文本设置到 vnode 的 text 属性，完成更新。</p>
<p>其中有个细节：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vnode.text = vnodeReplace;</span><br></pre></td></tr></table></figure>
<p>这里直接对 <code>vnode.text</code> 进行赋值，页面上的内容也随之发生变化。这是因为 <code>vnode</code> 是个响应式对象，通过调用其 <code>setter</code> 方法，会触发响应式更新，这样就实现页面内容更新。</p>
<p>于是我们看到页面内容中的 HTML 标签被清空了。</p>
<p><img src="https://images.pingan8787.com/Vue/Snabbdom/img-10.png" alt="img-10.png"></p>
<h3 id="3-小结"><a href="#3-小结" class="headerlink" title="3. 小结"></a>3. 小结</h3><p>这个小节中，我们实现一个简单的 <code>replaceTagModule</code> 模块，体验了一下 Snabbdom 模块灵活组合的特点，当我们需要自定义某些模块时，便可以按照 Snabbdom 的模块开发方式，开发自定义模块，然后通过 Snabbdom 的 <code>init()</code> 函数注入模块即可。</p>
<p>我们再回顾一下 Snabbdom 模块系统特点：支持按需引入、独立管理、职责单一、方便组合复用、可维护性强。</p>
<h2 id="五、通用模块生命周期模型"><a href="#五、通用模块生命周期模型" class="headerlink" title="五、通用模块生命周期模型"></a>五、通用模块生命周期模型</h2><p>下面我将前面 Snabbdom 的模块系统，抽象为一个通用模块生命周期模型，其中包含三个核心层：</p>
<ol>
<li>模块定义层</li>
</ol>
<p>在本层可以按照模块开发规范，自定义各种模块。</p>
<ol start="2">
<li>模块应用层</li>
</ol>
<p>一般是在业务开发层或组件层中，用来导入模块。</p>
<ol start="3">
<li>模块初始化层</li>
</ol>
<p>一般是在开发的模块系统的插件中，提供初始化函数（init 函数），执行初始化函数会遍历每个 Hooks，并执行对应处理函数列表的每个函数。</p>
<p>抽象后的模型如下：</p>
<p><img src="https://images.pingan8787.com/Vue/Snabbdom/img-11.png" alt="image.png"></p>
<p>在使用 Module 的时候就可以灵活组合搭配使用啦，在模块初始化层，就会做好调用。</p>
<h2 id="六、总结"><a href="#六、总结" class="headerlink" title="六、总结"></a>六、总结</h2><p>本文主要以 Snabbdom-demo 仓库为学习示例，学习了 Snabbdom 运行流程和 Snabbdom 模块系统的运行流程，还通过手写一个简单的 Snabbdom 模块，带大家领略一下 Snabbdom 模块的魅力，最后为大家总结了一个通用模块插件模型。</p>
<p>大家好好掌握 Snabbdom 对理解 Vue 会很有帮助。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/03/19/223-%E3%80%90%E5%89%8D%E7%AB%AF%E6%8E%A2%E7%B4%A2%E3%80%91%E6%8E%A2%E7%B4%A2Snabbdom%E6%A8%A1%E5%9D%97%E7%B3%BB%E7%BB%9F%E5%8E%9F%E7%90%86/" data-id="ckts3ejz400nn4d9kcff5b29t" data-title="223-【前端探索】探索Snabbdom模块系统原理" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Vuejs/" rel="tag">Vuejs</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/" rel="tag">前端开发</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%89%8D%E7%AB%AF%E6%8E%A2%E7%B4%A2/" rel="tag">前端探索</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%8E%9F%E5%88%9B/" rel="tag">原创</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-222-【前端探索】探索Vuejs响应式" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/01/30/222-%E3%80%90%E5%89%8D%E7%AB%AF%E6%8E%A2%E7%B4%A2%E3%80%91%E6%8E%A2%E7%B4%A2Vuejs%E5%93%8D%E5%BA%94%E5%BC%8F/" class="article-date">
  <time class="dt-published" datetime="2021-01-30T00:08:18.000Z" itemprop="datePublished">2021-01-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/01/30/222-%E3%80%90%E5%89%8D%E7%AB%AF%E6%8E%A2%E7%B4%A2%E3%80%91%E6%8E%A2%E7%B4%A2Vuejs%E5%93%8D%E5%BA%94%E5%BC%8F/">222-【前端探索】探索Vuejs响应式</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p><img src="https://images.pingan8787.com/Vue/Reactive/cover.png" alt="封面图"></p>
<p>提到“响应式”三个字，大家立刻想到啥？响应式布局？响应式编程？</p>
<p><img src="https://images.pingan8787.com/Vue/Reactive/what-reactive.png" alt="响应式关键词.png"><br>从字面意思可以看出，具有“响应式”特征的事物会根据条件变化，使得目标自动作出对应变化。比如在“响应式布局”中，页面根据不同设备尺寸自动显示不同样式。</p>
<p>Vue.js 中的响应式也是一样，当数据发生变化后，使用到该数据的视图也会相应进行自动更新。</p>
<p>接下来我根据个人理解，和大家一起探索下 Vue.js 中的响应式原理，如有错误，欢迎指点😺~~</p>
<h2 id="一、Vue-js-响应式的使用"><a href="#一、Vue-js-响应式的使用" class="headerlink" title="一、Vue.js 响应式的使用"></a>一、Vue.js 响应式的使用</h2><p>现在有个很简单的需求，点击页面中 “leo” 文本后，文本内容修改为“你好，前端自习课”。</p>
<p>我们可以直接操作 DOM，来完成这个需求：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">&quot;name&quot;</span>&gt;</span>leo<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> node = <span class="built_in">document</span>.querySelector(<span class="string">&#x27;#name&#x27;</span>)</span><br><span class="line">node.innerText = <span class="string">&#x27;你好，前端自习课&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>实现起来比较简单，当我们需要修改的数据有很多时（比如相同数据被多处引用），这样的操作将变得复杂。</p>
<p>既然说到 Vue.js，我们就来看看 Vue.js 怎么实现上面需求：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div id=&quot;app&quot;&gt;</span><br><span class="line">    &lt;span @click=&quot;setName&quot;&gt;&#123;&#123; name &#125;&#125;&lt;/span&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">export default &#123;</span><br><span class="line">  name: &quot;App&quot;,</span><br><span class="line">  data() &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">      name: &quot;leo&quot;,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">  methods: &#123;</span><br><span class="line">    setName() &#123;</span><br><span class="line">      this.name = &quot;你好，前端自习课&quot;;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>观察上面代码，我们<strong>通过改变数据，来自动更新视图</strong>。当我们有多个地方引用这个 <code>name</code> 时，视图都会自动更新。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div id=&quot;app&quot;&gt;</span><br><span class="line">    &lt;span @click=&quot;setName&quot;&gt;&#123;&#123; name &#125;&#125;&lt;/span&gt;</span><br><span class="line">    &lt;span&gt;&#123;&#123; name &#125;&#125;&lt;/span&gt;</span><br><span class="line">    &lt;span&gt;&#123;&#123; name &#125;&#125;&lt;/span&gt;</span><br><span class="line">    &lt;span&gt;&#123;&#123; name &#125;&#125;&lt;/span&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure>

<p>当我们使用目前主流的前端框架 Vue.js 和 React 开发业务时，<strong>只需关注页面数据如何变化，因为数据变化后，视图也会自动更新</strong>，这让我们从繁杂的 DOM 操作中解脱出来，提高开发效率。</p>
<h2 id="二、回顾观察者模式"><a href="#二、回顾观察者模式" class="headerlink" title="二、回顾观察者模式"></a>二、回顾观察者模式</h2><p>前面反复提到“<strong>通过改变数据，来自动更新视图</strong>”，换个说法就是“<strong>数据改变后，使用该数据的地方被动发生响应，更新视图</strong>”。</p>
<p>是不是有种熟悉的感觉？数据无需关注自身被多少对象引用，只需在数据变化时，通知到引用的对象即可，引用的对象作出响应。恩，有种观察者模式的味道？</p>
<blockquote>
<p>关于观察者模式，可阅读我之前写的<a target="_blank" rel="noopener" href="https://juejin.cn/post/6862112623417098248">《图解设计模式之观察者模式（TypeScript）》</a>。</p>
</blockquote>
<h3 id="1-观察者模式流程"><a href="#1-观察者模式流程" class="headerlink" title="1. 观察者模式流程"></a>1. 观察者模式流程</h3><p>观察者模式表示一种“<strong>一对多</strong>”的关系，n 个观察者关注 1 个被观察者，被观察者可以主动通知所有观察者。接下图：</p>
<p><img src="https://images.pingan8787.com/Vue/Reactive/observer.png" alt="observer.png"><br>在这张图中，粉丝想及时收到“前端自习课”最新文章，只需关注即可，“前端自习课”有新文章，会主动推送给每个粉丝。该过程中，“前端自习课”是被观察者，每位“粉丝”是观察者。</p>
<h3 id="2-观察者模式核心"><a href="#2-观察者模式核心" class="headerlink" title="2. 观察者模式核心"></a>2. 观察者模式核心</h3><p>观察者模式核心组成包括：n 个观察者和 1 个被观察者。这里实现一个简单观察者模式：</p>
<h4 id="2-1-定义接口"><a href="#2-1-定义接口" class="headerlink" title="2.1 定义接口"></a>2.1 定义接口</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 观察目标接口</span></span><br><span class="line"><span class="keyword">interface</span> ISubject &#123;</span><br><span class="line">    <span class="attr">addObserver</span>: <span class="function">(<span class="params">observer: Observer</span>) =&gt;</span> <span class="built_in">void</span>; <span class="comment">// 添加观察者</span></span><br><span class="line">    removeObserver: <span class="function">(<span class="params">observer: Observer</span>) =&gt;</span> <span class="built_in">void</span>; <span class="comment">// 移除观察者</span></span><br><span class="line">    notify: <span class="function">() =&gt;</span> <span class="built_in">void</span>; <span class="comment">// 通知观察者</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 观察者接口</span></span><br><span class="line"><span class="keyword">interface</span> IObserver &#123;</span><br><span class="line">    <span class="attr">update</span>: <span class="function">() =&gt;</span> <span class="built_in">void</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-2-实现被观察者类"><a href="#2-2-实现被观察者类" class="headerlink" title="2.2 实现被观察者类"></a>2.2 实现被观察者类</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 实现被观察者类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Subject</span> <span class="title">implements</span> <span class="title">ISubject</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> observers: IObserver[] = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> addObserver(observer: IObserver): <span class="built_in">void</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.observers.push(observer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> removeObserver(observer: IObserver): <span class="built_in">void</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> idx: <span class="built_in">number</span> = <span class="built_in">this</span>.observers.indexOf(observer);</span><br><span class="line">        ~idx &amp;&amp; <span class="built_in">this</span>.observers.splice(idx, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> notify(): <span class="built_in">void</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.observers.forEach(<span class="function"><span class="params">observer</span> =&gt;</span> &#123;</span><br><span class="line">            observer.update();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-3-实现观察者类"><a href="#2-3-实现观察者类" class="headerlink" title="2.3 实现观察者类"></a>2.3 实现观察者类</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 实现观察者类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Observer</span> <span class="title">implements</span> <span class="title">IObserver</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params"><span class="keyword">private</span> name: <span class="built_in">string</span></span>)</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line">    update(): <span class="built_in">void</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">`<span class="subst">$&#123;<span class="built_in">this</span>.name&#125;</span> has been notified.`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-4-测试代码"><a href="#2-4-测试代码" class="headerlink" title="2.4 测试代码"></a>2.4 测试代码</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useObserver</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">const</span> subject: ISubject = <span class="keyword">new</span> Subject();</span><br><span class="line">    <span class="keyword">const</span> Leo = <span class="keyword">new</span> Observer(<span class="string">&quot;Leo&quot;</span>);</span><br><span class="line">    <span class="keyword">const</span> Robin = <span class="keyword">new</span> Observer(<span class="string">&quot;Robin&quot;</span>);</span><br><span class="line">    <span class="keyword">const</span> Pual = <span class="keyword">new</span> Observer(<span class="string">&quot;Pual&quot;</span>);</span><br><span class="line"></span><br><span class="line">    subject.addObserver(Leo);</span><br><span class="line">    subject.addObserver(Robin);</span><br><span class="line">    subject.addObserver(Pual);</span><br><span class="line">    subject.notify();</span><br><span class="line"></span><br><span class="line">    subject.removeObserver(Pual);</span><br><span class="line">    subject.notify();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">useObserver();</span><br><span class="line"><span class="comment">// [LOG]: &quot;Leo has been notified.&quot; </span></span><br><span class="line"><span class="comment">// [LOG]: &quot;Robin has been notified.&quot; </span></span><br><span class="line"><span class="comment">// [LOG]: &quot;Pual has been notified.&quot; </span></span><br><span class="line"><span class="comment">// [LOG]: &quot;Leo has been notified.&quot; </span></span><br><span class="line"><span class="comment">// [LOG]: &quot;Robin has been notified.&quot; </span></span><br></pre></td></tr></table></figure>

<h2 id="三、回顾-Object-defineProperty"><a href="#三、回顾-Object-defineProperty" class="headerlink" title="三、回顾 Object.defineProperty()"></a>三、回顾 Object.defineProperty()</h2><p>Vue.js 的数据响应式原理是基于 JS 标准内置对象方法 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/defineproperty"><code>Object.defineProperty()</code> </a>方法来实现，该方法不兼容 IE8 和 FF22 及以下版本浏览器，这也是为什么 Vue.js 只能在这些版本之上的浏览器中才能运行的原因。</p>
<p>理解 <code>Object.defineProperty()</code> 对我们理解 Vue.js 响应式原理<strong>非常重要</strong>。</p>
<blockquote>
<p>Vue.js 3 使用 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy"><code>proxy</code></a> 方法实现响应式，两者类似，我们只需搞懂<code>Object.defineProperty()</code> ， <code>proxy</code> 也就差不多理解了。</p>
</blockquote>
<h3 id="1-概念介绍"><a href="#1-概念介绍" class="headerlink" title="1. 概念介绍"></a>1. 概念介绍</h3><p><code>Object.defineProperty()</code> 方法会直接在一个对象上定义一个新属性，或者修改一个对象的现有属性，并返回此对象。<br>语法如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Object</span>.defineProperty(obj, prop, descriptor)</span><br></pre></td></tr></table></figure>

<ul>
<li>入参说明：</li>
</ul>
<p><code>obj</code> ：要定义属性的<strong>源对象</strong>；<br><code>prop</code> ：要定义或修改的<strong>属性名称</strong>或 <strong>Symbol</strong>；<br><code>descriptor</code> ：要定义或修改的<strong>属性描述符</strong>，包括 <code>configurable</code>、<code>enumerable</code>、<code>value</code>、<code>writable</code>、<code>get</code>、<code>set</code>，具体的可以去参阅<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/definePropertyhttps://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/defineProperty">文档</a>；</p>
<ul>
<li>出参说明：</li>
</ul>
<p>修改后的源对象。</p>
<p>举个简单🌰例子：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> leo = &#123;&#125;;</span><br><span class="line"><span class="built_in">Object</span>.defineProperty(leo, <span class="string">&#x27;age&#x27;</span>, &#123; </span><br><span class="line">    <span class="attr">value</span>: <span class="number">18</span>,</span><br><span class="line">    <span class="attr">writable</span>: <span class="literal">true</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="built_in">console</span>.log(leo.age); <span class="comment">// 18</span></span><br><span class="line">leo.age = <span class="number">22</span>;</span><br><span class="line"><span class="built_in">console</span>.log(leo.age); <span class="comment">// 22</span></span><br></pre></td></tr></table></figure>

<h3 id="2-实现-getter-setter"><a href="#2-实现-getter-setter" class="headerlink" title="2. 实现 getter/setter"></a>2. 实现 getter/setter</h3><p>我们知道 <code>Object.defineProperty()</code> 方法第三个参数是属性描述符（<code>descriptor</code>），支持设置 <code>get</code> 和 <code>set</code> 描述符：</p>
<ul>
<li><code>get</code> 描述符：当<strong>访问该属性</strong>时，会调用此函数，默认值为 <code>undefined</code> ；</li>
<li><code>set</code> 描述符：当<strong>修改该属性</strong>时，会调用此函数，默认值为 <code>undefined</code> 。</li>
</ul>
<blockquote>
<p>一旦对象拥有了 getter/setter 方法，我们可以简单将该对象称为响应式对象。</p>
</blockquote>
<p>这两个操作符为我们提供拦截数据进行操作的可能性，修改前面示例，添加 getter/setter 方法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> leo = &#123;&#125;, age = <span class="number">18</span>;</span><br><span class="line"><span class="built_in">Object</span>.defineProperty(leo, <span class="string">&#x27;age&#x27;</span>, &#123; </span><br><span class="line">    <span class="function"><span class="title">get</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="comment">// to do something</span></span><br><span class="line">      	<span class="built_in">console</span>.log(<span class="string">&#x27;监听到请求数据&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">set</span>(<span class="params">newAge</span>)</span>&#123;</span><br><span class="line">        <span class="comment">// to do something</span></span><br><span class="line">      	<span class="built_in">console</span>.log(<span class="string">&#x27;监听到修改数据&#x27;</span>);</span><br><span class="line">        age = newAge &gt; age ? age : newAge</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line">leo.age = <span class="number">20</span>;  <span class="comment">// 监听到修改数据</span></span><br><span class="line"><span class="built_in">console</span>.log(leo.age); <span class="comment">// 监听到请求数据  // 18</span></span><br><span class="line"></span><br><span class="line">leo.age = <span class="number">10</span>;  <span class="comment">// 监听到修改数据</span></span><br><span class="line"><span class="built_in">console</span>.log(leo.age); <span class="comment">// 监听到请求数据  // 10</span></span><br></pre></td></tr></table></figure>

<p>访问 <code>leo</code> 对象的 <code>age</code> 属性，会通过 <code>get</code> 描述符处理，而修改 <code>age</code> 属性，则会通过 <code>set</code> 描述符处理。</p>
<h2 id="四、实现简单的数据响应式"><a href="#四、实现简单的数据响应式" class="headerlink" title="四、实现简单的数据响应式"></a>四、实现简单的数据响应式</h2><p>通过前面两个小节，我们复习了“观察者模式”和“<code>Object.defineProperty()</code>” 方法，这两个知识点在 Vue.js 响应式原理中非常重要。</p>
<p>接下来我们来实现一个很简单的数据响应式变化，需求如下：点击“更新数据”按钮，文本更新。</p>
<p><img src="https://images.pingan8787.com/Vue/Reactive/data-change.png" alt="data-change.png"></p>
<p>接下来我们将实现三个类：</p>
<ul>
<li><code>Dep</code> 被观察者类，用来生成被观察者；</li>
<li><code>Watcher</code> 观察者类，用来生成观察者；</li>
<li><code>Observer</code> 类，<strong>将普通数据转换为响应式数据，从而实现响应式对象</strong>。</li>
</ul>
<p>用一张图来描述三者之间关系，现在看不懂没关系，这小节看完可以再回顾这张图：<br><img src="https://images.pingan8787.com/Vue/Reactive/observer-watcher-dep.png" alt="observer-watcher-dep.png"></p>
<h3 id="1-实现精简观察者模式"><a href="#1-实现精简观察者模式" class="headerlink" title="1. 实现精简观察者模式"></a>1. 实现精简观察者模式</h3><p>这里参照前面复习“观察者模式”的示例，做下精简：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 实现被观察者类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dep</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.subs = [];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">addSub</span>(<span class="params">watcher</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.subs.push(watcher);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">notify</span>(<span class="params">data</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.subs.forEach(<span class="function"><span class="params">sub</span> =&gt;</span> sub.update(data));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 实现观察者类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Watcher</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">cb</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.cb = cb;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">update</span>(<span class="params">data</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.cb(data);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Vue.js 响应式原理中，<strong>观察者模式起到非常重要的作用</strong>。其中：</p>
<ul>
<li><code>Dep</code> 被观察者类，提供用来收集观察者（ <code>addSub</code> ）方法和通知观察者（ <code>notify</code> ）方法；</li>
<li><code>Watcher</code> 观察者类，实例化时支持传入回调（ <code>cb</code> ）方法，并提供更新（ <code>update</code> ）方法；</li>
</ul>
<h3 id="2-实现生成响应式的类"><a href="#2-实现生成响应式的类" class="headerlink" title="2. 实现生成响应式的类"></a>2. 实现生成响应式的类</h3><p>这一步需要实现 <code>Observer</code> 类，核心是通过 <code>Object.defineProperty()</code> 方法为对象的每个属性设置 getter/setter，目的是<strong>将普通数据转换为响应式数据，从而实现响应式对象</strong>。</p>
<p><img src="https://images.pingan8787.com/Vue/Reactive/reactive-data.png" alt="reactive-data.png"></p>
<p>这里<strong>以最简单的单层对象为例</strong>（下一节会介绍深层对象），如：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> initData = &#123;</span><br><span class="line">    <span class="attr">text</span>: <span class="string">&#x27;你好，前端自习课&#x27;</span>,</span><br><span class="line">    <span class="attr">desc</span>: <span class="string">&#x27;每日清晨，享受一篇前端优秀文章。&#x27;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>接下来实现 <code>Observer</code> 类：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 实现响应式类（最简单单层的对象，暂不考虑深层对象）</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Observer</span> </span>&#123;</span><br><span class="line">    <span class="title">constructor</span> (<span class="params">node, data</span>) &#123;</span><br><span class="line">        <span class="built_in">this</span>.defineReactive(node, data)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 实现数据劫持（核心方法）</span></span><br><span class="line">    <span class="comment">// 遍历 data 中所有的数据，都添加上 getter 和 setter 方法</span></span><br><span class="line">    <span class="function"><span class="title">defineReactive</span>(<span class="params">vm, obj</span>)</span> &#123;</span><br><span class="line">        <span class="comment">//每一个属性都重新定义get、set</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">let</span> key <span class="keyword">in</span> obj)&#123;</span><br><span class="line">            <span class="keyword">let</span> value = obj[key]， dep = <span class="keyword">new</span> Dep();</span><br><span class="line">            <span class="built_in">Object</span>.defineProperty(obj, key, &#123;</span><br><span class="line">                <span class="attr">enumerable</span>: <span class="literal">true</span>,</span><br><span class="line">                <span class="attr">configurable</span>: <span class="literal">true</span>,</span><br><span class="line">                <span class="function"><span class="title">get</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">                    <span class="comment">// 创建观察者</span></span><br><span class="line">                    <span class="keyword">let</span> watcher = <span class="keyword">new</span> Watcher(<span class="function"><span class="params">v</span> =&gt;</span> vm.innerText = v);</span><br><span class="line">                    dep.addSub(watcher);</span><br><span class="line">                    <span class="keyword">return</span> value;</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="function"><span class="title">set</span>(<span class="params">newValue</span>)</span> &#123;</span><br><span class="line">                    value = newValue;</span><br><span class="line">                    <span class="comment">// 通知所有观察者</span></span><br><span class="line">                    dep.notify(newValue);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面代码的核心是 <code>defineReactive</code> 方法，它遍历原始对象中每个属性，为每个属性实例化一个被观察者（<code>Dep</code>），然后分别调用 <code>Object.defineProperty()</code> 方法，为每个属性添加 getter/setter。</p>
<ul>
<li>访问数据时，getter 执行依赖收集（即添加观察者），通过实例化 <code>Watcher</code> 创建一个观察者，并执行被观察者的 <code>addSub()</code> 方法添加一个观察者；</li>
<li>修改数据时，setter 执行派发更新（即通知观察者），通过调用被观察者的 <code>notify()</code> 方法通知所有观察者，执行观察者 <code>update()</code> 方法。</li>
</ul>
<h3 id="3-测试代码"><a href="#3-测试代码" class="headerlink" title="3. 测试代码"></a>3. 测试代码</h3><p>为了方便观察数据变化，我们为“更新数据”按钮绑定点击事件来修改数据：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;update&quot;</span>&gt;</span>更新数据<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>测试代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 初始化测试数据</span></span><br><span class="line"><span class="keyword">let</span> initData = &#123;</span><br><span class="line">    <span class="attr">text</span>: <span class="string">&#x27;你好，前端自习课&#x27;</span>,</span><br><span class="line">    <span class="attr">desc</span>: <span class="string">&#x27;每日清晨，享受一篇前端优秀文章。&#x27;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="built_in">document</span>.querySelector(<span class="string">&#x27;#app&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 步骤1：为测试数据转换为响应式对象</span></span><br><span class="line"><span class="keyword">new</span> Observer(app, initData);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 步骤2：初始化页面文本内容</span></span><br><span class="line">app.innerText = initData.text;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 步骤3：绑定按钮事件，点击触发测试</span></span><br><span class="line"><span class="built_in">document</span>.querySelector(<span class="string">&#x27;#update&#x27;</span>).addEventListener(<span class="string">&#x27;click&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    initData.text = <span class="string">`我们必须经常保持旧的记忆和新的希望。`</span>;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`当前时间：<span class="subst">$&#123;<span class="keyword">new</span> <span class="built_in">Date</span>().toLocaleString()&#125;</span>`</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>测试代码中，核心在于通过实例化 <code>Observer</code>，将测试数据转换为响应式数据，然后模拟数据变化，来观察视图变化。<br>每次点击“更新数据”按钮，在控制台中都能看到“数据发生变化！”的提示，说明我们已经能通过 setter 观察到数据的变化情况。<br><img src="https://images.pingan8787.com/Vue/Reactive/demo-1.png" alt=" "></p>
<p>当然，你还可以在控制台手动修改 <code>initData</code> 对象中的 <code>text</code> 属性，来体验响应式变化~~<br><img src="https://images.pingan8787.com/Vue/Reactive/demo-2.png" alt=" "></p>
<p>到这里，我们实现了非常简单的数据响应式变化，当然 Vue.js 肯定没有这么简单，这个先理解，下一节看 Vue.js 响应式原理，思路就会清晰很多。</p>
<blockquote>
<p>这部分代码，我已经放到<a target="_blank" rel="noopener" href="https://github.com/pingan8787/Leo-JavaScript/blob/master/Cute-Gist/Vue/Basics-Reactive-Demo.js">我的 Github</a>，地址：<a target="_blank" rel="noopener" href="https://github.com/pingan8787/Leo-JavaScript/blob/master/Cute-Gist/Vue/Basics-Reactive-Demo.js">https://github.com/pingan8787/Leo-JavaScript/blob/master/Cute-Gist/Vue/Basics-Reactive-Demo.js</a></p>
</blockquote>
<p>可以再回顾下这张图，对整个过程会更清晰：</p>
<p><img src="https://images.pingan8787.com/Vue/Reactive/observer-watcher-dep.png" alt="observer-watcher-dep.png"></p>
<h2 id="五、实现简单-Vue-js-响应式"><a href="#五、实现简单-Vue-js-响应式" class="headerlink" title="五、实现简单 Vue.js 响应式"></a>五、实现简单 Vue.js 响应式</h2><blockquote>
<p>本节代码：<a target="_blank" rel="noopener" href="https://github.com/pingan8787/Leo-JavaScript/blob/master/Cute-Gist/Vue/leo-vue-reactive/compile.js">https://github.com/pingan8787/Leo-JavaScript/blob/master/Cute-Gist/Vue/leo-vue-reactive/</a></p>
</blockquote>
<p>这里大家可以再回顾下下面这张官网经典的图，思考下前面讲的示例。<br><img src="https://images.pingan8787.com/Vue/Reactive/demo-3.png" alt=" "></p>
<p>（图片来自：<a target="_blank" rel="noopener" href="https://cn.vuejs.org/v2/guide/reactivity.html">https://cn.vuejs.org/v2/guide/reactivity.html</a>）</p>
<p>上一节实现了简单的数据响应式，接下来继续通过完善该示例，实现一个简单的 Vue.js 响应式，测试代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.js</span></span><br><span class="line"><span class="keyword">const</span> vm = <span class="keyword">new</span> Vue(&#123;</span><br><span class="line">    <span class="attr">el</span>: <span class="string">&#x27;#app&#x27;</span>,</span><br><span class="line">    <span class="function"><span class="title">data</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="attr">text</span>: <span class="string">&#x27;你好，前端自习课&#x27;</span>,</span><br><span class="line">            <span class="attr">desc</span>: <span class="string">&#x27;每日清晨，享受一篇前端优秀文章。&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>是不是很有内味了，下面是我们最终实现后项目目录：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- mini-reactive</span><br><span class="line">	/ index.html   // 入口 HTML 文件</span><br><span class="line">  / index.js     // 入口 JS 文件</span><br><span class="line">  / observer.js  // 实现响应式，将数据转换为响应式对象</span><br><span class="line">  / watcher.js   // 实现观察者和被观察者（依赖收集者）</span><br><span class="line">  / vue.js       // 实现 Vue 类作为主入口类</span><br><span class="line">  / compile.js   // 实现编译模版功能</span><br></pre></td></tr></table></figure>

<p>知道每一个文件功能以后，接下来将每一步串联起来。</p>
<h3 id="1-实现入口文件"><a href="#1-实现入口文件" class="headerlink" title="1. 实现入口文件"></a>1. 实现入口文件</h3><p>我们首先实现入口文件，包括 <code>index.html</code> / <code>index.js</code>  2 个简单文件，用来方便接下来的测试。</p>
<h4 id="1-1-index-html"><a href="#1-1-index-html" class="headerlink" title="1.1 index.html"></a>1.1 index.html</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;./vue.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;./observer.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;./compile.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;./watcher.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span>&#123;&#123;text&#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;update&quot;</span>&gt;</span>更新数据<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;./index.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="1-2-index-js"><a href="#1-2-index-js" class="headerlink" title="1.2 index.js"></a>1.2 index.js</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> vm = <span class="keyword">new</span> Vue(&#123;</span><br><span class="line">    <span class="attr">el</span>: <span class="string">&#x27;#app&#x27;</span>,</span><br><span class="line">    <span class="function"><span class="title">data</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="attr">text</span>: <span class="string">&#x27;你好，前端自习课&#x27;</span>,</span><br><span class="line">            <span class="attr">desc</span>: <span class="string">&#x27;每日清晨，享受一篇前端优秀文章。&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(vm.$data.text)</span><br><span class="line">vm.$data.text = <span class="string">&#x27;页面数据更新成功！&#x27;</span>; <span class="comment">// 模拟数据变化</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	也可以手动绑定“更新数据”按钮的事件，来手动更新数据</span></span><br><span class="line"><span class="comment">  document.getElementById(&#x27;update&#x27;).addEventListener(&#x27;click&#x27;, function()&#123;</span></span><br><span class="line"><span class="comment">    vm.$data.text = &#x27;我们必须经常保持旧的记忆和新的希望。&#x27;;</span></span><br><span class="line"><span class="comment">  &#125;)</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="built_in">console</span>.log(vm.$data.text)</span><br></pre></td></tr></table></figure>

<h3 id="2-实现核心入口-vue-js"><a href="#2-实现核心入口-vue-js" class="headerlink" title="2. 实现核心入口 vue.js"></a>2. 实现核心入口 vue.js</h3><p><code>vue.js</code> 文件是我们实现的整个响应式的入口文件，暴露一个 <code>Vue</code> 类，并挂载全局。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Vue</span> </span>&#123;</span><br><span class="line">    <span class="title">constructor</span> (<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">        <span class="built_in">this</span>.$el = options.el;</span><br><span class="line">        <span class="built_in">this</span>.$data = options.data();</span><br><span class="line">        <span class="built_in">this</span>.$methods = options.methods;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// [核心流程]将普通 data 对象转换为响应式对象</span></span><br><span class="line">        <span class="keyword">new</span> Observer(<span class="built_in">this</span>.$data);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.$el) &#123;</span><br><span class="line">            <span class="comment">// [核心流程]将解析模板的内容</span></span><br><span class="line">            <span class="keyword">new</span> Compile(<span class="built_in">this</span>.$el, <span class="built_in">this</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">window</span>.Vue = Vue;</span><br></pre></td></tr></table></figure>

<p><code>Vue</code> 类入参为一个配置项 <code>option</code> ，使用起来跟 Vue.js 一样，包括 <code>$el</code> 挂载点、 <code>$data</code> 数据对象和 <code>$methods</code> 方法列表（本文不详细介绍）。</p>
<p>通过实例化 <code>Oberser</code> 类，将普通 data 对象转换为响应式对象，然后判断是否传入 <code>el</code> 参数，存在时，则实例化 <code>Compile</code> 类，解析模版内容。</p>
<p>总结下 <code>Vue</code> 这个类工作流程 ：<br><img src="https://images.pingan8787.com/Vue/Reactive/vue-class.png" alt="vue-class.png"></p>
<h3 id="3-实现-observer-js"><a href="#3-实现-observer-js" class="headerlink" title="3. 实现 observer.js"></a>3. 实现 observer.js</h3><p>observer.js 文件实现了 <code>Observer</code> 类，用来将普通对象转换为响应式对象：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Observer</span> </span>&#123;</span><br><span class="line">    <span class="title">constructor</span> (<span class="params">data</span>) &#123;</span><br><span class="line">        <span class="built_in">this</span>.data = data;</span><br><span class="line">        <span class="built_in">this</span>.walk(data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// [核心方法]将 data 对象转换为响应式对象，为每个 data 属性设置 getter 和 setter 方法</span></span><br><span class="line">    walk (data) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> data !== <span class="string">&#x27;object&#x27;</span>) <span class="keyword">return</span> data;</span><br><span class="line">        <span class="built_in">Object</span>.keys(data).forEach( <span class="function"><span class="params">key</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.defineReactive(data, key, data[key])</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// [核心方法]实现数据劫持</span></span><br><span class="line">    defineReactive (obj, key, value) &#123;</span><br><span class="line">        <span class="built_in">this</span>.walk(value);  <span class="comment">// [核心过程]遍历 walk 方法，处理深层对象。</span></span><br><span class="line">        <span class="keyword">const</span> dep = <span class="keyword">new</span> Dep();</span><br><span class="line">        <span class="built_in">Object</span>.defineProperty(obj, key, &#123;</span><br><span class="line">            <span class="attr">enumerable</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">configurable</span>: <span class="literal">true</span>,</span><br><span class="line">            get () &#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&#x27;[getter]方法执行&#x27;</span>)</span><br><span class="line">                Dep.target &amp;&amp;  dep.addSub(Dep.target);</span><br><span class="line">                <span class="keyword">return</span> value</span><br><span class="line">            &#125;,</span><br><span class="line">            set (newValue) &#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&#x27;[setter]方法执行&#x27;</span>)</span><br><span class="line">                <span class="keyword">if</span> (value === newValue) <span class="keyword">return</span>;</span><br><span class="line">                <span class="comment">// [核心过程]当设置的新值 newValue 为对象，则继续通过 walk 方法将其转换为响应式对象</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">typeof</span> newValue === <span class="string">&#x27;object&#x27;</span>) <span class="built_in">this</span>.walk(newValue);</span><br><span class="line">                value = newValue;</span><br><span class="line">                dep.notify(); <span class="comment">// [核心过程]执行被观察者通知方法，通知所有观察者执行 update 更新</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>相比较第四节实现的 <code>Observer</code> 类，这里做了调整：</p>
<ul>
<li>增加 <code>walk</code> 核心方法，用来遍历对象每个属性，分别调用数据劫持方法（ <code>defineReactive()</code> ）；</li>
<li>在 <code>defineReactive()</code> 的 getter 中，判断 <code>Dep.target</code> 存在才添加观察者，下一节会详细介绍 <code>Dep.target</code>；</li>
<li>在 <code>defineReactive()</code> 的 setter 中，判断当前新值（ <code>newValue</code> ）是否为对象，如果是，则直接调用 <code>this.walk()</code> 方法将当前对象再次转为响应式对象，<strong>处理深层对象</strong>。</li>
</ul>
<p>通过改善后的 <code>Observer</code> 类，我们就可以实现<strong>将单层或深层嵌套的普通对象转换为响应式对象</strong>。</p>
<h3 id="4-实现-watcher-js"><a href="#4-实现-watcher-js" class="headerlink" title="4. 实现 watcher.js"></a>4. 实现 watcher.js</h3><p>这里实现了 <code>Dep</code> 被观察者类（依赖收集者）和 <code>Watcher</code> 观察者类。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dep</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.subs = [];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">addSub</span>(<span class="params">watcher</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.subs.push(watcher);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">notify</span>(<span class="params">data</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.subs.forEach(<span class="function"><span class="params">sub</span> =&gt;</span> sub.update(data));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Watcher</span> </span>&#123;</span><br><span class="line">    <span class="title">constructor</span> (<span class="params">vm, key, cb</span>) &#123;</span><br><span class="line">        <span class="built_in">this</span>.vm = vm;   <span class="comment">// vm：表示当前实例</span></span><br><span class="line">        <span class="built_in">this</span>.key = key; <span class="comment">// key：表示当前操作的数据名称</span></span><br><span class="line">        <span class="built_in">this</span>.cb = cb;   <span class="comment">// cb：表示数据发生改变之后的回调</span></span><br><span class="line"></span><br><span class="line">        Dep.target = <span class="built_in">this</span>; <span class="comment">// 全局唯一</span></span><br><span class="line">      </span><br><span class="line">        <span class="comment">// 此处通过 this.vm.$data[key] 读取属性值，触发 getter</span></span><br><span class="line">        <span class="built_in">this</span>.oldValue = <span class="built_in">this</span>.vm.$data[key]; <span class="comment">// 保存变化的数据作为旧值，后续作判断是否更新</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 前面 getter 执行完后，执行下面清空</span></span><br><span class="line">        Dep.target = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    update () &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">`数据发生变化！`</span>);</span><br><span class="line">        <span class="keyword">let</span> oldValue = <span class="built_in">this</span>.oldValue;</span><br><span class="line">        <span class="keyword">let</span> newValue = <span class="built_in">this</span>.vm.$data[<span class="built_in">this</span>.key];</span><br><span class="line">        <span class="keyword">if</span> (oldValue != newValue) &#123;  <span class="comment">// 比较新旧值，发生变化才执行回调</span></span><br><span class="line">            <span class="built_in">this</span>.cb(newValue, oldValue);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>相比较第四节实现的 <code>Watcher</code>  类，这里做了调整：</p>
<ul>
<li>在构造函数中，增加 <code>Dep.target</code> 值操作；</li>
<li>在构造函数中，增加 <code>oldValue</code> 变量，保存变化的数据作为旧值，后续作为判断是否更新的依据；</li>
<li>在 <code>update()</code> 方法中，增加当前操作对象 <code>key</code> 对应值的新旧值比较，如果不同，才执行回调。</li>
</ul>
<p><code>Dep.target</code> 是<strong>当前全局唯一的订阅者</strong>，因为同一时间只允许一个订阅者被处理。<code>target</code> 指<strong>当前正在处理的目标订阅者</strong>，当前订阅者处理完就赋值为 <code>null</code> 。这里 <code>Dep.target</code> 会在 <code>defineReactive()</code> 的 getter 中使用到。</p>
<p>通过改善后的 <code>Watcher</code> 类，我们操作当前操作对象 <code>key</code> 对应值的时候，可以在数据有变化的情况才执行回调，减少资源浪费。</p>
<h3 id="4-实现-compile-js"><a href="#4-实现-compile-js" class="headerlink" title="4. 实现 compile.js"></a>4. 实现 compile.js</h3><p>compile.js 实现了 Vue.js 的模版编译，如将 HTML 中的 <code>&#123;&#123;text&#125;&#125;</code> 模版转换为具体变量的值。</p>
<p>compile.js 介绍内容较多，考虑到篇幅问题，并且本文核心介绍响应式原理，所以这里就暂时不介绍 compile.js 的实现，在学习的朋友可以到我 <a target="_blank" rel="noopener" href="https://github.com/pingan8787/Leo-JavaScript/blob/master/Cute-Gist/Vue/leo-vue-reactive/compile.js">Github 上下载该文件</a>直接下载使用即可，地址：<br><a target="_blank" rel="noopener" href="https://github.com/pingan8787/Leo-JavaScript/blob/master/Cute-Gist/Vue/leo-vue-reactive/compile.js">https://github.com/pingan8787/Leo-JavaScript/blob/master/Cute-Gist/Vue/leo-vue-reactive/compile.js</a></p>
<h3 id="5-测试代码"><a href="#5-测试代码" class="headerlink" title="5. 测试代码"></a>5. 测试代码</h3><p>到这里，我们已经将第四节的 demo 改造成简易版 Vue.js 响应式，接下来打开 index.html 看看效果：<br><img src="https://images.pingan8787.com/Vue/Reactive/demo-4.png" alt=" "></p>
<p>当 index.js 中执行到：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vm.$data.text = <span class="string">&#x27;我们必须经常保持旧的记忆和新的希望。&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>页面便发生更新，页面显示的文本内容从“<strong>你好，前端自习课</strong>”更新成“<strong>我们必须经常保持旧的记忆和新的希望。</strong>”。</p>
<p>到这里，我们的简易版 Vue.js 响应式原理实现好了，能跟着文章看到这里的朋友，给你点个大大的赞👍<br><img src="https://images.pingan8787.com/Vue/Reactive/demo-5.png" alt=" "></p>
<h2 id="六、总结"><a href="#六、总结" class="headerlink" title="六、总结"></a>六、总结</h2><p>本文首先通过回顾观察者模式和 <code>Object.defineProperty()</code> 方法，介绍 Vue.js 响应式原理的核心知识点，然后带大家通过一个简单示例实现简单响应式，最后通过改造这个简单响应式的示例，实现一个简单 Vue.js 响应式原理的示例。</p>
<p>相信看完本文的朋友，对 Vue.js 的响应式原理的理解会更深刻，希望大家理清思路，再好好回味下~</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ol>
<li><a target="_blank" rel="noopener" href="https://cn.vuejs.org/v2/guide/reactivity.html">官方文档 - 深入响应式原理</a> </li>
<li><a target="_blank" rel="noopener" href="https://juejin.cn/post/6911608521599483917">《浅谈Vue响应式原理》</a></li>
<li><a target="_blank" rel="noopener" href="https://www.infoq.cn/article/we3l33h5zgyyg6gc9hri">《Vue的数据响应式原理》</a> </li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/01/30/222-%E3%80%90%E5%89%8D%E7%AB%AF%E6%8E%A2%E7%B4%A2%E3%80%91%E6%8E%A2%E7%B4%A2Vuejs%E5%93%8D%E5%BA%94%E5%BC%8F/" data-id="ckts3ejz300nl4d9k5gi97wf9" data-title="222-【前端探索】探索Vuejs响应式" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Vuejs/" rel="tag">Vuejs</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/" rel="tag">前端开发</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%89%8D%E7%AB%AF%E6%8E%A2%E7%B4%A2/" rel="tag">前端探索</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%8E%9F%E5%88%9B/" rel="tag">原创</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-221-【前端探索】探索React合成事件" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/01/30/221-%E3%80%90%E5%89%8D%E7%AB%AF%E6%8E%A2%E7%B4%A2%E3%80%91%E6%8E%A2%E7%B4%A2React%E5%90%88%E6%88%90%E4%BA%8B%E4%BB%B6/" class="article-date">
  <time class="dt-published" datetime="2021-01-30T00:06:36.000Z" itemprop="datePublished">2021-01-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/01/30/221-%E3%80%90%E5%89%8D%E7%AB%AF%E6%8E%A2%E7%B4%A2%E3%80%91%E6%8E%A2%E7%B4%A2React%E5%90%88%E6%88%90%E4%BA%8B%E4%BB%B6/">221-【前端探索】探索React合成事件</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <blockquote>
<p>React 是一个 Facebook 开源的，用于构建用户界面的 JavaScript 库。</p>
</blockquote>
<p>React 目的在于解决：构建随着时间数据不断变化的大规模应用程序。<br>其中 React 合成事件是较为重要的知识点，阅读完本文，你将收获：</p>
<ol>
<li>合成事件的概念和作用；</li>
<li>合成事件与原生事件的 3 个区别；</li>
<li>合成事件与原生事件的执行顺序；</li>
<li>合成事件的事件池；</li>
<li>合成事件 4 个常见问题。</li>
</ol>
<p>接下来和我一起开始学习吧~</p>
<h2 id="一、概念介绍"><a href="#一、概念介绍" class="headerlink" title="一、概念介绍"></a>一、概念介绍</h2><p>React 合成事件（SyntheticEvent）是 React <strong>模拟原生 DOM 事件所有能力的一个事件对象</strong>，即浏览器原生事件的跨浏览器包装器。它根据 <a target="_blank" rel="noopener" href="https://www.w3.org/TR/DOM-Level-3-Events/">W3C 规范</a> 来定义合成事件，兼容所有浏览器，拥有与浏览器原生事件相同的接口。<br>看个简单示例：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> button = <span class="xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;handleClick&#125;</span>&gt;</span>Leo 按钮<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>在 React 中，所有事件都是合成的，不是原生 DOM 事件，但可以通过 <code>e.nativeEvent</code> 属性获取 DOM 事件。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> handleClick = <span class="function">(<span class="params">e</span>) =&gt;</span> <span class="built_in">console</span>.log(e.nativeEvent);;</span><br><span class="line"><span class="keyword">const</span> button = <span class="xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;handleClick&#125;</span>&gt;</span>Leo 按钮<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br></pre></td></tr></table></figure>


<p>学习一个新知识的时候，一定要知道为什么会出现这个技术。<br>那么 React 为什么使用合成事件？其主要有三个目的：</p>
<ol>
<li>进行浏览器兼容，实现更好的跨平台</li>
</ol>
<p>React 采用的是顶层事件代理机制，能够保证冒泡一致性，可以跨浏览器执行。React 提供的合成事件用来抹平不同浏览器事件对象之间的差异，将不同平台事件模拟合成事件。</p>
<ol start="2">
<li>避免垃圾回收</li>
</ol>
<p>事件对象可能会被频繁创建和回收，因此 React 引入<strong>事件池</strong>，在事件池中获取或释放事件对象。**即 React 事件对象不会被释放掉，而是存放进一个数组中，当事件触发，就从这个数组中弹出，避免频繁地去创建和销毁(垃圾回收)**。</p>
<ol start="3">
<li>方便事件统一管理和事务机制</li>
</ol>
<blockquote>
<p>本文不介绍源码啦，对具体实现的源码有兴趣的朋友可以查阅：<a target="_blank" rel="noopener" href="https://github.com/facebook/react/blob/75ab53b9e1de662121e68dabb010655943d28d11/packages/events/SyntheticEvent.js#L62">《React SyntheticEvent》</a> 。</p>
</blockquote>
<h2 id="二、原生事件回顾"><a href="#二、原生事件回顾" class="headerlink" title="二、原生事件回顾"></a>二、原生事件回顾</h2><p>在开始介绍 React 合成事件之前，我们先简单回顾 JavaScript 原生事件中几个重要知识点：<br><img src="https://images.pingan8787.com/React/Synthetic-Event/Native-Event.png" alt="Native-Event.png"></p>
<h3 id="1-事件捕获"><a href="#1-事件捕获" class="headerlink" title="1. 事件捕获"></a>1. 事件捕获</h3><p>当某个元素触发某个事件（如 <code>onclick</code> ），顶层对象 <code>document</code> 就会发出一个事件流，随着 DOM 树的节点向目标元素节点流去，<strong>直到到达事件真正发生的目标元素</strong>。在这个过程中，事件相应的监听函数是不会被触发的。</p>
<h3 id="2-事件目标"><a href="#2-事件目标" class="headerlink" title="2. 事件目标"></a>2. 事件目标</h3><p>当到达目标元素之后，执行目标元素该事件相应的处理函数。如果没有绑定监听函数，那就不执行。</p>
<h3 id="3-事件冒泡"><a href="#3-事件冒泡" class="headerlink" title="3. 事件冒泡"></a>3. 事件冒泡</h3><p>从目标元素开始，往顶层元素传播。途中如果有节点绑定了相应的事件处理函数，这些函数都会被触发一次。如果想阻止事件起泡，可以使用 <code>e.stopPropagation()</code> 或者<code> e.cancelBubble=true</code>（IE）来阻止事件的冒泡传播。</p>
<h3 id="4-事件委托-事件代理"><a href="#4-事件委托-事件代理" class="headerlink" title="4. 事件委托/事件代理"></a>4. 事件委托/事件代理</h3><p>简单理解就是<strong>将一个响应事件委托到另一个元素</strong>。<br>当子节点被点击时，<code>click</code> 事件向上冒泡，父节点捕获到事件后，我们判断是否为所需的节点，然后进行处理。其优点在于<strong>减少内存消耗和动态绑定事件</strong>。</p>
<h2 id="二、合成事件与原生事件区别"><a href="#二、合成事件与原生事件区别" class="headerlink" title="二、合成事件与原生事件区别"></a>二、合成事件与原生事件区别</h2><p>React 事件与原生事件很相似，但不完全相同。这里列举几个常见区别：</p>
<h3 id="1-事件名称命名方式不同"><a href="#1-事件名称命名方式不同" class="headerlink" title="1. 事件名称命名方式不同"></a>1. 事件名称命名方式不同</h3><p>原生事件命名为纯小写（onclick, onblur），而 React 事件命名采用<strong>小驼峰式</strong>（camelCase），如 <code>onClick</code> 等：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 原生事件绑定方式</span></span><br><span class="line">&lt;button onclick=<span class="string">&quot;handleClick()&quot;</span>&gt;Leo 按钮命名&lt;/button&gt;</span><br><span class="line">      </span><br><span class="line"><span class="comment">// React 合成事件绑定方式</span></span><br><span class="line"><span class="keyword">const</span> button = <span class="xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;handleClick&#125;</span>&gt;</span>Leo 按钮命名<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br></pre></td></tr></table></figure>


<h3 id="2-事件处理函数写法不同"><a href="#2-事件处理函数写法不同" class="headerlink" title="2. 事件处理函数写法不同"></a>2. 事件处理函数写法不同</h3><p>原生事件中事件处理函数为字符串，在 React JSX 语法中，传入一个<strong>函数</strong>作为事件处理函数。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 原生事件 事件处理函数写法</span></span><br><span class="line">&lt;button onclick=<span class="string">&quot;handleClick()&quot;</span>&gt;Leo 按钮命名&lt;/button&gt;</span><br><span class="line">      </span><br><span class="line"><span class="comment">// React 合成事件 事件处理函数写法</span></span><br><span class="line"><span class="keyword">const</span> button = <span class="xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;handleClick&#125;</span>&gt;</span>Leo 按钮命名<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br></pre></td></tr></table></figure>


<h3 id="3-阻止默认行为方式不同"><a href="#3-阻止默认行为方式不同" class="headerlink" title="3. 阻止默认行为方式不同"></a>3. 阻止默认行为方式不同</h3><p>在原生事件中，可以通过返回 <code>false</code> 方式来阻止默认行为，但是在 React 中，需要显式使用 <code>preventDefault()</code> 方法来阻止。<br>这里以阻止 <code>&lt;a&gt;</code> 标签默认打开新页面为例，介绍两种事件区别：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 原生事件阻止默认行为方式</span></span><br><span class="line">&lt;a href=<span class="string">&quot;https://www.pingan8787.com&quot;</span> </span><br><span class="line">  onclick=<span class="string">&quot;console.log(&#x27;Leo 阻止原生事件~&#x27;); return false&quot;</span></span><br><span class="line">&gt;</span><br><span class="line">  Leo 阻止原生事件</span><br><span class="line">&lt;/a&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">// React 事件阻止默认行为方式</span></span><br><span class="line"><span class="keyword">const</span> handleClick = <span class="function"><span class="params">e</span> =&gt;</span> &#123;</span><br><span class="line">  e.preventDefault();</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;Leo 阻止原生事件~&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> clickElement = <span class="xml"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;https://www.pingan8787.com&quot;</span> <span class="attr">onClick</span>=<span class="string">&#123;handleClick&#125;</span>&gt;</span></span></span><br><span class="line"><span class="xml">  Leo 阻止原生事件</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<h3 id="4-小结"><a href="#4-小结" class="headerlink" title="4. 小结"></a>4. 小结</h3><p>小结前面几点区别：</p>
<table>
<thead>
<tr>
<th></th>
<th align="center">原生事件</th>
<th align="center">React 事件</th>
</tr>
</thead>
<tbody><tr>
<td>事件名称命名方式</td>
<td align="center">名称全部小写<br/>（onclick, onblur）</td>
<td align="center">名称采用小驼峰<br/>（onClick, onBlur）</td>
</tr>
<tr>
<td>事件处理函数语法</td>
<td align="center">字符串</td>
<td align="center">函数</td>
</tr>
<tr>
<td>阻止默认行为方式</td>
<td align="center">事件返回 <code>false</code></td>
<td align="center">使用 <code>e.preventDefault()</code> 方法</td>
</tr>
</tbody></table>
<p><img src="https://images.pingan8787.com/React/Synthetic-Event/Native-Event-VS-Synthetic-Event.png" alt="Native-Event-VS-Synthetic-Event.png"></p>
<h2 id="三、React-事件与原生事件执行顺序"><a href="#三、React-事件与原生事件执行顺序" class="headerlink" title="三、React 事件与原生事件执行顺序"></a>三、React 事件与原生事件执行顺序</h2><p>在 React 中，“合成事件”会以事件委托（<a target="_blank" rel="noopener" href="https://javascript.info/event-delegation">Event Delegation</a>）方式绑定在组件最上层，并在组件卸载（unmount）阶段自动销毁绑定的事件。这里我们手写一个简单示例来观察 React 事件和原生事件的执行顺序：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span>&lt;<span class="title">any</span>, <span class="title">any</span>&gt; </span>&#123;</span><br><span class="line">  <span class="attr">parentRef</span>: any;</span><br><span class="line">  childRef: any;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props: any</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(props);</span><br><span class="line">    <span class="built_in">this</span>.parentRef = React.createRef();</span><br><span class="line">    <span class="built_in">this</span>.childRef = React.createRef();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">componentDidMount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;React componentDidMount！&quot;</span>);</span><br><span class="line">    <span class="built_in">this</span>.parentRef.current?.addEventListener(<span class="string">&quot;click&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&quot;原生事件：父元素 DOM 事件监听！&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="built_in">this</span>.childRef.current?.addEventListener(<span class="string">&quot;click&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&quot;原生事件：子元素 DOM 事件监听！&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="built_in">document</span>.addEventListener(<span class="string">&quot;click&quot;</span>, <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&quot;原生事件：document DOM 事件监听！&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  parentClickFun = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;React 事件：父元素事件监听！&quot;</span>);</span><br><span class="line">  &#125;;</span><br><span class="line">  childClickFun = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;React 事件：子元素事件监听！&quot;</span>);</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">ref</span>=<span class="string">&#123;this.parentRef&#125;</span> <span class="attr">onClick</span>=<span class="string">&#123;this.parentClickFun&#125;</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">ref</span>=<span class="string">&#123;this.childRef&#125;</span> <span class="attr">onClick</span>=<span class="string">&#123;this.childClickFun&#125;</span>&gt;</span></span></span><br><span class="line"><span class="xml">          分析事件执行顺序</span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> App;</span><br></pre></td></tr></table></figure>

<p>触发事件后，可以看到控制台输出：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">原生事件：子元素 DOM 事件监听！ </span><br><span class="line">原生事件：父元素 DOM 事件监听！ </span><br><span class="line">React 事件：子元素事件监听！ </span><br><span class="line">React 事件：父元素事件监听！ </span><br><span class="line">原生事件：<span class="built_in">document</span> DOM 事件监听！ </span><br></pre></td></tr></table></figure>

<p>通过上面流程，我们可以理解：</p>
<ul>
<li>React 所有事件都挂载在 <code>document</code> 对象上；</li>
<li>当真实 DOM 元素触发事件，会冒泡到 <code>document</code> 对象后，再处理 React 事件；</li>
<li>所以会先执行原生事件，然后处理 React 事件；</li>
<li>最后真正执行 <code>document</code> 上挂载的事件。</li>
</ul>
<p><img src="https://images.pingan8787.com/React/Synthetic-Event/Native-Event-And-Synthetic-Event.png" alt="Native-Event-And-Synthetic-Event.png"></p>
<h2 id="四、合成事件的事件池"><a href="#四、合成事件的事件池" class="headerlink" title="四、合成事件的事件池"></a>四、合成事件的事件池</h2><h3 id="1-事件池介绍"><a href="#1-事件池介绍" class="headerlink" title="1. 事件池介绍"></a>1. 事件池介绍</h3><p>合成事件对象池，是 React 事件系统提供的一种<strong>性能优化方式</strong>。<strong>合成事件对象在事件池统一管理</strong>，<strong>不同类型的合成事件具有不同的事件池</strong>。</p>
<ul>
<li>当事件池未满时，React 创建新的事件对象，派发给组件。</li>
<li>当事件池装满时，React 从事件池中复用事件对象，派发给组件。</li>
</ul>
<p>关于“事件池是如何工作”的问题，可以看看下面图片：</p>
<p><img src="https://images.pingan8787.com/React/Synthetic-Event/Synthetic-Event-Loop.png" alt="Synthetic-Event-Loop.png"></p>
<p>（图片来自：ReactDeveloper <a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903862285893639">https://juejin.cn/post/6844903862285893639</a>）</p>
<h3 id="2-事件池分析（React-16-版本）"><a href="#2-事件池分析（React-16-版本）" class="headerlink" title="2. 事件池分析（React 16 版本）"></a>2. 事件池分析（React 16 版本）</h3><p><strong>React 事件池仅支持在 React 16 及更早版本中，在 React 17 已经不使用事件池</strong>。<br>下面以 React 16 版本为例：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleChange</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;原始数据：&quot;</span>, e.target)</span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;定时任务 e.target：&quot;</span>, e.target); <span class="comment">// null</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;定时任务：e：&quot;</span>, e); </span><br><span class="line">  &#125;, <span class="number">100</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;App&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;handleChange&#125;</span>&gt;</span>测试事件池<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> App;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以看到输出：<br><img src="https://images.pingan8787.com/React/Synthetic-Event/Synthetic-Event-React16.png" alt="Synthetic-Event-React16.png"></p>
<p>在 React 16 及之前的版本，合成事件对象的事件处理函数全部被调用之后，所有属性都会被置为 <code>null</code> 。这时，如果我们需要在事件处理函数运行之后获取事件对象的属性，可以使用 React 提供的 <code>e.persist()</code> 方法，保留所有属性：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 只修改 handleChange 方法，其他不变</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleChange</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 只增加 persist() 执行</span></span><br><span class="line">  e.persist();</span><br><span class="line">  </span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;原始数据：&quot;</span>, e.target)</span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;定时任务 e.target：&quot;</span>, e.target); <span class="comment">// null</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;定时任务：e：&quot;</span>, e); </span><br><span class="line">  &#125;, <span class="number">100</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再看下结果：</p>
<p><img src="https://images.pingan8787.com/React/Synthetic-Event/Synthetic-Event-React17.png" alt="Synthetic-Event-React17.png"></p>
<h3 id="3-事件池分析（React-17-版本）"><a href="#3-事件池分析（React-17-版本）" class="headerlink" title="3. 事件池分析（React 17 版本）"></a>3. 事件池分析（React 17 版本）</h3><p>由于 Web 端的 React 17 不使用事件池，所有不会存在上述“所有属性都会被置为 <code>null</code>”的问题。</p>
<h2 id="五、常见问题"><a href="#五、常见问题" class="headerlink" title="五、常见问题"></a>五、常见问题</h2><h3 id="1-React-事件中-this-指向问题"><a href="#1-React-事件中-this-指向问题" class="headerlink" title="1. React 事件中 this 指向问题"></a>1. React 事件中 this 指向问题</h3><p>在 React 中，JSX 回调函数中的 this 经常会出问题，在 Class 中方法不会默认绑定 this，就会出现下面情况， <code>this.funName</code> 值为 <code>undefined</code> ：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span>&lt;<span class="title">any</span>, <span class="title">any</span>&gt; </span>&#123;</span><br><span class="line">  childClickFun = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;React 事件&quot;</span>);</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="function"><span class="title">clickFun</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;React this 指向问题&quot;</span>, <span class="built_in">this</span>.childClickFun); <span class="comment">// undefined</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">onClick</span>=<span class="string">&#123;this.clickFun&#125;</span>&gt;</span>React this 指向问题<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> App;</span><br></pre></td></tr></table></figure>

<p>我们有 2 种方式解决这个问题：</p>
<ol>
<li>使用 <code>bind</code> 方法绑定 <code>this</code> ：</li>
</ol>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span>&lt;<span class="title">any</span>, <span class="title">any</span>&gt; </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props: any</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(props);</span><br><span class="line">    <span class="built_in">this</span>.clickFun = <span class="built_in">this</span>.clickFun.bind(<span class="built_in">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 省略其他代码</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> App;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>将需要使用 <code>this</code> 的方法改写为使用<strong>箭头函数</strong>定义：</li>
</ol>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span>&lt;<span class="title">any</span>, <span class="title">any</span>&gt; </span>&#123;</span><br><span class="line">  clickFun = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;React this 指向问题&quot;</span>, <span class="built_in">this</span>.childClickFun); <span class="comment">// undefined</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 省略其他代码</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> App;</span><br></pre></td></tr></table></figure>

<p>或者在回调函数中使用<strong>箭头函数</strong>：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span>&lt;<span class="title">any</span>, <span class="title">any</span>&gt; </span>&#123;</span><br><span class="line">  <span class="comment">// 省略其他代码</span></span><br><span class="line">  <span class="function"><span class="title">clickFun</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;React this 指向问题&quot;</span>, <span class="built_in">this</span>.childClickFun); <span class="comment">// undefined</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> this.clickFun()&#125;&gt;React this 指向问题<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> App;</span><br></pre></td></tr></table></figure>

<h3 id="2-向事件传递参数问题"><a href="#2-向事件传递参数问题" class="headerlink" title="2. 向事件传递参数问题"></a>2. 向事件传递参数问题</h3><p>经常在遍历列表时，需要向事件传递额外参数，如 <code>id</code> 等，来指定需要操作的数据，在 React 中，可以使用 2 种方式向事件传参：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> List = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>];</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span>&lt;<span class="title">any</span>, <span class="title">any</span>&gt; </span>&#123;</span><br><span class="line">  <span class="comment">// 省略其他代码</span></span><br><span class="line">  clickFun (id) &#123;<span class="built_in">console</span>.log(<span class="string">&#x27;当前点击：&#x27;</span>, id)&#125;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">        	<span class="tag">&lt;<span class="name">h1</span>&gt;</span>第一种：通过 bind 绑定 this 传参<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="xml">        	&#123;</span></span><br><span class="line"><span class="xml">          	List.map(item =&gt; <span class="tag">&lt;<span class="name">div</span> <span class="attr">onClick</span>=<span class="string">&#123;this.clickFun.bind(this,</span> <span class="attr">item</span>)&#125;&gt;</span>按钮：&#123;item&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span>)</span></span><br><span class="line"><span class="xml">          &#125;</span></span><br><span class="line"><span class="xml">        	<span class="tag">&lt;<span class="name">h1</span>&gt;</span>第二种：通过箭头函数绑定 this 传参<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="xml">        	&#123;</span></span><br><span class="line"><span class="xml">          	List.map(item =&gt; <span class="tag">&lt;<span class="name">div</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> this.clickFun(item)&#125;&gt;按钮：&#123;item&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span>)</span></span><br><span class="line"><span class="xml">          &#125;</span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> App;</span><br></pre></td></tr></table></figure>

<p>这两种方式是等价的：</p>
<ul>
<li>第一种通过 <code>Function.prototype.bind</code> 实现；</li>
<li>第二种通过<strong>箭头函数</strong>实现。</li>
</ul>
<h3 id="3-合成事件阻止冒泡"><a href="#3-合成事件阻止冒泡" class="headerlink" title="3. 合成事件阻止冒泡"></a>3. 合成事件阻止冒泡</h3><p>官网文档描述了：</p>
<blockquote>
<p>从 v0.14 开始，事件处理器返回 false 时，不再阻止事件传递。你可以酌情手动调用 e.stopPropagation() 或 e.preventDefault() 作为替代方案。</p>
</blockquote>
<p>也就是说，在 React 合成事件中，需要阻止冒泡时，可以使用 <code>e.stopPropagation()</code> 或 <code>e.preventDefault()</code>  方法来解决，另外还可以使用 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/Event/stopImmediatePropagation"><code>e.nativeEvent.stopImmediatePropagation()</code></a> 方法解决。</p>
<h4 id="3-1-e-stopPropagation"><a href="#3-1-e-stopPropagation" class="headerlink" title="3.1 e.stopPropagation"></a>3.1 e.stopPropagation</h4><p>对于开发者来说，更希望使用 <code>e.stopPropagation()</code> 方法来阻止当前 DOM 事件冒泡，但事实上，从前两节介绍的执行顺序可知，<code>e.stopPropagation()</code> 只能阻止合成事件间冒泡，即下层的合成事件，不会冒泡到上层的合成事件。事件本身还都是在 document 上执行。所以<strong>最多只能阻止 document 事件不能再冒泡到 window 上。</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span>&lt;<span class="title">any</span>, <span class="title">any</span>&gt; </span>&#123;</span><br><span class="line">  <span class="attr">parentRef</span>: <span class="built_in">any</span>;</span><br><span class="line">  childRef: <span class="built_in">any</span>;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props: <span class="built_in">any</span></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(props);</span><br><span class="line">    <span class="built_in">this</span>.parentRef = React.createRef();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">componentDidMount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.parentRef.current?.addEventListener(<span class="string">&quot;click&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&quot;阻止原生事件冒泡~&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="built_in">document</span>.addEventListener(<span class="string">&quot;click&quot;</span>, <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&quot;原生事件：document DOM 事件监听！&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  parentClickFun = <span class="function">(<span class="params">e: <span class="built_in">any</span></span>) =&gt;</span> &#123;</span><br><span class="line">    e.stopPropagation();</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;阻止合成事件冒泡~&quot;</span>);</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">ref</span>=<span class="string">&#123;this.parentRef&#125;</span> <span class="attr">onClick</span>=<span class="string">&#123;this.parentClickFun&#125;</span>&gt;</span></span></span><br><span class="line"><span class="xml">        点击测试“合成事件和原生事件是否可以混用”</span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> App;</span><br></pre></td></tr></table></figure>

<p>输出结果：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">阻止原生事件冒泡~ </span><br><span class="line">阻止合成事件冒泡~ </span><br></pre></td></tr></table></figure>

<h4 id="3-2-e-nativeEvent-stopImmediatePropagation"><a href="#3-2-e-nativeEvent-stopImmediatePropagation" class="headerlink" title="3.2 e.nativeEvent.stopImmediatePropagation"></a>3.2 e.nativeEvent.stopImmediatePropagation</h4><p>该方法可以<strong>阻止监听同一事件的其他事件监听器被调用</strong>。<br>在 React 中，一个组件只能绑定一个同类型的事件监听器，当重复定义时，后面的监听器会覆盖之前的。<br>事实上 nativeEvent 的 <code>stopImmediatePropagation</code>只能阻止绑定在 document 上的事件监听器。而合成事件上的 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/Event/stopImmediatePropagation"><code>e.nativeEvent.stopImmediatePropagation()</code></a>  能<strong>阻止合成事件不会冒泡到 document 上</strong>。</p>
<p>举一个实际案例：实现点击空白处关闭菜单的功能：<br>当菜单打开时，在 document 上动态注册事件，用来关闭菜单。</p>
<ul>
<li>点击菜单内部，由于不冒泡，会正常执行菜单点击。</li>
<li>点击菜单外部，执行document上事件，关闭菜单。</li>
</ul>
<p>在菜单关闭的一刻，在 document 上移除该事件，这样就不会重复执行该事件，浪费性能，也可以在 window 上注册事件，这样可以避开 document。<br>**</p>
<h3 id="4-合成事件和原生事件是否可以混用"><a href="#4-合成事件和原生事件是否可以混用" class="headerlink" title="4. 合成事件和原生事件是否可以混用"></a>4. 合成事件和原生事件是否可以混用</h3><p><strong>合成事件和原生事件最好不要混用</strong>。<br>原生事件中如果执行了<code>stopPropagation</code>方法，则会导致其他<code>React</code>事件失效。因为所有元素的事件将无法冒泡到<code>document</code>上。<br>通过前面介绍的两者事件执行顺序来看，所有的 React 事件都将无法被注册。通过代码一起看看：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span>&lt;<span class="title">any</span>, <span class="title">any</span>&gt; </span>&#123;</span><br><span class="line">  <span class="attr">parentRef</span>: <span class="built_in">any</span>;</span><br><span class="line">  childRef: <span class="built_in">any</span>;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props: <span class="built_in">any</span></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(props);</span><br><span class="line">    <span class="built_in">this</span>.parentRef = React.createRef();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">componentDidMount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.parentRef.current?.addEventListener(<span class="string">&quot;click&quot;</span>, <span class="function">(<span class="params">e: <span class="built_in">any</span></span>) =&gt;</span> &#123;</span><br><span class="line">    	e.stopPropagation();</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&quot;阻止原生事件冒泡~&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="built_in">document</span>.addEventListener(<span class="string">&quot;click&quot;</span>, <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&quot;原生事件：document DOM 事件监听！&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  parentClickFun = <span class="function">(<span class="params">e: <span class="built_in">any</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;阻止合成事件冒泡~&quot;</span>);</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">ref</span>=<span class="string">&#123;this.parentRef&#125;</span> <span class="attr">onClick</span>=<span class="string">&#123;this.parentClickFun&#125;</span>&gt;</span></span></span><br><span class="line"><span class="xml">        点击测试“合成事件和原生事件是否可以混用”</span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> App;</span><br></pre></td></tr></table></figure>

<p>输出结果：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">阻止原生事件冒泡~ </span><br></pre></td></tr></table></figure>


<p>好了，本文就写到这里，建议大家可以再回去看下官方文档<a target="_blank" rel="noopener" href="https://zh-hans.reactjs.org/docs/events.html">《合成事件》</a><a target="_blank" rel="noopener" href="https://zh-hans.reactjs.org/docs/handling-events.html">《事件处理》</a>章节理解，有兴趣的朋友也可以阅读源码<a target="_blank" rel="noopener" href="https://github.com/facebook/react/blob/75ab53b9e1de662121e68dabb010655943d28d11/packages/events/SyntheticEvent.js#L62">《React SyntheticEvent.js》</a>。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>最后在回顾下本文学习目标：</p>
<ol>
<li>合成事件的概念和作用；</li>
<li>合成事件与原生事件的 3 个区别；</li>
<li>合成事件与原生事件的执行顺序；</li>
<li>合成事件的事件池；</li>
<li>合成事件 4 个常见问题。</li>
</ol>
<p>你是否都清楚了？欢迎一起讨论学习。</p>
<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p>1.<a target="_blank" rel="noopener" href="https://juejin.im/post/6844904099004022797">《事件处理与合成事件（react）》</a><br>2.官方文档<a target="_blank" rel="noopener" href="https://zh-hans.reactjs.org/docs/events.html">《合成事件》</a><a target="_blank" rel="noopener" href="https://zh-hans.reactjs.org/docs/handling-events.html">《事件处理》</a><br>3.<a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903502729183239">《React合成事件和DOM原生事件混用须知》</a><br>4.<a target="_blank" rel="noopener" href="https://www.bilibili.com/read/cv2836048/">《React 合成事件系统之事件池》</a>  </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/01/30/221-%E3%80%90%E5%89%8D%E7%AB%AF%E6%8E%A2%E7%B4%A2%E3%80%91%E6%8E%A2%E7%B4%A2React%E5%90%88%E6%88%90%E4%BA%8B%E4%BB%B6/" data-id="ckts3ejz200ni4d9k328ydoz2" data-title="221-【前端探索】探索React合成事件" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/React/" rel="tag">React</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/" rel="tag">前端开发</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%89%8D%E7%AB%AF%E6%8E%A2%E7%B4%A2/" rel="tag">前端探索</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%8E%9F%E5%88%9B/" rel="tag">原创</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-220-【总结】21张图总结我的2020年" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/12/24/220-%E3%80%90%E6%80%BB%E7%BB%93%E3%80%9121%E5%BC%A0%E5%9B%BE%E6%80%BB%E7%BB%93%E6%88%91%E7%9A%842020%E5%B9%B4/" class="article-date">
  <time class="dt-published" datetime="2020-12-24T15:03:32.000Z" itemprop="datePublished">2020-12-24</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/12/24/220-%E3%80%90%E6%80%BB%E7%BB%93%E3%80%9121%E5%BC%A0%E5%9B%BE%E6%80%BB%E7%BB%93%E6%88%91%E7%9A%842020%E5%B9%B4/">220-【总结】21张图总结我的2020年</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <hr>
<table>
<thead>
<tr>
<th>Author</th>
<th>王平安</th>
</tr>
</thead>
<tbody><tr>
<td>E-mail</td>
<td><a href="mailto:&#112;&#105;&#110;&#x67;&#x61;&#x6e;&#56;&#55;&#56;&#x37;&#64;&#x71;&#x71;&#x2e;&#99;&#111;&#x6d;">&#112;&#105;&#110;&#x67;&#x61;&#x6e;&#56;&#55;&#56;&#x37;&#64;&#x71;&#x71;&#x2e;&#99;&#111;&#x6d;</a></td>
</tr>
<tr>
<td>博  客</td>
<td><a target="_blank" rel="noopener" href="http://www.pingan8787.com/">www.pingan8787.com</a></td>
</tr>
<tr>
<td>微  信</td>
<td>pingan8787</td>
</tr>
<tr>
<td>每日文章推荐</td>
<td><a target="_blank" rel="noopener" href="https://github.com/pingan8787/Leo_Reading/issues">https://github.com/pingan8787/Leo_Reading/issues</a></td>
</tr>
<tr>
<td>JS小册</td>
<td>js.pingan8787.com</td>
</tr>
</tbody></table>
<hr>
<p><img src="https://images.pingan8787.com/2020/cover-haicang.png" alt="海沧湾公园.png"></p>
<blockquote>
<p>生活不可能像你想象的那么好，但也不会像你想象的那么糟。我觉得人的脆弱和坚强都超乎自己的想像，有时我脆弱得一句话就泪流满面，有时又发现自己咬着牙走了很长的路。</p>
</blockquote>
<p>回看 2020，我更加喜爱这句话了，每个小句子都有了不同味道。</p>
<h2 id="一、再见-2020-👋"><a href="#一、再见-2020-👋" class="headerlink" title="一、再见 2020 👋"></a>一、再见 2020 👋</h2><p>2020疫情复工后，我便开始进入“战斗模式”，深受公众号“全栈修仙之路”作者“<a target="_blank" rel="noopener" href="https://juejin.cn/user/764915822103079">阿宝哥</a>”影响🌟，开始把更多时间和精力用来修炼自身，努力成长和进阶，成为一位“靠谱的人”和一名“T 型人才”。</p>
<ul>
<li>靠谱的人：让自己靠谱，让别人放心；</li>
<li>T 型人才：深挖知识深度，拓展知识广度。</li>
</ul>
<p>（以下数据统计的时间，全部以 2020-12-19 日截止）</p>
<p>🤗🤗🤗</p>
<h3 id="1-走过的路"><a href="#1-走过的路" class="headerlink" title="1. 走过的路"></a>1. 走过的路</h3><p>疫情期间为了不给国家添麻烦，咱就天天家里窝着，闲来无事就给“貔貅”拍拍照啥的😎。</p>
<p><img src="https://images.pingan8787.com/2020/2020-pixiu.png" alt="貔貅"></p>
<p>复工后，骑上我的“绿豆”去了好多地方（快把厦门岛逛透透了），算是把疫情期间没去玩的地方都补上了🤠。</p>
<p><img src="https://images.pingan8787.com/2020/2020-bike.png" alt="骑行.png"></p>
<p>还有这杯意义不同的咖啡，和一句“心之所在即为家”😜。</p>
<p><img src="https://images.pingan8787.com/2020/2020-coffe.png" alt="星巴克的味道"></p>
<p>当然，除了玩，这一年也做了很多重要的事情😊。</p>
<p>2020 年，写了很多文章（包含未发布），基本都放在语雀上。数一数，将近 <strong>150</strong> 篇文档是在 2020 年完成的🤔。</p>
<p><img src="https://images.pingan8787.com/2020/2020-yuque.png" alt="语雀"></p>
<p>除了文章，我也画了很多图，慢慢形成自己的画图风格。</p>
<p><img src="https://images.pingan8787.com/2020/2020-draw.png" alt="画图"></p>
<p>当然，代码还是少不了的😎。</p>
<p>程序员嘛，当然要看看代码提交次数，这一年提交了这些代码，感觉 <a target="_blank" rel="noopener" href="https://github.com/pingan8787">Github</a> + Gitlab + <a target="_blank" rel="noopener" href="https://gitee.com/pingan8787">Gitee</a> 三个提交记录合并一下，都快铺满了。</p>
<ol>
<li>Github 提交记录</li>
</ol>
<p><img src="https://images.pingan8787.com/2020/2020-github.png" alt="gitlab 提交记录.png"></p>
<ol start="2">
<li>Gitlab 提交记录</li>
</ol>
<p><img src="https://images.pingan8787.com/2020/2020-gitlab.png" alt="gitlab 提交记录.png"></p>
<ol start="3">
<li>Gitee（码云） 提交记录</li>
</ol>
<p><img src="https://images.pingan8787.com/2020/2020-gitee.png" alt="gitlab 提交记录.png"></p>
<p>另外自己的微信公众号“前端自习课”也完成“<strong>连续推送 810+ 天</strong>”的成绩，这一年，我也玩起短视频，视频号了，也开始自己做动画，将一些知识点通过动画和大家分享，视频可以查看<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/1s4_WXCZscB6MXsVP3lbzQ">《1分钟了解 Axios 拦截器实现原理》</a>。</p>
<p><img src="https://images.pingan8787.com/2020/2020-video.png" alt="1分钟了解 Axios 拦截器实现原理"></p>
<p>2020 这一年还有很多事情想和大家分享，考虑到本文主旨和内容篇幅，就不再多介绍咯～有兴趣的朋友欢迎私聊我（微信：pingan8787）💘。</p>
<h3 id="2-感谢的人"><a href="#2-感谢的人" class="headerlink" title="2. 感谢的人"></a>2. 感谢的人</h3><p>今年最需要感谢的，是<strong>阿宝哥</strong>和我们“<strong>前端突击队</strong>”<strong>学习小组</strong>的每位小伙伴啦💐～</p>
<p>🌰最大感受是：原来前端还能这样玩！<br>🌰最开心的是：团队学习更有动力，你不是一个人在战斗！</p>
<p>在阿宝哥指导下，整理了一份自己的前端技能树，才知道自己的前端技能有几斤几两重，也才有更多动力和更清晰的方向。</p>
<p><img src="https://images.pingan8787.com/2020/2020-knowledge.png" alt="前端技能树"></p>
<p>在我们学习小组中，采用“<strong>专题学习 + 总结输出</strong>”的方式一起学习，目前已经沉淀 **200+ **篇文章啦！<br>小组目前 7 人（不含班主任），平均下来每人将近写了 30+ 篇！为小伙伴们点赞👍~</p>
<p><img src="https://images.pingan8787.com/2020/2020-study.png" alt="学习小组"></p>
<p>2020 年 11 月的某一天，思考了最近学习的知识和接下来的需要做的事情，于是有了下面的这篇字数少，内容多的笔记（用手机敲的，就是有点手酸🙁）：</p>
<p><img src="https://images.pingan8787.com/2020/2020-learn.png" alt="学习总结"></p>
<p>慢慢的，越来越发现，学得越多，发现自己要学的越多。🤣</p>
<p>这里再次感谢阿宝哥，感谢“前端突击队”的小伙伴们。未来继续冲🦆！</p>
<h3 id="3-遗憾的事"><a href="#3-遗憾的事" class="headerlink" title="3. 遗憾的事"></a>3. 遗憾的事</h3><p>这一年，比较遗憾的事，是自己与阿里插肩而过呀🥺～倒也让我发现更多不足。</p>
<p><img src="https://images.pingan8787.com/2020/2020-sad.png" alt="遗憾的事"></p>
<p>这里也非常感谢内推的小伙伴，还有几位面试官，人都挺不错。😃</p>
<p>我们闽南人嘛，喜欢“爱拼才会赢”，所以，趁年轻多拼多创。</p>
<h3 id="4-点赞的事"><a href="#4-点赞的事" class="headerlink" title="4. 点赞的事"></a>4. 点赞的事</h3><p>这一年为自己坚持的几件事情点赞~<br>①自己微信公众号“前端自习课”连续推送 810+ 天文章，为此我把所有文章分类做了一张词云图，如下:</p>
<p><img src="https://images.pingan8787.com/2020/2020-fe-study.png" alt="前端自习课"></p>
<p>可以看出，我主要分享的内容包括：“JS”、“CSS”、“拓展”和“Web技术”。🔔</p>
<p>②自己坚持的每月学习文章整理，也超过 40+ 个月了，截图如下：</p>
<p>详细请看 github 地址：<a target="_blank" rel="noopener" href="https://github.com/pingan8787/Leo_Reading">https://github.com/pingan8787/Leo_Reading</a></p>
<p><img src="https://images.pingan8787.com/2020/2020-github-study.png" alt="github 学习记录"></p>
<h2 id="二、你好-2021-👏"><a href="#二、你好-2021-👏" class="headerlink" title="二、你好 2021 👏"></a>二、你好 2021 👏</h2><p>2021 年即将到来，希望新的一年，每一个“下次一定”都能实现完成承诺。</p>
<p>⚽️⚽️⚽️</p>
<h3 id="1-加油，前端工程师"><a href="#1-加油，前端工程师" class="headerlink" title="1. 加油，前端工程师"></a>1. 加油，前端工程师</h3><p>在这前端生涯的第五年伊始，回想自己踩过的坑，走过的弯路，才慢慢领悟自己的前端生涯应该如何去走。</p>
<p>曾经和多数人一样，时常迷失学习什么知识，看到什么火，就去学什么，到头来，效果并不好。</p>
<p>未来自己的前端生涯，更应该站在巨人肩膀上，看向更远的地方。定个小目标呗，早日晋升技术专家。</p>
<p>接下来的时间里，做好自己在工作中的身份，做一个优秀的前端工程师。</p>
<p><img src="https://images.pingan8787.com/2020/2021-zhuomian.png" alt="桌面"></p>
<h3 id="2-加油，小儿子"><a href="#2-加油，小儿子" class="headerlink" title="2. 加油，小儿子"></a>2. 加油，小儿子</h3><p>作为家中最小的孩子，被催婚已经成为这一年的常事，哈哈。</p>
<p>也许性格如此，加上独自在外工作，每天只想把事情做得更好，学更多知识，提升自己的价值。</p>
<p>很幸运这一年遇到了女孩 C。</p>
<p>接下来的时间里，做好自己在家里的身份，做一个让父母放心的好儿子。</p>
<p><img src="https://images.pingan8787.com/2020/2021-wudian.png" alt="五店市.png"></p>
<h3 id="3-加油，骑行侠"><a href="#3-加油，骑行侠" class="headerlink" title="3. 加油，骑行侠"></a>3. 加油，骑行侠</h3><p>我这人，兴趣爱好不太多，比如：骑行🚴、足球⚽️、敲代码💻。</p>
<p>骑行让我如此着迷。</p>
<p>换上衣服，12 月的寒风，也依然无法阻挡我的脚步。</p>
<p>接下来的时间里，坚持自己的热爱，做一个勇往直前大胆创的闽南人。</p>
<p><img src="https://images.pingan8787.com/2020/2021-bike.png" alt="寒风.png"></p>
<h3 id="4-加油，前端自习课"><a href="#4-加油，前端自习课" class="headerlink" title="4. 加油，前端自习课"></a>4. 加油，前端自习课</h3><p>运营公众号“前端自习课”以后，认识了许多小伙伴，看见了许多从前的自己。</p>
<p>后来也慢慢和大家分享一些自己的经验和经历。</p>
<p>深刻记得，我简历中最后一句话：“希望自己的成⻓之路能帮助更多人，也希望在这个世界留下自己的一些足迹”。</p>
<p>接下来的时间里，坚持自己的初心，做一个对这个社区、这个社会有帮助的人。<br><img src="https://images.pingan8787.com/2020/2021-zhihu.png" alt="zhihu.png"></p>
<h2 id="三、总结"><a href="#三、总结" class="headerlink" title="三、总结"></a>三、总结</h2><p>每一年的总结，都是五味杂陈，才发现这一年来，自己又进步和成长了。</p>
<p>回顾篇头的一句话：“有时又发现自己咬着牙走了很长的路”。有时候一瞬间，一个偶然，发现自己原来咬着牙前进这么久，改变这么多。</p>
<p>最后，再思考一句话，希望对大家能有不同感受：</p>
<blockquote>
<p>除去睡眠，人的一生有一万多天。但是人与人之间的区别就在于，你究竟是活了一万多天，还是仅仅活了一天，却重复了一万多次。</p>
</blockquote>
<p>希望未来的我们，会感到自己的每一天都是崭新的。<br><img src="https://images.pingan8787.com/2020/2021-wulei.JPG" alt="武磊"><br>像武磊一样努力，加油！</p>
<p>最后欢迎关注我呀~<br><a target="_blank" rel="noopener" href="http://www.pingan8787.com/"><img src="http://images.pingan8787.com/icon_my1.png" alt="博客"></a><a target="_blank" rel="noopener" href="https://www.yuque.com/wangpingan/cute-frontend"><img src="http://images.pingan8787.com/assets/icon_26_yuque.png" alt="语雀"></a><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/cute-javascript"><img src="http://images.pingan8787.com/icon_zhihu1.png" alt="知乎"></a><a target="_blank" rel="noopener" href="https://juejin.im/user/586fc337a22b9d0058807d53/posts"><img src="http://images.pingan8787.com/icon_juejin2.png" alt="掘金"></a><a target="_blank" rel="noopener" href="https://segmentfault.com/blog/pingan8787"><img src="http://images.pingan8787.com/icon_sf1.png" alt="思否"></a><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_36380426"><img src="http://images.pingan8787.com/icon_csdn1.png" alt="CSDN"></a><a target="_blank" rel="noopener" href="https://www.jianshu.com/u/2ec5d94afd60"><img src="http://images.pingan8787.com/icon_jianshu1.png" alt="简书"></a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/12/24/220-%E3%80%90%E6%80%BB%E7%BB%93%E3%80%9121%E5%BC%A0%E5%9B%BE%E6%80%BB%E7%BB%93%E6%88%91%E7%9A%842020%E5%B9%B4/" data-id="ckts3ejuc006d4d9khq43dcb2" data-title="220-【总结】21张图总结我的2020年" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%80%BB%E7%BB%93/" rel="tag">总结</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-219-【Express】我为Express开了外挂" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/10/10/219-%E3%80%90Express%E3%80%91%E6%88%91%E4%B8%BAExpress%E5%BC%80%E4%BA%86%E5%A4%96%E6%8C%82/" class="article-date">
  <time class="dt-published" datetime="2020-10-10T14:03:00.000Z" itemprop="datePublished">2020-10-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/10/10/219-%E3%80%90Express%E3%80%91%E6%88%91%E4%B8%BAExpress%E5%BC%80%E4%BA%86%E5%A4%96%E6%8C%82/">219-【Express】我为Express开了外挂</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <blockquote>
<p>本项目源码地址：<br><a target="_blank" rel="noopener" href="https://github.com/pingan8787/Leo-JavaScript/blob/master/Cute-Gist/LearnSource/OvernightDemo/">https://github.com/pingan8787/Leo-JavaScript/blob/master/Cute-Gist/LearnSource/OvernightDemo/</a></p>
</blockquote>
<p>随着 Nodejs 在前端涉及领域越来越广，也越来越成熟，相信很多朋友已经尝试或使用过 Nodejs 开发服务端项目了。<br>本文我将和大家一起回顾 Express，然后介绍一个超级外挂——<strong>OvernightJS</strong>，它强大的地方在于，它将为 Express 路由提供 TypeScript 装饰器支持，使得我们开发路由更加简单，代码复用性更好。<br>这里也希望帮助大家对 TypeScript 的装饰器有更深了解。</p>
<p>接下来跟本文主角 Leo 一起来看看这个外挂吧~</p>
<h1 id="一、背景介绍"><a href="#一、背景介绍" class="headerlink" title="一、背景介绍"></a>一、背景介绍</h1><p>最近 Leo 打算使用 <a target="_blank" rel="noopener" href="http://expressjs.com/">Express</a> 来开始重构自己博客的服务端项目，经过认真研究和设计，并确定完方案，Leo 开始下手啦：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app.ts</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> express, &#123; Application, Request, Response &#125; <span class="keyword">from</span> <span class="string">&#x27;express&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app: Application = express();</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">req: Request, res: Response</span>) =&gt;</span> &#123;</span><br><span class="line">  res.send(<span class="string">&#x27;Hello World!&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>, <span class="function">()=&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;Example app listening on port 3000!&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>其中 tsconfig.json 配置如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;compilerOptions&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;target&quot;</span>: <span class="string">&quot;es6&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;module&quot;</span>: <span class="string">&quot;commonjs&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;strict&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">		<span class="attr">&quot;esModuleInterop&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">&quot;experimentalDecorators&quot;</span>: <span class="literal">true</span>, <span class="comment">// 开启装饰器</span></span><br><span class="line">    <span class="attr">&quot;emitDecoratorMetadata&quot;</span>: <span class="literal">true</span>,  <span class="comment">// 开启元编程</span></span><br><span class="line">    <span class="attr">&quot;skipLibCheck&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">&quot;forceConsistentCasingInFileNames&quot;</span>: <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>基本代码写完，测试能不能跑起来。<br>Leo 在命令行使用 <code>ts-node</code> 命令行执行。（<a target="_blank" rel="noopener" href="https://www.npmjs.com/package/ts-node">ts-node</a> 用来直接运行 ts 文件，详细介绍请查看文档，这里不细讲咯）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ts-node app.ts</span><br></pre></td></tr></table></figure>
<p>看到命令行输出：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Example app listening on port 3000!</span><br></pre></td></tr></table></figure>
<p>服务跑起来了，心情愉快。<br>接下来 Leo 使用 Express 的路由方法写了其他接口：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app.ts</span></span><br><span class="line"></span><br><span class="line">app.get(<span class="string">&#x27;/article&#x27;</span>, <span class="function">(<span class="params">req: Request, res: Response</span>) =&gt;</span> &#123;res.send(<span class="string">&#x27;Hello get!&#x27;</span>)&#125;);</span><br><span class="line">app.post(<span class="string">&#x27;/article&#x27;</span>, <span class="function">(<span class="params">req: Request, res: Response</span>) =&gt;</span> &#123;res.send(<span class="string">&#x27;Hello post!&#x27;</span>)&#125;);</span><br><span class="line">app.put(<span class="string">&#x27;/article&#x27;</span>, <span class="function">(<span class="params">req: Request, res: Response</span>) =&gt;</span> &#123;res.send(<span class="string">&#x27;Hello put!&#x27;</span>)&#125;);</span><br><span class="line">app.delete(<span class="string">&#x27;/article&#x27;</span>, <span class="function">(<span class="params">req: Request, res: Response</span>) =&gt;</span> &#123;res.send(<span class="string">&#x27;Hello delete!&#x27;</span>)&#125;);</span><br><span class="line">app.get(<span class="string">&#x27;/article/list&#x27;</span>, <span class="function">(<span class="params">req: Request, res: Response</span>) =&gt;</span> &#123;res.send(<span class="string">&#x27;Hello article/list!&#x27;</span>)&#125;);</span><br><span class="line"><span class="comment">// ... 等等其他接口</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>Express 路由方法派生自 HTTP 方法之一，附加到 express 类的实例。 支持对应于 HTTP 方法的以下路由方法：get、post、put、head、delete、options等等。</p>
</blockquote>
<p>同事 Robin 看了看代码，问到：<br><img src="http://images.pingan8787.com/JavaScript-Base/Learn-Overnight-Source/Overnight-Learn-1.png" alt="Overnight-Learn-1.png"></p>
<p>随着接口越写越多，代码不免出现复杂和冗余的情况，为了解决这个问题，Leo 引入 Express 的 <code>Router()</code> ，来创建<strong>可安装的模块化路由处理程序</strong>。Router 实例是<strong>完整的中间件</strong>和<strong>路由系统</strong>。因此，常常将其称为“<strong>微型应用程序</strong>”。</p>
<p>Leo 新建文件 <code>app.router.ts</code> ，重新实现上面接口：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app.router.ts</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> express, &#123; Router, Request, Response &#125; <span class="keyword">from</span> <span class="string">&#x27;express&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> router: Router = express.Router();</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">req: Request, res: Response</span>) =&gt;</span> &#123;res.send(<span class="string">&#x27;Hello get!&#x27;</span>)&#125;);</span><br><span class="line">router.post(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">req: Request, res: Response</span>) =&gt;</span> &#123;res.send(<span class="string">&#x27;Hello post!&#x27;</span>)&#125;);</span><br><span class="line">router.put(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">req: Request, res: Response</span>) =&gt;</span> &#123;res.send(<span class="string">&#x27;Hello put!&#x27;</span>)&#125;);</span><br><span class="line">router.delete(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">req: Request, res: Response</span>) =&gt;</span> &#123;res.send(<span class="string">&#x27;Hello delete!&#x27;</span>)&#125;);</span><br><span class="line">router.get(<span class="string">&#x27;/user&#x27;</span>, <span class="function">(<span class="params">req: Request, res: Response</span>) =&gt;</span> &#123;res.send(<span class="string">&#x27;Hello api/user!&#x27;</span>)&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> router;</span><br></pre></td></tr></table></figure>
<p>接着在 app.ts 中使用，由于<a target="_blank" rel="noopener" href="http://expressjs.com/zh-cn/4x/api.html#router"><code>express.Router()</code> </a>是个中间件，因此可以使用 <code>app.use()</code> 来使用：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app.ts</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 删除原来路由声明</span></span><br><span class="line"><span class="keyword">import</span> router <span class="keyword">from</span> <span class="string">&quot;../controller/app.router&quot;</span>;</span><br><span class="line">app.use(<span class="string">&#x27;/api&#x27;</span>, router);</span><br></pre></td></tr></table></figure>
<p>这里 <code>app.use</code> 第一个参数 <code>/api</code> 表示这一组路由对象的根路径，第二个参数 <code>router</code> 表示一组路由对象。 </p>
<p>于是就实现了下面 API 接口：</p>
<ul>
<li><code>/api</code></li>
<li><code>/api/user</code></li>
</ul>
<p>确定所有接口正常运行后，Leo 琢磨着，既然 Express 每个路由都是由<strong>路由名称</strong>和<strong>路由处理方法</strong>组成，那为什么不能给 Express 加个外挂？为每个路由添加装饰器来装饰。<br>幸运的是，已经有大佬实现这个外挂了，它就是今天主角——<a target="_blank" rel="noopener" href="https://github.com/seanpmaxwell/overnight">OvernightJS</a>。<br>下面一起看看这个很棒的 OvernightJS 吧。</p>
<h1 id="二、基础知识介绍"><a href="#二、基础知识介绍" class="headerlink" title="二、基础知识介绍"></a>二、基础知识介绍</h1><p><img src="http://images.pingan8787.com/JavaScript-Base/Learn-Overnight-Source/Overnight-Learn-2.png" alt="Overnight-Learn-2.png"><br>在开始介绍 Overnight 之前，我们先回顾下“装饰器”和“Reflect”：</p>
<h2 id="1-装饰器"><a href="#1-装饰器" class="headerlink" title="1. 装饰器"></a>1. 装饰器</h2><h3 id="1-1-什么是装饰器？"><a href="#1-1-什么是装饰器？" class="headerlink" title="1.1 什么是装饰器？"></a>1.1 什么是装饰器？</h3><p>TypeScript 中，装饰器（Decorators）是一种特殊类型的声明，它能够被附加到类声明、方法、访问符、属性或参数上，<strong>本质上还是个函数</strong>。<br>装饰器为我们在类的声明及成员上通过<strong>元编程语法</strong>添加标注提供了一种方式。</p>
<p>需要记住这几点：</p>
<ul>
<li>装饰器是一个声明（表达式）；</li>
<li>该表达式被执行后，<strong>返回一个函数</strong>；</li>
<li>函数的入参分别为 <code>target</code>、<code>name</code> 和 <code>descriptor</code>；</li>
<li>执行该函数后，可能返回 <code>descriptor</code> 对象，用于配置 <code>target</code> 对象；</li>
</ul>
<p>更多装饰器详细介绍，请阅读文档<a target="_blank" rel="noopener" href="https://www.tslang.cn/docs/handbook/decorators.html">《TypeScript 装饰器》</a>。</p>
<h3 id="1-2-装饰器分类"><a href="#1-2-装饰器分类" class="headerlink" title="1.2 装饰器分类"></a>1.2 装饰器分类</h3><p>装饰器一般包括：</p>
<ul>
<li>类装饰器（Class decorators）；</li>
<li>属性装饰器（Property decorators）；</li>
<li>方法装饰器（Method decorators）；</li>
<li>参数装饰器（Parameter decorators）；</li>
</ul>
<h3 id="1-3-示例代码"><a href="#1-3-示例代码" class="headerlink" title="1.3 示例代码"></a>1.3 示例代码</h3><p>这里以类装饰器（Class decorators）为例，介绍如何使用装饰器：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">MyDecorators</span>(<span class="params">target: <span class="built_in">Function</span></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  target.prototype.say = <span class="function"><span class="keyword">function</span> (<span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;Hello 前端自习课!&quot;</span>);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@MyDecorators</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LeoClass</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params"></span>)</span> &#123;&#125;</span><br><span class="line">  <span class="function"><span class="title">say</span>(<span class="params"></span>)</span>&#123;<span class="built_in">console</span>.log(<span class="string">&quot;Hello Leo&quot;</span>)&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> leo = <span class="keyword">new</span> LeoClass();</span><br><span class="line">leo.say(); </span><br><span class="line"><span class="comment">// &#x27;Hello Leo!&#x27;;</span></span><br></pre></td></tr></table></figure>

<h3 id="1-4-编译结果"><a href="#1-4-编译结果" class="headerlink" title="1.4 编译结果"></a>1.4 编译结果</h3><p>装饰器实际上非常简单，编译出来以后，只是个函数，我们接着看。<br>这里以《1.3 示例代码》为例，看看它的编译结果：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> __decorate = (<span class="built_in">this</span> &amp;&amp; <span class="built_in">this</span>.__decorate) || <span class="function"><span class="keyword">function</span> (<span class="params">decorators, target, key, desc</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> c = <span class="built_in">arguments</span>.length, r = c &lt; <span class="number">3</span> ? target : desc === <span class="literal">null</span> ? desc = <span class="built_in">Object</span>.getOwnPropertyDescriptor(target, key) : desc, d;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="built_in">Reflect</span> === <span class="string">&quot;object&quot;</span> &amp;&amp; <span class="keyword">typeof</span> <span class="built_in">Reflect</span>.decorate === <span class="string">&quot;function&quot;</span>) r = <span class="built_in">Reflect</span>.decorate(decorators, target, key, desc);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">for</span> (<span class="keyword">var</span> i = decorators.length - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) <span class="keyword">if</span> (d = decorators[i]) r = (c &lt; <span class="number">3</span> ? d(r) : c &gt; <span class="number">3</span> ? d(target, key, r) : d(target, key)) || r;</span><br><span class="line">    <span class="keyword">return</span> c &gt; <span class="number">3</span> &amp;&amp; r &amp;&amp; <span class="built_in">Object</span>.defineProperty(target, key, r), r;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> __metadata = (<span class="built_in">this</span> &amp;&amp; <span class="built_in">this</span>.__metadata) || <span class="function"><span class="keyword">function</span> (<span class="params">k, v</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="built_in">Reflect</span> === <span class="string">&quot;object&quot;</span> &amp;&amp; <span class="keyword">typeof</span> <span class="built_in">Reflect</span>.metadata === <span class="string">&quot;function&quot;</span>) <span class="keyword">return</span> <span class="built_in">Reflect</span>.metadata(k, v);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">MyDecorators</span>(<span class="params">target</span>) </span>&#123;</span><br><span class="line">    target.prototype.say = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;Hello 前端自习课!&quot;</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> LeoClass = <span class="class"><span class="keyword">class</span> <span class="title">LeoClass</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params"></span>)</span> &#123; &#125;</span><br><span class="line">    <span class="function"><span class="title">say</span>(<span class="params"></span>)</span> &#123; <span class="built_in">console</span>.log(<span class="string">&quot;Hello Leo&quot;</span>); &#125;</span><br><span class="line">&#125;;</span><br><span class="line">LeoClass = __decorate([</span><br><span class="line">    MyDecorators,</span><br><span class="line">    __metadata(<span class="string">&quot;design:paramtypes&quot;</span>, [])</span><br><span class="line">], LeoClass);</span><br><span class="line"><span class="keyword">let</span> leo = <span class="keyword">new</span> LeoClass();</span><br><span class="line">leo.say();</span><br><span class="line"><span class="comment">// &#x27;Hello Leo!&#x27;;</span></span><br></pre></td></tr></table></figure>
<p>其实就是 <code>__decorate</code> 函数啦，具体大家可以自行细看咯~<br>从编译后 JS 代码中可以看出，<strong>装饰器是在模块导入时便执行的</strong>。如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">LeoClass = __decorate([</span><br><span class="line">    MyDecorators,</span><br><span class="line">    __metadata(<span class="string">&quot;design:paramtypes&quot;</span>, [])</span><br><span class="line">], LeoClass);</span><br></pre></td></tr></table></figure>



<h3 id="1-5-小结"><a href="#1-5-小结" class="headerlink" title="1.5 小结"></a>1.5 小结</h3><p>接下来通过下图来回顾装饰器的知识。<br><img src="http://images.pingan8787.com/JavaScript-Base/Learn-Overnight-Source/Decorator-Introduce.png" alt="Decorator-Introduce.png"></p>
<h2 id="2-Reflect-Metadata-API"><a href="#2-Reflect-Metadata-API" class="headerlink" title="2. Reflect Metadata API"></a>2. Reflect Metadata API</h2><h3 id="2-1-什么是-Reflect-？"><a href="#2-1-什么是-Reflect-？" class="headerlink" title="2.1 什么是 Reflect ？"></a>2.1 什么是 Reflect ？</h3><p>Reflect（即反射）是 ES6 新增的一个<strong>内置对象</strong>，它提供用来<strong>拦截和操作</strong> JavaScript 对象的 API。并且 <strong>Reflect 的所有属性和方法都是静态的</strong>，就像 Math 对象（ <code>Math.random()</code> 等）。</p>
<p>更多 Reflect 详细介绍，请阅读文档<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Reflect">《MDN Reflect》</a>。</p>
<h3 id="2-2-为什么出现-Reflect？"><a href="#2-2-为什么出现-Reflect？" class="headerlink" title="2.2 为什么出现 Reflect？"></a>2.2 为什么出现 Reflect？</h3><p>其核心目的，是为了保持 JS 的简单，让我们可以不用写很多代码，这里举个栗子🌰，看看有使用 Reflect 和没使用有什么区别：<br>当对象里有 <code>Symbol</code> 时，如何遍历对象的 <code>keys</code>？</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> s = <span class="built_in">Symbol</span>(<span class="string">&#x27;foo&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> k = <span class="string">&#x27;bar&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> o = &#123; [s]: <span class="number">1</span>, [k]: <span class="number">1</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 没有使用 Reflect</span></span><br><span class="line"><span class="keyword">const</span> keys = <span class="built_in">Object</span>.getOwnPropertyNames(o).concat(<span class="built_in">Object</span>.getOwnPropertySymbols(o));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 Reflect</span></span><br><span class="line"><span class="built_in">Reflect</span>.ownKeys(o);</span><br></pre></td></tr></table></figure>
<p>这看起来是不是简单多了？</p>
<p>更多 <code>Reflect</code> 详细介绍，请阅读文档<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Reflect">《MDN Reflect》</a>。</p>
<h3 id="2-3-什么是-Reflect-Metadata"><a href="#2-3-什么是-Reflect-Metadata" class="headerlink" title="2.3 什么是 Reflect Metadata"></a>2.3 什么是 Reflect Metadata</h3><p>Reflect Metadata 是 ES7 的一个提案，它主要用来<strong>在声明的时添加和读取元数据</strong>。TypeScript 在 1.5+ 的版本已经支持它，你只需要：</p>
<ul>
<li><code>npm i reflect-metadata --save</code>。</li>
<li>在 <code>tsconfig.json</code> 里配置 <code>emitDecoratorMetadata</code> 选项。</li>
</ul>
<p>Reflect Metadata 可以当做装饰器使用，有两个 API：</p>
<ul>
<li>使用 <code>Reflect.metadata()</code> API <strong>添加元数据</strong>；</li>
<li>使用 <code>Reflect.getMetadata()</code> API <strong>读取元数据</strong>。<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@<span class="built_in">Reflect</span>.metadata(<span class="string">&#x27;inClass&#x27;</span>, <span class="string">&#x27;A&#x27;</span>)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LearnReflect</span> </span>&#123;</span><br><span class="line">  @<span class="built_in">Reflect</span>.metadata(<span class="string">&#x27;inMethod&#x27;</span>, <span class="string">&#x27;B&#x27;</span>)</span><br><span class="line">  public hello(): string &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;hello world&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">Reflect</span>.getMetadata(<span class="string">&#x27;inClass&#x27;</span>, LearnReflect)); <span class="comment">// &#x27;A&#x27;</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">Reflect</span>.getMetadata(<span class="string">&#x27;inMethod&#x27;</span>, <span class="keyword">new</span> LearnReflect(), <span class="string">&#x27;hello&#x27;</span>)); <span class="comment">// &#x27;B&#x27;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>当然 <code>Reflect</code> 提供很多其他 API：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;reflect-metadata&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义对象或属性的元数据</span></span><br><span class="line"><span class="built_in">Reflect</span>.defineMetadata(metadataKey, metadataValue, target);</span><br><span class="line"><span class="built_in">Reflect</span>.defineMetadata(metadataKey, metadataValue, target, propertyKey);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查对象或属性的原型链上是否存在元数据键</span></span><br><span class="line"><span class="keyword">let</span> result = <span class="built_in">Reflect</span>.hasMetadata(metadataKey, target);</span><br><span class="line"><span class="keyword">let</span> result = <span class="built_in">Reflect</span>.hasMetadata(metadataKey, target, propertyKey);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查对象或属性是否存在自己的元数据键</span></span><br><span class="line"><span class="keyword">let</span> result = <span class="built_in">Reflect</span>.hasMetadata(metadataKey, target);</span><br><span class="line"><span class="keyword">let</span> result = <span class="built_in">Reflect</span>.hasMetadata(metadataKey, target, propertyKey);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取对象或属性原型链上元数据键的元数据值</span></span><br><span class="line"><span class="keyword">let</span> result = <span class="built_in">Reflect</span>.getMetadata(metadataKey, target);</span><br><span class="line"><span class="keyword">let</span> result = <span class="built_in">Reflect</span>.getMetadata(metadataKey, target, propertyKey);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取对象或属性的自己的元数据键的元数据值</span></span><br><span class="line"><span class="keyword">let</span> result = <span class="built_in">Reflect</span>.getOwnMetadata(metadataKey, target);</span><br><span class="line"><span class="keyword">let</span> result = <span class="built_in">Reflect</span>.getOwnMetadata(metadataKey, target, propertyKey);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取对象或属性原型链上的所有元数据键</span></span><br><span class="line"><span class="keyword">let</span> result = <span class="built_in">Reflect</span>.getMetadataKeys(target);</span><br><span class="line"><span class="keyword">let</span> result = <span class="built_in">Reflect</span>.getMetadataKeys(target, propertyKey);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取对象或属性的所有自己的元数据键</span></span><br><span class="line"><span class="keyword">let</span> result = <span class="built_in">Reflect</span>.getOwnMetadataKeys(target);</span><br><span class="line"><span class="keyword">let</span> result = <span class="built_in">Reflect</span>.getOwnMetadataKeys(target, propertyKey);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从对象或属性中删除元数据</span></span><br><span class="line"><span class="keyword">let</span> result = <span class="built_in">Reflect</span>.deleteMetadata(metadataKey, target);</span><br><span class="line"><span class="keyword">let</span> result = <span class="built_in">Reflect</span>.deleteMetadata(metadataKey, target, propertyKey);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过装饰器将元数据应用于构造函数</span></span><br><span class="line"><span class="meta">@Reflect</span>.metadata(metadataKey, metadataValue)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 通过装饰器将元数据应用于方法(属性)</span></span><br><span class="line">  <span class="meta">@Reflect</span>.metadata(metadataKey, metadataValue)</span><br><span class="line">  <span class="function"><span class="title">method</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>需要记得配置 tsconfig.json：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;compilerOptions&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;target&quot;</span>: <span class="string">&quot;es5&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;lib&quot;</span>: [<span class="string">&quot;es6&quot;</span>, <span class="string">&quot;dom&quot;</span>],</span><br><span class="line">    <span class="attr">&quot;types&quot;</span>: [<span class="string">&quot;reflect-metadata&quot;</span>],</span><br><span class="line">    <span class="attr">&quot;module&quot;</span>: <span class="string">&quot;commonjs&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;moduleResolution&quot;</span>: <span class="string">&quot;node&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;experimentalDecorators&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">&quot;emitDecoratorMetadata&quot;</span>: <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 Overnight 中主要使用有两个 API：</p>
<ul>
<li>使用 <code>Reflect.defineMetadata()</code> API <strong>添加元数据</strong>；</li>
<li>使用 <code>Reflect.getOwnMetadata()</code> API <strong>读取元数据</strong>。</li>
</ul>
<p>下面以 Overnight 中类装饰器（Common Class）来介绍这两个 API 使用过程：<br><img src="http://images.pingan8787.com/JavaScript-Base/Learn-Overnight-Source/Reflect-Metadata-Use.png" alt="Reflect-Metadata-Use.png"></p>
<h3 id="2-4-小结"><a href="#2-4-小结" class="headerlink" title="2.4 小结"></a>2.4 小结</h3><p>这里回顾下 Relect Metadata 的知识：<br><img src="http://images.pingan8787.com/JavaScript-Base/Learn-Overnight-Source/Reflect-Metadata-Introduce.png" alt="Reflect-Metadata-Introduce.png"><br>理解清楚前面两个知识点后，我们接下来开始看看 Overnight。</p>
<h1 id="三、Overnight-详解"><a href="#三、Overnight-详解" class="headerlink" title="三、Overnight 详解"></a>三、Overnight 详解</h1><h2 id="1-概念介绍"><a href="#1-概念介绍" class="headerlink" title="1. 概念介绍"></a>1. 概念介绍</h2><p><a target="_blank" rel="noopener" href="https://github.com/seanpmaxwell/overnight"><strong>OvernightJS</strong></a>** 主要是为 Express 路由提供 TypeScript 装饰器支持，通过装饰器来管理路由**。<br>是不是抽象了点？那看看下面这段代码吧：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span>(<span class="string">&#x27;api/posts&#x27;</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">PostController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Get</span>(<span class="string">&#x27;:id&#x27;</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="title">get</span>(<span class="params">req: Request, res: Response</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// do something</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如上面代码所示，OvernightJS 就是这样使用，简单，明了。<br>另外 OvernightJS 共提供了三个库：</p>
<ul>
<li>OvernightJS/core：核心库；</li>
<li>OvernightJS/logger：日志记录工具库；</li>
<li>OvernightJS/jwt：<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/86937325">JWT</a> 库；</li>
</ul>
<p>接下来主要介绍 OvernightJS/core 核心库，其他两个有兴趣可以自己看哈，举一反三，其实核心一样的。</p>
<h2 id="2-OvernightJS-core-快速上手"><a href="#2-OvernightJS-core-快速上手" class="headerlink" title="2. OvernightJS/core 快速上手"></a>2. OvernightJS/core 快速上手</h2><h3 id="2-1-安装-OvernightJS-core"><a href="#2-1-安装-OvernightJS-core" class="headerlink" title="2.1 安装 OvernightJS/core"></a>2.1 安装 OvernightJS/core</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ npm install --save @overnightjs/core express </span><br><span class="line">$ npm install --save-dev @types/express</span><br></pre></td></tr></table></figure>

<h3 id="2-2-OvernightJS-core-示例代码"><a href="#2-2-OvernightJS-core-示例代码" class="headerlink" title="2.2 OvernightJS/core 示例代码"></a>2.2 OvernightJS/core 示例代码</h3><p>首先介绍下我们示例代码需要实现的功能：</p>
<ol>
<li><code>UserController</code> 类，负责管理<strong>业务逻辑</strong>的控制器；</li>
<li><code>ServerController</code> 类，负责管理<strong>服务逻辑</strong>的控制器；</li>
<li>执行服务启动；</li>
</ol>
<p><strong>第一步</strong>，导入需要的依赖：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Controller, Get, Server &#125; <span class="keyword">from</span> <span class="string">&#x27;@overnightjs/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Request, Response &#125; <span class="keyword">from</span> <span class="string">&#x27;express&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> bodyParser <span class="keyword">from</span> <span class="string">&#x27;body-parser&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> port = <span class="number">3000</span>;</span><br></pre></td></tr></table></figure>

<p><strong>第二步</strong>，实现 <code>UserController</code> 类：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span>(<span class="string">&#x27;/users&#x27;</span>)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Get</span>(<span class="string">&#x27;/:id&#x27;</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="title">get</span>(<span class="params">req: Request, res: Response</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> res.send(<span class="string">`hello, your id is:<span class="subst">$&#123;req.params.id&#125;</span>`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Get</span>(<span class="string">&#x27;/list&#x27;</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="title">getList</span>(<span class="params">req: Request, res: Response</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> res.send([</span><br><span class="line">          &#123;<span class="attr">name</span>: <span class="string">&quot;leo&quot;</span>, <span class="attr">age</span>: <span class="number">17</span>&#125;,</span><br><span class="line">          &#123;<span class="attr">name</span>: <span class="string">&quot;robin&quot;</span>, <span class="attr">age</span>: <span class="number">19</span>&#125;</span><br><span class="line">        ])</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在声明 <code>UserController</code> 类时，使用 OvernightJS/core 的 <code>@Controller</code> 装饰器，使用 <code>&quot;/users&quot;</code> 路径作为参数，作用是为当前路由控制器指定一个路由地址，可以理解为这组路由的“根路径”，该类中实现的所有接口路径，都会以该“根路径”为基础。<br>然后在<code>UserController</code> 类中，通过 OvernightJS/core 提供 <code>@Get</code> 装饰器，分别使用 <code>&quot;/:id&quot;</code> 和 <code>&quot;/list&quot;</code> 路径作为参数，绑定路由。</p>
<p>最终 <code>UserController</code> 类实现的路由地址包括：</p>
<ul>
<li><code>/user/:id</code></li>
<li><code>/users/list</code></li>
</ul>
<p><strong>第三步</strong>，实现 <code>ServerController</code> 类：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ServerController</span> <span class="keyword">extends</span> <span class="title">Server</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>();</span><br><span class="line">        <span class="built_in">this</span>.app.use(bodyParser.json());</span><br><span class="line">        <span class="built_in">super</span>.addControllers(<span class="keyword">new</span> UserController());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> start(port?: <span class="built_in">number</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.app.listen(port, <span class="function">() =&gt;</span> &#123;<span class="built_in">console</span>.log(<span class="string">&#x27;启动成功，端口号：&#x27;</span>,port)&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>ServerController</code> 类继承  OvernightJS/core 提供的 <code>Server</code> 类，通过在构造函数中调用 <code>super.addControllers(new UserController())</code> 来实现将前面声明好的路由控制器类，添加到OvernightJS/core 统一管理的控制器数组中。<br>另外在该类中，我们还声明 <code>start</code> 方法，用来启动服务器。</p>
<p><strong>第四步</strong>，实现启动服务器逻辑：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> server = <span class="keyword">new</span> ServerController();</span><br><span class="line">server.start(port);</span><br></pre></td></tr></table></figure>
<p>这里启动服务器就相当简单咯~~</p>
<p> 整个实现示例代码的流程如下：<br>声明了两个类： <code>UserController</code> 和 <code>ServerController</code> ，分别为<strong>业务逻辑的控制器</strong>和<strong>服务逻辑的控制器</strong>，最后在主入口中去实例化，并执行实例化结果的 <code>start</code> 方法启动服务。<br> <br>最后完整代码如下：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Controller, Get, Server &#125; <span class="keyword">from</span> <span class="string">&#x27;@overnightjs/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Request, Response &#125; <span class="keyword">from</span> <span class="string">&#x27;express&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> bodyParser <span class="keyword">from</span> <span class="string">&#x27;body-parser&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> port = <span class="number">3000</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span>(<span class="string">&#x27;users&#x27;</span>)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Get</span>(<span class="string">&#x27;:id&#x27;</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="title">get</span>(<span class="params">req: Request, res: Response</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> res.send(<span class="string">`hello, your id is:<span class="subst">$&#123;req.params.id&#125;</span>`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Get</span>(<span class="string">&#x27;list&#x27;</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="title">get</span>(<span class="params">req: Request, res: Response</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> res.send([</span><br><span class="line">          &#123;<span class="attr">name</span>: <span class="string">&quot;leo&quot;</span>, <span class="attr">age</span>: <span class="number">17</span>&#125;,</span><br><span class="line">          &#123;<span class="attr">name</span>: <span class="string">&quot;robin&quot;</span>, <span class="attr">age</span>: <span class="number">19</span>&#125;</span><br><span class="line">        ])</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ServerController</span> <span class="keyword">extends</span> <span class="title">Server</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>();</span><br><span class="line">        <span class="built_in">this</span>.app.use(bodyParser.json());</span><br><span class="line">        <span class="built_in">super</span>.addControllers(<span class="keyword">new</span> UserController());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> start(port?: <span class="built_in">number</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.app.listen(port, <span class="function">() =&gt;</span> &#123;<span class="built_in">console</span>.log(<span class="string">&#x27;启动成功，端口号：&#x27;</span>,port)&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> server = <span class="keyword">new</span> ServerController();</span><br><span class="line">server.start(port);</span><br></pre></td></tr></table></figure>
<p> </p>
<h2 id="3-OvernightJS-core-装饰器分析"><a href="#3-OvernightJS-core-装饰器分析" class="headerlink" title="3. OvernightJS/core 装饰器分析"></a>3. OvernightJS/core 装饰器分析</h2><p>在阅读源码过程中，我将 OvernightJS/core 中所有的装饰器按照<strong>源码目录结构维度</strong>做了分类，结果如下：<br><img src="http://images.pingan8787.com/JavaScript-Base/Learn-Overnight-Source/Overnight-Decorators-Classify.png" alt="Overnight-Decorators-Classify.png"><br>通过上图可以清晰看出，OvernightJS/core 为我们提供了四个大类的装饰器，具体的使用方式，还请看看官网文档啦~</p>
<h2 id="4-OvernightJS-core-架构分析"><a href="#4-OvernightJS-core-架构分析" class="headerlink" title="4. OvernightJS/core 架构分析"></a>4. OvernightJS/core 架构分析</h2><p>OvernightJS/core 结构设计上还是比较简单，大致如下架构：<br><img src="http://images.pingan8787.com/JavaScript-Base/Learn-Overnight-Source/Overnight-Design.png" alt="Overnight-Design.png"><br>在 OvernightJS/core 中，主要提供两个大类： <code>Server</code> 类和  <code>Decorators</code> 相关方法。<br>其中 <code>Server</code> 类中的 <code>addConterllers</code> 方法是关键，下一节将详细介绍。哈哈</p>
<h2 id="5-OvernightJS-core-与-Express-关联"><a href="#5-OvernightJS-core-与-Express-关联" class="headerlink" title="5. OvernightJS/core 与 Express 关联"></a>5. OvernightJS/core 与 Express 关联</h2><p>回顾下 Express ，我们经常通过 <code>app.use(path, route)</code> 来定义一个接口：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.use(path, route);</span><br></pre></td></tr></table></figure>
<p>那么在 OvernightJS 中呢？？<br>前一小节提到的<code>addConterllers</code> 方法是什么呢？？</p>
<p> 其实 OvernightJS 本质上是通过调用 <code>addConterllers()</code> 方法来和 Express 做关联。<br>可以理解为 <strong>OvernightJS 与 Express 之间的桥梁</strong>，它将 OvernightJS/core 定义好的路由控制器作为参数，通过 Express 的 <code>use</code> 方法，将路由添加的 Express 中，实现 Express 路由注册。</p>
<p> 我们看下源码中<code>addControllers</code> 方法做了什么事情：  </p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// core/lib/Server.ts</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> addControllers(</span><br><span class="line">    controllers: Controller | Controller[],</span><br><span class="line">    routerLib?: RouterLib,</span><br><span class="line">    globalMiddleware?: RequestHandler,</span><br><span class="line">): <span class="built_in">void</span> &#123;</span><br><span class="line">    controllers = (controllers <span class="keyword">instanceof</span> <span class="built_in">Array</span>) ? controllers : [controllers];</span><br><span class="line">    <span class="keyword">const</span> routerLibrary: RouterLib = routerLib || Router;</span><br><span class="line">    controllers.forEach(<span class="function">(<span class="params">controller: Controller</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (controller) &#123;</span><br><span class="line">            <span class="keyword">const</span> routerAndPath: IRouterAndPath | <span class="literal">null</span> = <span class="built_in">this</span>.getRouter(routerLibrary, controller);</span><br><span class="line">            <span class="keyword">if</span> (routerAndPath) &#123;</span><br><span class="line">                <span class="keyword">if</span> (globalMiddleware) &#123;</span><br><span class="line">                    <span class="built_in">this</span>.app.use(routerAndPath.basePath, globalMiddleware, routerAndPath.router);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="built_in">this</span>.app.use(routerAndPath.basePath, routerAndPath.router);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们简化下上面代码，保留核心功能的源码：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> addControllers(</span><br><span class="line">    controllers: Controller | Controller[],</span><br><span class="line">    routerLib?: RouterLib,</span><br><span class="line">    globalMiddleware?: RequestHandler,</span><br><span class="line">): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="comment">// ... 省略其他代码</span></span><br><span class="line">    controllers = (controllers <span class="keyword">instanceof</span> <span class="built_in">Array</span>) ? controllers : [controllers];</span><br><span class="line">    controllers.forEach(<span class="function">(<span class="params">controller: Controller</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.app.use(routerAndPath.basePath, routerAndPath.router);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从上面代码可以看出， <code>addControllers</code> 方法支持传入单个 controller 或一个数组的 controller，方法内通过 <code>forEach</code> 遍历每个控制器，并将 <code>path</code> 和 <code>router</code> 作为参数传入 <code>app.use</code> 方法中，实现 Express 的路由注册。</p>
<h1 id="四、Overnight-VS-Express"><a href="#四、Overnight-VS-Express" class="headerlink" title="四、Overnight VS Express"></a>四、Overnight VS Express</h1><p>从前面概念介绍中，我们知道：OvernightJS 主要是为 Express 路由提供 TypeScript 装饰器支持，通过装饰器来管理路由。</p>
<p>那么<strong>使用 OvernightJS 跟没有使用有什么区别呢？</strong><br>下面我们分别通过 OvernightJS 和 Express 实现相同功能，功能包括：本地启动 4000 端口，支持 <code>api/users/:id</code> 接口。</p>
<h2 id="1-OvernightJS-实现"><a href="#1-OvernightJS-实现" class="headerlink" title="1. OvernightJS 实现"></a>1. OvernightJS 实现</h2><p>首先实现入口文件，其中通过实例化 <code>ServerController</code> 类，并执行实例化结构的 <code>start</code> 方法来启动服务：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// customApp.ts</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ServerController <span class="keyword">from</span> <span class="string">&quot;../controller/custom.server.controller&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> port = <span class="number">4000</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> server = <span class="keyword">new</span> ServerController();</span><br><span class="line">server.start(port);</span><br></pre></td></tr></table></figure>
<p>其中 tsconfig.json 配置如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;compilerOptions&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;target&quot;</span>: <span class="string">&quot;es6&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;module&quot;</span>: <span class="string">&quot;commonjs&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;strict&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">&quot;esModuleInterop&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">&quot;experimentalDecorators&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">&quot;skipLibCheck&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">&quot;forceConsistentCasingInFileNames&quot;</span>: <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>大致过程如上面代码，接下来要开始实现具体的 <code>ServerController</code>  类：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// controller/custom.server.controller.ts</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; Server &#125; <span class="keyword">from</span> <span class="string">&quot;@overnightjs/core&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> RouterController <span class="keyword">from</span> <span class="string">&quot;./custom.router.controller&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ServerController</span> <span class="keyword">extends</span> <span class="title">Server</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>();</span><br><span class="line">        <span class="built_in">super</span>.addControllers(<span class="keyword">new</span> RouterController());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> start(port?: <span class="built_in">number</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.app.listen(port, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&#x27;启动成功，端口号：&#x27;</span>,port)&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> ServerController;</span><br></pre></td></tr></table></figure>
<p> <br>最后实现 <code>RouterController</code>  类，该 API 下的路由方法，都定义在这个类中：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// controller/custom.router.controller.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; Request, Response &#125; <span class="keyword">from</span> <span class="string">&#x27;express&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Controller, Get, Put &#125; <span class="keyword">from</span> <span class="string">&#x27;@overnightjs/core&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span>(<span class="string">&quot;api/users&quot;</span>)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RouterController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Get</span>(<span class="string">&quot;:id&quot;</span>)</span><br><span class="line">    <span class="keyword">private</span> get(req:Request, <span class="attr">res</span>:Response): <span class="built_in">any</span>&#123;</span><br><span class="line">        res.send(<span class="string">&quot;hello leo!&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> RouterController;</span><br></pre></td></tr></table></figure>
<p> </p>
<h2 id="2-Express-实现"><a href="#2-Express-实现" class="headerlink" title="2. Express 实现"></a>2. Express 实现</h2><p>跟前面一下，这里也是先实现入口文件：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app.ts</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ServerController <span class="keyword">from</span> <span class="string">&quot;../controller/server.controller&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> port = <span class="number">4000</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> server = <span class="keyword">new</span> ServerController();</span><br><span class="line">server.start(port);</span><br></pre></td></tr></table></figure>
<p>然后实现具体的 <code>ServerController</code>  类：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// controller/server.controller/.ts</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> express, &#123; Application &#125; <span class="keyword">from</span> <span class="string">&#x27;express&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> RouterController <span class="keyword">from</span> <span class="string">&quot;./router.controller&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ServerController</span> </span>&#123;</span><br><span class="line">    <span class="attr">app</span>: Application = express();</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params"></span>)</span>&#123;<span class="built_in">this</span>.addControllers()&#125;;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="title">addControllers</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">const</span> Router = <span class="keyword">new</span> RouterController().getController();</span><br><span class="line">        <span class="built_in">this</span>.app.use(<span class="string">&#x27;/api/users&#x27;</span>, Router);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> start(port?: <span class="built_in">number</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.app.listen(port, <span class="function">() =&gt;</span> &#123;<span class="built_in">console</span>.log(<span class="string">&#x27;启动成功，端口号：&#x27;</span>,port)&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> ServerController;</span><br></pre></td></tr></table></figure>
<p> <br>最后实现 <code>RouterController</code>  类：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// controller/router.controller.ts</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> express, &#123; Router, Application, Request, Response, NextFunction &#125; <span class="keyword">from</span> <span class="string">&quot;express&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RouterController</span> </span>&#123;</span><br><span class="line">    <span class="attr">router</span>: Router = express.Router();</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params"></span>)</span> &#123; <span class="built_in">this</span>.addControllers()&#125;;</span><br><span class="line">    <span class="keyword">public</span> getController = (): <span class="function"><span class="params">Router</span> =&gt;</span> <span class="built_in">this</span>.router;</span><br><span class="line">    <span class="keyword">public</span> addControllers(): <span class="built_in">void</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.router.get(<span class="string">&quot;/:id&quot;</span>, <span class="built_in">this</span>.get);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> get (req: Request, <span class="attr">res</span>: Response, <span class="attr">next</span>: NextFunction)&#123;</span><br><span class="line">        res.send(<span class="string">&quot;hello leo!&quot;</span>)</span><br><span class="line">        next();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> RouterController;</span><br></pre></td></tr></table></figure>
<p> </p>
<h2 id="3-两者比较"><a href="#3-两者比较" class="headerlink" title="3. 两者比较"></a>3. 两者比较</h2><p>相信看到这里的朋友，对前面两种实现方法大致了解了，接下来通过一张图，来看看总结两者实现的区别吧。<br><img src="http://images.pingan8787.com/JavaScript-Base/Learn-Overnight-Source/Overnight-VS-Express.png" alt="Overnight-VS-Express.png"></p>
<h1 id="五、总结"><a href="#五、总结" class="headerlink" title="五、总结"></a>五、总结</h1><p>本文主要介绍 OvernightJS 与 Express 路由功能的基本使用，然后分别用两者实现相同的路由功能，对比得出 OvernightJS 的优点，推荐使用 Express + TypeScript 的朋友可以尝试使用 OvernightJS 咯~</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/10/10/219-%E3%80%90Express%E3%80%91%E6%88%91%E4%B8%BAExpress%E5%BC%80%E4%BA%86%E5%A4%96%E6%8C%82/" data-id="ckts3ejyz00ng4d9k9ot4dovc" data-title="219-【Express】我为Express开了外挂" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Express/" rel="tag">Express</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Nodejs/" rel="tag">Nodejs</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/" rel="tag">前端开发</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%8E%9F%E5%88%9B/" rel="tag">原创</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" rel="tag">设计模式</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-218-【设计模式】TypeScript设计模式之发布-订阅模式" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/09/22/218-%E3%80%90%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E3%80%91TypeScript%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E5%8F%91%E5%B8%83-%E8%AE%A2%E9%98%85%E6%A8%A1%E5%BC%8F/" class="article-date">
  <time class="dt-published" datetime="2020-09-22T01:38:27.000Z" itemprop="datePublished">2020-09-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/09/22/218-%E3%80%90%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E3%80%91TypeScript%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E5%8F%91%E5%B8%83-%E8%AE%A2%E9%98%85%E6%A8%A1%E5%BC%8F/">218-【设计模式】TypeScript设计模式之发布-订阅模式</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>在之前两篇自测清单中，和大家分享了很多 JavaScript 基础知识，大家可以一起再回顾下~</p>
<p>本文是我在我们团队内部“<strong>现代 JavaScript 突击队</strong>”分享的一篇内容，第二期学习内容为“<strong>设计模式</strong>”系列，我会将我负责分享的知识整理成文章输出，希望能够和大家一起温故知新！</p>
<p>“<strong>现代 JavaScript 突击队</strong>”学习总结：</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://juejin.im/post/6846687584710557710">《初中级前端 JavaScript 自测清单 - 1》</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.im/post/6857037330113363982">《初中级前端 JavaScript 自测清单 - 2》</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.im/post/6862112623417098248">《TypeScript 设计模式之观察者模式》</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.im/post/6861525441786675208">《TypeScript语法总结+项目(Vue.js+TS)实战》</a></li>
</ol>
<h1 id="一、模式介绍"><a href="#一、模式介绍" class="headerlink" title="一、模式介绍"></a>一、模式介绍</h1><h2 id="1-生活场景"><a href="#1-生活场景" class="headerlink" title="1. 生活场景"></a>1. 生活场景</h2><p>最近刚毕业的学生 Leo 准备开始租房了，他来到房产中介，跟中介描述了自己的租房需求，开开心心回家了。第二天，中介的小哥哥小姐姐为 Leo 列出符他需求的房间，并打电话约他一起看房了，最后 Leo 选中一套满意的房间，高高兴兴过去签合同，准备开始新生活~</p>
<p>还有个大佬 Paul，准备将手中 10 套房出租出去，于是他来到房产中介，在中介那边提供了自己要出租的房间信息，沟通好手续费，开开心心回家了。第二天，Paul 接到中介的好消息，房子租出去了，于是他高高兴兴过去签合同，开始收房租了~</p>
<p><img src="http://images.pingan8787.com/DesignPattern/PubSubPattern/pub-sub-desc.png" alt="发布-订阅模式（简介）.png"></p>
<p>上面场景有个需要特别注意的地方：</p>
<ul>
<li>租户在租房过程中，不知道房间具体房东是谁，到后面签合同才知道；</li>
<li>房东在出租过程中，不知道房间具体租户是谁，到后面签合同才知道；</li>
</ul>
<p>这两点其实就是后面要介绍的 <strong>发布-订阅模式</strong> 的一个核心特点。</p>
<h2 id="2-概念介绍"><a href="#2-概念介绍" class="headerlink" title="2. 概念介绍"></a>2. 概念介绍</h2><p>在<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E8%BD%AF%E4%BB%B6%E6%9E%B6%E6%9E%84">软件架构</a>中，发布-订阅模式是一种<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E6%B6%88%E6%81%AF">消息</a><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E8%8C%83%E5%BC%8F">范式</a>，消息的发送者（称为发布者）<strong>不会将消息直接发送给特定的接收者</strong>（称为订阅者）。而是将发布的消息分为不同的类别，无需了解哪些订阅者（如果有的话）可能存在。同样的，订阅者可以表达对一个或多个类别的兴趣，只接收感兴趣的消息，无需了解哪些发布者（如果有的话）存在。</p>
<p>发布-订阅是<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97">消息队列</a>范式的兄弟，通常是更大的<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/w/index.php?title=%E9%9D%A2%E5%90%91%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6&action=edit&redlink=1">面向消息中间件</a>系统的一部分。大多数消息系统在<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E6%8E%A5%E5%8F%A3">API</a>中同时支持消息队列模型和发布/订阅模型，例如<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Java%E6%B6%88%E6%81%AF%E6%9C%8D%E5%8A%A1">Java消息服务</a>（JMS）。</p>
<p>这种模式提供了更大的网络<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%8F%AF%E6%89%A9%E5%B1%95%E6%80%A7">可扩展性</a>和更动态的<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E7%BD%91%E7%BB%9C%E6%8B%93%E6%89%91">网络拓扑</a>，同时也降低了对发布者和发布数据的结构修改的灵活性。</p>
<h1 id="二、-观察者模式-vs-发布-订阅模式"><a href="#二、-观察者模式-vs-发布-订阅模式" class="headerlink" title="二、 观察者模式 vs 发布-订阅模式"></a>二、 观察者模式 vs 发布-订阅模式</h1><p>看完上面概念，有没有觉得与观察者模式很像？<br>但其实两者还是有差异的，接下来一起看看。</p>
<h2 id="1-概念对比"><a href="#1-概念对比" class="headerlink" title="1. 概念对比"></a>1. 概念对比</h2><p>我们分别为通过两种实际生活场景来介绍这两种模式：</p>
<ul>
<li><strong>观察者模式</strong>：如微信中 <strong>顾客-微商</strong> 关系；</li>
<li><strong>发布-订阅模式</strong>：如淘宝购物中 <strong>顾客-淘宝-商家</strong> 关系。</li>
</ul>
<p>这两种场景的过程分别是这样：</p>
<h3 id="1-1-观察者模式"><a href="#1-1-观察者模式" class="headerlink" title="1.1 观察者模式"></a>1.1 观察者模式</h3><p><img src="http://images.pingan8787.com/DesignPattern/PubSubPattern/observer-desc.png" alt="观察者模式（微商与顾客）.png"><br><strong>观察者模式</strong>中，消费顾客关注（如加微信好友）自己有兴趣的微商，微商就会私聊发自己在卖的产品给消费顾客。<br>这个过程中，消费顾客相当于观察者（Observer），微商相当于观察目标（Subject）。</p>
<h3 id="1-2-发布-订阅模式"><a href="#1-2-发布-订阅模式" class="headerlink" title="1.2 发布-订阅模式"></a>1.2 发布-订阅模式</h3><p>接下来看看 <strong>发布-订阅模式</strong> ：</p>
<p><img src="http://images.pingan8787.com/DesignPattern/PubSubPattern/pub-sub-demo1.png" alt="发布-订阅模式（淘宝与顾客） .png"><br>在 <strong>发布-订阅模式</strong> 中，消费顾客通过淘宝搜索自己关注的产品，商家通过淘宝发布商品，当消费顾客在淘宝搜索的产品，已经有商家发布，则淘宝会将对应商品推荐给消费顾客。<br>这个过程中，消费顾客相当于订阅者，淘宝相当于事件总线，商家相当于发布者。</p>
<h2 id="2-流程对比"><a href="#2-流程对比" class="headerlink" title="2. 流程对比"></a>2. 流程对比</h2><p><img src="http://images.pingan8787.com/DesignPattern/PubSubPattern/pub-sub.png" alt="观察者模式和发布-订阅模式区别（流程图）.png"></p>
<h2 id="3-小结"><a href="#3-小结" class="headerlink" title="3. 小结"></a>3. 小结</h2><p>所以可以看出，<strong>观察者模式</strong>和<strong>发布-订阅模式</strong>差别在于<strong>有没有一个中央的事件总线</strong>。如果有，我们就可以认为这是个<strong>发布-订阅模式</strong>。如果没有，那么就可以认为是<strong>观察者模式</strong>。因为其实它们都实现了一个关键的功能：<strong>发布事件-订阅事件并触发事件</strong>。</p>
<h1 id="三、模式特点"><a href="#三、模式特点" class="headerlink" title="三、模式特点"></a>三、模式特点</h1><p>对比完<strong>观察者模式</strong>和<strong>发布-订阅模式</strong>后，我们大致理解<strong>发布-订阅模式</strong>是什么了。接着总结下该模式的特点：</p>
<h2 id="1-模式组成"><a href="#1-模式组成" class="headerlink" title="1. 模式组成"></a>1. 模式组成</h2><p>在发布-订阅模式中，通常包含以下角色：</p>
<ul>
<li><strong>发布者：Publisher</strong></li>
<li><strong>事件总线：Event Channel</strong></li>
<li><strong>订阅者：Subscriber</strong></li>
</ul>
<h2 id="2-UML-类图"><a href="#2-UML-类图" class="headerlink" title="2. UML 类图"></a>2. UML 类图</h2><p><img src="http://images.pingan8787.com/DesignPattern/PubSubPattern/pub-sub-uml.jpg" alt="发布-订阅模式（UML）.jpg"></p>
<h2 id="3-优点"><a href="#3-优点" class="headerlink" title="3. 优点"></a>3. 优点</h2><ol>
<li>松耦合（Independence）</li>
</ol>
<p><strong>发布-订阅模式</strong>可以将众多需要通信的子系统(Subsystem)解耦，每个子系统独立管理。而且即使部分子系统取消订阅，也不会影响<strong>事件总线</strong>的整体管理。<br><strong>发布-订阅模式</strong>中每个应用程序都可以专注于其核心功能，而<strong>事件总线</strong>负责将消息路由到每个<strong>订阅者</strong>手里。</p>
<ol start="2">
<li>高伸缩性（Scalability）</li>
</ol>
<p><strong>发布-订阅模式</strong>增加了系统的可伸缩性，提高了发布者的响应能力。原因是<strong>发布者</strong>(Publisher)可以快速地向输入通道发送一条消息，然后返回到其核心处理职责，而不必等待子系统处理完成。然后<strong>事件总线</strong>负责确保把消息传递到每个<strong>订阅者</strong>(Subscriber)手里。</p>
<ol start="3">
<li>高可靠性（Reliability）</li>
</ol>
<p><strong>发布-订阅模式</strong>提高了可靠性。异步的消息传递有助于应用程序在增加的负载下继续平稳运行，并且可以更有效地处理间歇性故障。</p>
<ol start="4">
<li>灵活性（Flexibility）</li>
</ol>
<p>你不需要关心不同的组件是如何组合在一起的，只要他们共同遵守一份协议即可。<br><strong>发布-订阅模式</strong>允许延迟处理或者按计划的处理。例如当系统负载大的时候，订阅者可以等到非高峰时间才接收消息，或者根据特定的计划处理消息。</p>
<h2 id="4-缺点"><a href="#4-缺点" class="headerlink" title="4. 缺点"></a>4. 缺点</h2><ol>
<li>在创建订阅者本身会消耗内存，但当订阅消息后，没有进行发布，而订阅者会一直保存在内存中，占用内存；</li>
<li>创建订阅者需要消耗一定的时间和内存。如果过度使用的话，反而使代码不好理解及代码不好维护。</li>
</ol>
<h1 id="四、使用场景"><a href="#四、使用场景" class="headerlink" title="四、使用场景"></a>四、使用场景</h1><p>如果我们项目中很少使用到订阅者，或者与子系统实时交互较少，则不适合 <strong>发布-订阅模式</strong> 。<br>在以下情况下可以考虑使用此模式：</p>
<ol>
<li>应用程序需要<strong>向大量消费者广播信息</strong>。例如微信订阅号就是一个消费者量庞大的广播平台。</li>
<li>应用程序需要与一个或多个独立开发的应用程序或服务<strong>通信</strong>，这些应用程序或服务可能使用不同的平台、编程语言和通信协议。</li>
<li>应用程序可以向消费者发送信息，而不需要消费者的实时响应。</li>
</ol>
<h1 id="五、实战示例"><a href="#五、实战示例" class="headerlink" title="五、实战示例"></a>五、实战示例</h1><h2 id="1-简单示例"><a href="#1-简单示例" class="headerlink" title="1. 简单示例"></a>1. 简单示例</h2><ol>
<li><p>定义<strong>发布者接口</strong>（Publisher）、<strong>事件总线接口</strong>（EventChannel）和<strong>订阅者接口</strong>（Subscriber）：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> Publisher&lt;T&gt; &#123;</span><br><span class="line">  <span class="attr">subscriber</span>: <span class="built_in">string</span>;</span><br><span class="line">  data: T;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> EventChannel&lt;T&gt;  &#123;</span><br><span class="line">  <span class="attr">on</span>  : <span class="function">(<span class="params">subscriber: <span class="built_in">string</span>, callback: () =&gt; <span class="built_in">void</span></span>) =&gt;</span> <span class="built_in">void</span>;</span><br><span class="line">  off : <span class="function">(<span class="params">subscriber: <span class="built_in">string</span>, callback: () =&gt; <span class="built_in">void</span></span>) =&gt;</span> <span class="built_in">void</span>;</span><br><span class="line">  emit: <span class="function">(<span class="params">subscriber: <span class="built_in">string</span>, data: T</span>) =&gt;</span> <span class="built_in">void</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> Subscriber &#123;</span><br><span class="line">  <span class="attr">subscriber</span>: <span class="built_in">string</span>;</span><br><span class="line">  callback: <span class="function">() =&gt;</span> <span class="built_in">void</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方便后面使用</span></span><br><span class="line"><span class="keyword">interface</span> PublishData &#123;</span><br><span class="line">  [key: <span class="built_in">string</span>]: <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>实现<strong>具体发布者类</strong>（ConcretePublisher）：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConcretePublisher</span>&lt;<span class="title">T</span>&gt; <span class="title">implements</span> <span class="title">Publisher</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> subscriber: <span class="built_in">string</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">  <span class="keyword">public</span> data: T; </span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">subscriber: <span class="built_in">string</span>, data: T</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.subscriber = subscriber;</span><br><span class="line">    <span class="built_in">this</span>.data = data;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>实现<strong>具体事件总线类</strong>（ConcreteEventChannel）：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConcreteEventChannel</span>&lt;<span class="title">T</span>&gt; <span class="title">implements</span> <span class="title">EventChannel</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  <span class="comment">// 初始化订阅者对象</span></span><br><span class="line">  <span class="keyword">private</span> subjects: &#123; [key: <span class="built_in">string</span>]: <span class="built_in">Function</span>[] &#125; = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 实现添加订阅事件</span></span><br><span class="line">  <span class="keyword">public</span> on(subscriber: <span class="built_in">string</span>, <span class="attr">callback</span>: <span class="function">() =&gt;</span> <span class="built_in">void</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`收到订阅信息，订阅事件：<span class="subst">$&#123;subscriber&#125;</span>`</span>);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">this</span>.subjects[subscriber]) &#123;</span><br><span class="line">      <span class="built_in">this</span>.subjects[subscriber] = [];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">this</span>.subjects[subscriber].push(callback);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 实现取消订阅事件</span></span><br><span class="line">  <span class="keyword">public</span> off(subscriber: <span class="built_in">string</span>, <span class="attr">callback</span>: <span class="function">() =&gt;</span> <span class="built_in">void</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`收到取消订阅请求，需要取消的订阅事件：<span class="subst">$&#123;subscriber&#125;</span>`</span>);</span><br><span class="line">    <span class="keyword">if</span> (callback === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="built_in">this</span>.subjects[subscriber] = [];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> index: <span class="built_in">number</span> = <span class="built_in">this</span>.subjects[subscriber].indexOf(callback);</span><br><span class="line">      ~index &amp;&amp; <span class="built_in">this</span>.subjects[subscriber].splice(index, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 实现发布订阅事件</span></span><br><span class="line">  <span class="keyword">public</span> emit (subscriber: <span class="built_in">string</span>, <span class="attr">data</span>: T): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`收到发布者信息，执行订阅事件：<span class="subst">$&#123;subscriber&#125;</span>`</span>);</span><br><span class="line">    <span class="built_in">this</span>.subjects[subscriber].forEach(<span class="function"><span class="params">item</span> =&gt;</span> item(data));</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>实现<strong>具体订阅者类</strong>（ConcreteSubscriber）：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConcreteSubscriber</span> <span class="title">implements</span> <span class="title">Subscriber</span> </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> subscriber: <span class="built_in">string</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">subscriber: <span class="built_in">string</span>, callback: () =&gt; <span class="built_in">void</span></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.subscriber = subscriber;</span><br><span class="line">    <span class="built_in">this</span>.callback = callback;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> callback(): <span class="built_in">void</span> &#123; &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>运行示例代码：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> Publisher&lt;T&gt; &#123;</span><br><span class="line">  <span class="attr">subscriber</span>: <span class="built_in">string</span>;</span><br><span class="line">  data: T;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> EventChannel&lt;T&gt;  &#123;</span><br><span class="line">  <span class="attr">on</span>  : <span class="function">(<span class="params">subscriber: <span class="built_in">string</span>, callback: () =&gt; <span class="built_in">void</span></span>) =&gt;</span> <span class="built_in">void</span>;</span><br><span class="line">  off : <span class="function">(<span class="params">subscriber: <span class="built_in">string</span>, callback: () =&gt; <span class="built_in">void</span></span>) =&gt;</span> <span class="built_in">void</span>;</span><br><span class="line">  emit: <span class="function">(<span class="params">subscriber: <span class="built_in">string</span>, data: T</span>) =&gt;</span> <span class="built_in">void</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> Subscriber &#123;</span><br><span class="line">  <span class="attr">subscriber</span>: <span class="built_in">string</span>;</span><br><span class="line">  callback: <span class="function">() =&gt;</span> <span class="built_in">void</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> PublishData &#123;</span><br><span class="line">  [key: <span class="built_in">string</span>]: <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConcreteEventChannel</span>&lt;<span class="title">T</span>&gt; <span class="title">implements</span> <span class="title">EventChannel</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  <span class="comment">// 初始化订阅者对象</span></span><br><span class="line">  <span class="keyword">private</span> subjects: &#123; [key: <span class="built_in">string</span>]: <span class="built_in">Function</span>[] &#125; = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 实现添加订阅事件</span></span><br><span class="line">  <span class="keyword">public</span> on(subscriber: <span class="built_in">string</span>, <span class="attr">callback</span>: <span class="function">() =&gt;</span> <span class="built_in">void</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`收到订阅信息，订阅事件：<span class="subst">$&#123;subscriber&#125;</span>`</span>);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">this</span>.subjects[subscriber]) &#123;</span><br><span class="line">      <span class="built_in">this</span>.subjects[subscriber] = [];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">this</span>.subjects[subscriber].push(callback);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 实现取消订阅事件</span></span><br><span class="line">  <span class="keyword">public</span> off(subscriber: <span class="built_in">string</span>, <span class="attr">callback</span>: <span class="function">() =&gt;</span> <span class="built_in">void</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`收到取消订阅请求，需要取消的订阅事件：<span class="subst">$&#123;subscriber&#125;</span>`</span>);</span><br><span class="line">    <span class="keyword">if</span> (callback === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="built_in">this</span>.subjects[subscriber] = [];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> index: <span class="built_in">number</span> = <span class="built_in">this</span>.subjects[subscriber].indexOf(callback);</span><br><span class="line">      ~index &amp;&amp; <span class="built_in">this</span>.subjects[subscriber].splice(index, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 实现发布订阅事件</span></span><br><span class="line">  <span class="keyword">public</span> emit (subscriber: <span class="built_in">string</span>, <span class="attr">data</span>: T): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`收到发布者信息，执行订阅事件：<span class="subst">$&#123;subscriber&#125;</span>`</span>);</span><br><span class="line">    <span class="built_in">this</span>.subjects[subscriber].forEach(<span class="function"><span class="params">item</span> =&gt;</span> item(data));</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConcretePublisher</span>&lt;<span class="title">T</span>&gt; <span class="title">implements</span> <span class="title">Publisher</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> subscriber: <span class="built_in">string</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">  <span class="keyword">public</span> data: T; </span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">subscriber: <span class="built_in">string</span>, data: T</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.subscriber = subscriber;</span><br><span class="line">    <span class="built_in">this</span>.data = data;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConcreteSubscriber</span> <span class="title">implements</span> <span class="title">Subscriber</span> </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> subscriber: <span class="built_in">string</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">subscriber: <span class="built_in">string</span>, callback: () =&gt; <span class="built_in">void</span></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.subscriber = subscriber;</span><br><span class="line">    <span class="built_in">this</span>.callback = callback;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> callback(): <span class="built_in">void</span> &#123; &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 运行示例 */</span></span><br><span class="line"><span class="keyword">const</span> pingan8787 = <span class="keyword">new</span> ConcreteSubscriber(</span><br><span class="line">  <span class="string">&quot;running&quot;</span>,</span><br><span class="line">  <span class="function">() =&gt;</span> &#123; </span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;订阅者 pingan8787 订阅事件成功！执行回调~&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> leo = <span class="keyword">new</span> ConcreteSubscriber(</span><br><span class="line">  <span class="string">&quot;swimming&quot;</span>,</span><br><span class="line">  <span class="function">() =&gt;</span> &#123; </span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;订阅者 leo 订阅事件成功！执行回调~&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> lisa = <span class="keyword">new</span> ConcreteSubscriber(</span><br><span class="line">  <span class="string">&quot;swimming&quot;</span>,</span><br><span class="line">  <span class="function">() =&gt;</span> &#123; </span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;订阅者 lisa 订阅事件成功！执行回调~&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> pual = <span class="keyword">new</span> ConcretePublisher&lt;PublishData&gt;(</span><br><span class="line">  <span class="string">&quot;swimming&quot;</span>,</span><br><span class="line">  &#123;<span class="attr">message</span>: <span class="string">&quot;pual 发布消息~&quot;</span>&#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> eventBus = <span class="keyword">new</span> ConcreteEventChannel&lt;PublishData&gt;();</span><br><span class="line">eventBus.on(pingan8787.subscriber, pingan8787.callback);</span><br><span class="line">eventBus.on(leo.subscriber, leo.callback);</span><br><span class="line">eventBus.on(lisa.subscriber, lisa.callback);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发布者 pual 发布 &quot;swimming&quot;相关的事件</span></span><br><span class="line">eventBus.emit(pual.subscriber, pual.data); </span><br><span class="line">eventBus.off (lisa.subscriber, lisa.callback);</span><br><span class="line">eventBus.emit(pual.subscriber, pual.data);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">输出结果：</span></span><br><span class="line"><span class="comment">[LOG]: 收到订阅信息，订阅事件：running</span></span><br><span class="line"><span class="comment">[LOG]: 收到订阅信息，订阅事件：swimming</span></span><br><span class="line"><span class="comment">[LOG]: 收到订阅信息，订阅事件：swimming</span></span><br><span class="line"><span class="comment">[LOG]: 收到发布者信息，执行订阅事件：swimming </span></span><br><span class="line"><span class="comment">[LOG]: 订阅者 leo 订阅事件成功！执行回调~ </span></span><br><span class="line"><span class="comment">[LOG]: 订阅者 lisa 订阅事件成功！执行回调~ </span></span><br><span class="line"><span class="comment">[LOG]: 收到取消订阅请求，需要取消的订阅事件：swimming </span></span><br><span class="line"><span class="comment">[LOG]: 收到发布者信息，执行订阅事件：swimming </span></span><br><span class="line"><span class="comment">[LOG]: 订阅者 leo 订阅事件成功！执行回调~ </span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>完整代码如下：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> Publisher &#123;</span><br><span class="line">  <span class="attr">subscriber</span>: <span class="built_in">string</span>;</span><br><span class="line">  data: <span class="built_in">any</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> EventChannel &#123;</span><br><span class="line">  <span class="attr">on</span>  : <span class="function">(<span class="params">subscriber: <span class="built_in">string</span>, callback: () =&gt; <span class="built_in">void</span></span>) =&gt;</span> <span class="built_in">void</span>;</span><br><span class="line">  off : <span class="function">(<span class="params">subscriber: <span class="built_in">string</span>, callback: () =&gt; <span class="built_in">void</span></span>) =&gt;</span> <span class="built_in">void</span>;</span><br><span class="line">  emit: <span class="function">(<span class="params">subscriber: <span class="built_in">string</span>, data: <span class="built_in">any</span></span>) =&gt;</span> <span class="built_in">void</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> Subscriber &#123;</span><br><span class="line">  <span class="attr">subscriber</span>: <span class="built_in">string</span>;</span><br><span class="line">  callback: <span class="function">() =&gt;</span> <span class="built_in">void</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConcreteEventChannel</span> <span class="title">implements</span> <span class="title">EventChannel</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 初始化订阅者对象</span></span><br><span class="line">  <span class="keyword">private</span> subjects: &#123; [key: <span class="built_in">string</span>]: <span class="built_in">Function</span>[] &#125; = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 实现添加订阅事件</span></span><br><span class="line">  <span class="keyword">public</span> on(subscriber: <span class="built_in">string</span>, <span class="attr">callback</span>: <span class="function">() =&gt;</span> <span class="built_in">void</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`收到订阅信息，订阅事件：<span class="subst">$&#123;subscriber&#125;</span>`</span>);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">this</span>.subjects[subscriber]) &#123;</span><br><span class="line">      <span class="built_in">this</span>.subjects[subscriber] = [];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">this</span>.subjects[subscriber].push(callback);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 实现取消订阅事件</span></span><br><span class="line">  <span class="keyword">public</span> off(subscriber: <span class="built_in">string</span>, <span class="attr">callback</span>: <span class="function">() =&gt;</span> <span class="built_in">void</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`收到取消订阅请求，需要取消的订阅事件：<span class="subst">$&#123;subscriber&#125;</span>`</span>);</span><br><span class="line">    <span class="keyword">if</span> (callback === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="built_in">this</span>.subjects[subscriber] = [];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> index: <span class="built_in">number</span> = <span class="built_in">this</span>.subjects[subscriber].indexOf(callback);</span><br><span class="line">      ~index &amp;&amp; <span class="built_in">this</span>.subjects[subscriber].splice(index, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 实现发布订阅事件</span></span><br><span class="line">  <span class="keyword">public</span> emit (subscriber: <span class="built_in">string</span>, data = <span class="literal">null</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`收到发布者信息，执行订阅事件：<span class="subst">$&#123;subscriber&#125;</span>`</span>);</span><br><span class="line">    <span class="built_in">this</span>.subjects[subscriber].forEach(<span class="function"><span class="params">item</span> =&gt;</span> item(data));</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConcretePublisher</span> <span class="title">implements</span> <span class="title">Publisher</span> </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> subscriber: <span class="built_in">string</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">  <span class="keyword">public</span> data: <span class="built_in">any</span>; </span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">subscriber: <span class="built_in">string</span>, data: <span class="built_in">any</span></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.subscriber = subscriber;</span><br><span class="line">    <span class="built_in">this</span>.data = data;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConcreteSubscriber</span> <span class="title">implements</span> <span class="title">Subscriber</span> </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> subscriber: <span class="built_in">string</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">subscriber: <span class="built_in">string</span>, callback: () =&gt; <span class="built_in">void</span></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.subscriber = subscriber;</span><br><span class="line">    <span class="built_in">this</span>.callback = callback;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> callback(): <span class="built_in">void</span> &#123; &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 运行示例 */</span></span><br><span class="line"><span class="keyword">const</span> pingan8787 = <span class="keyword">new</span> ConcreteSubscriber(</span><br><span class="line">  <span class="string">&quot;running&quot;</span>,</span><br><span class="line">  <span class="function">() =&gt;</span> &#123; </span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;订阅者 pingan8787 订阅事件成功！执行回调~&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> leo = <span class="keyword">new</span> ConcreteSubscriber(</span><br><span class="line">  <span class="string">&quot;swimming&quot;</span>,</span><br><span class="line">  <span class="function">() =&gt;</span> &#123; </span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;订阅者 leo 订阅事件成功！执行回调~&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> lisa = <span class="keyword">new</span> ConcreteSubscriber(</span><br><span class="line">  <span class="string">&quot;swimming&quot;</span>,</span><br><span class="line">  <span class="function">() =&gt;</span> &#123; </span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;订阅者 lisa 订阅事件成功！执行回调~&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> pual = <span class="keyword">new</span> ConcretePublisher(</span><br><span class="line">  <span class="string">&quot;swimming&quot;</span>,</span><br><span class="line">  &#123;<span class="attr">message</span>: <span class="string">&quot;pual 发布消息~&quot;</span>&#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> eventBus = <span class="keyword">new</span> ConcreteEventChannel();</span><br><span class="line">eventBus.on(pingan8787.subscriber, pingan8787.callback);</span><br><span class="line">eventBus.on(leo.subscriber, leo.callback);</span><br><span class="line">eventBus.on(lisa.subscriber, lisa.callback);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发布者 pual 发布 &quot;swimming&quot;相关的事件</span></span><br><span class="line">eventBus.emit(pual.subscriber, pual.data); </span><br><span class="line">eventBus.off (lisa.subscriber, lisa.callback);</span><br><span class="line">eventBus.emit(pual.subscriber, pual.data);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">输出结果：</span></span><br><span class="line"><span class="comment">[LOG]: 收到订阅信息，订阅事件：running</span></span><br><span class="line"><span class="comment">[LOG]: 收到订阅信息，订阅事件：swimming</span></span><br><span class="line"><span class="comment">[LOG]: 收到订阅信息，订阅事件：swimming</span></span><br><span class="line"><span class="comment">[LOG]: 收到发布者信息，执行订阅事件：swimming </span></span><br><span class="line"><span class="comment">[LOG]: 订阅者 leo 订阅事件成功！执行回调~ </span></span><br><span class="line"><span class="comment">[LOG]: 订阅者 lisa 订阅事件成功！执行回调~ </span></span><br><span class="line"><span class="comment">[LOG]: 收到取消订阅请求，需要取消的订阅事件：swimming </span></span><br><span class="line"><span class="comment">[LOG]: 收到发布者信息，执行订阅事件：swimming </span></span><br><span class="line"><span class="comment">[LOG]: 订阅者 leo 订阅事件成功！执行回调~ </span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="2-Vue-js-使用示例"><a href="#2-Vue-js-使用示例" class="headerlink" title="2. Vue.js 使用示例"></a>2. Vue.js 使用示例</h2><p>参考文章：<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/72777951">《Vue事件总线（EventBus）使用详细介绍》</a> 。</p>
<h3 id="2-1-创建-event-bus"><a href="#2-1-创建-event-bus" class="headerlink" title="2.1 创建 event bus"></a>2.1 创建 event bus</h3><p>在 Vue.js 中创建 EventBus 有两种方式：</p>
<ol>
<li><p>手动实现，导出 Vue 实例化的结果。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// event-bus.js</span></span><br><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> EventBus = <span class="keyword">new</span> Vue();</span><br></pre></td></tr></table></figure></li>
<li><p>直接在项目中的 <code>main.js</code>全局挂载 Vue 实例化的结果。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.js</span></span><br><span class="line">Vue.prototype.$EventBus = <span class="keyword">new</span> Vue()</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="2-2-发送事件"><a href="#2-2-发送事件" class="headerlink" title="2.2 发送事件"></a>2.2 发送事件</h3><p>假设你有两个Vue页面需要通信： A 和 B ，A页面按钮上绑定了<strong>点击事件</strong>，发送一则消息，通知 B 页面。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- A.vue --&gt;</span><br><span class="line">&lt;template&gt;</span><br><span class="line">    &lt;button @click=&quot;sendMsg()&quot;&gt;-&lt;/button&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt; </span><br><span class="line">import &#123; EventBus &#125; from &quot;../event-bus.js&quot;;</span><br><span class="line">export default &#123;</span><br><span class="line">  methods: &#123;</span><br><span class="line">    sendMsg() &#123;</span><br><span class="line">      EventBus.$emit(&quot;aMsg&quot;, &#x27;来自A页面的消息&#x27;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;; </span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-接收事件"><a href="#2-3-接收事件" class="headerlink" title="2.3 接收事件"></a>2.3 接收事件</h3><p>B 页面中接收消息，并展示内容到页面上。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- IncrementCount.vue --&gt;</span><br><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;p&gt;&#123;&#123;msg&#125;&#125;&lt;/p&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt; </span><br><span class="line">import &#123; </span><br><span class="line">  EventBus </span><br><span class="line">&#125; from &quot;../event-bus.js&quot;;</span><br><span class="line">export default &#123;</span><br><span class="line">  data()&#123;</span><br><span class="line">    return &#123;</span><br><span class="line">      msg: &#x27;&#x27;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  mounted() &#123;</span><br><span class="line">    EventBus.$on(&quot;aMsg&quot;, (msg) =&gt; &#123;</span><br><span class="line">      // A发送来的消息</span><br><span class="line">      this.msg = msg;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>同理可以从 B 页面往 A 页面发送消息，使用下面方法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 发送消息</span></span><br><span class="line">EventBus.$emit(channel: string, callback(payload1,…))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听接收消息</span></span><br><span class="line">EventBus.$on(channel: string, callback(payload1,…))</span><br></pre></td></tr></table></figure>

<h3 id="2-4-移除事件监听者"><a href="#2-4-移除事件监听者" class="headerlink" title="2.4 移除事件监听者"></a>2.4 <strong>移除事件监听者</strong></h3><p>使用 <code>EventBus.$off(&#39;aMsg&#39;)</code> 来移除应用内所有对此某个事件的监听。或者直接用 <code>EventBus.$off()</code> 来移除所有事件频道，不需要添加任何参数 。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; </span><br><span class="line">  eventBus </span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;./event-bus.js&#x27;</span></span><br><span class="line">EventBus.$off(<span class="string">&#x27;aMsg&#x27;</span>, &#123;&#125;)</span><br></pre></td></tr></table></figure>

<h1 id="六、总结"><a href="#六、总结" class="headerlink" title="六、总结"></a>六、总结</h1><p>观察者模式和发布-订阅模式的差别在于事件总线，如果有则是发布-订阅模式，反之为观察者模式。所以在实现发布-订阅模式，关键在于实现这个事件总线，在某个特定时间触发某个特定事件，从而触发监听这个特定事件的组件进行相应操作的功能。发布-订阅模式在很多时候非常有用。</p>
<h1 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h1><p>1.<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%8F%91%E5%B8%83/%E8%AE%A2%E9%98%85">《发布/订阅》</a> <br>2.<a target="_blank" rel="noopener" href="https://molunerfinn.com/observer-vs-pubsub-pattern/#%E6%A6%82%E8%BF%B0">《观察者模式VS订阅发布模式》</a> </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/09/22/218-%E3%80%90%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E3%80%91TypeScript%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E5%8F%91%E5%B8%83-%E8%AE%A2%E9%98%85%E6%A8%A1%E5%BC%8F/" data-id="ckts3ejyy00ne4d9k85js86dl" data-title="218-【设计模式】TypeScript设计模式之发布-订阅模式" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/" rel="tag">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/" rel="tag">前端开发</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%8E%9F%E5%88%9B/" rel="tag">原创</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" rel="tag">设计模式</a></li></ul>

    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/23/">23</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Angular/" rel="tag">Angular</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CSS/" rel="tag">CSS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CSS%E5%8A%A8%E7%94%BB/" rel="tag">CSS动画</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Chrome/" rel="tag">Chrome</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ES6-ES7-ES8/" rel="tag">ES6/ES7/ES8</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Eslint/" rel="tag">Eslint</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Express/" rel="tag">Express</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GraphQL/" rel="tag">GraphQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/H5/" rel="tag">H5</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTML/" rel="tag">HTML</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTTP/" rel="tag">HTTP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTTP%E5%8D%8F%E8%AE%AE/" rel="tag">HTTP协议</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hybrid/" rel="tag">Hybrid</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JavaScript/" rel="tag">JavaScript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NPM/" rel="tag">NPM</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nodejs/" rel="tag">Nodejs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Numpy/" rel="tag">Numpy</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Python/" rel="tag">Python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/React/" rel="tag">React</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Tensorflow/" rel="tag">Tensorflow</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TyeScript/" rel="tag">TyeScript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TypeScript/" rel="tag">TypeScript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vuejs/" rel="tag">Vuejs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WebSocket/" rel="tag">WebSocket</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Webpack/" rel="tag">Webpack</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/demo/" rel="tag">demo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/" rel="tag">中间件</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD/" rel="tag">人工智能</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%85%A8%E6%A0%88%E5%BC%80%E5%8F%91/" rel="tag">全栈开发</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/" rel="tag">前端开发</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%89%8D%E7%AB%AF%E6%8E%A2%E7%B4%A2/" rel="tag">前端探索</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%89%8D%E7%AB%AF%E7%9F%A5%E4%B9%8E%E7%B3%BB%E5%88%97/" rel="tag">前端知乎系列</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8E%9F%E5%88%9B/" rel="tag">原创</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B8%B8%E7%94%A8%E6%8A%80%E6%9C%AF/" rel="tag">常用技术</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BE%AE%E5%89%8D%E7%AB%AF/" rel="tag">微前端</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%80%BB%E7%BB%93/" rel="tag">总结</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" rel="tag">数据结构</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/" rel="tag">机器学习</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9E%84%E5%BB%BA%E5%B7%A5%E5%85%B7/" rel="tag">构建工具</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/" rel="tag">正则表达式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%BA%90%E7%A0%81/" rel="tag">源码</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%BA%90%E7%A0%81%E7%B2%BE%E8%AF%BB/" rel="tag">源码精读</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%83%AD%E9%97%A8/" rel="tag">热门</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%94%9F%E6%B4%BB%E6%9D%82%E8%AE%B0/" rel="tag">生活杂记</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%AE%97%E6%B3%95/" rel="tag">算法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/" rel="tag">编译原理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BD%91%E7%BB%9C%E8%AF%B7%E6%B1%82/" rel="tag">网络请求</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" rel="tag">设计模式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" rel="tag">读书笔记</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%87%8D%E6%B8%A9%E5%9F%BA%E7%A1%80/" rel="tag">重温基础</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9D%A2%E8%AF%95%E9%A2%98/" rel="tag">面试题</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Angular/" style="font-size: 11.88px;">Angular</a> <a href="/tags/CSS/" style="font-size: 18.13px;">CSS</a> <a href="/tags/CSS%E5%8A%A8%E7%94%BB/" style="font-size: 12.5px;">CSS动画</a> <a href="/tags/Chrome/" style="font-size: 10px;">Chrome</a> <a href="/tags/ES6-ES7-ES8/" style="font-size: 10.63px;">ES6/ES7/ES8</a> <a href="/tags/Eslint/" style="font-size: 10px;">Eslint</a> <a href="/tags/Express/" style="font-size: 10px;">Express</a> <a href="/tags/GraphQL/" style="font-size: 10px;">GraphQL</a> <a href="/tags/H5/" style="font-size: 10px;">H5</a> <a href="/tags/HTML/" style="font-size: 10px;">HTML</a> <a href="/tags/HTTP/" style="font-size: 11.88px;">HTTP</a> <a href="/tags/HTTP%E5%8D%8F%E8%AE%AE/" style="font-size: 11.25px;">HTTP协议</a> <a href="/tags/Hybrid/" style="font-size: 10.63px;">Hybrid</a> <a href="/tags/JavaScript/" style="font-size: 19.38px;">JavaScript</a> <a href="/tags/NPM/" style="font-size: 10px;">NPM</a> <a href="/tags/Nodejs/" style="font-size: 11.25px;">Nodejs</a> <a href="/tags/Numpy/" style="font-size: 10.63px;">Numpy</a> <a href="/tags/Python/" style="font-size: 17.5px;">Python</a> <a href="/tags/React/" style="font-size: 12.5px;">React</a> <a href="/tags/Tensorflow/" style="font-size: 10.63px;">Tensorflow</a> <a href="/tags/TyeScript/" style="font-size: 10px;">TyeScript</a> <a href="/tags/TypeScript/" style="font-size: 11.25px;">TypeScript</a> <a href="/tags/Vuejs/" style="font-size: 14.38px;">Vuejs</a> <a href="/tags/WebSocket/" style="font-size: 10px;">WebSocket</a> <a href="/tags/Webpack/" style="font-size: 15.63px;">Webpack</a> <a href="/tags/demo/" style="font-size: 10.63px;">demo</a> <a href="/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/" style="font-size: 10px;">中间件</a> <a href="/tags/%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD/" style="font-size: 16.25px;">人工智能</a> <a href="/tags/%E5%85%A8%E6%A0%88%E5%BC%80%E5%8F%91/" style="font-size: 11.25px;">全栈开发</a> <a href="/tags/%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/" style="font-size: 20px;">前端开发</a> <a href="/tags/%E5%89%8D%E7%AB%AF%E6%8E%A2%E7%B4%A2/" style="font-size: 11.25px;">前端探索</a> <a href="/tags/%E5%89%8D%E7%AB%AF%E7%9F%A5%E4%B9%8E%E7%B3%BB%E5%88%97/" style="font-size: 10.63px;">前端知乎系列</a> <a href="/tags/%E5%8E%9F%E5%88%9B/" style="font-size: 18.75px;">原创</a> <a href="/tags/%E5%B8%B8%E7%94%A8%E6%8A%80%E6%9C%AF/" style="font-size: 10.63px;">常用技术</a> <a href="/tags/%E5%BE%AE%E5%89%8D%E7%AB%AF/" style="font-size: 10px;">微前端</a> <a href="/tags/%E6%80%BB%E7%BB%93/" style="font-size: 13.75px;">总结</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" style="font-size: 10px;">数据结构</a> <a href="/tags/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/" style="font-size: 15px;">机器学习</a> <a href="/tags/%E6%9E%84%E5%BB%BA%E5%B7%A5%E5%85%B7/" style="font-size: 10.63px;">构建工具</a> <a href="/tags/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/" style="font-size: 10.63px;">正则表达式</a> <a href="/tags/%E6%BA%90%E7%A0%81/" style="font-size: 10px;">源码</a> <a href="/tags/%E6%BA%90%E7%A0%81%E7%B2%BE%E8%AF%BB/" style="font-size: 10px;">源码精读</a> <a href="/tags/%E7%83%AD%E9%97%A8/" style="font-size: 10px;">热门</a> <a href="/tags/%E7%94%9F%E6%B4%BB%E6%9D%82%E8%AE%B0/" style="font-size: 10px;">生活杂记</a> <a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 13.13px;">算法</a> <a href="/tags/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/" style="font-size: 10px;">编译原理</a> <a href="/tags/%E7%BD%91%E7%BB%9C%E8%AF%B7%E6%B1%82/" style="font-size: 10px;">网络请求</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 15px;">设计模式</a> <a href="/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" style="font-size: 14.38px;">读书笔记</a> <a href="/tags/%E9%87%8D%E6%B8%A9%E5%9F%BA%E7%A1%80/" style="font-size: 16.88px;">重温基础</a> <a href="/tags/%E9%9D%A2%E8%AF%95%E9%A2%98/" style="font-size: 10px;">面试题</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">July 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">May 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">December 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">October 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/07/28/227-%E3%80%90%E6%80%BB%E7%BB%93%E3%80%91%E5%A6%82%E4%BD%95%E4%BC%98%E9%9B%85%E7%9A%84%E5%9C%A8%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E4%BD%BF%E7%94%A8SVG%E5%AD%97%E4%BD%93%E5%9B%BE%E6%A0%87/">227-【总结】如何优雅的在微信小程序使用SVG字体图标</a>
          </li>
        
          <li>
            <a href="/2021/07/28/226-%E3%80%90HTTP%E3%80%91%E5%A6%82%E4%BD%95%E4%BC%98%E9%9B%85%E7%9A%84%E7%AE%A1%E7%90%86HTTP%E8%AF%B7%E6%B1%82%E5%92%8C%E5%93%8D%E5%BA%94%E6%8B%A6%E6%88%AA%E5%99%A8%EF%BC%9F/">226-【HTTP】如何优雅的管理HTTP请求和响应拦截器？</a>
          </li>
        
          <li>
            <a href="/2021/07/28/225-%E3%80%90Vue%E3%80%91%E4%BB%8E%E6%89%8B%E5%86%99Vue3%E7%9A%84Reactivity%E5%BC%80%E5%A7%8B%E6%B7%B1%E5%85%A5Vue3%E6%BA%90%E7%A0%81/">225-【Vue】从手写Vue3的Reactivity开始深入Vue3源码</a>
          </li>
        
          <li>
            <a href="/2021/05/30/224-%E3%80%90Chrome%E3%80%915%E4%B8%AAChrome%E8%B0%83%E8%AF%95%E6%B7%B7%E5%90%88%E5%BA%94%E7%94%A8%E7%9A%84%E6%8A%80%E5%B7%A7/">224-【Chrome】5个Chrome调试混合应用的技巧</a>
          </li>
        
          <li>
            <a href="/2021/03/19/223-%E3%80%90%E5%89%8D%E7%AB%AF%E6%8E%A2%E7%B4%A2%E3%80%91%E6%8E%A2%E7%B4%A2Snabbdom%E6%A8%A1%E5%9D%97%E7%B3%BB%E7%BB%9F%E5%8E%9F%E7%90%86/">223-【前端探索】探索Snabbdom模块系统原理</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2021 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>